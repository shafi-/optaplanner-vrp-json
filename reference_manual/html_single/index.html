<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.5">
<meta name="author" content="The OptaPlanner Team">
<title>OptaPlanner User Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>OptaPlanner User Guide</h1>
<div class="details">
<span id="author" class="author">The OptaPlanner Team</span><br>
<span id="email" class="email"><a href="https://www.optaplanner.org/community/team.html" class="bare">https://www.optaplanner.org/community/team.html</a></span><br>
<span id="revnumber">version 7.0.0.Final</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#plannerIntroduction">1. OptaPlanner Introduction</a>
<ul class="sectlevel2">
<li><a href="#whatIsOptaPlanner">1.1. What is OptaPlanner?</a></li>
<li><a href="#whatIsAPlanningProblem">1.2. What is a Planning Problem?</a>
<ul class="sectlevel3">
<li><a href="#aPlanningProblemIsNPCompleteOrNPHard">1.2.1. A Planning Problem is NP-complete or NP-hard</a></li>
<li><a href="#aPlanningProblemHasConstraints">1.2.2. A Planning Problem Has (Hard and Soft) Constraints</a></li>
<li><a href="#aPlanningProblemHasAHugeSearchSpace">1.2.3. A Planning Problem Has a Huge Search Space</a></li>
</ul>
</li>
<li><a href="#requirements">1.3. Requirements</a></li>
<li><a href="#governance">1.4. Governance</a>
<ul class="sectlevel3">
<li><a href="#statusOfOptaPlanner">1.4.1. Status of OptaPlanner</a></li>
<li><a href="#releaseNotes">1.4.2. Release Notes</a></li>
<li><a href="#backwardsCompatibility">1.4.3. Backwards Compatibility</a></li>
<li><a href="#communityAndSupport">1.4.4. Community and Support</a></li>
<li><a href="#relationshipWithKie">1.4.5. Relationship with Drools and jBPM</a></li>
</ul>
</li>
<li><a href="#downloadAndRunTheExamples">1.5. Download and Run the Examples</a>
<ul class="sectlevel3">
<li><a href="#getTheReleaseZipAndRunTheExamples">1.5.1. Get the Release .zip and Run the Examples</a></li>
<li><a href="#runTheExamplesInAnIDE">1.5.2. Run the Examples in an IDE (IntelliJ, Eclipse, NetBeans)</a></li>
<li><a href="#useWithMavenGradleEtc">1.5.3. Use OptaPlanner with Maven, Gradle, Ivy, Buildr or ANT</a></li>
<li><a href="#buildFromSource">1.5.4. Build OptaPlanner from Source</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#quickStart">2. Getting Started: A Cloud Balancing Demonstration</a>
<ul class="sectlevel2">
<li><a href="#cloudBalancingTutorial">2.1. Cloud Balancing Tutorial</a>
<ul class="sectlevel3">
<li><a href="#cloudBalancingProblemDescription">2.1.1. Problem Description</a></li>
<li><a href="#cloudBalancingProblemSize">2.1.2. Problem Size</a></li>
</ul>
</li>
<li><a href="#cloudBalancingDomainModel">2.2. Using the Domain Model</a>
<ul class="sectlevel3">
<li><a href="#cloudBalancingDomainModelDesign">2.2.1. Domain Model Design</a></li>
<li><a href="#cloudBalancingDomainModelImplementation">2.2.2. Domain Model Implementation</a></li>
</ul>
</li>
<li><a href="#cloudBalancingMainMethod">2.3. Run the Cloud Balancing Hello World</a></li>
<li><a href="#cloudBalancingSolverConfiguration">2.4. Solver Configuration</a></li>
<li><a href="#cloudBalancingScoreConfiguration">2.5. Score Configuration</a>
<ul class="sectlevel3">
<li><a href="#cloudBalancingEasyJavaScoreConfiguration">2.5.1. Easy Java Score Configuration</a></li>
<li><a href="#cloudBalancingDroolsScoreConfiguration">2.5.2. Drools Score Configuration</a></li>
</ul>
</li>
<li><a href="#cloudBalancingBeyondThisTutorial">2.6. Beyond this Tutorial</a></li>
</ul>
</li>
<li><a href="#useCasesAndExamples">3. Use Cases and Examples</a>
<ul class="sectlevel2">
<li><a href="#examplesOverview">3.1. Examples Overview</a></li>
<li><a href="#basicExamples">3.2. Basic Examples</a>
<ul class="sectlevel3">
<li><a href="#nQueens">3.2.1. N Queens</a></li>
<li><a href="#cloudBalancing">3.2.2. Cloud Balancing</a></li>
<li><a href="#tsp">3.2.3. Traveling Salesman (TSP - Traveling Salesman Problem)</a></li>
<li><a href="#dinnerParty">3.2.4. Dinner Party</a></li>
<li><a href="#tennis">3.2.5. Tennis Club Scheduling</a></li>
<li><a href="#meetingScheduling">3.2.6. Meeting Scheduling</a></li>
</ul>
</li>
<li><a href="#realExamples">3.3. Real Examples</a>
<ul class="sectlevel3">
<li><a href="#curriculumCourse">3.3.1. Course Timetabling (ITC 2007 Track 3 - Curriculum Course Scheduling)</a></li>
<li><a href="#machineReassignment">3.3.2. Machine Reassignment (Google ROADEF 2012)</a></li>
<li><a href="#vehicleRouting">3.3.3. Vehicle Routing</a></li>
<li><a href="#projectJobScheduling">3.3.4. Project Job Scheduling</a></li>
<li><a href="#bedAllocation">3.3.5. Hospital Bed Planning (PAS - Patient Admission Scheduling)</a></li>
<li><a href="#taskAssigning">3.3.6. Task assigning</a></li>
</ul>
</li>
<li><a href="#difficultExamples">3.4. Difficult Examples</a>
<ul class="sectlevel3">
<li><a href="#examination">3.4.1. Exam Timetabling (ITC 2007 track 1 - Examination)</a></li>
<li><a href="#employeeRostering">3.4.2. Employee Rostering (INRC 2010 - Nurse Rostering)</a></li>
<li><a href="#travelingTournament">3.4.3. Traveling Tournament Problem (TTP)</a></li>
<li><a href="#cheapTimeScheduling">3.4.4. Cheap Time Scheduling</a></li>
<li><a href="#investment">3.4.5. Investment asset class allocation (portfolio optimization)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#plannerConfiguration">4. Planner Configuration</a>
<ul class="sectlevel2">
<li><a href="#plannerConfigurationOverview">4.1. Overview</a></li>
<li><a href="#solverConfiguration">4.2. Solver Configuration</a>
<ul class="sectlevel3">
<li><a href="#solverConfigurationByXML">4.2.1. Solver Configuration by XML</a></li>
<li><a href="#solverConfigurationByJavaAPI">4.2.2. Solver Configuration by Java API</a></li>
<li><a href="#annotationsConfiguration">4.2.3. Annotations Configuration</a></li>
</ul>
</li>
<li><a href="#modelAPlanningProblem">4.3. Model a Planning Problem</a>
<ul class="sectlevel3">
<li><a href="#isThisClassAProblemFactOrPlanningEntity">4.3.1. Is This Class a Problem Fact or Planning Entity?</a></li>
<li><a href="#problemFact">4.3.2. Problem Fact</a></li>
<li><a href="#planningEntity">4.3.3. Planning Entity</a></li>
<li><a href="#planningVariable">4.3.4. Planning Variable (genuine)</a></li>
<li><a href="#planningValueAndPlanningValueRange">4.3.5. Planning Value and Planning Value Range</a></li>
<li><a href="#shadowVariable">4.3.6. Shadow Variable</a></li>
<li><a href="#planningProblemAndPlanningSolution">4.3.7. Planning Problem and Planning Solution</a></li>
</ul>
</li>
<li><a href="#useTheSolver">4.4. Use the <code>Solver</code></a>
<ul class="sectlevel3">
<li><a href="#theSolverInterface">4.4.1. The <code>Solver</code> Interface</a></li>
<li><a href="#solvingAProblem">4.4.2. Solving a Problem</a></li>
<li><a href="#environmentMode">4.4.3. Environment Mode: Are There Bugs in my Code?</a></li>
<li><a href="#logging">4.4.4. Logging Level: What is the <code>Solver</code> Doing?</a></li>
<li><a href="#randomNumberGenerator">4.4.5. Random Number Generator</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scoreCalculation">5. Score Calculation</a>
<ul class="sectlevel2">
<li><a href="#scoreTerminology">5.1. Score Terminology</a>
<ul class="sectlevel3">
<li><a href="#whatIsAScore">5.1.1. What is a Score?</a></li>
<li><a href="#formalizeTheBusinessConstraints">5.1.2. Formalize the Business Constraints</a></li>
<li><a href="#scoreConstraintSignum">5.1.3. Score Constraint Signum (Positive or Negative)</a></li>
<li><a href="#scoreConstraintWeight">5.1.4. Score Constraint Weight</a></li>
<li><a href="#scoreLevel">5.1.5. Score Constraint Level (hard, soft, &#8230;&#8203;)</a></li>
<li><a href="#paretoScoring">5.1.6. Pareto Scoring (AKA Multi-objective Optimization Scoring)</a></li>
<li><a href="#combiningScoreTechniques">5.1.7. Combining Score Techniques</a></li>
<li><a href="#scoreInterface">5.1.8. <code>Score</code> interface</a></li>
<li><a href="#avoidFloatingPointNumbersInScoreCalculation">5.1.9. Avoid Floating Point Numbers in Score Calculation</a></li>
</ul>
</li>
<li><a href="#scoreType">5.2. Choose a Score Type</a>
<ul class="sectlevel3">
<li><a href="#simpleScore">5.2.1. SimpleScore</a></li>
<li><a href="#hardSoftScore">5.2.2. HardSoftScore (Recommended)</a></li>
<li><a href="#hardMediumSoftScore">5.2.3. HardMediumSoftScore</a></li>
<li><a href="#bendableScore">5.2.4. BendableScore</a></li>
<li><a href="#customScore">5.2.5. Implementing a Custom Score</a></li>
</ul>
</li>
<li><a href="#calculateTheScore">5.3. Calculate the <code>Score</code></a>
<ul class="sectlevel3">
<li><a href="#scoreCalculationTypes">5.3.1. Score Calculation Types</a></li>
<li><a href="#easyJavaScoreCalculation">5.3.2. Easy Java Score Calculation</a></li>
<li><a href="#incrementalJavaScoreCalculation">5.3.3. Incremental Java Score Calculation</a></li>
<li><a href="#droolsScoreCalculation">5.3.4. Drools Score Calculation</a></li>
<li><a href="#initializingScoreTrend">5.3.5. InitializingScoreTrend</a></li>
<li><a href="#invalidScoreDetection">5.3.6. Invalid Score Detection</a></li>
</ul>
</li>
<li><a href="#scoreCalculationPerformanceTricks">5.4. Score Calculation Performance Tricks</a>
<ul class="sectlevel3">
<li><a href="#scoreCalculationPerformanceTricksOverview">5.4.1. Overview</a></li>
<li><a href="#scoreCalculationSpeed">5.4.2. Score Calculation Speed</a></li>
<li><a href="#incrementalScoreCalculation">5.4.3. Incremental Score Calculation (with Deltas)</a></li>
<li><a href="#avoidCallingRemoteServicesDuringScoreCalculation">5.4.4. Avoid Calling Remote Services During Score Calculation</a></li>
<li><a href="#pointlessConstraints">5.4.5. Pointless Constraints</a></li>
<li><a href="#buildInHardConstraint">5.4.6. Built-in Hard Constraint</a></li>
<li><a href="#otherScoreCalculationPerformanceTricks">5.4.7. Other Score Calculation Performance Tricks</a></li>
<li><a href="#scoreTrap">5.4.8. Score Trap</a></li>
<li><a href="#stepLimitBenchmark">5.4.9. stepLimit Benchmark</a></li>
<li><a href="#fairnessScoreConstraints">5.4.10. Fairness Score Constraints</a></li>
</ul>
</li>
<li><a href="#explainingTheScore">5.5. Explaining the Score: Using Score Calculation Outside the <code>Solver</code></a>
<ul class="sectlevel3">
<li><a href="#constraintMatchTotal">5.5.1. Constraint Match Total: Break down the Score by Constraint</a></li>
<li><a href="#indictmentHeatMap">5.5.2. Indictment Heat Map: Visualize the Hot Planning Entities</a></li>
</ul>
</li>
<li><a href="#testingScoreConstraints">5.6. Testing score constraints with JUnit</a></li>
</ul>
</li>
<li><a href="#optimizationAlgorithms">6. Optimization Algorithms</a>
<ul class="sectlevel2">
<li><a href="#searchSpaceSize">6.1. Search Space Size in the Real World</a></li>
<li><a href="#doesPlannerFindTheOptimalSolution">6.2. Does Planner Find the Optimal Solution?</a></li>
<li><a href="#architectureOverview">6.3. Architecture Overview</a></li>
<li><a href="#optimizationAlgorithmsOverview">6.4. Optimization Algorithms Overview</a></li>
<li><a href="#whichOptimizationAlgorithmsShouldIUse">6.5. Which Optimization Algorithms Should I Use?</a></li>
<li><a href="#powerTweaking">6.6. Power tweaking or default parameter values</a></li>
<li><a href="#solverPhase">6.7. Solver Phase</a></li>
<li><a href="#scopeOverview">6.8. Scope Overview</a></li>
<li><a href="#termination">6.9. Termination</a>
<ul class="sectlevel3">
<li><a href="#timeMillisSpentTermination">6.9.1. TimeMillisSpentTermination</a></li>
<li><a href="#unimprovedTimeMillisSpentTermination">6.9.2. UnimprovedTimeMillisSpentTermination</a></li>
<li><a href="#bestScoreTermination">6.9.3. BestScoreTermination</a></li>
<li><a href="#bestScoreFeasibleTermination">6.9.4. BestScoreFeasibleTermination</a></li>
<li><a href="#stepCountTermination">6.9.5. StepCountTermination</a></li>
<li><a href="#unimprovedStepCountTermination">6.9.6. UnimprovedStepCountTermination</a></li>
<li><a href="#scoreCalculationCountTermination">6.9.7. ScoreCalculationCountTermination</a></li>
<li><a href="#combiningMultipleTerminations">6.9.8. Combining Multiple Terminations</a></li>
<li><a href="#asynchronousTermination">6.9.9. Asynchronous Termination from Another Thread</a></li>
</ul>
</li>
<li><a href="#SolverEventListener">6.10. SolverEventListener</a></li>
<li><a href="#customSolverPhase">6.11. Custom Solver Phase</a></li>
<li><a href="#noChangeSolverPhase">6.12. No Change Solver Phase</a></li>
<li><a href="#multiThreadedSolving">6.13. Multi-threaded Solving</a></li>
</ul>
</li>
<li><a href="#moveAndNeighborhoodSelection">7. <code>Move</code> and Neighborhood Selection</a>
<ul class="sectlevel2">
<li><a href="#moveAndNeighborhoodSelectionIntroduction">7.1. <code>Move</code> and Neighborhood Introduction</a>
<ul class="sectlevel3">
<li><a href="#whatIsAMove">7.1.1. What is a <code>Move</code>?</a></li>
<li><a href="#whatIsAMoveSelector">7.1.2. What is a <code>MoveSelector</code>?</a></li>
<li><a href="#subselectingOfEntitiesValuesAndOtherMoves">7.1.3. Subselecting of Entities, Values and Other Moves</a></li>
</ul>
</li>
<li><a href="#genericMoveSelectors">7.2. Generic MoveSelectors</a>
<ul class="sectlevel3">
<li><a href="#changeMoveSelector">7.2.1. changeMoveSelector</a></li>
<li><a href="#swapMoveSelector">7.2.2. swapMoveSelector</a></li>
<li><a href="#pillarChangeMoveSelector">7.2.3. pillarChangeMoveSelector</a></li>
<li><a href="#pillarSwapMoveSelector">7.2.4. pillarSwapMoveSelector</a></li>
<li><a href="#tailChainSwapMoveSelector">7.2.5. tailChainSwapMoveSelector or 2-opt (chained variables only)</a></li>
<li><a href="#subChainChangeMoveSelector">7.2.6. subChainChangeMoveSelector (chained variables only)</a></li>
<li><a href="#subChainSwapMoveSelector">7.2.7. subChainSwapMoveSelector (chained variables only)</a></li>
</ul>
</li>
<li><a href="#combiningMultipleMoveSelectors">7.3. Combining Multiple <code>MoveSelector</code>s</a>
<ul class="sectlevel3">
<li><a href="#unionMoveSelector">7.3.1. unionMoveSelector</a></li>
<li><a href="#cartesianProductMoveSelector">7.3.2. cartesianProductMoveSelector</a></li>
</ul>
</li>
<li><a href="#entitySelector">7.4. EntitySelector</a></li>
<li><a href="#valueSelector">7.5. ValueSelector</a></li>
<li><a href="#generalSelectorFeatures">7.6. General <code>Selector</code> Features</a>
<ul class="sectlevel3">
<li><a href="#cacheType">7.6.1. <code>CacheType</code>: Create Moves Ahead of Time or Just In Time</a></li>
<li><a href="#selectionOrder">7.6.2. SelectionOrder: Original, Sorted, Random, Shuffled or Probabilistic</a></li>
<li><a href="#recommendedCombinationsOfCacheTypeAndSelectionOrder">7.6.3. Recommended Combinations of <code>CacheType</code> and <code>SelectionOrder</code></a></li>
<li><a href="#filteredSelection">7.6.4. Filtered Selection</a></li>
<li><a href="#sortedSelection">7.6.5. Sorted Selection</a></li>
<li><a href="#probabilisticSelection">7.6.6. Probabilistic Selection</a></li>
<li><a href="#limitedSelection">7.6.7. Limited Selection</a></li>
<li><a href="#mimicSelection">7.6.8. Mimic Selection (Record/Replay)</a></li>
<li><a href="#nearbySelection">7.6.9. Nearby Selection</a></li>
</ul>
</li>
<li><a href="#customMoves">7.7. Custom Moves</a>
<ul class="sectlevel3">
<li><a href="#whichMoveTypesMightBeMissing">7.7.1. Which Move Types Might be Missing in my Implementation?</a></li>
<li><a href="#customMovesIntroduction">7.7.2. Custom Moves Introduction</a></li>
<li><a href="#theInterfaceMove">7.7.3. The Interface <code>Move</code></a></li>
<li><a href="#moveListFactory">7.7.4. <code>MoveListFactory</code>: the Easy Way to Generate Custom Moves</a></li>
<li><a href="#moveIteratorFactory">7.7.5. <code>MoveIteratorFactory</code>: Generate Custom Moves Just in Time</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#exhaustiveSearch">8. Exhaustive Search</a>
<ul class="sectlevel2">
<li><a href="#exhaustiveSearchOverview">8.1. Overview</a></li>
<li><a href="#bruteForce">8.2. Brute Force</a>
<ul class="sectlevel3">
<li><a href="#bruteForceAlgorithm">8.2.1. Algorithm Description</a></li>
<li><a href="#bruteForceConfiguration">8.2.2. Configuration</a></li>
</ul>
</li>
<li><a href="#branchAndBound">8.3. Branch And Bound</a>
<ul class="sectlevel3">
<li><a href="#branchAndBoundAlgorithm">8.3.1. Algorithm Description</a></li>
<li><a href="#branchAndBoundConfiguration">8.3.2. Configuration</a></li>
</ul>
</li>
<li><a href="#scalabilityOfExhaustiveSearch">8.4. Scalability of Exhaustive Search</a></li>
</ul>
</li>
<li><a href="#constructionHeuristics">9. Construction Heuristics</a>
<ul class="sectlevel2">
<li><a href="#constructionHeuristicsOverview">9.1. Overview</a></li>
<li><a href="#firstFit">9.2. First Fit</a>
<ul class="sectlevel3">
<li><a href="#firstFitAlgorithm">9.2.1. Algorithm Description</a></li>
<li><a href="#firstFitConfiguration">9.2.2. Configuration</a></li>
</ul>
</li>
<li><a href="#firstFitDecreasing">9.3. First Fit Decreasing</a>
<ul class="sectlevel3">
<li><a href="#firstFitDecreasingAlgorithm">9.3.1. Algorithm Description</a></li>
<li><a href="#firstFitDecreasingConfiguration">9.3.2. Configuration</a></li>
</ul>
</li>
<li><a href="#weakestFit">9.4. Weakest Fit</a>
<ul class="sectlevel3">
<li><a href="#weakestFitAlgorithm">9.4.1. Algorithm Description</a></li>
<li><a href="#weakestFitConfiguration">9.4.2. Configuration</a></li>
</ul>
</li>
<li><a href="#weakestFitDecreasing">9.5. Weakest Fit Decreasing</a>
<ul class="sectlevel3">
<li><a href="#weakestFitDecreasingAlgorithm">9.5.1. Algorithm Description</a></li>
<li><a href="#weakestFitDecreasingConfiguration">9.5.2. Configuration</a></li>
</ul>
</li>
<li><a href="#strongestFit">9.6. Strongest Fit</a>
<ul class="sectlevel3">
<li><a href="#strongestFitAlgorithm">9.6.1. Algorithm Description</a></li>
<li><a href="#strongestFitConfiguration">9.6.2. Configuration</a></li>
</ul>
</li>
<li><a href="#strongestFitDecreasing">9.7. Strongest Fit Decreasing</a>
<ul class="sectlevel3">
<li><a href="#strongestFitDecreasingAlgorithm">9.7.1. Algorithm Description</a></li>
<li><a href="#strongestFitDecreasingConfiguration">9.7.2. Configuration</a></li>
</ul>
</li>
<li><a href="#allocateEntityFromQueue">9.8. Allocate Entity From Queue</a>
<ul class="sectlevel3">
<li><a href="#allocateEntityFromQueueAlgorithm">9.8.1. Algorithm Description</a></li>
<li><a href="#allocateEntityFromQueueConfiguration">9.8.2. Configuration</a></li>
<li><a href="#allocateEntityFromQueueMultipleVariables">9.8.3. Multiple Variables</a></li>
<li><a href="#allocateEntityFromQueueMultipleEntityClasses">9.8.4. Multiple Entity Classes</a></li>
<li><a href="#constructionHeuristicsPickEarlyType">9.8.5. Pick Early Type</a></li>
</ul>
</li>
<li><a href="#allocateToValueFromQueue">9.9. Allocate To Value From Queue</a>
<ul class="sectlevel3">
<li><a href="#allocateToValueFromQueueAlgorithm">9.9.1. Algorithm Description</a></li>
<li><a href="#allocateToValueFromQueueConfiguration">9.9.2. Configuration</a></li>
</ul>
</li>
<li><a href="#cheapestInsertion">9.10. Cheapest Insertion</a>
<ul class="sectlevel3">
<li><a href="#cheapestInsertionAlgorithm">9.10.1. Algorithm Description</a></li>
<li><a href="#cheapestInsertionConfiguration">9.10.2. Configuration</a></li>
</ul>
</li>
<li><a href="#regretInsertion">9.11. Regret Insertion</a>
<ul class="sectlevel3">
<li><a href="#regretInsertionAlgorithm">9.11.1. Algorithm Description</a></li>
<li><a href="#regretInsertionConfiguration">9.11.2. Configuration</a></li>
</ul>
</li>
<li><a href="#allocateFromPool">9.12. Allocate From Pool</a>
<ul class="sectlevel3">
<li><a href="#allocateFromPoolAlgorithm">9.12.1. Algorithm Description</a></li>
<li><a href="#allocateFromPoolConfiguration">9.12.2. Configuration</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#localSearch">10. Local Search</a>
<ul class="sectlevel2">
<li><a href="#localSearchOverview">10.1. Overview</a></li>
<li><a href="#localSearchConcepts">10.2. Local Search Concepts</a>
<ul class="sectlevel3">
<li><a href="#localSearchStepByStep">10.2.1. Step by Step</a></li>
<li><a href="#localSearchConceptsDecideTheNextStep">10.2.2. Decide the Next Step</a></li>
<li><a href="#localSearchAcceptor">10.2.3. Acceptor</a></li>
<li><a href="#localSearchForager">10.2.4. Forager</a></li>
</ul>
</li>
<li><a href="#hillClimbing">10.3. Hill Climbing (Simple Local Search)</a>
<ul class="sectlevel3">
<li><a href="#hillClimbingAlgorithm">10.3.1. Algorithm Description</a></li>
<li><a href="#hillClimbingStuckInLocalOptima">10.3.2. Stuck in Local Optima</a></li>
<li><a href="#hillClimbingConfigure">10.3.3. Configuration</a></li>
</ul>
</li>
<li><a href="#tabuSearch">10.4. Tabu Search</a>
<ul class="sectlevel3">
<li><a href="#tabuSearchAlgorithm">10.4.1. Algorithm Description</a></li>
<li><a href="#tabuSearchConfiguration">10.4.2. Configuration</a></li>
</ul>
</li>
<li><a href="#simulatedAnnealing">10.5. Simulated Annealing</a>
<ul class="sectlevel3">
<li><a href="#simulatedAnnealingAlgorithm">10.5.1. Algorithm Description</a></li>
<li><a href="#simulatedAnnealingConfiguration">10.5.2. Configuration</a></li>
</ul>
</li>
<li><a href="#lateAcceptance">10.6. Late Acceptance</a>
<ul class="sectlevel3">
<li><a href="#lateAcceptanceAlgorithm">10.6.1. Algorithm Description</a></li>
<li><a href="#lateAcceptanceConfiguration">10.6.2. Configuration</a></li>
</ul>
</li>
<li><a href="#stepCountingHillClimbing">10.7. Step Counting Hill Climbing</a>
<ul class="sectlevel3">
<li><a href="#stepCountingHillClimbingAlgorithm">10.7.1. Algorithm Description</a></li>
<li><a href="#stepCountingHillClimbingConfiguration">10.7.2. Configuration</a></li>
</ul>
</li>
<li><a href="#strategicOscillation">10.8. Strategic Oscillation</a>
<ul class="sectlevel3">
<li><a href="#strategicOscillationAlgorithm">10.8.1. Algorithm Description</a></li>
<li><a href="#strategicOscillationConfiguration">10.8.2. Configuration</a></li>
</ul>
</li>
<li><a href="#customTerminationSelectorOrAcceptor">10.9. Using a Custom Termination, MoveSelector, EntitySelector, ValueSelector or Acceptor</a></li>
</ul>
</li>
<li><a href="#evolutionaryAlgorithms">11. Evolutionary Algorithms</a>
<ul class="sectlevel2">
<li><a href="#evolutionaryAlgorithmsOverview">11.1. Overview</a></li>
<li><a href="#evolutionaryStrategies">11.2. Evolutionary Strategies</a></li>
<li><a href="#geneticAlgorithms">11.3. Genetic Algorithms</a></li>
</ul>
</li>
<li><a href="#hyperheuristics">12. Hyperheuristics</a>
<ul class="sectlevel2">
<li><a href="#hyperheuristicsOverview">12.1. Overview</a></li>
</ul>
</li>
<li><a href="#partitionedSearch">13. Partitioned Search</a>
<ul class="sectlevel2">
<li><a href="#partitionedSearchAlgorithm">13.1. Algorithm Description</a></li>
<li><a href="#partitionedSearchConfiguration">13.2. Configuration</a></li>
<li><a href="#partitioningASolution">13.3. Partitioning a Solution</a>
<ul class="sectlevel3">
<li><a href="#customSolutionPartitioner">13.3.1. Custom SolutionPartitioner</a></li>
</ul>
</li>
<li><a href="#runnablePartThreadLimit">13.4. Runnable Part Thread Limit</a></li>
</ul>
</li>
<li><a href="#benchmarker">14. Benchmarking And Tweaking</a>
<ul class="sectlevel2">
<li><a href="#findTheBestSolverConfiguration">14.1. Find The Best <code>Solver</code> Configuration</a></li>
<li><a href="#benchmarkConfiguration">14.2. Benchmark Configuration</a>
<ul class="sectlevel3">
<li><a href="#benchmarker.addDependency">14.2.1. Add Dependency On <code>optaplanner-benchmark</code></a></li>
<li><a href="#buildAndRunAPlannerBenchmark">14.2.2. Build And Run A <code>PlannerBenchmark</code></a></li>
<li><a href="#solutionFileIO">14.2.3. SolutionFileIO: Input And Output Of Solution Files</a></li>
<li><a href="#warmingUpTheHotSpotCompiler">14.2.4. Warming Up The HotSpot Compiler</a></li>
<li><a href="#benchmarkBlueprint">14.2.5. Benchmark Blueprint: A Predefined Configuration</a></li>
<li><a href="#writeTheOutputSolutionOfBenchmarkRuns">14.2.6. Write The Output Solution Of Benchmark Runs</a></li>
<li><a href="#benchmarkLogging">14.2.7. Benchmark Logging</a></li>
</ul>
</li>
<li><a href="#benchmarkReport">14.3. Benchmark Report</a>
<ul class="sectlevel3">
<li><a href="#benchmarkHtmlReport">14.3.1. HTML Report</a></li>
<li><a href="#rankingTheSolvers">14.3.2. Ranking The <code>Solver</code>s</a></li>
</ul>
</li>
<li><a href="#benchmarkReportSummaryStatistics">14.4. Summary Statistics</a>
<ul class="sectlevel3">
<li><a href="#benchmarkReportBestScoreSummary">14.4.1. Best Score Summary (Graph And Table)</a></li>
<li><a href="#benchmarkReportBestScoreScalabilitySummary">14.4.2. Best Score Scalability Summary (Graph)</a></li>
<li><a href="#benchmarkReportBestScoreDistributionSummary">14.4.3. Best Score Distribution Summary (Graph)</a></li>
<li><a href="#benchmarkReportWinningScoreDifferenceSummary">14.4.4. Winning Score Difference Summary (Graph And Table)</a></li>
<li><a href="#benchmarkReportWorstScoreDifferencePercentageSummary">14.4.5. Worst Score Difference Percentage (ROI) Summary (Graph and Table)</a></li>
<li><a href="#benchmarkReportScoreCalculationSpeedSummary">14.4.6. Score Calculation Speed Summary (Graph and Table)</a></li>
<li><a href="#benchmarkReportTimeSpentSummary">14.4.7. Time Spent Summary (Graph And Table)</a></li>
<li><a href="#benchmarkReportTimeSpentScalabilitySummary">14.4.8. Time Spent Scalability Summary (Graph)</a></li>
<li><a href="#benchmarkReportBestScorePerTimeSpentSummary">14.4.9. Best Score Per Time Spent Summary (Graph)</a></li>
</ul>
</li>
<li><a href="#benchmarkReportStatisticPerDataset">14.5. Statistic Per Dataset (Graph And CSV)</a>
<ul class="sectlevel3">
<li><a href="#enableAProblemStatistic">14.5.1. Enable A Problem Statistic</a></li>
<li><a href="#benchmarkReportBestScoreOverTimeStatistic">14.5.2. Best Score Over Time Statistic (Graph And CSV)</a></li>
<li><a href="#benchmarkReportStepScoreOverTimeStatistic">14.5.3. Step Score Over Time Statistic (Graph And CSV)</a></li>
<li><a href="#benchmarkReportScoreCalculationSpeedtatistic">14.5.4. Score Calculation Speed Statistic (Graph And CSV)</a></li>
<li><a href="#benchmarkReportBestSolutionMutationOverTimeStatistic">14.5.5. Best Solution Mutation Over Time Statistic (Graph And CSV)</a></li>
<li><a href="#benchmarkReportMoveCountPerStepStatistic">14.5.6. Move Count Per Step Statistic (Graph And CSV)</a></li>
<li><a href="#benchmarkReportMemoryUseStatistic">14.5.7. Memory Use Statistic (Graph And CSV)</a></li>
</ul>
</li>
<li><a href="#benchmarkReportStatisticPerSingleBenchmark">14.6. Statistic Per Single Benchmark (Graph And CSV)</a>
<ul class="sectlevel3">
<li><a href="#enableASingleStatistic">14.6.1. Enable A Single Statistic</a></li>
<li><a href="#benchmarkReportConstraintMatchTotalBestScoreOverTimeStatistic">14.6.2. Constraint Match Total Best Score Over Time Statistic (Graph And CSV)</a></li>
<li><a href="#benchmarkReportConstraintMatchTotalStepScoreOverTimeStatistic">14.6.3. Constraint Match Total Step Score Over Time Statistic (Graph And CSV)</a></li>
<li><a href="#benchmarkReportPickedMoveTypeBestScoreDiffOverTimeStatistic">14.6.4. Picked Move Type Best Score Diff Over Time Statistic (Graph And CSV)</a></li>
<li><a href="#benchmarkReportPickedMoveTypeStepScoreDiffOverTimeStatistic">14.6.5. Picked Move Type Step Score Diff Over Time Statistic (Graph And CSV)</a></li>
</ul>
</li>
<li><a href="#advancedBenchmarking">14.7. Advanced Benchmarking</a>
<ul class="sectlevel3">
<li><a href="#benchmarkingPerformanceTricks">14.7.1. Benchmarking Performance Tricks</a></li>
<li><a href="#statisticalBenchmarking">14.7.2. Statistical Benchmarking</a></li>
<li><a href="#templateBasedBenchmarking">14.7.3. Template Based Benchmarking And Matrix Benchmarking</a></li>
<li><a href="#benchmarkReportAggregation">14.7.4. Benchmark Report Aggregation</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#repeatedPlanning">15. Repeated Planning</a>
<ul class="sectlevel2">
<li><a href="#introductionToRepeatedPlanning">15.1. Introduction to Repeated Planning</a></li>
<li><a href="#backupPlanning">15.2. Backup Planning</a></li>
<li><a href="#overconstrainedPlanning">15.3. Overconstrained Planning</a>
<ul class="sectlevel3">
<li><a href="#overconstrainedPlanningWithNullableVariables">15.3.1. Overconstrained Planning with Nullable Variables</a></li>
<li><a href="#overconstrainedPlanningWithVirutalValues">15.3.2. Overconstrained Planning with Virtual Values</a></li>
</ul>
</li>
<li><a href="#continuousPlanning">15.4. Continuous Planning (Windowed Planning)</a>
<ul class="sectlevel3">
<li><a href="#immovablePlanningEntities">15.4.1. Immovable Planning Entities</a></li>
<li><a href="#nonvolatileReplanning">15.4.2. Nonvolatile Replanning to minimize disruption (Semi-movable Planning Entities)</a></li>
</ul>
</li>
<li><a href="#realTimePlanning">15.5. Real-time Planning</a>
<ul class="sectlevel3">
<li><a href="#problemFactChange">15.5.1. <code>ProblemFactChange</code></a></li>
<li><a href="#daemon">15.5.2. Daemon: <code>solve()</code> Does Not Return</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#integration">16. Integration</a>
<ul class="sectlevel2">
<li><a href="#integrationOverview">16.1. Overview</a></li>
<li><a href="#integrationWithPersistentStorage">16.2. Persistent Storage</a>
<ul class="sectlevel3">
<li><a href="#integrationWithJpaAndHibernate">16.2.1. Database: JPA and Hibernate</a></li>
<li><a href="#integrationWithXStream">16.2.2. XML or JSON: XStream</a></li>
<li><a href="#integrationWithJaxb">16.2.3. XML or JSON: JAXB</a></li>
<li><a href="#integrationWithJackson">16.2.4. JSON: Jackson</a></li>
</ul>
</li>
<li><a href="#integrationWithSoaAndEsb">16.3. SOA and ESB</a>
<ul class="sectlevel3">
<li><a href="#integrationWithCamel">16.3.1. Camel and Karaf</a></li>
</ul>
</li>
<li><a href="#integrationWithOtherEnvironments">16.4. Other Environments</a>
<ul class="sectlevel3">
<li><a href="#integrationWithJBossModules">16.4.1. JBoss Modules, WildFly and JBoss EAP</a></li>
<li><a href="#integrationWithOSGi">16.4.2. OSGi</a></li>
<li><a href="#integrationWithAndroid">16.4.3. Android</a></li>
</ul>
</li>
<li><a href="#integrationWithHumanPlanners">16.5. Integration with Human Planners (Politics)</a></li>
<li><a href="#sizingHardwareAndSoftware">16.6. Sizing Hardware and Software</a></li>
</ul>
</li>
<li><a href="#designPatterns">17. Design Patterns</a>
<ul class="sectlevel2">
<li><a href="#designPatternsIntroduction">17.1. Design Patterns Introduction</a>
<ul class="sectlevel3">
<li><a href="#domainModelingGuide">17.1.1. Domain Modeling Guide</a></li>
</ul>
</li>
<li><a href="#assigningTimeToPlanningEntities">17.2. Assigning Time to Planning Entities</a>
<ul class="sectlevel3">
<li><a href="#timeslotPattern">17.2.1. Timeslot Pattern: Assign to a Fixed-Length Timeslot</a></li>
<li><a href="#timeGrainPattern">17.2.2. TimeGrain Pattern: Assign to a Starting TimeGrain</a></li>
<li><a href="#chainedThroughTimePattern">17.2.3. Chained Through Time Pattern: Assign in a Chain that Determines Starting Time</a></li>
</ul>
</li>
<li><a href="#multiStragePlanning">17.3. Multi-stage planning</a></li>
</ul>
</li>
<li><a href="#development">18. Development</a>
<ul class="sectlevel2">
<li><a href="#methodologyOverview">18.1. Methodology Overview</a></li>
<li><a href="#developmentGuidelines">18.2. Development guidelines</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./shared/optaPlannerLogo.png" alt="optaPlannerLogo">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="plannerIntroduction"><a class="anchor" href="#plannerIntroduction"></a><a class="link" href="#plannerIntroduction">1. OptaPlanner Introduction</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="whatIsOptaPlanner"><a class="anchor" href="#whatIsOptaPlanner"></a><a class="link" href="#whatIsOptaPlanner">1.1. What is OptaPlanner?</a></h3>
<div class="paragraph">
<p>Every organization faces planning problems: providing products or services with a limited set of <em>constrained</em> resources (employees, assets, time and money). OptaPlanner optimizes such planning to do more business with less resources.
This is known as <em>Constraint Satisfaction Programming</em> (which is part of the <em>Operations Research</em> discipline).</p>
</div>
<div class="paragraph">
<p><a href="https://www.optaplanner.org">OptaPlanner</a> is a lightweight, embeddable constraint satisfaction engine which optimizes planning problems. It solves use cases such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Employee shift rostering</strong>: timetabling nurses, repairmen, &#8230;&#8203;</p>
</li>
<li>
<p><strong>Agenda scheduling</strong>: scheduling meetings, appointments, maintenance jobs, advertisements, &#8230;&#8203;</p>
</li>
<li>
<p><strong>Educational timetabling</strong>: scheduling lessons, courses, exams, conference presentations, &#8230;&#8203;</p>
</li>
<li>
<p><strong>Vehicle routing</strong>: planning vehicle routes (trucks, trains, boats, airplanes, &#8230;&#8203;) for moving freight and/or passengers through multiple destinations using known mapping tools &#8230;&#8203;</p>
</li>
<li>
<p><strong>Bin packing</strong>: filling containers, trucks, ships, and storage warehouses with items, but also packing information across computer resources, as in cloud computing &#8230;&#8203;</p>
</li>
<li>
<p><strong>Job shop scheduling</strong>: planning car assembly lines, machine queue planning, workforce task planning, &#8230;&#8203;</p>
</li>
<li>
<p><strong>Cutting stock</strong>: minimizing waste while cutting paper, steel, carpet, &#8230;&#8203;</p>
</li>
<li>
<p><strong>Sport scheduling</strong>: planning games and training schedules for football leagues, baseball leagues, &#8230;&#8203;</p>
</li>
<li>
<p><strong>Financial optimization</strong>: investment portfolio optimization, risk spreading, &#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./PlannerIntroduction/WhatIsOptaPlanner/useCaseOverview.png" alt="useCaseOverview">
</div>
</div>
</div>
<div class="sect2">
<h3 id="whatIsAPlanningProblem"><a class="anchor" href="#whatIsAPlanningProblem"></a><a class="link" href="#whatIsAPlanningProblem">1.2. What is a Planning Problem?</a></h3>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./PlannerIntroduction/WhatIsAPlanningProblem/whatIsAPlanningProblem.png" alt="whatIsAPlanningProblem">
</div>
</div>
<div class="paragraph">
<p>A planning problem has an optimal goal, based on limited resources and under specific constraints. Optimal goals can be any number of things, such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Maximized profits - the optimal goal results in the highest possible profit.</p>
</li>
<li>
<p>Minimized ecological footprint - the optimal goal has the least amount of environmental impact.</p>
</li>
<li>
<p>Maximized satisfaction for employees or customers - the optimal goal prioritizes the needs of employees or customers.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The ability to achieve these goals relies on the number of resources available, such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The number of people.</p>
</li>
<li>
<p>Amount of time.</p>
</li>
<li>
<p>Budget.</p>
</li>
<li>
<p>Physical assets, for example, machinery, vehicles, computers, buildings, etc.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Specific constraints related to these resources must also be taken into account, such as the number of hours a person works, their ability to use certain machines, or compatibility between pieces of equipment.</p>
</div>
<div class="paragraph">
<p>OptaPlanner helps Java<sup>TM</sup> programmers solve constraint satisfaction problems efficiently. Under the hood, it combines optimization heuristics and metaheuristics with very efficient score calculation.</p>
</div>
<div class="sect3">
<h4 id="aPlanningProblemIsNPCompleteOrNPHard"><a class="anchor" href="#aPlanningProblemIsNPCompleteOrNPHard"></a><a class="link" href="#aPlanningProblemIsNPCompleteOrNPHard">1.2.1. A Planning Problem is NP-complete or NP-hard</a></h4>
<div class="paragraph">
<p>All the use cases above are <em>probably</em> <a href="http://en.wikipedia.org/wiki/NP-complete">NP-complete</a> or harder.
In layman&#8217;s terms, NP-complete means:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It&#8217;s easy to verify a given solution to a problem in reasonable time.</p>
</li>
<li>
<p>There is no silver bullet to find the optimal solution of a problem in reasonable time (*).</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>(*) At least, none of the smartest computer scientists in the world have found such a silver bullet yet.
But if they find one for 1 NP-complete problem, it will work for every NP-complete problem.</p>
</div>
<div class="paragraph">
<p>In fact, there&#8217;s a $ 1,000,000 reward for anyone that proves if <a href="http://en.wikipedia.org/wiki/P_%3D_NP_problem">such a silver bullet actually exists or not</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The implication of this is pretty dire: solving your problem is probably harder than you anticipated, because the two common techniques won&#8217;t suffice:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A Brute Force algorithm (even a smarter variant) will take too long.</p>
</li>
<li>
<p>A quick algorithm, for example in bin packing, <em>putting in the largest items first</em>, will return a solution that is far from optimal.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By using advanced optimization algorithms, <strong>OptaPlanner does find a good solution in reasonable time for such planning problems.</strong></p>
</div>
</div>
<div class="sect3">
<h4 id="aPlanningProblemHasConstraints"><a class="anchor" href="#aPlanningProblemHasConstraints"></a><a class="link" href="#aPlanningProblemHasConstraints">1.2.2. A Planning Problem Has (Hard and Soft) Constraints</a></h4>
<div class="paragraph">
<p>Usually, a planning problem has at least two levels of constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <em>(negative) hard constraint</em> must not be broken. For example: <em>1 teacher can not teach 2 different lessons at the same time</em>.</p>
</li>
<li>
<p>A <em>(negative) soft constraint</em> should not be broken if it can be avoided. For example: <em>Teacher A does not like to teach on Friday afternoon</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Some problems have positive constraints too:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <em>positive soft constraint (or reward)</em> should be fulfilled if possible. For example: <em>Teacher B likes to teach on Monday morning</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Some basic problems (such as <a href="#nQueens">N queens</a>) only have hard constraints.
Some problems have three or more levels of constraints, for example hard, medium and soft constraints.</p>
</div>
<div class="paragraph">
<p>These constraints define the <em>score calculation</em> (AKA <em>fitness function</em>) of a planning problem.
Each solution of a planning problem can be graded with a score. <strong>With OptaPlanner, score constraints are written in an Object Oriented language, such as Java<sup>TM</sup> code or Drools rules</strong>.
Such code is easy, flexible and scalable.</p>
</div>
</div>
<div class="sect3">
<h4 id="aPlanningProblemHasAHugeSearchSpace"><a class="anchor" href="#aPlanningProblemHasAHugeSearchSpace"></a><a class="link" href="#aPlanningProblemHasAHugeSearchSpace">1.2.3. A Planning Problem Has a Huge Search Space</a></h4>
<div class="paragraph">
<p>A planning problem has a number of <em>solutions</em>.
There are several categories of solutions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <em>possible solution</em> is any solution, whether or not it breaks any number of constraints. Planning problems tend to have an incredibly large number of possible solutions. Many of those solutions are worthless.</p>
</li>
<li>
<p>A <em>feasible solution</em> is a solution that does not break any (negative) hard constraints. The number of feasible solutions tends to be relative to the number of possible solutions. Sometimes there are no feasible solutions. Every feasible solution is a possible solution.</p>
</li>
<li>
<p>An <em>optimal solution</em> is a solution with the highest score. Planning problems tend to have 1 or a few optimal solutions. There is always at least 1 optimal solution, even in the case that there are no feasible solutions and the optimal solution isn&#8217;t feasible.</p>
</li>
<li>
<p>The <em>best solution found</em> is the solution with the highest score found by an implementation in a given amount of time. The best solution found is likely to be feasible and, given enough time, it&#8217;s an optimal solution.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Counterintuitively, the number of possible solutions is huge (if calculated correctly), even with a small dataset.
As you can see in the examples, most instances have a lot more possible solutions than the minimal number of atoms in the known universe (10^80). Because there is no silver bullet to find the optimal solution, any implementation is forced to evaluate at least a subset of all those possible solutions.</p>
</div>
<div class="paragraph">
<p>OptaPlanner supports several optimization algorithms to efficiently wade through that incredibly large number of possible solutions.
Depending on the use case, some optimization algorithms perform better than others, but it&#8217;s impossible to tell in advance. <strong>With OptaPlanner, it is easy to switch the optimization algorithm</strong>, by changing the solver configuration in a few lines of XML or code.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="requirements"><a class="anchor" href="#requirements"></a><a class="link" href="#requirements">1.3. Requirements</a></h3>
<div class="paragraph">
<p>OptaPlanner is <em>open source</em> software, released under <a href="http://www.apache.org/licenses/LICENSE-2.0.html">the Apache Software License 2.0</a>.
This license is very liberal and allows reuse for commercial purposes.
Read <a href="http://www.apache.org/foundation/licence-FAQ.html#WhatDoesItMEAN">the layman&#8217;s explanation</a>.</p>
</div>
<div class="paragraph">
<p>OptaPlanner is 100% pure Java<sup>TM</sup> and runs on any JVM 8 or higher.
It <a href="#integration">integrates very easily</a> with other Java<sup>TM</sup> technologies.
OptaPlanner is available in <a href="#useWithMavenGradleEtc">the Maven Central Repository</a>.</p>
</div>
<div class="paragraph">
<p>Planner works on any Java Virtual Machine and is compatible with Standard Java, Enterprise Java, and all JVM languages.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./PlannerIntroduction/Requirements/compatibility.png" alt="compatibility">
</div>
</div>
</div>
<div class="sect2">
<h3 id="governance"><a class="anchor" href="#governance"></a><a class="link" href="#governance">1.4. Governance</a></h3>
<div class="sect3">
<h4 id="statusOfOptaPlanner"><a class="anchor" href="#statusOfOptaPlanner"></a><a class="link" href="#statusOfOptaPlanner">1.4.1. Status of OptaPlanner</a></h4>
<div class="paragraph">
<p>OptaPlanner is stable, reliable and scaleable. It has been heavily tested with unit, integration, and stress tests, and is used in production throughout the world. One example handles over 50 000 variables with 5000 variables each, multiple constraint types and billions of possible constraint matches.</p>
</div>
</div>
<div class="sect3">
<h4 id="releaseNotes"><a class="anchor" href="#releaseNotes"></a><a class="link" href="#releaseNotes">1.4.2. Release Notes</a></h4>
<div class="paragraph">
<p>We release a <code>Beta</code> or <code>CR</code> version every few weeks and a <code>Final</code> version every few months. <a href="https://www.optaplanner.org/download/releaseNotes/">Read the release notes of each release on our website.</a></p>
</div>
</div>
<div class="sect3">
<h4 id="backwardsCompatibility"><a class="anchor" href="#backwardsCompatibility"></a><a class="link" href="#backwardsCompatibility">1.4.3. Backwards Compatibility</a></h4>
<div class="paragraph">
<p>OptaPlanner separates its API and implementation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Public API</strong>: All classes in the package namespace <strong>org.optaplanner.core.api</strong> are 100% <strong>backwards compatible</strong> in future releases (especially minor and hotfix releases). In rare circumstances, if the major version number changes, a few specific classes might have a few backwards incompatible changes, but those will be clearly documented in <a href="https://www.optaplanner.org/download/upgradeRecipe/">the upgrade recipe</a>.</p>
</li>
<li>
<p><strong>XML configuration</strong>: The XML solver configuration is backwards compatible for all elements, except for elements that require the use of non public API classes. The XML solver configuration is defined by the classes in the package namespace <strong>org.optaplanner.core.config</strong>.</p>
</li>
<li>
<p><strong>Implementation classes</strong>: All classes in the package namespace <strong>org.optaplanner.core.impl</strong> are <em>not</em> backwards compatible: they will change in future major or minor releases (but probably not in hotfix releases). <a href="https://www.optaplanner.org/download/upgradeRecipe/">The upgrade recipe</a> describes every such relevant change and on how to quickly deal with it when upgrading to a newer version.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This documentation covers some <code>impl</code> classes too.
Those documented <code>impl</code> classes are reliable and safe to use (unless explicitly marked as experimental in this documentation), but we&#8217;re just not entirely comfortable yet to write their signatures in stone.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="communityAndSupport"><a class="anchor" href="#communityAndSupport"></a><a class="link" href="#communityAndSupport">1.4.4. Community and Support</a></h4>
<div class="paragraph">
<p>For news and articles, check <a href="https://www.optaplanner.org/blog/">our blog</a>, Google+ (<a href="https://plus.google.com/+OptaPlannerOrg">OptaPlanner</a>, <a href="https://plus.google.com/+GeoffreyDeSmet">Geoffrey De Smet</a>) and twitter (<a href="https://twitter.com/OptaPlanner">OptaPlanner</a>, <a href="https://twitter.com/GeoffreyDeSmet">Geoffrey De Smet</a>).
<strong>If OptaPlanner helps you, help us by blogging or tweeting about it!</strong></p>
</div>
<div class="paragraph">
<p>Public questions are welcome on <a href="https://www.optaplanner.org/community/forum.html">our community forum</a>.
Bugs and feature requests are welcome in <a href="https://issues.jboss.org/browse/PLANNER">our issue tracker</a>.
Pull requests are very welcome on GitHub and get priority treatment! By open sourcing your improvements, you 'll benefit from our peer review and from our improvements made on top of your improvements.</p>
</div>
<div class="paragraph">
<p>Red Hat sponsors OptaPlanner development by employing the core team.
For enterprise support and consulting, take a look at <a href="https://www.optaplanner.org/community/product.html">the BRMS and BPM Suite products</a> (which contain OptaPlanner) or <a href="https://www.redhat.com/en/about/contact/sales">contact Red Hat</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="relationshipWithKie"><a class="anchor" href="#relationshipWithKie"></a><a class="link" href="#relationshipWithKie">1.4.5. Relationship with Drools and jBPM</a></h4>
<div class="paragraph">
<p>OptaPlanner is part of the <a href="http://www.kiegroup.org">KIE group of projects</a>.
It releases regularly (often once or twice per month) together with the <a href="http://www.drools.org/">Drools</a> rule engine and the <a href="http://www.jbpm.org/">jBPM</a> workflow engine.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./PlannerIntroduction/Governance/kieFunctionalityOverview.png" alt="kieFunctionalityOverview">
</div>
</div>
<div class="paragraph">
<p>See <a href="#architectureOverview">the architecture overview</a> to learn more about the optional integration with Drools.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="downloadAndRunTheExamples"><a class="anchor" href="#downloadAndRunTheExamples"></a><a class="link" href="#downloadAndRunTheExamples">1.5. Download and Run the Examples</a></h3>
<div class="sect3">
<h4 id="getTheReleaseZipAndRunTheExamples"><a class="anchor" href="#getTheReleaseZipAndRunTheExamples"></a><a class="link" href="#getTheReleaseZipAndRunTheExamples">1.5.1. Get the Release .zip and Run the Examples</a></h4>
<div class="paragraph">
<p>To try it now:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Download a release zip of OptaPlanner from <a href="https://www.optaplanner.org">the OptaPlanner website</a> and unzip it.</p>
</li>
<li>
<p>Open the directory <em class="path">examples</em> and run the script.</p>
<div class="paragraph">
<p>Linux or Mac:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-sh" data-lang="sh">$ cd examples
$ ./runExamples.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Windows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-sh" data-lang="sh">$ cd examples
$ runExamples.bat</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./PlannerIntroduction/DownloadAndRunTheExamples/distributionZip.png" alt="distributionZip">
</div>
</div>
<div class="paragraph">
<p>The Examples GUI application will open.
Pick an example to try it out:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./PlannerIntroduction/DownloadAndRunTheExamples/plannerExamplesAppScreenshot.png" alt="plannerExamplesAppScreenshot">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>OptaPlanner itself has no GUI dependencies.
It runs just as well on a server or a mobile JVM as it does on the desktop.</p>
</div>
</td>
</tr>
</table>
</div>
<h3 id="_run_the_webexamples" class="discrete">Run the Webexamples</h3>
<div class="paragraph">
<p>Besides the GUI examples, there are also a set of webexamples to try out. The webexamples include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Vehicle routing: calculating the shortest possible route to pick up all items required for a number of different customers using either <a href="http://leafletjs.com/">Leaflet</a> or <a href="http://google.com/maps">Google Maps</a> visualizations.</p>
</li>
<li>
<p>Cloud balancing: Assigning processes across computers with different specifications and costs.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Prerequisites</strong></p>
</div>
<div class="paragraph">
<p>The webexamples require several JEE APIs to run, such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Servlet</p>
</li>
<li>
<p>JAX-RS</p>
</li>
<li>
<p>CDI</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These are not required for Planner itself.</p>
</div>
<div class="paragraph">
<p><strong>Running the Webexamples on a JEE Application Server </strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Download a JEE application server, such as JBoss EAP or <a href="http://www.wildfly.org/">WildFly</a> and unzip it.</p>
</li>
<li>
<p>Download a release zip of OptaPlanner from <a href="https://www.optaplanner.org">the OptaPlanner website</a> and unzip it.</p>
</li>
<li>
<p>Open the directory <em class="path">webexamples</em> and deploy the <code>optaplanner-webexamples-*.war</code> file on the JEE application server.</p>
<div class="paragraph">
<p>If using JBoss EAP in standalone mode, this can be done by adding the <code>optaplanner-webexamples-<strong>.war</code> file to the <code>jboss-eap-</strong>/standalone/deployments</code> folder.</p>
</div>
</li>
<li>
<p>Open the following address in a web browser:  http://localhost:8080/optaplanner-webexamples-*/ (replace the * with the actual version).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Deploying Webexamples on a Servlet Container</strong></p>
</div>
<div class="paragraph">
<p>To successfully deploy the webexamples on a servlet container (such as Jetty or Tomcat) instead of on a real JEE application server (such as WildFly):</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add the missing implementation libraries (for example RestEasy and Weld) in the <code>optaplanner-webexamples-*.war</code> manually.</p>
</li>
<li>
<p>Deploy the <code>optaplanner-webexamples-*.war</code> on the servlet container.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Pick an example to try it out, such as the Vehicle Routing example:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./PlannerIntroduction/DownloadAndRunTheExamples/plannerWebexamplesScreenshot.png" alt="plannerWebexamplesScreenshot">
</div>
</div>
</div>
<div class="sect3">
<h4 id="runTheExamplesInAnIDE"><a class="anchor" href="#runTheExamplesInAnIDE"></a><a class="link" href="#runTheExamplesInAnIDE">1.5.2. Run the Examples in an IDE (IntelliJ, Eclipse, NetBeans)</a></h4>
<div class="paragraph">
<p>To run the examples in your favorite IDE:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In IntelliJ IDEA, NetBeans or a non-vanilla Eclipse:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open the file <em class="path">examples/sources/pom.xml</em> as a new project, the maven integration will take care of the rest.</p>
</li>
<li>
<p>Run the examples from the project.</p>
</li>
</ol>
</div>
</li>
<li>
<p>In a vanilla Eclipse (which lacks the M2Eclipse plugin):</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open a new project for the directory <em class="path">examples/sources</em> .</p>
</li>
<li>
<p>Add all the jars to the classpath from the directory <em class="path">binaries</em> and the directory <em class="path">examples/binaries</em> , except for the file <em class="path">examples/binaries/optaplanner-examples-*.jar</em> .</p>
</li>
<li>
<p>Add the Java source directory <em class="path">src/main/java</em> and the Java resources directory <em class="path">src/main/resources</em> .</p>
</li>
<li>
<p>Create a run configuration:</p>
<div class="ulist">
<ul>
<li>
<p>Main class: <code>org.optaplanner.examples.app.OptaPlannerExamplesApp</code></p>
</li>
<li>
<p>VM parameters (optional): <code>-Xmx512M -server</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>To run a specific example directly and skip the example selection window, run its <code>App</code> class (for example <code>CloudBalancingApp</code>) instead of <code>OptaPlannerExamplesApp</code>.</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Run that run configuration.</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="useWithMavenGradleEtc"><a class="anchor" href="#useWithMavenGradleEtc"></a><a class="link" href="#useWithMavenGradleEtc">1.5.3. Use OptaPlanner with Maven, Gradle, Ivy, Buildr or ANT</a></h4>
<div class="paragraph">
<p>The OptaPlanner jars are also available in <a href="http://search.maven.org/#search|ga|1|org.optaplanner">the central maven repository</a> (and also in
<a href="https://repository.jboss.org/nexus/index.html#nexus-search;gav~org.optaplanner~~~~">the JBoss maven repository</a>).</p>
</div>
<div class="paragraph">
<p>If you use Maven, add a dependency to <code>optaplanner-core</code> in your project&#8217;s <em class="path">pom.xml</em>
:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;dependency&gt;
      &lt;groupId&gt;org.optaplanner&lt;/groupId&gt;
      &lt;artifactId&gt;optaplanner-core&lt;/artifactId&gt;
    &lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is similar for Gradle, Ivy and Buildr.
To identify the latest version, check <a href="http://search.maven.org/#search|ga|1|org.optaplanner">the central maven repository</a>.</p>
</div>
<div class="paragraph">
<p>Because you might end up using other OptaPlanner modules too, it&#8217;s recommended to import the <code>optaplanner-bom</code> in Maven&#8217;s <code>dependencyManagement</code> so the OptaPlanner version is specified only once:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;dependencyManagement&gt;
    &lt;dependencies&gt;
      &lt;dependency&gt;
        &lt;groupId&gt;org.optaplanner&lt;/groupId&gt;
        &lt;artifactId&gt;optaplanner-bom&lt;/artifactId&gt;
        &lt;type&gt;pom&lt;/type&gt;
        &lt;version&gt;...&lt;/version&gt;
        &lt;scope&gt;import&lt;/scope&gt;
      &lt;/dependency&gt;
      ...
    &lt;/dependencies&gt;
  &lt;/dependencyManagement&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you&#8217;re still using ANT (without Ivy), copy all the jars from the download zip&#8217;s <em class="path">binaries</em>
 directory in your classpath.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The download zip&#8217;s <em class="path">binaries</em>
 directory contains far more jars then <code>optaplanner-core</code> actually uses.
It also contains the jars used by other modules, such as <code>optaplanner-benchmark</code>.</p>
</div>
<div class="paragraph">
<p>Check the maven repository <em class="path">pom.xml</em>
 files to determine the minimal dependency set of a specific module (for a specific version).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="buildFromSource"><a class="anchor" href="#buildFromSource"></a><a class="link" href="#buildFromSource">1.5.4. Build OptaPlanner from Source</a></h4>
<div class="paragraph">
<p>It&#8217;s easy to build OptaPlanner from source.</p>
</div>
<div class="paragraph">
<p><strong>Prerequisites</strong></p>
</div>
<div class="paragraph">
<p><a href="https://help.github.com/articles/set-up-git/">Set up Git</a>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Clone <code>optaplanner</code> from GitHub (or alternatively, download <a href="https://github.com/kiegroup/optaplanner/zipball/master">the zipball</a>):</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-sh" data-lang="sh">$ git clone git@github.com:kiegroup/optaplanner.git optaplanner
...</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you don&#8217;t have a GitHub account or your local Git installation isn&#8217;t configured with it, use this command instead, to avoid an authentication issue:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-sh" data-lang="sh">$ git clone https://github.com/kiegroup/optaplanner.git optaplanner
...</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Build it with <a href="http://maven.apache.org/">Maven</a>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-sh" data-lang="sh">$ cd optaplanner
$ mvn clean install -DskipTests
...</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The first time, Maven might take a long time, because it needs to download jars.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Run the examples:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-sh" data-lang="sh">$ cd optaplanner-examples
$ mvn exec:java
...</code></pre>
</div>
</div>
</li>
<li>
<p>Edit the sources in your favorite IDE.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><em>Optional</em>: use a Java profiler.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="quickStart"><a class="anchor" href="#quickStart"></a><a class="link" href="#quickStart">2. Getting Started: A Cloud Balancing Demonstration</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="cloudBalancingTutorial"><a class="anchor" href="#cloudBalancingTutorial"></a><a class="link" href="#cloudBalancingTutorial">2.1. Cloud Balancing Tutorial</a></h3>
<div class="sect3">
<h4 id="cloudBalancingProblemDescription"><a class="anchor" href="#cloudBalancingProblemDescription"></a><a class="link" href="#cloudBalancingProblemDescription">2.1.1. Problem Description</a></h4>
<div class="paragraph">
<p>Suppose your company owns a number of cloud computers and needs to run a number of processes on those computers.
Assign each process to a computer.</p>
</div>
<div class="paragraph">
<p>The following hard constraints must be fulfilled:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Every computer must be able to handle the minimum hardware requirements of the sum of its processes:</p>
<div class="ulist">
<ul>
<li>
<p><strong>CPU capacity</strong>: The CPU power of a computer must be at least the sum of the CPU power required by the processes assigned to that computer.</p>
</li>
<li>
<p><strong>Memory capacity</strong>: The RAM memory of a computer must be at least the sum of the RAM memory required by the processes assigned to that computer.</p>
</li>
<li>
<p><strong>Network capacity</strong>: The network bandwidth of a computer must be at least the sum of the network bandwidth required by the processes assigned to that computer.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following soft constraints should be optimized:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each computer that has one or more processes assigned, incurs a maintenance cost (which is fixed per computer).</p>
<div class="ulist">
<ul>
<li>
<p><strong>Cost</strong>: Minimize the total maintenance cost.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>This problem is a form of <em>bin packing</em>.
The following is a simplified example, in which we assign four processes to two computers with two constraints (CPU and RAM) with a simple algorithm:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./QuickStart/CloudBalancingTutorial/cloudBalanceUseCase.png" alt="cloudBalanceUseCase">
</div>
</div>
<div class="paragraph">
<p>The simple algorithm used here is the <em>First Fit Decreasing</em> algorithm, which assigns the bigger processes first and assigns the smaller processes to the remaining space.
As you can see, it is not optimal, as it does not leave enough room to assign the yellow process <code>D</code>.</p>
</div>
<div class="paragraph">
<p>Planner does find the more optimal solution by using additional, smarter algorithms.
It also scales: both in data (more processes, more computers) and constraints (more hardware requirements, other constraints).
So let&#8217;s see how Planner can be used in this scenario.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s an executive summary of this example and <a href="#machineReassignment">an advanced implementation with more constraints</a>:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./shared/cloudOptimizationValueProposition.png" alt="cloudOptimizationValueProposition">
</div>
</div>
</div>
<div class="sect3">
<h4 id="cloudBalancingProblemSize"><a class="anchor" href="#cloudBalancingProblemSize"></a><a class="link" href="#cloudBalancingProblemSize">2.1.2. Problem Size</a></h4>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Cloud Balancing Problem Size</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Problem Size</th>
<th class="tableblock halign-left valign-top">Computers</th>
<th class="tableblock halign-left valign-top">Processes</th>
<th class="tableblock halign-left valign-top">Search Space</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2computers-6processes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">64</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3computers-9processes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10^4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4computers-012processes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10^7</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">100computers-300processes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">300</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10^600</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">200computers-600processes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">600</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10^1380</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">400computers-1200processes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">400</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10^3122</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">800computers-2400processes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">800</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2400</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10^6967</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="cloudBalancingDomainModel"><a class="anchor" href="#cloudBalancingDomainModel"></a><a class="link" href="#cloudBalancingDomainModel">2.2. Using the Domain Model</a></h3>
<div class="sect3">
<h4 id="cloudBalancingDomainModelDesign"><a class="anchor" href="#cloudBalancingDomainModelDesign"></a><a class="link" href="#cloudBalancingDomainModelDesign">2.2.1. Domain Model Design</a></h4>
<div class="paragraph">
<p>Using a <a href="#domainModelingGuide">domain model</a> helps determine which classes are planning entities and which of their properties are planning variables. It also helps to simplify contraints, improve performance, and increase flexibility for future needs.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Draw a class diagram of your domain model.</p>
</li>
<li>
<p>Normalize it to remove duplicate data.</p>
</li>
<li>
<p>Write down some sample instances for each class.</p>
<div class="ulist">
<ul>
<li>
<p><code>Computer</code>: represents a computer with certain hardware and maintenance costs.</p>
<div class="paragraph">
<p>In this example, the sample instances for the <code>Computer</code> class are: <code>cpuPower</code>, <code>memory</code>, <code>networkBandwidth</code>, <code>cost</code>.</p>
</div>
</li>
<li>
<p><code>Process</code>: represents a process with a demand. Needs to be assigned to a <code>Computer</code> by Planner.</p>
<div class="paragraph">
<p>Sample instances for <code>Process</code> are: <code>requiredCpuPower</code>, <code>requiredMemory</code>, and <code>requiredNetworkBandwidth</code>.</p>
</div>
</li>
<li>
<p><code>CloudBalance</code>: represents a problem. Contains every <code>Computer</code> and <code>Process</code> for a certain data set.</p>
<div class="paragraph">
<p>The sample instance for <code>CloudBalance</code> is <code>score</code>.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Determine which relationships (or fields) change during planning.</p>
<div class="ulist">
<ul>
<li>
<p>Planning entity: the class (or classes) that changes during solving. In this example, it is the class <code>Process</code>.</p>
</li>
<li>
<p>Planning variable: the property (or properties) of a planning entity class that changes during solving. In this example, it is the property <code>computer</code> on the class <code>Process</code>.</p>
</li>
<li>
<p>Planning solution: the class that represents a data set and contains all planning entities. In this example that is the class <code>CloudBalance</code>.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>In the UML class diagram below, the Planner concepts are already annotated:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./QuickStart/CloudBalancingDomainModel/cloudBalanceClassDiagram.png" alt="cloudBalanceClassDiagram">
</div>
</div>
</div>
<div class="sect3">
<h4 id="cloudBalancingDomainModelImplementation"><a class="anchor" href="#cloudBalancingDomainModelImplementation"></a><a class="link" href="#cloudBalancingDomainModelImplementation">2.2.2. Domain Model Implementation</a></h4>
<div class="sect4">
<h5 id="cloudBalancingClassComputer"><a class="anchor" href="#cloudBalancingClassComputer"></a><a class="link" href="#cloudBalancingClassComputer">2.2.2.1. The <code>Computer</code> Class</a></h5>
<div class="paragraph">
<p>The <code>Computer</code> class is a POJO (Plain Old Java Object). Usually, you will have more of this kind of classes with input data.</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. CloudComputer.java</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class CloudComputer ... {

    private int cpuPower;
    private int memory;
    private int networkBandwidth;
    private int cost;

    ... // getters
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="cloudBalancingClassProcess"><a class="anchor" href="#cloudBalancingClassProcess"></a><a class="link" href="#cloudBalancingClassProcess">2.2.2.2. The <code>Process</code> Class</a></h5>
<div class="paragraph">
<p>The <code>Process</code> class is particularly important. It is the class that is modified during solving.</p>
</div>
<div class="paragraph">
<p>We need to tell Planner that it can change the property <code>computer</code>. To do this:
. Annotate the class with <code>@PlanningEntity</code>.
. Annotate the getter <code>getComputer()</code> with <code>@PlanningVariable</code>.</p>
</div>
<div class="paragraph">
<p>Of course, the property <code>computer</code> needs a setter too, so Planner can change it during solving.</p>
</div>
<div class="exampleblock">
<div class="title">Example 2. CloudProcess.java</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningEntity(...)
public class CloudProcess ... {

    private int requiredCpuPower;
    private int requiredMemory;
    private int requiredNetworkBandwidth;

    private CloudComputer computer;

    ... // getters

    @PlanningVariable(valueRangeProviderRefs = {"computerRange"})
    public CloudComputer getComputer() {
        return computer;
    }

    public void setComputer(CloudComputer computer) {
        computer = computer;
    }

    // ************************************************************************
    // Complex methods
    // ************************************************************************

    ...

}</code></pre>
</div>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Planner needs to know which values it can choose from to assign to the property <code>computer</code>. Those values are retrieved from the method <code>CloudBalance.getComputerList()</code> on the planning solution, which returns a list of all computers in the current data set.</p>
</li>
<li>
<p>The <code>@PlanningVariable</code>'s <code>valueRangeProviderRefs</code> parameter on <code>CloudProcess.getComputer()</code> needs to match with the <code>@ValueRangeProvider</code>'s <code>id</code> on CloudBalance.getComputerList().</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Instead of getter annotations, it is also possible to use <a href="#annotationAlternatives">field annotations</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="cloudBalancingClassCloudBalance"><a class="anchor" href="#cloudBalancingClassCloudBalance"></a><a class="link" href="#cloudBalancingClassCloudBalance">2.2.2.3. The <code>CloudBalance</code> Class</a></h5>
<div class="paragraph">
<p>The <code>CloudBalance</code> class has a <em class="path">@PlanningSolution</em>
 annotation.
* It holds a list of all computers and processes.
* It represents both the planning problem and (if it&#8217;s initialized) the planning solution.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Planner needs to retrieve the collection of processes that it can change, therefore we annotate the getter <code>getProcessList()</code> with <code>@PlanningEntityCollectionProperty</code>.</p>
</li>
<li>
<p>The <code>CloudBalance</code> class also has a <code>@PlanningScore</code> annotated property <code>score</code>, which is the <code>Score</code> of that solution in its current state.
Planner automatically updates it when it calculates a <code>Score</code> for a solution instance and therefore it needs a setter.</p>
</li>
<li>
<p>Especially for score calculation with Drools, the property <code>computerList</code> needs to be annotated with a <code>@ProblemFactCollectionProperty</code> so the computers are known to it.</p>
</li>
</ol>
</div>
<div class="exampleblock">
<div class="title">Example 3. CloudBalance.java</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningSolution
public class CloudBalance ... {

    private List&lt;CloudComputer&gt; computerList;

    private List&lt;CloudProcess&gt; processList;

    private HardSoftScore score;

    @ValueRangeProvider(id = "computerRange")
    @ProblemFactCollectionProperty
    public List&lt;CloudComputer&gt; getComputerList() {
        return computerList;
    }

    @PlanningEntityCollectionProperty
    public List&lt;CloudProcess&gt; getProcessList() {
        return processList;
    }

    @PlanningScore
    public HardSoftScore getScore() {
        return score;
    }

    public void setScore(HardSoftScore score) {
        this.score = score;
    }

    ...
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cloudBalancingMainMethod"><a class="anchor" href="#cloudBalancingMainMethod"></a><a class="link" href="#cloudBalancingMainMethod">2.3. Run the Cloud Balancing Hello World</a></h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#runTheExamplesInAnIDE">Download and configure the examples in your preferred IDE.</a></p>
</li>
<li>
<p>Create a run configuration with the following main class: <code>org.optaplanner.examples.cloudbalancing.app.CloudBalancingHelloWorld</code></p>
<div class="paragraph">
<p>By default, the Cloud Balancing Hello World is configured to run for 120 seconds.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>It will execute the following code:</p>
</div>
<div class="exampleblock">
<div class="title">Example 4. CloudBalancingHelloWorld.java</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class CloudBalancingHelloWorld {

    public static void main(String[] args) {
        // Build the Solver
        SolverFactory&lt;CloudBalance&gt; solverFactory = SolverFactory.createFromXmlResource(
                "org/optaplanner/examples/cloudbalancing/solver/cloudBalancingSolverConfig.xml");
        Solver&lt;CloudBalance&gt; solver = solverFactory.buildSolver();

        // Load a problem with 400 computers and 1200 processes
        CloudBalance unsolvedCloudBalance = new CloudBalancingGenerator().createCloudBalance(400, 1200);

        // Solve the problem
        CloudBalance solvedCloudBalance = solver.solve(unsolvedCloudBalance);

        // Display the result
        System.out.println("\nSolved cloudBalance with 400 computers and 1200 processes:\n"
                + toDisplayString(solvedCloudBalance));
    }

    ...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The code example does the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Build the <code>Solver</code> based on a solver configuration (in this case <a href="#solverConfigurationByXML">an XML file</a>, <code>cloudBalancingSolverConfig.xml</code>, from the classpath).</p>
<div class="paragraph">
<p>Building the <code>Solver</code> is the most complicated part of this procedure. For more detail, see <a href="#cloudBalancingSolverConfiguration">Solver Configuration</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">        SolverFactory&lt;CloudBalance&gt; solverFactory = SolverFactory.createFromXmlResource(
                "org/optaplanner/examples/cloudbalancing/solver/cloudBalancingSolverConfig.xml");
        Solver solver&lt;CloudBalance&gt; = solverFactory.buildSolver();</code></pre>
</div>
</div>
</li>
<li>
<p>Load the problem.</p>
<div class="paragraph">
<p><code>CloudBalancingGenerator</code> generates a random problem: you will replace this with a class that loads a real problem, for example from a database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">        CloudBalance unsolvedCloudBalance = new CloudBalancingGenerator().createCloudBalance(400, 1200);</code></pre>
</div>
</div>
</li>
<li>
<p>Solve the problem.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">        CloudBalance solvedCloudBalance = solver.solve(unsolvedCloudBalance);</code></pre>
</div>
</div>
</li>
<li>
<p>Display the result.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">        System.out.println("\nSolved cloudBalance with 400 computers and 1200 processes:\n"
                + toDisplayString(solvedCloudBalance));</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="cloudBalancingSolverConfiguration"><a class="anchor" href="#cloudBalancingSolverConfiguration"></a><a class="link" href="#cloudBalancingSolverConfiguration">2.4. Solver Configuration</a></h3>
<div class="paragraph">
<p>Take a look at the solver configuration:</p>
</div>
<div class="exampleblock">
<div class="title">Example 5. cloudBalancingSolverConfig.xml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;solver&gt;
  &lt;!-- Domain model configuration --&gt;
  &lt;scanAnnotatedClasses/&gt;

  &lt;!-- Score configuration --&gt;
  &lt;scoreDirectorFactory&gt;
    &lt;easyScoreCalculatorClass&gt;org.optaplanner.examples.cloudbalancing.optional.score.CloudBalancingEasyScoreCalculator&lt;/easyScoreCalculatorClass&gt;
    &lt;!--&lt;scoreDrl&gt;org/optaplanner/examples/cloudbalancing/solver/cloudBalancingScoreRules.drl&lt;/scoreDrl&gt;--&gt;
  &lt;/scoreDirectorFactory&gt;

  &lt;!-- Optimization algorithms configuration --&gt;
  &lt;termination&gt;
    &lt;secondsSpentLimit&gt;30&lt;/secondsSpentLimit&gt;
  &lt;/termination&gt;
&lt;/solver&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This solver configuration consists of three parts:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Domain model configuration</strong>: <em>What can Planner change?</em></p>
<div class="paragraph">
<p>We need to make Planner aware of our domain classes. In this configuration, it will automatically scan all classes in your classpath (for a <code>@PlanningEntity</code> or <code>@PlanningSolution</code> annotation):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;scanAnnotatedClasses/&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><strong>Score configuration</strong>: <em>How should Planner optimize the planning variables? What is our goal?</em></p>
<div class="paragraph">
<p>Since we have hard and soft constraints, we use a <code>HardSoftScore</code>. But we need to tell Planner how to calculate the score, depending on our business requirements. Further down, we will look into two alternatives to calculate the score: using an easy Java implementation, or using Drools DRL.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;scoreDirectorFactory&gt;
    &lt;easyScoreCalculatorClass&gt;org.optaplanner.examples.cloudbalancing.optional.score.CloudBalancingEasyScoreCalculator&lt;/easyScoreCalculatorClass&gt;
    &lt;!--&lt;scoreDrl&gt;org/optaplanner/examples/cloudbalancing/solver/cloudBalancingScoreRules.drl&lt;/scoreDrl&gt;--&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><strong>Optimization algorithms configuration</strong>: <em>How should Planner optimize it?</em></p>
<div class="paragraph">
<p>In this case, we use the default <a href="#optimizationAlgorithms">optimization algorithms</a> (because no explicit optimization algorithms are configured) for 30 seconds:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;termination&gt;
    &lt;secondsSpentLimit&gt;30&lt;/secondsSpentLimit&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Planner should get a good result in seconds (and even in less than 15 milliseconds with <a href="#realTimePlanning">real-time planning</a>), but the more time it has, the better the result will be. Advanced use cases might use a different <a href="#termination">termination criteria</a> than a hard time limit.</p>
</div>
<div class="paragraph">
<p>The default algorithms will already easily surpass human planners and most in-house implementations.
Use the <a href="#benchmarker">Benchmarker</a> to <a href="#powerTweaking">power tweak</a> to get even better results.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="cloudBalancingScoreConfiguration"><a class="anchor" href="#cloudBalancingScoreConfiguration"></a><a class="link" href="#cloudBalancingScoreConfiguration">2.5. Score Configuration</a></h3>
<div class="paragraph">
<p>Planner will search for the <code>Solution</code> with the highest <code>Score</code>.
This example uses a <code>HardSoftScore</code>, which means Planner will look for the solution with no hard constraints broken (fulfill hardware requirements) and as little as possible soft constraints broken (minimize maintenance cost).</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./QuickStart/CloudBalancingScoreConfiguration/cloudBalanceScoreCalculation.png" alt="cloudBalanceScoreCalculation">
</div>
</div>
<div class="paragraph">
<p>Of course, Planner needs to be told about these domain-specific score constraints.
There are several ways to implement such a score function:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#cloudBalancingEasyJavaScoreConfiguration">Easy Java</a></p>
</li>
<li>
<p>Incremental Java</p>
</li>
<li>
<p><a href="#cloudBalancingDroolsScoreConfiguration">Drools</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="cloudBalancingEasyJavaScoreConfiguration"><a class="anchor" href="#cloudBalancingEasyJavaScoreConfiguration"></a><a class="link" href="#cloudBalancingEasyJavaScoreConfiguration">2.5.1. Easy Java Score Configuration</a></h4>
<div class="paragraph">
<p>One way to define a score function is to implement the interface <code>EasyScoreCalculator</code> in plain Java.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;scoreDirectorFactory&gt;
    &lt;easyScoreCalculatorClass&gt;org.optaplanner.examples.cloudbalancing.optional.score.CloudBalancingEasyScoreCalculator&lt;/easyScoreCalculatorClass&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Just implement the <code>calculateScore(Solution)</code> method to return a <code>HardSoftScore</code> instance.</p>
</div>
<div class="exampleblock">
<div class="title">Example 6. CloudBalancingEasyScoreCalculator.java</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class CloudBalancingEasyScoreCalculator implements EasyScoreCalculator&lt;CloudBalance&gt; {

    /**
     * A very simple implementation. The double loop can easily be removed by using Maps as shown in
     * {@link CloudBalancingMapBasedEasyScoreCalculator#calculateScore(CloudBalance)}.
     */
    public HardSoftScore calculateScore(CloudBalance cloudBalance) {
        int hardScore = 0;
        int softScore = 0;
        for (CloudComputer computer : cloudBalance.getComputerList()) {
            int cpuPowerUsage = 0;
            int memoryUsage = 0;
            int networkBandwidthUsage = 0;
            boolean used = false;

            // Calculate usage
            for (CloudProcess process : cloudBalance.getProcessList()) {
                if (computer.equals(process.getComputer())) {
                    cpuPowerUsage += process.getRequiredCpuPower();
                    memoryUsage += process.getRequiredMemory();
                    networkBandwidthUsage += process.getRequiredNetworkBandwidth();
                    used = true;
                }
            }

            // Hard constraints
            int cpuPowerAvailable = computer.getCpuPower() - cpuPowerUsage;
            if (cpuPowerAvailable &lt; 0) {
                hardScore += cpuPowerAvailable;
            }
            int memoryAvailable = computer.getMemory() - memoryUsage;
            if (memoryAvailable &lt; 0) {
                hardScore += memoryAvailable;
            }
            int networkBandwidthAvailable = computer.getNetworkBandwidth() - networkBandwidthUsage;
            if (networkBandwidthAvailable &lt; 0) {
                hardScore += networkBandwidthAvailable;
            }

            // Soft constraints
            if (used) {
                softScore -= computer.getCost();
            }
        }
        return HardSoftScore.valueOf(hardScore, softScore);
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Even if we optimize the code above to use <code>Map</code>s to iterate through the <code>processList</code> only once, <em>it is still slow</em> because it does not do <a href="#incrementalScoreCalculation">incremental score calculation</a>.
To fix that, either use incremental Java score calculation or Drools score calculation.</p>
</div>
</div>
<div class="sect3">
<h4 id="cloudBalancingDroolsScoreConfiguration"><a class="anchor" href="#cloudBalancingDroolsScoreConfiguration"></a><a class="link" href="#cloudBalancingDroolsScoreConfiguration">2.5.2. Drools Score Configuration</a></h4>
<div class="paragraph">
<p>Drools score calculation uses incremental calculation, where every score constraint is written as one or more score rules.</p>
</div>
<div class="paragraph">
<p>Using the Drools rule engine for score calculation, allows you to integrate with other Drools technologies, such as decision tables (XLS or web based), the KIE Workbench, &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p><strong>Prerequisite</strong>
To use the Drools rule engine as a score function, simply add a <code>scoreDrl</code> resource in the classpath:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;scoreDirectorFactory&gt;
    &lt;scoreDrl&gt;org/optaplanner/examples/cloudbalancing/solver/cloudBalancingScoreRules.drl&lt;/scoreDrl&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>We want to make sure that all computers have enough CPU, RAM and network bandwidth to support all their processes, so we make these hard constraints:</p>
<div class="exampleblock">
<div class="title">Example 7. cloudBalancingScoreRules.drl - Hard Constraints</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>...

import org.optaplanner.examples.cloudbalancing.domain.CloudBalance;
import org.optaplanner.examples.cloudbalancing.domain.CloudComputer;
import org.optaplanner.examples.cloudbalancing.domain.CloudProcess;

global HardSoftScoreHolder scoreHolder;

// ############################################################################
// Hard constraints
// ############################################################################

rule "requiredCpuPowerTotal"
    when
        $computer : CloudComputer($cpuPower : cpuPower)
        accumulate(
            CloudProcess(
                computer == $computer,
                $requiredCpuPower : requiredCpuPower);
            $requiredCpuPowerTotal : sum($requiredCpuPower);
            $requiredCpuPowerTotal &gt; $cpuPower
        )
    then
        scoreHolder.addHardConstraintMatch(kcontext, $cpuPower - $requiredCpuPowerTotal);
end

rule "requiredMemoryTotal"
    ...
end

rule "requiredNetworkBandwidthTotal"
    ...
end</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>If those constraints are met, we want to minimize the maintenance cost, so we add that as a soft constraint:</p>
<div class="exampleblock">
<div class="title">Example 8. cloudBalancingScoreRules.drl - Soft Constraints</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>// ############################################################################
// Soft constraints
// ############################################################################

rule "computerCost"
    when
        $computer : CloudComputer($cost : cost)
        exists CloudProcess(computer == $computer)
    then
        scoreHolder.addSoftConstraintMatch(kcontext, - $cost);
end</code></pre>
</div>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cloudBalancingBeyondThisTutorial"><a class="anchor" href="#cloudBalancingBeyondThisTutorial"></a><a class="link" href="#cloudBalancingBeyondThisTutorial">2.6. Beyond this Tutorial</a></h3>
<div class="paragraph">
<p>Now that this simple example works, try going further.
Enrich the domain model and add extra constraints such as these:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each <code>Process</code> belongs to a <code>Service</code>. A computer might crash, so processes running the same service should be assigned to different computers.</p>
</li>
<li>
<p>Each <code>Computer</code> is located in a <code>Building</code>. A building might burn down, so processes of the same services should be assigned to computers in different buildings.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="useCasesAndExamples"><a class="anchor" href="#useCasesAndExamples"></a><a class="link" href="#useCasesAndExamples">3. Use Cases and Examples</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="examplesOverview"><a class="anchor" href="#examplesOverview"></a><a class="link" href="#examplesOverview">3.1. Examples Overview</a></h3>
<div class="paragraph">
<p>Planner has several examples. In this manual we explain mainly using the <em>n</em> queens example and cloud balancing example. So it is advisable to read at least those sections.</p>
</div>
<div class="paragraph">
<p>The <code>Competition?</code> column in the following table identifies an example as being either realistic or unrealistic. A <em>realistic competition</em> is <em>an official, independent competition</em>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>that clearly defines a real-word use case.</p>
</li>
<li>
<p>with real-world constraints.</p>
</li>
<li>
<p>with multiple, real-world datasets.</p>
</li>
<li>
<p>that expects reproducible results within a specific time limit on specific hardware.</p>
</li>
<li>
<p>that has had serious participation from the academic and/or enterprise Operations Research community.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These realistic competitions provide an objective comparison of Planner with competitive software and academic research.</p>
</div>
<div class="paragraph">
<p>The source code of all these examples is available in the distribution zip under <em class="path">examples/sources</em>
and also in git under <em class="path">optaplanner/optaplanner-examples</em>.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 2. Examples Overview</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Example</th>
<th class="tableblock halign-left valign-top">Domain</th>
<th class="tableblock halign-left valign-top">Size</th>
<th class="tableblock halign-left valign-top">Competition?</th>
<th class="tableblock halign-left valign-top">Special features used</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#nQueens">N queens</a></p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
</li>
<li>
<p>1 variable</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>256</code></p>
</li>
<li>
<p>Value &#8656; 256</p>
</li>
<li>
<p>Search space &#8656; <code>10^616</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Pointless (<a href="http://en.wikipedia.org/wiki/Eight_queens_puzzle#Explicit_solutions">cheatable</a>)</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>None</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#cloudBalancing">Cloud balancing</a></p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
</li>
<li>
<p>1 variable</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>2400</code></p>
</li>
<li>
<p>Value &#8656; 800</p>
</li>
<li>
<p>Search space &#8656; <code>10^6967</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>No</p>
</li>
<li>
<p>Defined by us</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p><a href="#realTimePlanning">Real-time planning</a></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#tsp">Traveling salesman</a></p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
</li>
<li>
<p>1 chained variable</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>980</code></p>
</li>
<li>
<p>Value &#8656; 980</p>
</li>
<li>
<p>Search space &#8656; <code>10^2927</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Unrealistic</p>
</li>
<li>
<p><a href="http://www.math.uwaterloo.ca/tsp/">TSP web</a></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p><a href="#realTimePlanning">Real-time planning</a></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#dinnerParty">Dinner party</a></p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
</li>
<li>
<p>1 variable</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>144</code></p>
</li>
<li>
<p>Value &#8656; 72</p>
</li>
<li>
<p>Search space &#8656; <code>10^310</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Unrealistic</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Decision Table spreadsheet (XLS) for score constraints</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#tennis">Tennis club scheduling</a></p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
</li>
<li>
<p>1 variable</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>72</code></p>
</li>
<li>
<p>Value &#8656; 7</p>
</li>
<li>
<p>Search space &#8656; <code>10^60</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>No</p>
</li>
<li>
<p>Defined by us</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p><a href="#fairnessScoreConstraints">Fairness score constraints</a></p>
</li>
<li>
<p><a href="#immovablePlanningEntities">Immovable entities</a></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#meetingScheduling">Meeting scheduling</a></p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
</li>
<li>
<p>2 variables</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>10</code></p>
</li>
<li>
<p>Value &#8656; 320 and &#8656; <code>5</code></p>
</li>
<li>
<p>Search space &#8656; <code>10^320</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>No</p>
</li>
<li>
<p>Defined by us</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p><a href="#timeGrainPattern">TimeGrain pattern</a></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#curriculumCourse">Course timetabling</a></p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
</li>
<li>
<p>2 variables</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>434</code></p>
</li>
<li>
<p>Value &#8656; 25 and &#8656; <code>20</code></p>
</li>
<li>
<p>Search space &#8656; <code>10^1171</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Realistic</p>
</li>
<li>
<p><a href="http://www.cs.qub.ac.uk/itc2007/curriculmcourse/course_curriculm_index.htm">ITC 2007 track 3</a></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p><a href="#immovablePlanningEntities">Immovable entities</a></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#machineReassignment">Machine reassignment</a></p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
</li>
<li>
<p>1 variable</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>50000</code></p>
</li>
<li>
<p>Value &#8656; 5000</p>
</li>
<li>
<p>Search space &#8656; <code>10^184948</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Nearly realistic</p>
</li>
<li>
<p><a href="http://challenge.roadef.org/2012/en/">ROADEF 2012</a></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p><a href="#realTimePlanning">Real-time planning</a></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#vehicleRouting">Vehicle routing</a></p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
</li>
<li>
<p>1 chained variable</p>
</li>
<li>
<p>1 shadow entity class</p>
</li>
<li>
<p>1 automatic shadow variable</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>134</code></p>
</li>
<li>
<p>Value &#8656; 141</p>
</li>
<li>
<p>Search space &#8656; <code>10^285</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Unrealistic</p>
</li>
<li>
<p><a href="http://neo.lcc.uma.es/vrp/">VRP web</a></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p><a href="#shadowVariable">Shadow variable</a></p>
</li>
<li>
<p><a href="#realTimePlanning">Real-time planning</a></p>
</li>
<li>
<p><a href="#nearbySelection">Nearby selection</a></p>
</li>
<li>
<p>Real road distances</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#vehicleRouting">Vehicle routing</a> with time windows</p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>All of Vehicle routing</p>
</li>
<li>
<p>1 shadow variable</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>1000</code></p>
</li>
<li>
<p>Value &#8656; 1250</p>
</li>
<li>
<p>Search space &#8656; <code>10^3000</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Unrealistic</p>
</li>
<li>
<p><a href="http://neo.lcc.uma.es/vrp/">VRP web</a></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>All of Vehicle routing</p>
</li>
<li>
<p>Custom <a href="#customVariableListener">VariableListener</a></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#projectJobScheduling">Project job scheduling</a></p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
</li>
<li>
<p>2 variables</p>
</li>
<li>
<p>1 shadow variable</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>640</code></p>
</li>
<li>
<p>Value &#8656; ? and &#8656; <code>?</code></p>
</li>
<li>
<p>Search space &#8656; <code>?</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Nearly realistic</p>
</li>
<li>
<p><a href="http://gent.cs.kuleuven.be/mista2013challenge/">MISTA 2013</a></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p><a href="#bendableScore">Bendable score</a></p>
</li>
<li>
<p>Custom <a href="#customVariableListener">VariableListener</a></p>
</li>
<li>
<p><a href="#valueRangeFactory">ValueRangeFactory</a></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#bedAllocation">Hospital bed planning</a></p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
</li>
<li>
<p>1 nullable variable</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>2750</code></p>
</li>
<li>
<p>Value &#8656; 471</p>
</li>
<li>
<p>Search space &#8656; <code>10^6851</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Unrealistic</p>
</li>
<li>
<p><a href="https://people.cs.kuleuven.be/~wim.vancroonenburg/pas/">Kaho PAS</a></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p><a href="#overconstrainedPlanning">Overconstrained planning</a></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#taskAssigning">Task assigning</a></p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
</li>
<li>
<p>1 chained variable</p>
</li>
<li>
<p>1 shadow entity class</p>
</li>
<li>
<p>1 automatic shadow variable</p>
</li>
<li>
<p>1 shadow variable</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>500</code></p>
</li>
<li>
<p>Value &#8656; 520</p>
</li>
<li>
<p>Search space &#8656; <code>10^1384</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>No</p>
</li>
<li>
<p>Defined by us</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p><a href="#bendableScore">Bendable score</a></p>
</li>
<li>
<p><a href="#chainedThroughTimePattern">Chained through time pattern</a></p>
</li>
<li>
<p>Custom <a href="#customVariableListener">VariableListener</a></p>
</li>
<li>
<p><a href="#continuousPlanning">Continuous planning</a></p>
</li>
<li>
<p><a href="#realTimePlanning">Real-time planning</a></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#examination">Exam timetabling</a></p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>2 entity classes (same hierarchy)</p>
</li>
<li>
<p>2 variables</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>1096</code></p>
</li>
<li>
<p>Value &#8656; 80 and &#8656; <code>49</code></p>
</li>
<li>
<p>Search space &#8656; <code>10^3374</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Realistic</p>
</li>
<li>
<p><a href="http://www.cs.qub.ac.uk/itc2007/examtrack/exam_track_index.htm">ITC 2007 track 1</a></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Custom <a href="#customVariableListener">VariableListener</a></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#employeeRostering">Employee rostering</a></p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
</li>
<li>
<p>1 variable</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>752</code></p>
</li>
<li>
<p>Value &#8656; 50</p>
</li>
<li>
<p>Search space &#8656; <code>10^1277</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Realistic</p>
</li>
<li>
<p><a href="http://www.kuleuven-kortrijk.be/nrpcompetition">INRC 2010</a></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p><a href="#continuousPlanning">Continuous planning</a></p>
</li>
<li>
<p><a href="#realTimePlanning">Real-time planning</a></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#travelingTournament">Traveling tournament</a></p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
</li>
<li>
<p>1 variable</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>1560</code></p>
</li>
<li>
<p>Value &#8656; 78</p>
</li>
<li>
<p>Search space &#8656; <code>10^2951</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Unrealistic</p>
</li>
<li>
<p><a href="http://mat.gsia.cmu.edu/TOURN/">TTP</a></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Custom <a href="#moveListFactory">MoveListFactory</a></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#cheapTimeScheduling">Cheap time scheduling</a></p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
</li>
<li>
<p>2 variables</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>500</code></p>
</li>
<li>
<p>Value &#8656; 100 and &#8656; <code>288</code></p>
</li>
<li>
<p>Search space &#8656; <code>10^20078</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Nearly realistic</p>
</li>
<li>
<p><a href="http://iconchallenge.insight-centre.org/challenge-energy">ICON Energy</a></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p><a href="#annotationAlternatives">Field annotations</a></p>
</li>
<li>
<p><a href="#valueRangeFactory">ValueRangeFactory</a></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#investment">Investment</a></p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
</li>
<li>
<p>1 variable</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>11</code></p>
</li>
<li>
<p>Value = 1000</p>
</li>
<li>
<p>Search space &#8656; <code>10^4</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>No</p>
</li>
<li>
<p>Defined by us</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p><a href="#valueRangeFactory">ValueRangeFactory</a></p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="basicExamples"><a class="anchor" href="#basicExamples"></a><a class="link" href="#basicExamples">3.2. Basic Examples</a></h3>
<div class="sect3">
<h4 id="nQueens"><a class="anchor" href="#nQueens"></a><a class="link" href="#nQueens">3.2.1. N Queens</a></h4>
<div class="sect4">
<h5 id="nQueensProblemDescription"><a class="anchor" href="#nQueensProblemDescription"></a><a class="link" href="#nQueensProblemDescription">3.2.1.1. Problem Description</a></h5>
<div class="paragraph">
<p>Place <em>n</em> queens on a <em>n</em> sized chessboard so that no two queens can attack each other.
The most common <em>n</em> queens puzzle is the eight queens puzzle, with <em>n = 8</em>:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./UseCasesAndExamples/BasicExamples/nQueensScreenshot.png" alt="nQueensScreenshot">
</div>
</div>
<div class="paragraph">
<p>Constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use a chessboard of <em>n</em> columns and <em>n</em> rows.</p>
</li>
<li>
<p>Place <em>n</em> queens on the chessboard.</p>
</li>
<li>
<p>No two queens can attack each other. A queen can attack any other queen on the same horizontal, vertical or diagonal line.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This documentation heavily uses the four queens puzzle as the primary example.</p>
</div>
<div class="paragraph">
<p>A proposed solution could be:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./UseCasesAndExamples/BasicExamples/partiallySolvedNQueens04Explained.png" alt="partiallySolvedNQueens04Explained">
</div>
<div class="title">Figure 1. A Wrong Solution for the Four Queens Puzzle</div>
</div>
<div class="paragraph">
<p>The above solution is wrong because queens <code>A1</code> and <code>B0</code> can attack each other (so can queens <code>B0</code> and <code>D0</code>). Removing queen <code>B0</code> would respect the "no two queens can attack each other" constraint, but would break the "place <em>n</em> queens" constraint.</p>
</div>
<div class="paragraph">
<p>Below is a correct solution:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./UseCasesAndExamples/BasicExamples/solvedNQueens04.png" alt="solvedNQueens04">
</div>
<div class="title">Figure 2. A Correct Solution for the Four Queens Puzzle</div>
</div>
<div class="paragraph">
<p>All the constraints have been met, so the solution is correct.</p>
</div>
<div class="paragraph">
<p>Note that most <em>n</em> queens puzzles have multiple correct solutions.
We will focus on finding a single correct solution for a given <em>n</em>, not on finding the number of possible correct solutions for a given <em>n</em>.</p>
</div>
</div>
<div class="sect4">
<h5 id="nQueensProblemSize"><a class="anchor" href="#nQueensProblemSize"></a><a class="link" href="#nQueensProblemSize">3.2.1.2. Problem Size</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>4queens   has   4 queens with a search space of    256.
8queens   has   8 queens with a search space of   10^7.
16queens  has  16 queens with a search space of  10^19.
32queens  has  32 queens with a search space of  10^48.
64queens  has  64 queens with a search space of 10^115.
256queens has 256 queens with a search space of 10^616.</code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation of the <em>n</em> queens example has not been optimized because it functions as a beginner example. Nevertheless, it can easily handle 64 queens.
With a few changes it has been shown to easily handle 5000 queens and more.</p>
</div>
</div>
<div class="sect4">
<h5 id="nQueensDomainModel"><a class="anchor" href="#nQueensDomainModel"></a><a class="link" href="#nQueensDomainModel">3.2.1.3. Domain Model</a></h5>
<div class="paragraph">
<p>This example uses the domain model to solve the four queens problem.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Creating a Domain Model</strong>
A good domain model will make it easier to understand and solve your planning problem.</p>
<div class="paragraph">
<p>This is the domain model for the <em>n</em> queens example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class Column {

    private int index;

    // ... getters and setters
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class Row {

    private int index;

    // ... getters and setters
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class Queen {

    private Column column;
    private Row row;

    public int getAscendingDiagonalIndex() {...}
    public int getDescendingDiagonalIndex() {...}

    // ... getters and setters
}</code></pre>
</div>
</div>
</li>
<li>
<p><strong>Calculating the Search Space.</strong></p>
<div class="paragraph">
<p>A <code>Queen</code> instance has a <code>Column</code> (for example: 0 is column A, 1 is column B, &#8230;&#8203;) and a <code>Row</code> (its row, for example: 0 is row 0, 1 is row 1, &#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>The ascending diagonal line and the descending diagonal line can be calculated based on the column and the row.</p>
</div>
<div class="paragraph">
<p>The column and row indexes start from the upper left corner of the chessboard.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class NQueens {

    private int n;
    private List&lt;Column&gt; columnList;
    private List&lt;Row&gt; rowList;

    private List&lt;Queen&gt; queenList;

    private SimpleScore score;

    // ... getters and setters
}</code></pre>
</div>
</div>
</li>
<li>
<p><strong>Finding the Solution</strong></p>
<div class="paragraph">
<p>A single <code>NQueens</code> instance contains a list of all <code>Queen</code> instances.
It is the <code>Solution</code> implementation which will be supplied to, solved by, and retrieved from the Solver.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Notice that in the four queens example, NQueens&#8217;s <code>getN()</code> method will always return four.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 3. A Solution for Four Queens Shown in the Domain Model</caption>
<colgroup>
<col style="width: 54.5454%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.091%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">A solution</th>
<th class="tableblock halign-left valign-top">Queen</th>
<th class="tableblock halign-left valign-top">columnIndex</th>
<th class="tableblock halign-left valign-top">rowIndex</th>
<th class="tableblock halign-left valign-top">ascendingDiagonalIndex (columnIndex + rowIndex)</th>
<th class="tableblock halign-left valign-top">descendingDiagonalIndex (columnIndex - rowIndex)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" rowspan="4"><div><div class="imageblock" style="text-align: center">
<div class="content">
<img src="./UseCasesAndExamples/BasicExamples/partiallySolvedNQueens04Explained.png" alt="partiallySolvedNQueens04Explained">
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>1 (**)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>B0</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>0 (*)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>1 (**)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>C2</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>D0</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>0 (*)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When two queens share the same column, row or diagonal line, such as (*) and (**), they can attack each other.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cloudBalancing"><a class="anchor" href="#cloudBalancing"></a><a class="link" href="#cloudBalancing">3.2.2. Cloud Balancing</a></h4>
<div class="paragraph">
<p>This example is explained in <a href="#cloudBalancingTutorial">a tutorial</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="tsp"><a class="anchor" href="#tsp"></a><a class="link" href="#tsp">3.2.3. Traveling Salesman (TSP - Traveling Salesman Problem)</a></h4>
<div class="sect4">
<h5 id="tspProblemDescription"><a class="anchor" href="#tspProblemDescription"></a><a class="link" href="#tspProblemDescription">3.2.3.1. Problem Description</a></h5>
<div class="paragraph">
<p>Given a list of cities, find the shortest tour for a salesman that visits each city exactly once.</p>
</div>
<div class="paragraph">
<p>The problem is defined by <a href="http://en.wikipedia.org/wiki/Travelling_salesman_problem">Wikipedia</a>.
It is <a href="http://www.math.uwaterloo.ca/tsp/">one of the most intensively studied problems</a> in computational mathematics.
Yet, in the real world, it is often only part of a planning problem, along with other constraints, such as employee shift rostering constraints.</p>
</div>
</div>
<div class="sect4">
<h5 id="tspProblemSize"><a class="anchor" href="#tspProblemSize"></a><a class="link" href="#tspProblemSize">3.2.3.2. Problem Size</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>dj38     has  38 cities with a search space of   10^58.
europe40 has  40 cities with a search space of   10^62.
st70     has  70 cities with a search space of  10^126.
pcb442   has 442 cities with a search space of 10^1166.
lu980    has 980 cities with a search space of 10^2927.</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="tspProblemDifficulty"><a class="anchor" href="#tspProblemDifficulty"></a><a class="link" href="#tspProblemDifficulty">3.2.3.3. Problem Difficulty</a></h5>
<div class="paragraph">
<p>Despite TSP&#8217;s simple definition, the problem is surprisingly hard to solve.
Because it is an NP-hard problem (like most planning problems), the optimal solution for a specific problem dataset can change a lot when that problem dataset is slightly altered:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./UseCasesAndExamples/BasicExamples/tspOptimalSolutionVolatility.png" alt="tspOptimalSolutionVolatility">
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="dinnerParty"><a class="anchor" href="#dinnerParty"></a><a class="link" href="#dinnerParty">3.2.4. Dinner Party</a></h4>
<div class="sect4">
<h5 id="dinnerPartyProblemDescription"><a class="anchor" href="#dinnerPartyProblemDescription"></a><a class="link" href="#dinnerPartyProblemDescription">3.2.4.1. Problem Description</a></h5>
<div class="paragraph">
<p>Miss Manners is throwing another dinner party.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>This time she invited 144 guests and prepared 12 round tables with 12 seats each.</p>
</li>
<li>
<p>Every guest should sit next to someone (left and right) of the opposite gender.</p>
</li>
<li>
<p>And that neighbour should have at least one hobby in common with the guest.</p>
</li>
<li>
<p>At every table, there should be two politicians, two doctors, two socialites, two coaches, two teachers and two programmers.</p>
</li>
<li>
<p>And the two politicians, two doctors, two coaches and two programmers should not be the same kind at a table.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Drools Expert also has the normal Miss Manners example (which is much smaller) and employs an exhaustive heuristic to solve it.
Planner&#8217;s implementation is far more scalable because it uses heuristics to find the best solution and Drools Expert to calculate the score of each solution.</p>
</div>
</div>
<div class="sect4">
<h5 id="dinnerPartyProblemSize"><a class="anchor" href="#dinnerPartyProblemSize"></a><a class="link" href="#dinnerPartyProblemSize">3.2.4.2. Problem Size</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>wedding01 has 18 jobs, 144 guests, 288 hobby practicians, 12 tables and 144 seats with a search space of 10^310.</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tennis"><a class="anchor" href="#tennis"></a><a class="link" href="#tennis">3.2.5. Tennis Club Scheduling</a></h4>
<div class="sect4">
<h5 id="tennisProblemDescription"><a class="anchor" href="#tennisProblemDescription"></a><a class="link" href="#tennisProblemDescription">3.2.5.1. Problem Description</a></h5>
<div class="paragraph">
<p>Every week the tennis club has four teams playing round robin against each other.
Assign those four spots to the teams fairly.</p>
</div>
<div class="paragraph">
<p>Hard constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Conflict: A team can only play once per day.</p>
</li>
<li>
<p>Unavailability: Some teams are unavailable on some dates.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Medium constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Fair assignment: All teams should play an (almost) equal number of times.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Evenly confrontation: Each team should play against every other team an equal number of times.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="tennisProblemSize"><a class="anchor" href="#tennisProblemSize"></a><a class="link" href="#tennisProblemSize">3.2.5.2. Problem Size</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>munich-7teams has 7 teams, 18 days, 12 unavailabilityPenalties and 72 teamAssignments with a search space of 10^60.</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="tennisDomainModel"><a class="anchor" href="#tennisDomainModel"></a><a class="link" href="#tennisDomainModel">3.2.5.3. Domain Model</a></h5>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./UseCasesAndExamples/BasicExamples/tennisClassDiagram.png" alt="tennisClassDiagram">
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="meetingScheduling"><a class="anchor" href="#meetingScheduling"></a><a class="link" href="#meetingScheduling">3.2.6. Meeting Scheduling</a></h4>
<div class="sect4">
<h5 id="meetingSchedulingProblemDescription"><a class="anchor" href="#meetingSchedulingProblemDescription"></a><a class="link" href="#meetingSchedulingProblemDescription">3.2.6.1. Problem Description</a></h5>
<div class="paragraph">
<p>Assign each meeting to a starting time and a room.
Meetings have different durations.</p>
</div>
<div class="paragraph">
<p>Hard constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Room conflict: two meetings must not use the same room at the same time.</p>
</li>
<li>
<p>Required attendance: A person cannot have two required meetings at the same time.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Medium constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Preferred attendance: A person cannot have two preferred meetings at the same time, nor a preferred and a required meeting at the same time.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Sooner rather than later: Schedule all meetings as soon as possible.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="meetingSchedulingProblemSize"><a class="anchor" href="#meetingSchedulingProblemSize"></a><a class="link" href="#meetingSchedulingProblemSize">3.2.6.2. Problem Size</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>50meetings-160timegrains-5rooms  has  50 meetings, 160 timeGrains and 5 rooms with a search space of 10^145.
100meetings-320timegrains-5rooms has 100 meetings, 320 timeGrains and 5 rooms with a search space of 10^320.</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="realExamples"><a class="anchor" href="#realExamples"></a><a class="link" href="#realExamples">3.3. Real Examples</a></h3>
<div class="sect3">
<h4 id="curriculumCourse"><a class="anchor" href="#curriculumCourse"></a><a class="link" href="#curriculumCourse">3.3.1. Course Timetabling (ITC 2007 Track 3 - Curriculum Course Scheduling)</a></h4>
<div class="sect4">
<h5 id="curriculumCourseProblemDescription"><a class="anchor" href="#curriculumCourseProblemDescription"></a><a class="link" href="#curriculumCourseProblemDescription">3.3.1.1. Problem Description</a></h5>
<div class="paragraph">
<p>Schedule each lecture into a timeslot and into a room.</p>
</div>
<div class="paragraph">
<p>Hard constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Teacher conflict: A teacher must not have two lectures in the same period.</p>
</li>
<li>
<p>Curriculum conflict: A curriculum must not have two lectures in the same period.</p>
</li>
<li>
<p>Room occupancy: two lectures must not be in the same room in the same period.</p>
</li>
<li>
<p>Unavailable period (specified per dataset): A specific lecture must not be assigned to a specific period.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Room capacity: A room&#8217;s capacity should not be less than the number of students in its lecture.</p>
</li>
<li>
<p>Minimum working days: Lectures of the same course should be spread out into a minimum number of days.</p>
</li>
<li>
<p>Curriculum compactness: Lectures belonging to the same curriculum should be adjacent to each other (so in consecutive periods).</p>
</li>
<li>
<p>Room stability: Lectures of the same course should be assigned to the same room.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The problem is defined by <a href="http://www.cs.qub.ac.uk/itc2007/curriculmcourse/course_curriculm_index.htm">the International Timetabling Competition 2007 track 3</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="curriculumCourseProblemSize"><a class="anchor" href="#curriculumCourseProblemSize"></a><a class="link" href="#curriculumCourseProblemSize">3.3.1.2. Problem Size</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>comp01 has 24 teachers,  14 curricula,  30 courses, 160 lectures, 30 periods,  6 rooms and   53 unavailable period constraints with a search space of  10^360.
comp02 has 71 teachers,  70 curricula,  82 courses, 283 lectures, 25 periods, 16 rooms and  513 unavailable period constraints with a search space of  10^736.
comp03 has 61 teachers,  68 curricula,  72 courses, 251 lectures, 25 periods, 16 rooms and  382 unavailable period constraints with a search space of  10^653.
comp04 has 70 teachers,  57 curricula,  79 courses, 286 lectures, 25 periods, 18 rooms and  396 unavailable period constraints with a search space of  10^758.
comp05 has 47 teachers, 139 curricula,  54 courses, 152 lectures, 36 periods,  9 rooms and  771 unavailable period constraints with a search space of  10^381.
comp06 has 87 teachers,  70 curricula, 108 courses, 361 lectures, 25 periods, 18 rooms and  632 unavailable period constraints with a search space of  10^957.
comp07 has 99 teachers,  77 curricula, 131 courses, 434 lectures, 25 periods, 20 rooms and  667 unavailable period constraints with a search space of 10^1171.
comp08 has 76 teachers,  61 curricula,  86 courses, 324 lectures, 25 periods, 18 rooms and  478 unavailable period constraints with a search space of  10^859.
comp09 has 68 teachers,  75 curricula,  76 courses, 279 lectures, 25 periods, 18 rooms and  405 unavailable period constraints with a search space of  10^740.
comp10 has 88 teachers,  67 curricula, 115 courses, 370 lectures, 25 periods, 18 rooms and  694 unavailable period constraints with a search space of  10^981.
comp11 has 24 teachers,  13 curricula,  30 courses, 162 lectures, 45 periods,  5 rooms and   94 unavailable period constraints with a search space of  10^381.
comp12 has 74 teachers, 150 curricula,  88 courses, 218 lectures, 36 periods, 11 rooms and 1368 unavailable period constraints with a search space of  10^566.
comp13 has 77 teachers,  66 curricula,  82 courses, 308 lectures, 25 periods, 19 rooms and  468 unavailable period constraints with a search space of  10^824.
comp14 has 68 teachers,  60 curricula,  85 courses, 275 lectures, 25 periods, 17 rooms and  486 unavailable period constraints with a search space of  10^722.</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="curriculumCourseDomainModel"><a class="anchor" href="#curriculumCourseDomainModel"></a><a class="link" href="#curriculumCourseDomainModel">3.3.1.3. Domain Model</a></h5>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./UseCasesAndExamples/RealExamples/curriculumCourseClassDiagram.png" alt="curriculumCourseClassDiagram">
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="machineReassignment"><a class="anchor" href="#machineReassignment"></a><a class="link" href="#machineReassignment">3.3.2. Machine Reassignment (Google ROADEF 2012)</a></h4>
<div class="sect4">
<h5 id="machineReassignmentProblemDescription"><a class="anchor" href="#machineReassignmentProblemDescription"></a><a class="link" href="#machineReassignmentProblemDescription">3.3.2.1. Problem Description</a></h5>
<div class="paragraph">
<p>Assign each process to a machine.
All processes already have an original (unoptimized) assignment.
Each process requires an amount of each resource (such as CPU, RAM, &#8230;&#8203;). This is a more complex version of the Cloud Balancing example.</p>
</div>
<div class="paragraph">
<p>Hard constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Maximum capacity: The maximum capacity for each resource for each machine must not be exceeded.</p>
</li>
<li>
<p>Conflict: Processes of the same service must run on distinct machines.</p>
</li>
<li>
<p>Spread: Processes of the same service must be spread out across locations.</p>
</li>
<li>
<p>Dependency: The processes of a service depending on another service must run in the neighborhood of a process of the other service.</p>
</li>
<li>
<p>Transient usage: Some resources are transient and count towards the maximum capacity of both the original machine as the newly assigned machine.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Load: The safety capacity for each resource for each machine should not be exceeded.</p>
</li>
<li>
<p>Balance: Leave room for future assignments by balancing the available resources on each machine.</p>
</li>
<li>
<p>Process move cost: A process has a move cost.</p>
</li>
<li>
<p>Service move cost: A service has a move cost.</p>
</li>
<li>
<p>Machine move cost: Moving a process from machine A to machine B has another A-B specific move cost.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The problem is defined by <a href="http://challenge.roadef.org/2012/en/">the Google ROADEF/EURO Challenge 2012</a>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./UseCasesAndExamples/RealExamples/cloudOptimizationIsLikeTetris.png" alt="cloudOptimizationIsLikeTetris">
</div>
</div>
</div>
<div class="sect4">
<h5 id="machineReassignmentValueProposition"><a class="anchor" href="#machineReassignmentValueProposition"></a><a class="link" href="#machineReassignmentValueProposition">3.3.2.2. Value Proposition</a></h5>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./shared/cloudOptimizationValueProposition.png" alt="cloudOptimizationValueProposition">
</div>
</div>
</div>
<div class="sect4">
<h5 id="machineReassignmentProblemSize"><a class="anchor" href="#machineReassignmentProblemSize"></a><a class="link" href="#machineReassignmentProblemSize">3.3.2.3. Problem Size</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>model_a1_1 has  2 resources,  1 neighborhoods,   4 locations,    4 machines,    79 services,   100 processes and 1 balancePenalties with a search space of     10^60.
model_a1_2 has  4 resources,  2 neighborhoods,   4 locations,  100 machines,   980 services,  1000 processes and 0 balancePenalties with a search space of   10^2000.
model_a1_3 has  3 resources,  5 neighborhoods,  25 locations,  100 machines,   216 services,  1000 processes and 0 balancePenalties with a search space of   10^2000.
model_a1_4 has  3 resources, 50 neighborhoods,  50 locations,   50 machines,   142 services,  1000 processes and 1 balancePenalties with a search space of   10^1698.
model_a1_5 has  4 resources,  2 neighborhoods,   4 locations,   12 machines,   981 services,  1000 processes and 1 balancePenalties with a search space of   10^1079.
model_a2_1 has  3 resources,  1 neighborhoods,   1 locations,  100 machines,  1000 services,  1000 processes and 0 balancePenalties with a search space of   10^2000.
model_a2_2 has 12 resources,  5 neighborhoods,  25 locations,  100 machines,   170 services,  1000 processes and 0 balancePenalties with a search space of   10^2000.
model_a2_3 has 12 resources,  5 neighborhoods,  25 locations,  100 machines,   129 services,  1000 processes and 0 balancePenalties with a search space of   10^2000.
model_a2_4 has 12 resources,  5 neighborhoods,  25 locations,   50 machines,   180 services,  1000 processes and 1 balancePenalties with a search space of   10^1698.
model_a2_5 has 12 resources,  5 neighborhoods,  25 locations,   50 machines,   153 services,  1000 processes and 0 balancePenalties with a search space of   10^1698.
model_b_1  has 12 resources,  5 neighborhoods,  10 locations,  100 machines,  2512 services,  5000 processes and 0 balancePenalties with a search space of  10^10000.
model_b_2  has 12 resources,  5 neighborhoods,  10 locations,  100 machines,  2462 services,  5000 processes and 1 balancePenalties with a search space of  10^10000.
model_b_3  has  6 resources,  5 neighborhoods,  10 locations,  100 machines, 15025 services, 20000 processes and 0 balancePenalties with a search space of  10^40000.
model_b_4  has  6 resources,  5 neighborhoods,  50 locations,  500 machines,  1732 services, 20000 processes and 1 balancePenalties with a search space of  10^53979.
model_b_5  has  6 resources,  5 neighborhoods,  10 locations,  100 machines, 35082 services, 40000 processes and 0 balancePenalties with a search space of  10^80000.
model_b_6  has  6 resources,  5 neighborhoods,  50 locations,  200 machines, 14680 services, 40000 processes and 1 balancePenalties with a search space of  10^92041.
model_b_7  has  6 resources,  5 neighborhoods,  50 locations, 4000 machines, 15050 services, 40000 processes and 1 balancePenalties with a search space of 10^144082.
model_b_8  has  3 resources,  5 neighborhoods,  10 locations,  100 machines, 45030 services, 50000 processes and 0 balancePenalties with a search space of 10^100000.
model_b_9  has  3 resources,  5 neighborhoods, 100 locations, 1000 machines,  4609 services, 50000 processes and 1 balancePenalties with a search space of 10^150000.
model_b_10 has  3 resources,  5 neighborhoods, 100 locations, 5000 machines,  4896 services, 50000 processes and 1 balancePenalties with a search space of 10^184948.</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="machineReassignmentDomainModel"><a class="anchor" href="#machineReassignmentDomainModel"></a><a class="link" href="#machineReassignmentDomainModel">3.3.2.4. Domain Model</a></h5>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./UseCasesAndExamples/RealExamples/machineReassignmentClassDiagram.png" alt="machineReassignmentClassDiagram">
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="vehicleRouting"><a class="anchor" href="#vehicleRouting"></a><a class="link" href="#vehicleRouting">3.3.3. Vehicle Routing</a></h4>
<div class="sect4">
<h5 id="vehicleRoutingProblemDescription"><a class="anchor" href="#vehicleRoutingProblemDescription"></a><a class="link" href="#vehicleRoutingProblemDescription">3.3.3.1. Problem Description</a></h5>
<div class="paragraph">
<p>Using a fleet of vehicles, pick up the objects of each customer and bring them to the depot.
Each vehicle can service multiple customers, but it has a limited capacity.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./UseCasesAndExamples/RealExamples/vehicleRoutingUseCase.png" alt="vehicleRoutingUseCase">
</div>
</div>
<div class="paragraph">
<p>Besides the basic case (CVRP), there is also a variant with time windows (CVRPTW).</p>
</div>
<div class="paragraph">
<p>Hard constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Vehicle capacity: a vehicle cannot carry more items then its capacity.</p>
</li>
<li>
<p>Time windows (only in CVRPTW):</p>
<div class="ulist">
<ul>
<li>
<p>Travel time: Traveling from one location to another takes time.</p>
</li>
<li>
<p>Customer service duration: a vehicle must stay at the customer for the length of the service duration.</p>
</li>
<li>
<p>Customer ready time: a vehicle may arrive before the customer&#8217;s ready time, but it must wait until the ready time before servicing.</p>
</li>
<li>
<p>Customer due time: a vehicle must arrive on time, before the customer&#8217;s due time.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Total distance: minimize the total distance driven (fuel consumption) of all vehicles.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The capacitated vehicle routing problem (CVRP) and its timewindowed variant (CVRPTW) are defined by <a href="http://neo.lcc.uma.es/vrp/">the VRP web</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="vehicleRoutingValueProposition"><a class="anchor" href="#vehicleRoutingValueProposition"></a><a class="link" href="#vehicleRoutingValueProposition">3.3.3.2. Value Proposition</a></h5>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./UseCasesAndExamples/RealExamples/vehicleRoutingValueProposition.png" alt="vehicleRoutingValueProposition">
</div>
</div>
</div>
<div class="sect4">
<h5 id="vehicleRoutingProblemSize"><a class="anchor" href="#vehicleRoutingProblemSize"></a><a class="link" href="#vehicleRoutingProblemSize">3.3.3.3. Problem Size</a></h5>
<div class="paragraph">
<p>CVRP instances (without time windows):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>A-n32-k5  has 1 depots,  5 vehicles and  31 customers with a search space of  10^46.
A-n33-k5  has 1 depots,  5 vehicles and  32 customers with a search space of  10^48.
A-n33-k6  has 1 depots,  6 vehicles and  32 customers with a search space of  10^48.
A-n34-k5  has 1 depots,  5 vehicles and  33 customers with a search space of  10^50.
A-n36-k5  has 1 depots,  5 vehicles and  35 customers with a search space of  10^54.
A-n37-k5  has 1 depots,  5 vehicles and  36 customers with a search space of  10^56.
A-n37-k6  has 1 depots,  6 vehicles and  36 customers with a search space of  10^56.
A-n38-k5  has 1 depots,  5 vehicles and  37 customers with a search space of  10^58.
A-n39-k5  has 1 depots,  5 vehicles and  38 customers with a search space of  10^60.
A-n39-k6  has 1 depots,  6 vehicles and  38 customers with a search space of  10^60.
A-n44-k7  has 1 depots,  7 vehicles and  43 customers with a search space of  10^70.
A-n45-k6  has 1 depots,  6 vehicles and  44 customers with a search space of  10^72.
A-n45-k7  has 1 depots,  7 vehicles and  44 customers with a search space of  10^72.
A-n46-k7  has 1 depots,  7 vehicles and  45 customers with a search space of  10^74.
A-n48-k7  has 1 depots,  7 vehicles and  47 customers with a search space of  10^78.
A-n53-k7  has 1 depots,  7 vehicles and  52 customers with a search space of  10^89.
A-n54-k7  has 1 depots,  7 vehicles and  53 customers with a search space of  10^91.
A-n55-k9  has 1 depots,  9 vehicles and  54 customers with a search space of  10^93.
A-n60-k9  has 1 depots,  9 vehicles and  59 customers with a search space of 10^104.
A-n61-k9  has 1 depots,  9 vehicles and  60 customers with a search space of 10^106.
A-n62-k8  has 1 depots,  8 vehicles and  61 customers with a search space of 10^108.
A-n63-k10 has 1 depots, 10 vehicles and  62 customers with a search space of 10^111.
A-n63-k9  has 1 depots,  9 vehicles and  62 customers with a search space of 10^111.
A-n64-k9  has 1 depots,  9 vehicles and  63 customers with a search space of 10^113.
A-n65-k9  has 1 depots,  9 vehicles and  64 customers with a search space of 10^115.
A-n69-k9  has 1 depots,  9 vehicles and  68 customers with a search space of 10^124.
A-n80-k10 has 1 depots, 10 vehicles and  79 customers with a search space of 10^149.
F-n135-k7 has 1 depots,  7 vehicles and 134 customers with a search space of 10^285.
F-n45-k4  has 1 depots,  4 vehicles and  44 customers with a search space of  10^72.
F-n72-k4  has 1 depots,  4 vehicles and  71 customers with a search space of 10^131.</code></pre>
</div>
</div>
<div class="paragraph">
<p>CVRPTW instances (with time windows):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>Solomon_025_C101       has 1 depots,  25 vehicles and   25 customers with a search space of   10^34.
Solomon_025_C201       has 1 depots,  25 vehicles and   25 customers with a search space of   10^34.
Solomon_025_R101       has 1 depots,  25 vehicles and   25 customers with a search space of   10^34.
Solomon_025_R201       has 1 depots,  25 vehicles and   25 customers with a search space of   10^34.
Solomon_025_RC101      has 1 depots,  25 vehicles and   25 customers with a search space of   10^34.
Solomon_025_RC201      has 1 depots,  25 vehicles and   25 customers with a search space of   10^34.
Solomon_100_C101       has 1 depots,  25 vehicles and  100 customers with a search space of  10^200.
Solomon_100_C201       has 1 depots,  25 vehicles and  100 customers with a search space of  10^200.
Solomon_100_R101       has 1 depots,  25 vehicles and  100 customers with a search space of  10^200.
Solomon_100_R201       has 1 depots,  25 vehicles and  100 customers with a search space of  10^200.
Solomon_100_RC101      has 1 depots,  25 vehicles and  100 customers with a search space of  10^200.
Solomon_100_RC201      has 1 depots,  25 vehicles and  100 customers with a search space of  10^200.
Homberger_0200_C1_2_1  has 1 depots,  50 vehicles and  200 customers with a search space of  10^460.
Homberger_0200_C2_2_1  has 1 depots,  50 vehicles and  200 customers with a search space of  10^460.
Homberger_0200_R1_2_1  has 1 depots,  50 vehicles and  200 customers with a search space of  10^460.
Homberger_0200_R2_2_1  has 1 depots,  50 vehicles and  200 customers with a search space of  10^460.
Homberger_0200_RC1_2_1 has 1 depots,  50 vehicles and  200 customers with a search space of  10^460.
Homberger_0200_RC2_2_1 has 1 depots,  50 vehicles and  200 customers with a search space of  10^460.
Homberger_0400_C1_4_1  has 1 depots, 100 vehicles and  400 customers with a search space of 10^1040.
Homberger_0400_C2_4_1  has 1 depots, 100 vehicles and  400 customers with a search space of 10^1040.
Homberger_0400_R1_4_1  has 1 depots, 100 vehicles and  400 customers with a search space of 10^1040.
Homberger_0400_R2_4_1  has 1 depots, 100 vehicles and  400 customers with a search space of 10^1040.
Homberger_0400_RC1_4_1 has 1 depots, 100 vehicles and  400 customers with a search space of 10^1040.
Homberger_0400_RC2_4_1 has 1 depots, 100 vehicles and  400 customers with a search space of 10^1040.
Homberger_0600_C1_6_1  has 1 depots, 150 vehicles and  600 customers with a search space of 10^1666.
Homberger_0600_C2_6_1  has 1 depots, 150 vehicles and  600 customers with a search space of 10^1666.
Homberger_0600_R1_6_1  has 1 depots, 150 vehicles and  600 customers with a search space of 10^1666.
Homberger_0600_R2_6_1  has 1 depots, 150 vehicles and  600 customers with a search space of 10^1666.
Homberger_0600_RC1_6_1 has 1 depots, 150 vehicles and  600 customers with a search space of 10^1666.
Homberger_0600_RC2_6_1 has 1 depots, 150 vehicles and  600 customers with a search space of 10^1666.
Homberger_0800_C1_8_1  has 1 depots, 200 vehicles and  800 customers with a search space of 10^2322.
Homberger_0800_C2_8_1  has 1 depots, 200 vehicles and  800 customers with a search space of 10^2322.
Homberger_0800_R1_8_1  has 1 depots, 200 vehicles and  800 customers with a search space of 10^2322.
Homberger_0800_R2_8_1  has 1 depots, 200 vehicles and  800 customers with a search space of 10^2322.
Homberger_0800_RC1_8_1 has 1 depots, 200 vehicles and  800 customers with a search space of 10^2322.
Homberger_0800_RC2_8_1 has 1 depots, 200 vehicles and  800 customers with a search space of 10^2322.
Homberger_1000_C110_1  has 1 depots, 250 vehicles and 1000 customers with a search space of 10^3000.
Homberger_1000_C210_1  has 1 depots, 250 vehicles and 1000 customers with a search space of 10^3000.
Homberger_1000_R110_1  has 1 depots, 250 vehicles and 1000 customers with a search space of 10^3000.
Homberger_1000_R210_1  has 1 depots, 250 vehicles and 1000 customers with a search space of 10^3000.
Homberger_1000_RC110_1 has 1 depots, 250 vehicles and 1000 customers with a search space of 10^3000.
Homberger_1000_RC210_1 has 1 depots, 250 vehicles and 1000 customers with a search space of 10^3000.</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="vehicleRoutingDomainModel"><a class="anchor" href="#vehicleRoutingDomainModel"></a><a class="link" href="#vehicleRoutingDomainModel">3.3.3.4. Domain Model</a></h5>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./UseCasesAndExamples/RealExamples/vehicleRoutingClassDiagram.png" alt="vehicleRoutingClassDiagram">
</div>
</div>
<div class="paragraph">
<p>The vehicle routing with timewindows domain model makes heavily use of <a href="#shadowVariable">shadow variables</a>.
This allows it to express its constraints more naturally, because properties such as <code>arrivalTime</code> and <code>departureTime</code>, are directly available on the domain model.</p>
</div>
</div>
<div class="sect4">
<h5 id="roadDistancesInsteadOfAirDistances"><a class="anchor" href="#roadDistancesInsteadOfAirDistances"></a><a class="link" href="#roadDistancesInsteadOfAirDistances">3.3.3.5. Road Distances Instead of Air Distances</a></h5>
<div class="paragraph">
<p>In the real world, vehicles cannot follow a straight line from location to location: they have to use roads and highways.
From a business point of view, this matters a lot:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./UseCasesAndExamples/RealExamples/vehicleRoutingDistanceType.png" alt="vehicleRoutingDistanceType">
</div>
</div>
<div class="paragraph">
<p>For the optimization algorithm, this does not matter much, as long as the distance between two points can be looked up (and are preferably precalculated). The road cost does not even need to be a distance, it can also be travel time, fuel cost, or a weighted function of those.
There are several technologies available to precalculate road costs, such as <a href="https://graphhopper.com/">GraphHopper</a> (embeddable, offline Java engine), <a href="http://open.mapquestapi.com/directions/#matrix">Open MapQuest</a> (web service) and <a href="https://developers.google.com/maps/documentation/webservices/client-library">Google Maps Client API</a> (web service).</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./UseCasesAndExamples/RealExamples/integrationWithRealMaps.png" alt="integrationWithRealMaps">
</div>
</div>
<div class="paragraph">
<p>There are also several technologies to render it, such as <a href="http://leafletjs.com">Leaflet</a> and <a href="https://developers.google.com/maps/">Google Maps for developers</a>: the <code>optaplanner-webexamples-*.war</code> has an example which demonstrates such rendering:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./UseCasesAndExamples/RealExamples/vehicleRoutingLeafletAndGoogleMaps.png" alt="vehicleRoutingLeafletAndGoogleMaps">
</div>
</div>
<div class="paragraph">
<p>It is even possible to render the actual road routes with GraphHopper or Google Map Directions, but because of route overlaps on highways, it can become harder to see the standstill order:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./UseCasesAndExamples/RealExamples/vehicleRoutingGoogleMapsDirections.png" alt="vehicleRoutingGoogleMapsDirections">
</div>
</div>
<div class="paragraph">
<p>Take special care that the road costs between two points use the same optimization criteria as the one used in Planner.
For example, GraphHopper etc will by default return the fastest route, not the shortest route.
Don&#8217;t use the km (or miles) distances of the fastest GPS routes to optimize the shortest trip in Planner: this leads to a suboptimal solution as shown below:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./UseCasesAndExamples/RealExamples/roadDistanceTriangleInequality.png" alt="roadDistanceTriangleInequality">
</div>
</div>
<div class="paragraph">
<p>Contrary to popular belief, most users do not want the shortest route: they want the fastest route instead.
They prefer highways over normal roads.
They prefer normal roads over dirt roads.
In the real world, the fastest and shortest route are rarely the same.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="projectJobScheduling"><a class="anchor" href="#projectJobScheduling"></a><a class="link" href="#projectJobScheduling">3.3.4. Project Job Scheduling</a></h4>
<div class="sect4">
<h5 id="projectJobSchedulingProblemDescription"><a class="anchor" href="#projectJobSchedulingProblemDescription"></a><a class="link" href="#projectJobSchedulingProblemDescription">3.3.4.1. Problem Description</a></h5>
<div class="paragraph">
<p>Schedule all jobs in time and execution mode to minimize project delays.
Each job is part of a project.
A job can be executed in different ways: each way is an execution mode that implies a different duration but also different resource usages.
This is a form of flexible <em>job shop scheduling</em>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./UseCasesAndExamples/RealExamples/projectJobSchedulingUseCase.png" alt="projectJobSchedulingUseCase">
</div>
</div>
<div class="paragraph">
<p>Hard constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Job precedence: a job can only start when all its predecessor jobs are finished.</p>
</li>
<li>
<p>Resource capacity: do not use more resources than available.</p>
<div class="ulist">
<ul>
<li>
<p>Resources are local (shared between jobs of the same project) or global (shared between all jobs)</p>
</li>
<li>
<p>Resource are renewable (capacity available per day) or nonrenewable (capacity available for all days)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Medium constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Total project delay: minimize the duration (makespan) of each project.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Total makespan: minimize the duration of the whole multi-project schedule.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The problem is defined by <a href="http://gent.cs.kuleuven.be/mista2013challenge/">the MISTA 2013 challenge</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="projectJobSchedulingProblemSize"><a class="anchor" href="#projectJobSchedulingProblemSize"></a><a class="link" href="#projectJobSchedulingProblemSize">3.3.4.2. Problem Size</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>Schedule A-1  has  2 projects,  24 jobs,   64 execution modes,  7 resources and  150 resource requirements.
Schedule A-2  has  2 projects,  44 jobs,  124 execution modes,  7 resources and  420 resource requirements.
Schedule A-3  has  2 projects,  64 jobs,  184 execution modes,  7 resources and  630 resource requirements.
Schedule A-4  has  5 projects,  60 jobs,  160 execution modes, 16 resources and  390 resource requirements.
Schedule A-5  has  5 projects, 110 jobs,  310 execution modes, 16 resources and  900 resource requirements.
Schedule A-6  has  5 projects, 160 jobs,  460 execution modes, 16 resources and 1440 resource requirements.
Schedule A-7  has 10 projects, 120 jobs,  320 execution modes, 22 resources and  900 resource requirements.
Schedule A-8  has 10 projects, 220 jobs,  620 execution modes, 22 resources and 1860 resource requirements.
Schedule A-9  has 10 projects, 320 jobs,  920 execution modes, 31 resources and 2880 resource requirements.
Schedule A-10 has 10 projects, 320 jobs,  920 execution modes, 31 resources and 2970 resource requirements.
Schedule B-1  has 10 projects, 120 jobs,  320 execution modes, 31 resources and  900 resource requirements.
Schedule B-2  has 10 projects, 220 jobs,  620 execution modes, 22 resources and 1740 resource requirements.
Schedule B-3  has 10 projects, 320 jobs,  920 execution modes, 31 resources and 3060 resource requirements.
Schedule B-4  has 15 projects, 180 jobs,  480 execution modes, 46 resources and 1530 resource requirements.
Schedule B-5  has 15 projects, 330 jobs,  930 execution modes, 46 resources and 2760 resource requirements.
Schedule B-6  has 15 projects, 480 jobs, 1380 execution modes, 46 resources and 4500 resource requirements.
Schedule B-7  has 20 projects, 240 jobs,  640 execution modes, 61 resources and 1710 resource requirements.
Schedule B-8  has 20 projects, 440 jobs, 1240 execution modes, 42 resources and 3180 resource requirements.
Schedule B-9  has 20 projects, 640 jobs, 1840 execution modes, 61 resources and 5940 resource requirements.
Schedule B-10 has 20 projects, 460 jobs, 1300 execution modes, 42 resources and 4260 resource requirements.</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="bedAllocation"><a class="anchor" href="#bedAllocation"></a><a class="link" href="#bedAllocation">3.3.5. Hospital Bed Planning (PAS - Patient Admission Scheduling)</a></h4>
<div class="sect4">
<h5 id="bedAllocationProblemDescription"><a class="anchor" href="#bedAllocationProblemDescription"></a><a class="link" href="#bedAllocationProblemDescription">3.3.5.1. Problem Description</a></h5>
<div class="paragraph">
<p>Assign each patient (that will come to the hospital) into a bed for each night that the patient will stay in the hospital.
Each bed belongs to a room and each room belongs to a department.
The arrival and departure dates of the patients is fixed: only a bed needs to be assigned for each night.</p>
</div>
<div class="paragraph">
<p>This problem features <a href="#overconstrainedPlanning">overconstrained</a> datasets.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./UseCasesAndExamples/RealExamples/patientAdmissionScheduleUseCase.png" alt="patientAdmissionScheduleUseCase">
</div>
</div>
<div class="paragraph">
<p>Hard constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Two patients must not be assigned to the same bed in the same night. Weight: <code>-1000hard * conflictNightCount</code>.</p>
</li>
<li>
<p>A room can have a gender limitation: only females, only males, the same gender in the same night or no gender limitation at all. Weight: <code>-50hard * nightCount</code>.</p>
</li>
<li>
<p>A department can have a minimum or maximum age. Weight: <code>-100hard * nightCount</code>.</p>
</li>
<li>
<p>A patient can require a room with specific equipment(s). Weight: <code>-50hard * nightCount</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Medium constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Assign every patient to a bed, unless the dataset is overconstrained. Weight: <code>-1medium * nightCount</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A patient can prefer a maximum room size, for example if he/she wants a single room. Weight: <code>-8soft * nightCount</code>.</p>
</li>
<li>
<p>A patient is best assigned to a department that specializes in his/her problem. Weight: <code>-10soft * nightCount</code>.</p>
</li>
<li>
<p>A patient is best assigned to a room that specializes in his/her problem. Weight: <code>-20soft * nightCount</code>.</p>
<div class="ulist">
<ul>
<li>
<p>That room speciality should be priority 1. Weight: <code>-10soft * (priority - 1) * nightCount</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>A patient can prefer a room with specific equipment(s). Weight: <code>-20soft * nightCount</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The problem is a variant on <a href="https://people.cs.kuleuven.be/~wim.vancroonenburg/pas/">Kaho&#8217;s Patient Scheduling</a> and the datasets come from real world hospitals.</p>
</div>
</div>
<div class="sect4">
<h5 id="bedAllocationProblemSize"><a class="anchor" href="#bedAllocationProblemSize"></a><a class="link" href="#bedAllocationProblemSize">3.3.5.2. Problem Size</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>testdata01 has 4 specialisms, 2 equipments, 4 departments,  98 rooms, 286 beds, 14 nights,  652 patients and  652 admissions with a search space of 10^1601.
testdata02 has 6 specialisms, 2 equipments, 6 departments, 151 rooms, 465 beds, 14 nights,  755 patients and  755 admissions with a search space of 10^2013.
testdata03 has 5 specialisms, 2 equipments, 5 departments, 131 rooms, 395 beds, 14 nights,  708 patients and  708 admissions with a search space of 10^1838.
testdata04 has 6 specialisms, 2 equipments, 6 departments, 155 rooms, 471 beds, 14 nights,  746 patients and  746 admissions with a search space of 10^1994.
testdata05 has 4 specialisms, 2 equipments, 4 departments, 102 rooms, 325 beds, 14 nights,  587 patients and  587 admissions with a search space of 10^1474.
testdata06 has 4 specialisms, 2 equipments, 4 departments, 104 rooms, 313 beds, 14 nights,  685 patients and  685 admissions with a search space of 10^1709.
testdata07 has 6 specialisms, 4 equipments, 6 departments, 162 rooms, 472 beds, 14 nights,  519 patients and  519 admissions with a search space of 10^1387.
testdata08 has 6 specialisms, 4 equipments, 6 departments, 148 rooms, 441 beds, 21 nights,  895 patients and  895 admissions with a search space of 10^2366.
testdata09 has 4 specialisms, 4 equipments, 4 departments, 105 rooms, 310 beds, 28 nights, 1400 patients and 1400 admissions with a search space of 10^3487.
testdata10 has 4 specialisms, 4 equipments, 4 departments, 104 rooms, 308 beds, 56 nights, 1575 patients and 1575 admissions with a search space of 10^3919.
testdata11 has 4 specialisms, 4 equipments, 4 departments, 107 rooms, 318 beds, 91 nights, 2514 patients and 2514 admissions with a search space of 10^6291.
testdata12 has 4 specialisms, 4 equipments, 4 departments, 105 rooms, 310 beds, 84 nights, 2750 patients and 2750 admissions with a search space of 10^6851.
testdata13 has 5 specialisms, 4 equipments, 5 departments, 125 rooms, 368 beds, 28 nights,  907 patients and 1109 admissions with a search space of 10^2845.</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="bedAllocationDomainModel"><a class="anchor" href="#bedAllocationDomainModel"></a><a class="link" href="#bedAllocationDomainModel">3.3.5.3. Domain Model</a></h5>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./UseCasesAndExamples/RealExamples/hospitalBedAllocationClassDiagram.png" alt="hospitalBedAllocationClassDiagram">
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="taskAssigning"><a class="anchor" href="#taskAssigning"></a><a class="link" href="#taskAssigning">3.3.6. Task assigning</a></h4>
<div class="sect4">
<h5 id="taskAssigningProblemDescription"><a class="anchor" href="#taskAssigningProblemDescription"></a><a class="link" href="#taskAssigningProblemDescription">3.3.6.1. Problem Description</a></h5>
<div class="paragraph">
<p>Assign each task to a spot in an employee&#8217;s queue.
Each task has a duration which is affected by the employee&#8217;s affinity level with the task&#8217;s customer.</p>
</div>
<div class="paragraph">
<p>Hard constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Skill: Each task requires one or more skills. The employee must posses all these skills.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft level 0 constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Critical tasks: Complete critical tasks first, sooner than major and minor tasks.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft level 1 constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Minimize makespan: Reduce the time to complete all tasks.</p>
<div class="ulist">
<ul>
<li>
<p>Start with the longest working employee first, then the second longest working employee and so forth, to creates <a href="#fairnessScoreConstraints">fairness and load balancing</a>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft level 2 constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Major tasks: Complete major tasks as soon as possible, sooner than minor tasks.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft level 3 constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Minor tasks: Complete minor tasks as soon as possible.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="taskAssigningProblemSize"><a class="anchor" href="#taskAssigningProblemSize"></a><a class="link" href="#taskAssigningProblemSize">3.3.6.2. Problem Size</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>24tasks-8employees   has  24 tasks, 6 skills,  8 employees,   4 task types and  4 customers with a search space of   10^40.
50tasks-5employees   has  50 tasks, 5 skills,  5 employees,  10 task types and 10 customers with a search space of   10^91.
100tasks-5employees  has 100 tasks, 5 skills,  5 employees,  20 task types and 15 customers with a search space of  10^207.
500tasks-20employees has 500 tasks, 6 skills, 20 employees, 100 task types and 60 customers with a search space of 10^1384.</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="taskAssigningDomainModel"><a class="anchor" href="#taskAssigningDomainModel"></a><a class="link" href="#taskAssigningDomainModel">3.3.6.3. Domain Model</a></h5>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./UseCasesAndExamples/RealExamples/taskAssigningClassDiagram.png" alt="taskAssigningClassDiagram">
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="difficultExamples"><a class="anchor" href="#difficultExamples"></a><a class="link" href="#difficultExamples">3.4. Difficult Examples</a></h3>
<div class="sect3">
<h4 id="examination"><a class="anchor" href="#examination"></a><a class="link" href="#examination">3.4.1. Exam Timetabling (ITC 2007 track 1 - Examination)</a></h4>
<div class="sect4">
<h5 id="examinationProblemDescription"><a class="anchor" href="#examinationProblemDescription"></a><a class="link" href="#examinationProblemDescription">3.4.1.1. Problem Description</a></h5>
<div class="paragraph">
<p>Schedule each exam into a period and into a room.
Multiple exams can share the same room during the same period.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./UseCasesAndExamples/DifficultExamples/examinationTimetablingUseCase.png" alt="examinationTimetablingUseCase">
</div>
</div>
<div class="paragraph">
<p>Hard constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Exam conflict: two exams that share students must not occur in the same period.</p>
</li>
<li>
<p>Room capacity: A room&#8217;s seating capacity must suffice at all times.</p>
</li>
<li>
<p>Period duration: A period&#8217;s duration must suffice for all of its exams.</p>
</li>
<li>
<p>Period related hard constraints (specified per dataset):</p>
<div class="ulist">
<ul>
<li>
<p>Coincidence: two specified exams must use the same period (but possibly another room).</p>
</li>
<li>
<p>Exclusion: two specified exams must not use the same period.</p>
</li>
<li>
<p>After: A specified exam must occur in a period after another specified exam&#8217;s period.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Room related hard constraints (specified per dataset):</p>
<div class="ulist">
<ul>
<li>
<p>Exclusive: one specified exam should not have to share its room with any other exam.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft constraints (each of which has a parametrized penalty):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The same student should not have two exams in a row.</p>
</li>
<li>
<p>The same student should not have two exams on the same day.</p>
</li>
<li>
<p>Period spread: two exams that share students should be a number of periods apart.</p>
</li>
<li>
<p>Mixed durations: two exams that share a room should not have different durations.</p>
</li>
<li>
<p>Front load: Large exams should be scheduled earlier in the schedule.</p>
</li>
<li>
<p>Period penalty (specified per dataset): Some periods have a penalty when used.</p>
</li>
<li>
<p>Room penalty (specified per dataset): Some rooms have a penalty when used.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It uses large test data sets of real-life universities.</p>
</div>
<div class="paragraph">
<p>The problem is defined by <a href="http://www.cs.qub.ac.uk/itc2007/examtrack/exam_track_index.htm">the International Timetabling Competition 2007 track 1</a>.
Geoffrey De Smet finished 4th in that competition with a very early version of Planner.
Many improvements have been made since then.</p>
</div>
</div>
<div class="sect4">
<h5 id="examinationProblemSize"><a class="anchor" href="#examinationProblemSize"></a><a class="link" href="#examinationProblemSize">3.4.1.2. Problem Size</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>exam_comp_set1 has  7883 students,  607 exams, 54 periods,  7 rooms,  12 period constraints and  0 room constraints with a search space of 10^1564.
exam_comp_set2 has 12484 students,  870 exams, 40 periods, 49 rooms,  12 period constraints and  2 room constraints with a search space of 10^2864.
exam_comp_set3 has 16365 students,  934 exams, 36 periods, 48 rooms, 168 period constraints and 15 room constraints with a search space of 10^3023.
exam_comp_set4 has  4421 students,  273 exams, 21 periods,  1 rooms,  40 period constraints and  0 room constraints with a search space of  10^360.
exam_comp_set5 has  8719 students, 1018 exams, 42 periods,  3 rooms,  27 period constraints and  0 room constraints with a search space of 10^2138.
exam_comp_set6 has  7909 students,  242 exams, 16 periods,  8 rooms,  22 period constraints and  0 room constraints with a search space of  10^509.
exam_comp_set7 has 13795 students, 1096 exams, 80 periods, 15 rooms,  28 period constraints and  0 room constraints with a search space of 10^3374.
exam_comp_set8 has  7718 students,  598 exams, 80 periods,  8 rooms,  20 period constraints and  1 room constraints with a search space of 10^1678.</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="examinationDomainModel"><a class="anchor" href="#examinationDomainModel"></a><a class="link" href="#examinationDomainModel">3.4.1.3. Domain Model</a></h5>
<div class="paragraph">
<p>Below you can see the main examination domain classes:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./UseCasesAndExamples/DifficultExamples/examinationDomainDiagram.png" alt="examinationDomainDiagram">
</div>
<div class="title">Figure 3. Examination Domain Class Diagram</div>
</div>
<div class="paragraph">
<p>Notice that we&#8217;ve split up the exam concept into an <code>Exam</code> class and a <code>Topic</code> class.
The <code>Exam</code> instances change during solving (this is the planning entity class), when their period or room property changes.
The <code>Topic</code>, <code>Period</code> and <code>Room</code> instances never change during solving (these are problem facts, just like some other classes).</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="employeeRostering"><a class="anchor" href="#employeeRostering"></a><a class="link" href="#employeeRostering">3.4.2. Employee Rostering (INRC 2010 - Nurse Rostering)</a></h4>
<div class="sect4">
<h5 id="employeeRosteringProblemDescription"><a class="anchor" href="#employeeRosteringProblemDescription"></a><a class="link" href="#employeeRosteringProblemDescription">3.4.2.1. Problem Description</a></h5>
<div class="paragraph">
<p>For each shift, assign a nurse to work that shift.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./UseCasesAndExamples/DifficultExamples/employeeShiftRosteringUseCase.png" alt="employeeShiftRosteringUseCase">
</div>
</div>
<div class="paragraph">
<p>Hard constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>No unassigned shifts</strong> (built-in): Every shift need to be assigned to an employee.</p>
</li>
<li>
<p><strong>Shift conflict</strong>: An employee can have only one shift per day.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Contract obligations. The business frequently violates these, so they decided to define these as soft constraints instead of hard constraints.</p>
<div class="ulist">
<ul>
<li>
<p><strong>Minimum and maximum assignments</strong>: Each employee needs to work more than x shifts and less than y shifts (depending on their contract).</p>
</li>
<li>
<p><strong>Minimum and maximum consecutive working days</strong>: Each employee needs to work between x and y days in a row (depending on their contract).</p>
</li>
<li>
<p><strong>Minimum and maximum consecutive free days</strong>: Each employee needs to be free between x and y days in a row (depending on their contract).</p>
</li>
<li>
<p><strong>Minimum and maximum consecutive working weekends</strong>: Each employee needs to work between x and y weekends in a row (depending on their contract).</p>
</li>
<li>
<p><strong>Complete weekends</strong>: Each employee needs to work every day in a weekend or not at all.</p>
</li>
<li>
<p><strong>Identical shift types during weekend</strong>: Each weekend shift for the same weekend of the same employee must be the same shift type.</p>
</li>
<li>
<p><strong>Unwanted patterns</strong>: A combination of unwanted shift types in a row. For example: a late shift followed by an early shift followed by a late shift.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Employee wishes:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Day on request</strong>: An employee wants to work on a specific day.</p>
</li>
<li>
<p><strong>Day off request</strong>: An employee does not want to work on a specific day.</p>
</li>
<li>
<p><strong>Shift on request</strong>: An employee wants to be assigned to a specific shift.</p>
</li>
<li>
<p><strong>Shift off request</strong>: An employee does not want to be assigned to a specific shift.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Alternative skill</strong>: An employee assigned to a skill should have a proficiency in every skill required by that shift.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The problem is defined by <a href="http://www.kuleuven-kortrijk.be/nrpcompetition">the International Nurse Rostering Competition 2010</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="employeeRosteringValueProposition"><a class="anchor" href="#employeeRosteringValueProposition"></a><a class="link" href="#employeeRosteringValueProposition">3.4.2.2. Value Proposition</a></h5>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./UseCasesAndExamples/DifficultExamples/employeeRosteringValueProposition.png" alt="employeeRosteringValueProposition">
</div>
</div>
</div>
<div class="sect4">
<h5 id="employeeRosteringProblemSize"><a class="anchor" href="#employeeRosteringProblemSize"></a><a class="link" href="#employeeRosteringProblemSize">3.4.2.3. Problem Size</a></h5>
<div class="paragraph">
<p>There are three dataset types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>sprint: must be solved in seconds.</p>
</li>
<li>
<p>medium: must be solved in minutes.</p>
</li>
<li>
<p>long: must be solved in hours.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>toy1          has 1 skills, 3 shiftTypes, 2 patterns, 1 contracts,  6 employees,  7 shiftDates,  35 shiftAssignments and   0 requests with a search space of   10^27.
toy2          has 1 skills, 3 shiftTypes, 3 patterns, 2 contracts, 20 employees, 28 shiftDates, 180 shiftAssignments and 140 requests with a search space of  10^234.

sprint01      has 1 skills, 4 shiftTypes, 3 patterns, 4 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint02      has 1 skills, 4 shiftTypes, 3 patterns, 4 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint03      has 1 skills, 4 shiftTypes, 3 patterns, 4 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint04      has 1 skills, 4 shiftTypes, 3 patterns, 4 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint05      has 1 skills, 4 shiftTypes, 3 patterns, 4 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint06      has 1 skills, 4 shiftTypes, 3 patterns, 4 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint07      has 1 skills, 4 shiftTypes, 3 patterns, 4 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint08      has 1 skills, 4 shiftTypes, 3 patterns, 4 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint09      has 1 skills, 4 shiftTypes, 3 patterns, 4 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint10      has 1 skills, 4 shiftTypes, 3 patterns, 4 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint_hint01 has 1 skills, 4 shiftTypes, 8 patterns, 3 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint_hint02 has 1 skills, 4 shiftTypes, 0 patterns, 3 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint_hint03 has 1 skills, 4 shiftTypes, 8 patterns, 3 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint_late01 has 1 skills, 4 shiftTypes, 8 patterns, 3 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint_late02 has 1 skills, 3 shiftTypes, 4 patterns, 3 contracts, 10 employees, 28 shiftDates, 144 shiftAssignments and 139 requests with a search space of  10^144.
sprint_late03 has 1 skills, 4 shiftTypes, 8 patterns, 3 contracts, 10 employees, 28 shiftDates, 160 shiftAssignments and 150 requests with a search space of  10^160.
sprint_late04 has 1 skills, 4 shiftTypes, 8 patterns, 3 contracts, 10 employees, 28 shiftDates, 160 shiftAssignments and 150 requests with a search space of  10^160.
sprint_late05 has 1 skills, 4 shiftTypes, 8 patterns, 3 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint_late06 has 1 skills, 4 shiftTypes, 0 patterns, 3 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint_late07 has 1 skills, 4 shiftTypes, 0 patterns, 3 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint_late08 has 1 skills, 4 shiftTypes, 0 patterns, 3 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and   0 requests with a search space of  10^152.
sprint_late09 has 1 skills, 4 shiftTypes, 0 patterns, 3 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and   0 requests with a search space of  10^152.
sprint_late10 has 1 skills, 4 shiftTypes, 0 patterns, 3 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.

medium01      has 1 skills, 4 shiftTypes, 0 patterns, 4 contracts, 31 employees, 28 shiftDates, 608 shiftAssignments and 403 requests with a search space of  10^906.
medium02      has 1 skills, 4 shiftTypes, 0 patterns, 4 contracts, 31 employees, 28 shiftDates, 608 shiftAssignments and 403 requests with a search space of  10^906.
medium03      has 1 skills, 4 shiftTypes, 0 patterns, 4 contracts, 31 employees, 28 shiftDates, 608 shiftAssignments and 403 requests with a search space of  10^906.
medium04      has 1 skills, 4 shiftTypes, 0 patterns, 4 contracts, 31 employees, 28 shiftDates, 608 shiftAssignments and 403 requests with a search space of  10^906.
medium05      has 1 skills, 4 shiftTypes, 0 patterns, 4 contracts, 31 employees, 28 shiftDates, 608 shiftAssignments and 403 requests with a search space of  10^906.
medium_hint01 has 1 skills, 4 shiftTypes, 7 patterns, 4 contracts, 30 employees, 28 shiftDates, 428 shiftAssignments and 390 requests with a search space of  10^632.
medium_hint02 has 1 skills, 4 shiftTypes, 7 patterns, 3 contracts, 30 employees, 28 shiftDates, 428 shiftAssignments and 390 requests with a search space of  10^632.
medium_hint03 has 1 skills, 4 shiftTypes, 7 patterns, 4 contracts, 30 employees, 28 shiftDates, 428 shiftAssignments and 390 requests with a search space of  10^632.
medium_late01 has 1 skills, 4 shiftTypes, 7 patterns, 4 contracts, 30 employees, 28 shiftDates, 424 shiftAssignments and 390 requests with a search space of  10^626.
medium_late02 has 1 skills, 4 shiftTypes, 7 patterns, 3 contracts, 30 employees, 28 shiftDates, 428 shiftAssignments and 390 requests with a search space of  10^632.
medium_late03 has 1 skills, 4 shiftTypes, 0 patterns, 4 contracts, 30 employees, 28 shiftDates, 428 shiftAssignments and 390 requests with a search space of  10^632.
medium_late04 has 1 skills, 4 shiftTypes, 7 patterns, 3 contracts, 30 employees, 28 shiftDates, 416 shiftAssignments and 390 requests with a search space of  10^614.
medium_late05 has 2 skills, 5 shiftTypes, 7 patterns, 4 contracts, 30 employees, 28 shiftDates, 452 shiftAssignments and 390 requests with a search space of  10^667.

long01        has 2 skills, 5 shiftTypes, 3 patterns, 3 contracts, 49 employees, 28 shiftDates, 740 shiftAssignments and 735 requests with a search space of 10^1250.
long02        has 2 skills, 5 shiftTypes, 3 patterns, 3 contracts, 49 employees, 28 shiftDates, 740 shiftAssignments and 735 requests with a search space of 10^1250.
long03        has 2 skills, 5 shiftTypes, 3 patterns, 3 contracts, 49 employees, 28 shiftDates, 740 shiftAssignments and 735 requests with a search space of 10^1250.
long04        has 2 skills, 5 shiftTypes, 3 patterns, 3 contracts, 49 employees, 28 shiftDates, 740 shiftAssignments and 735 requests with a search space of 10^1250.
long05        has 2 skills, 5 shiftTypes, 3 patterns, 3 contracts, 49 employees, 28 shiftDates, 740 shiftAssignments and 735 requests with a search space of 10^1250.
long_hint01   has 2 skills, 5 shiftTypes, 9 patterns, 3 contracts, 50 employees, 28 shiftDates, 740 shiftAssignments and   0 requests with a search space of 10^1257.
long_hint02   has 2 skills, 5 shiftTypes, 7 patterns, 3 contracts, 50 employees, 28 shiftDates, 740 shiftAssignments and   0 requests with a search space of 10^1257.
long_hint03   has 2 skills, 5 shiftTypes, 7 patterns, 3 contracts, 50 employees, 28 shiftDates, 740 shiftAssignments and   0 requests with a search space of 10^1257.
long_late01   has 2 skills, 5 shiftTypes, 9 patterns, 3 contracts, 50 employees, 28 shiftDates, 752 shiftAssignments and   0 requests with a search space of 10^1277.
long_late02   has 2 skills, 5 shiftTypes, 9 patterns, 4 contracts, 50 employees, 28 shiftDates, 752 shiftAssignments and   0 requests with a search space of 10^1277.
long_late03   has 2 skills, 5 shiftTypes, 9 patterns, 3 contracts, 50 employees, 28 shiftDates, 752 shiftAssignments and   0 requests with a search space of 10^1277.
long_late04   has 2 skills, 5 shiftTypes, 9 patterns, 4 contracts, 50 employees, 28 shiftDates, 752 shiftAssignments and   0 requests with a search space of 10^1277.
long_late05   has 2 skills, 5 shiftTypes, 9 patterns, 3 contracts, 50 employees, 28 shiftDates, 740 shiftAssignments and   0 requests with a search space of 10^1257.</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="employeeRosteringDomainModel"><a class="anchor" href="#employeeRosteringDomainModel"></a><a class="link" href="#employeeRosteringDomainModel">3.4.2.4. Domain Model</a></h5>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./UseCasesAndExamples/DifficultExamples/employeeShiftRosteringClassDiagram.png" alt="employeeShiftRosteringClassDiagram">
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="travelingTournament"><a class="anchor" href="#travelingTournament"></a><a class="link" href="#travelingTournament">3.4.3. Traveling Tournament Problem (TTP)</a></h4>
<div class="sect4">
<h5 id="travelingTournamentProblemDescription"><a class="anchor" href="#travelingTournamentProblemDescription"></a><a class="link" href="#travelingTournamentProblemDescription">3.4.3.1. Problem Description</a></h5>
<div class="paragraph">
<p>Schedule matches between <em>n</em> teams.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./UseCasesAndExamples/DifficultExamples/travelingTournamentUseCase.png" alt="travelingTournamentUseCase">
</div>
</div>
<div class="paragraph">
<p>Hard constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each team plays twice against every other team: once home and once away.</p>
</li>
<li>
<p>Each team has exactly one match on each timeslot.</p>
</li>
<li>
<p>No team must have more than three consecutive home or three consecutive away matches.</p>
</li>
<li>
<p>No repeaters: no two consecutive matches of the same two opposing teams.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Minimize the total distance traveled by all teams.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The problem is defined on <a href="http://mat.gsia.cmu.edu/TOURN/">Michael Trick&#8217;s website (which contains the world records too)</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="travelingTournamentProblemSize"><a class="anchor" href="#travelingTournamentProblemSize"></a><a class="link" href="#travelingTournamentProblemSize">3.4.3.2. Problem Size</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>1-nl04     has  6 days,  4 teams and   12 matches with a search space of    10^9.
1-nl06     has 10 days,  6 teams and   30 matches with a search space of   10^30.
1-nl08     has 14 days,  8 teams and   56 matches with a search space of   10^64.
1-nl10     has 18 days, 10 teams and   90 matches with a search space of  10^112.
1-nl12     has 22 days, 12 teams and  132 matches with a search space of  10^177.
1-nl14     has 26 days, 14 teams and  182 matches with a search space of  10^257.
1-nl16     has 30 days, 16 teams and  240 matches with a search space of  10^354.
2-bra24    has 46 days, 24 teams and  552 matches with a search space of  10^917.
3-nfl16    has 30 days, 16 teams and  240 matches with a search space of  10^354.
3-nfl18    has 34 days, 18 teams and  306 matches with a search space of  10^468.
3-nfl20    has 38 days, 20 teams and  380 matches with a search space of  10^600.
3-nfl22    has 42 days, 22 teams and  462 matches with a search space of  10^749.
3-nfl24    has 46 days, 24 teams and  552 matches with a search space of  10^917.
3-nfl26    has 50 days, 26 teams and  650 matches with a search space of 10^1104.
3-nfl28    has 54 days, 28 teams and  756 matches with a search space of 10^1309.
3-nfl30    has 58 days, 30 teams and  870 matches with a search space of 10^1534.
3-nfl32    has 62 days, 32 teams and  992 matches with a search space of 10^1778.
4-super04  has  6 days,  4 teams and   12 matches with a search space of    10^9.
4-super06  has 10 days,  6 teams and   30 matches with a search space of   10^30.
4-super08  has 14 days,  8 teams and   56 matches with a search space of   10^64.
4-super10  has 18 days, 10 teams and   90 matches with a search space of  10^112.
4-super12  has 22 days, 12 teams and  132 matches with a search space of  10^177.
4-super14  has 26 days, 14 teams and  182 matches with a search space of  10^257.
5-galaxy04 has  6 days,  4 teams and   12 matches with a search space of    10^9.
5-galaxy06 has 10 days,  6 teams and   30 matches with a search space of   10^30.
5-galaxy08 has 14 days,  8 teams and   56 matches with a search space of   10^64.
5-galaxy10 has 18 days, 10 teams and   90 matches with a search space of  10^112.
5-galaxy12 has 22 days, 12 teams and  132 matches with a search space of  10^177.
5-galaxy14 has 26 days, 14 teams and  182 matches with a search space of  10^257.
5-galaxy16 has 30 days, 16 teams and  240 matches with a search space of  10^354.
5-galaxy18 has 34 days, 18 teams and  306 matches with a search space of  10^468.
5-galaxy20 has 38 days, 20 teams and  380 matches with a search space of  10^600.
5-galaxy22 has 42 days, 22 teams and  462 matches with a search space of  10^749.
5-galaxy24 has 46 days, 24 teams and  552 matches with a search space of  10^917.
5-galaxy26 has 50 days, 26 teams and  650 matches with a search space of 10^1104.
5-galaxy28 has 54 days, 28 teams and  756 matches with a search space of 10^1309.
5-galaxy30 has 58 days, 30 teams and  870 matches with a search space of 10^1534.
5-galaxy32 has 62 days, 32 teams and  992 matches with a search space of 10^1778.
5-galaxy34 has 66 days, 34 teams and 1122 matches with a search space of 10^2041.
5-galaxy36 has 70 days, 36 teams and 1260 matches with a search space of 10^2324.
5-galaxy38 has 74 days, 38 teams and 1406 matches with a search space of 10^2628.
5-galaxy40 has 78 days, 40 teams and 1560 matches with a search space of 10^2951.</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cheapTimeScheduling"><a class="anchor" href="#cheapTimeScheduling"></a><a class="link" href="#cheapTimeScheduling">3.4.4. Cheap Time Scheduling</a></h4>
<div class="sect4">
<h5 id="cheapTimeSchedulingProblemDescription"><a class="anchor" href="#cheapTimeSchedulingProblemDescription"></a><a class="link" href="#cheapTimeSchedulingProblemDescription">3.4.4.1. Problem Description</a></h5>
<div class="paragraph">
<p>Schedule all tasks in time and on a machine to minimize power cost.
Power prices differs in time.
This is a form of <em>job shop scheduling</em>.</p>
</div>
<div class="paragraph">
<p>Hard constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Start time limits: each task must start between its earliest start and latest start limit.</p>
</li>
<li>
<p>Maximum capacity: the maximum capacity for each resource for each machine must not be exceeded.</p>
</li>
<li>
<p>Startup and shutdown: each machine must be active in the periods during which it has assigned tasks. Between tasks it is allowed to be idle to avoid startup and shutdown costs.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Medium constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Power cost: minimize the total power cost of the whole schedule.</p>
<div class="ulist">
<ul>
<li>
<p>Machine power cost: Each active or idle machine consumes power, which infers a power cost (depending on the power price during that time).</p>
</li>
<li>
<p>Task power cost: Each task consumes power too, which infers a power cost (depending on the power price during its time).</p>
</li>
<li>
<p>Machine startup and shutdown cost: Every time a machine starts up or shuts down, an extra cost is inflicted.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft constraints (addendum to the original problem definition):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Start early: prefer starting a task sooner rather than later.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The problem is defined by <a href="http://iconchallenge.insight-centre.org/">the ICON challenge</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="cheapTimeSchedulingProblemSize"><a class="anchor" href="#cheapTimeSchedulingProblemSize"></a><a class="link" href="#cheapTimeSchedulingProblemSize">3.4.4.2. Problem Size</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>sample01   has 3 resources,   2 machines, 288 periods and   25 tasks with a search space of    10^53.
sample02   has 3 resources,   2 machines, 288 periods and   50 tasks with a search space of   10^114.
sample03   has 3 resources,   2 machines, 288 periods and  100 tasks with a search space of   10^226.
sample04   has 3 resources,   5 machines, 288 periods and  100 tasks with a search space of   10^266.
sample05   has 3 resources,   2 machines, 288 periods and  250 tasks with a search space of   10^584.
sample06   has 3 resources,   5 machines, 288 periods and  250 tasks with a search space of   10^673.
sample07   has 3 resources,   2 machines, 288 periods and 1000 tasks with a search space of  10^2388.
sample08   has 3 resources,   5 machines, 288 periods and 1000 tasks with a search space of  10^2748.
sample09   has 4 resources,  20 machines, 288 periods and 2000 tasks with a search space of  10^6668.
instance00 has 1 resources,  10 machines, 288 periods and  200 tasks with a search space of   10^595.
instance01 has 1 resources,  10 machines, 288 periods and  200 tasks with a search space of   10^599.
instance02 has 1 resources,  10 machines, 288 periods and  200 tasks with a search space of   10^599.
instance03 has 1 resources,  10 machines, 288 periods and  200 tasks with a search space of   10^591.
instance04 has 1 resources,  10 machines, 288 periods and  200 tasks with a search space of   10^590.
instance05 has 2 resources,  25 machines, 288 periods and  200 tasks with a search space of   10^667.
instance06 has 2 resources,  25 machines, 288 periods and  200 tasks with a search space of   10^660.
instance07 has 2 resources,  25 machines, 288 periods and  200 tasks with a search space of   10^662.
instance08 has 2 resources,  25 machines, 288 periods and  200 tasks with a search space of   10^651.
instance09 has 2 resources,  25 machines, 288 periods and  200 tasks with a search space of   10^659.
instance10 has 2 resources,  20 machines, 288 periods and  500 tasks with a search space of  10^1657.
instance11 has 2 resources,  20 machines, 288 periods and  500 tasks with a search space of  10^1644.
instance12 has 2 resources,  20 machines, 288 periods and  500 tasks with a search space of  10^1637.
instance13 has 2 resources,  20 machines, 288 periods and  500 tasks with a search space of  10^1659.
instance14 has 2 resources,  20 machines, 288 periods and  500 tasks with a search space of  10^1643.
instance15 has 3 resources,  40 machines, 288 periods and  500 tasks with a search space of  10^1782.
instance16 has 3 resources,  40 machines, 288 periods and  500 tasks with a search space of  10^1778.
instance17 has 3 resources,  40 machines, 288 periods and  500 tasks with a search space of  10^1764.
instance18 has 3 resources,  40 machines, 288 periods and  500 tasks with a search space of  10^1769.
instance19 has 3 resources,  40 machines, 288 periods and  500 tasks with a search space of  10^1778.
instance20 has 3 resources,  50 machines, 288 periods and 1000 tasks with a search space of  10^3689.
instance21 has 3 resources,  50 machines, 288 periods and 1000 tasks with a search space of  10^3678.
instance22 has 3 resources,  50 machines, 288 periods and 1000 tasks with a search space of  10^3706.
instance23 has 3 resources,  50 machines, 288 periods and 1000 tasks with a search space of  10^3676.
instance24 has 3 resources,  50 machines, 288 periods and 1000 tasks with a search space of  10^3681.
instance25 has 3 resources,  60 machines, 288 periods and 1000 tasks with a search space of  10^3774.
instance26 has 3 resources,  60 machines, 288 periods and 1000 tasks with a search space of  10^3737.
instance27 has 3 resources,  60 machines, 288 periods and 1000 tasks with a search space of  10^3744.
instance28 has 3 resources,  60 machines, 288 periods and 1000 tasks with a search space of  10^3731.
instance29 has 3 resources,  60 machines, 288 periods and 1000 tasks with a search space of  10^3746.
instance30 has 4 resources,  70 machines, 288 periods and 2000 tasks with a search space of  10^7718.
instance31 has 4 resources,  70 machines, 288 periods and 2000 tasks with a search space of  10^7740.
instance32 has 4 resources,  70 machines, 288 periods and 2000 tasks with a search space of  10^7686.
instance33 has 4 resources,  70 machines, 288 periods and 2000 tasks with a search space of  10^7672.
instance34 has 4 resources,  70 machines, 288 periods and 2000 tasks with a search space of  10^7695.
instance35 has 4 resources,  80 machines, 288 periods and 2000 tasks with a search space of  10^7807.
instance36 has 4 resources,  80 machines, 288 periods and 2000 tasks with a search space of  10^7814.
instance37 has 4 resources,  80 machines, 288 periods and 2000 tasks with a search space of  10^7764.
instance38 has 4 resources,  80 machines, 288 periods and 2000 tasks with a search space of  10^7736.
instance39 has 4 resources,  80 machines, 288 periods and 2000 tasks with a search space of  10^7783.
instance40 has 4 resources,  90 machines, 288 periods and 4000 tasks with a search space of 10^15976.
instance41 has 4 resources,  90 machines, 288 periods and 4000 tasks with a search space of 10^15935.
instance42 has 4 resources,  90 machines, 288 periods and 4000 tasks with a search space of 10^15887.
instance43 has 4 resources,  90 machines, 288 periods and 4000 tasks with a search space of 10^15896.
instance44 has 4 resources,  90 machines, 288 periods and 4000 tasks with a search space of 10^15885.
instance45 has 4 resources, 100 machines, 288 periods and 5000 tasks with a search space of 10^20173.
instance46 has 4 resources, 100 machines, 288 periods and 5000 tasks with a search space of 10^20132.
instance47 has 4 resources, 100 machines, 288 periods and 5000 tasks with a search space of 10^20126.
instance48 has 4 resources, 100 machines, 288 periods and 5000 tasks with a search space of 10^20110.
instance49 has 4 resources, 100 machines, 288 periods and 5000 tasks with a search space of 10^20078.</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="investment"><a class="anchor" href="#investment"></a><a class="link" href="#investment">3.4.5. Investment asset class allocation (portfolio optimization)</a></h4>
<div class="sect4">
<h5 id="investmentProblemDescription"><a class="anchor" href="#investmentProblemDescription"></a><a class="link" href="#investmentProblemDescription">3.4.5.1. Problem Description</a></h5>
<div class="paragraph">
<p>Decide the relative quantity to invest in each asset class.</p>
</div>
<div class="paragraph">
<p>Hard constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Risk maximum: the total standard deviation must not be higher than the standard deviation maximum.</p>
<div class="ulist">
<ul>
<li>
<p>Total standard deviation calculation takes asset class correlations into account by applying <a href="https://en.wikipedia.org/wiki/Modern_portfolio_theory">Markowitz Portfolio Theory</a>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Region maximum: Each region has a quantity maximum.</p>
</li>
<li>
<p>Sector maximum: Each sector has a quantity maximum.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Maximize expected return.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="investmentProblemSize"><a class="anchor" href="#investmentProblemSize"></a><a class="link" href="#investmentProblemSize">3.4.5.2. Problem Size</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>de_smet_1 has 1 regions, 3 sectors and 11 asset classes with a search space of 10^4.
irrinki_1 has 2 regions, 3 sectors and 6 asset classes with a search space of 10^3.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Larger datasets have not been created or tested yet, but should not pose a problem.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="plannerConfiguration"><a class="anchor" href="#plannerConfiguration"></a><a class="link" href="#plannerConfiguration">4. Planner Configuration</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="plannerConfigurationOverview"><a class="anchor" href="#plannerConfigurationOverview"></a><a class="link" href="#plannerConfigurationOverview">4.1. Overview</a></h3>
<div class="paragraph">
<p>Solving a planning problem with Planner consists of the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Model your planning problem</strong> as a class that implements the interface <code>Solution</code>, for example the class <code>NQueens</code>.</p>
</li>
<li>
<p><strong>Configure a <code></strong>Solver<strong></code></strong>, for example a First Fit and Tabu Search solver for any <code>NQueens</code> instance.</p>
</li>
<li>
<p><strong>Load a problem data set</strong> from your data layer, for example a Four Queens instance. That is the planning problem.</p>
</li>
<li>
<p><strong>Solve it</strong> with <code>Solver.solve(planningProblem)</code> which returns the best solution found.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./PlannerConfiguration/inputOutputOverview.png" alt="inputOutputOverview">
</div>
</div>
</div>
<div class="sect2">
<h3 id="solverConfiguration"><a class="anchor" href="#solverConfiguration"></a><a class="link" href="#solverConfiguration">4.2. Solver Configuration</a></h3>
<div class="sect3">
<h4 id="solverConfigurationByXML"><a class="anchor" href="#solverConfigurationByXML"></a><a class="link" href="#solverConfigurationByXML">4.2.1. Solver Configuration by XML</a></h4>
<div class="paragraph">
<p>Build a <code>Solver</code> instance with the <code>SolverFactory</code>.
Configure the <code>SolverFactory</code> with a solver configuration XML file, provided as a classpath resource (as definied by <code>ClassLoader.getResource()</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">       SolverFactory&lt;NQueens&gt; solverFactory = SolverFactory.createFromXmlResource(
               "org/optaplanner/examples/nqueens/solver/nqueensSolverConfig.xml");
       Solver&lt;NQueens&gt; solver = solverFactory.buildSolver();</code></pre>
</div>
</div>
<div class="paragraph">
<p>In a typical project (following the Maven directory structure), that solverConfig XML file would be located at <code>$PROJECT_DIR/src/main/resources/org/optaplanner/examples/nqueens/solver/nqueensSolverConfig.xml</code>.
Alternatively, a <code>SolverFactory</code> can be created from a <code>File</code>, an <code>InputStream</code> or a <code>Reader</code> with methods such as <code>SolverFactory.createFromXmlFile()</code>.
However, for portability reasons, a classpath resource is recommended.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>On some environments (<a href="#integrationWithOSGi">OSGi</a>, <a href="#integrationWithJBossModules">JBoss modules</a>, &#8230;&#8203;), classpath resources (such as the solver config, score DRL&#8217;s and domain classes) in your jars might not be available to the default <code>ClassLoader</code> of the <code>optaplanner-core</code> jar.
In those cases, provide the <code>ClassLoader</code> of your classes as a parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">       SolverFactory&lt;NQueens&gt; solverFactory = SolverFactory.createFromXmlResource(
               ".../nqueensSolverConfig.xml", getClass().getClassLoader());</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When using Workbench or Execution Server or to take advantage of Drools&#8217;s <code>KieContainer</code> features, provide the <code>KieContainer</code> as a parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">       KieServices kieServices = KieServices.Factory.get();
       KieContainer kieContainer = kieServices.newKieContainer(
               kieServices.newReleaseId("org.nqueens", "nqueens", "1.0.0"));
       SolverFactory&lt;NQueens&gt; solverFactory = SolverFactory.createFromKieContainerXmlResource(
               kieContainer, ".../nqueensSolverConfig.xml");</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also use <a href="#droolsScoreCalculationKsessionName">a ksessionName in the solver configuration</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Both a <code>Solver</code> and a <code>SolverFactory</code> have a generic type called <code>Solution_</code>, which is the class representing a <a href="#planningProblemAndPlanningSolution">planning problem and solution</a>.</p>
</div>
<div class="paragraph">
<p>A solver configuration XML file looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;solver&gt;
  &lt;!-- Define the model --&gt;
  &lt;solutionClass&gt;org.optaplanner.examples.nqueens.domain.NQueens&lt;/solutionClass&gt;
  &lt;entityClass&gt;org.optaplanner.examples.nqueens.domain.Queen&lt;/entityClass&gt;

  &lt;!-- Define the score function --&gt;
  &lt;scoreDirectorFactory&gt;
    &lt;scoreDrl&gt;org/optaplanner/examples/nqueens/solver/nQueensScoreRules.drl&lt;/scoreDrl&gt;
  &lt;/scoreDirectorFactory&gt;

  &lt;!-- Configure the optimization algorithms (optional) --&gt;
  &lt;termination&gt;
    ...
  &lt;/termination&gt;
  &lt;constructionHeuristic&gt;
    ...
  &lt;/constructionHeuristic&gt;
  &lt;localSearch&gt;
    ...
  &lt;/localSearch&gt;
&lt;/solver&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the three parts in it:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Define the model.</p>
</li>
<li>
<p>Define the score function.</p>
</li>
<li>
<p>Optionally configure the optimization algorithm(s).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These various parts of a configuration are explained further in this manual.</p>
</div>
<div class="paragraph">
<p><strong>Planner makes it relatively easy to switch optimization algorithm(s) just by changing the configuration.</strong> There is even a <a href="#benchmarker">Benchmarker</a> which allows you to play out different configurations against each other and report the most appropriate configuration for your use case.</p>
</div>
</div>
<div class="sect3">
<h4 id="solverConfigurationByJavaAPI"><a class="anchor" href="#solverConfigurationByJavaAPI"></a><a class="link" href="#solverConfigurationByJavaAPI">4.2.2. Solver Configuration by Java API</a></h4>
<div class="paragraph">
<p>A solver configuration can also be configured with the <code>SolverConfig</code> API.
This is especially useful to change some values dynamically at runtime.
For example, to change the running time based on user input, before building the <code>Solver</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">        SolverFactory&lt;NQueens&gt; solverFactory = SolverFactory.createFromXmlResource(
                "org/optaplanner/examples/nqueens/solver/nqueensSolverConfig.xml");

        TerminationConfig terminationConfig = new TerminationConfig();
        terminationConfig.setMinutesSpentLimit(userInput);
        solverFactory.getSolverConfig().setTerminationConfig(terminationConfig);

        Solver&lt;NQueens&gt; solver = solverFactory.buildSolver();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Every element in the solver configuration XML is available as a <code>*Config</code> class or a property on a <code>*Config</code> class in the package namespace <code>org.optaplanner.core.config</code>.
These <code>*Config</code> classes are the Java representation of the XML format.
They build the runtime components (of the package namespace <code>org.optaplanner.core.impl</code>) and assemble them into an efficient <code>Solver</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>SolverFactory</code> is only multi-thread safe after its configured.
So the <code>getSolverConfig()</code> method is not thread-safe.
To configure a <code>SolverFactory</code> dynamically for each user request, build a <code>SolverFactory</code> as base during initialization and clone it with the <code>cloneSolverFactory()</code> method for a user request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    private SolverFactory&lt;NQueens&gt; base;

    public void init() {
        base = SolverFactory.createFromXmlResource(
                "org/optaplanner/examples/nqueens/solver/nqueensSolverConfig.xml");
        base.getSolverConfig().setTerminationConfig(new TerminationConfig());
    }

    // Called concurrently from different threads
    public void userRequest(..., long userInput)
        SolverFactory&lt;NQueens&gt; solverFactory = base.cloneSolverFactory();
        solverFactory.getSolverConfig().getTerminationConfig().setMinutesSpentLimit(userInput);
        Solver&lt;NQueens&gt; solver = solverFactory.buildSolver();
        ...
    }</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="annotationsConfiguration"><a class="anchor" href="#annotationsConfiguration"></a><a class="link" href="#annotationsConfiguration">4.2.3. Annotations Configuration</a></h4>
<div class="sect4">
<h5 id="automaticScanningForAnnotations"><a class="anchor" href="#automaticScanningForAnnotations"></a><a class="link" href="#automaticScanningForAnnotations">4.2.3.1. Automatic Scanning for Annotations</a></h5>
<div class="paragraph">
<p>Instead of the declaring the classes that have a <code>@PlanningSolution</code> or <code>@PlanningEntity</code> manually:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;solver&gt;
  &lt;!-- Define the model --&gt;
  &lt;solutionClass&gt;org.optaplanner.examples.nqueens.domain.NQueens&lt;/solutionClass&gt;
  &lt;entityClass&gt;org.optaplanner.examples.nqueens.domain.Queen&lt;/entityClass&gt;

  ...
&lt;/solver&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Planner can find scan the classpath and find them automatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;solver&gt;
  &lt;!-- Define the model --&gt;
  &lt;scanAnnotatedClasses/&gt;

  ...
&lt;/solver&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>On environments such as OSGi and Android, which use a non-standard <code>ClassLoader</code>,
automated scanning might not find the <code>@PlanningSolution</code> or <code>@PlanningEntity</code> classes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Automated scanning inflicts a performance cost during bootstrap.
To speed up scanning or if there are multiple models in your classpath,
specify the packages to scan:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;solver&gt;
  &lt;!-- Define the model --&gt;
  &lt;scanAnnotatedClasses&gt;
    &lt;packageInclude&gt;org.optaplanner.examples.cloudbalancing&lt;/packageInclude&gt;
  &lt;/scanAnnotatedClasses&gt;

  ...
&lt;/solver&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This finds all solution and entity classes in that package or its subpackages.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If <code>scanAnnotatedClasses</code> is not specified, the <code>org.reflections</code> transitive maven dependency can be excluded.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="annotationAlternatives"><a class="anchor" href="#annotationAlternatives"></a><a class="link" href="#annotationAlternatives">4.2.3.2. Annotation Alternatives</a></h5>
<div class="paragraph">
<p>Planner needs to be told which classes in your domain model are planning entities, which properties are planning variables, etc.
There are several ways to deliver this information:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add class annotations and JavaBean property annotations on the domain model (recommended). The property annotations must be on the getter method, not on the setter method. Such a getter does not need to be public.</p>
</li>
<li>
<p>Add class annotations and field annotations on the domain model. Such a field does not need to be public.</p>
</li>
<li>
<p>No annotations: externalize the domain configuration in an XML file. This is <a href="https://issues.jboss.org/browse/PLANNER-151">not yet supported</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This manual focuses on the first manner, but every features supports all three manners, even if it&#8217;s not explicitly mentioned.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="modelAPlanningProblem"><a class="anchor" href="#modelAPlanningProblem"></a><a class="link" href="#modelAPlanningProblem">4.3. Model a Planning Problem</a></h3>
<div class="sect3">
<h4 id="isThisClassAProblemFactOrPlanningEntity"><a class="anchor" href="#isThisClassAProblemFactOrPlanningEntity"></a><a class="link" href="#isThisClassAProblemFactOrPlanningEntity">4.3.1. Is This Class a Problem Fact or Planning Entity?</a></h4>
<div class="paragraph">
<p>Look at a dataset of your planning problem.
You will recognize domain classes in there, each of which can be categorized as one of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A unrelated class: not used by any of the score constraints. From a planning standpoint, this data is obsolete.</p>
</li>
<li>
<p>A <strong>problem fact</strong> class: used by the score constraints, but does NOT change during planning (as long as the problem stays the same). For example: <code>Bed</code>, <code>Room</code>, <code>Shift</code>, <code>Employee</code>, <code>Topic</code>, <code>Period</code>, &#8230;&#8203; All the properties of a problem fact class are problem properties.</p>
</li>
<li>
<p>A <strong>planning entity</strong> class: used by the score constraints and changes during planning. For example: <code>BedDesignation</code>, <code>ShiftAssignment</code>, <code>Exam</code>, &#8230;&#8203; The properties that change during planning are planning variables. The other properties are problem properties.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ask yourself: _What class changes during planning?<em>_Which class has variables that I want the <code></em>Solver<em></code> to change for me?</em> That class is a planning entity.
Most use cases have only one planning entity class.
Most use cases also have only one planning variable per planning entity class.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In <a href="#realTimePlanning">real-time planning</a>, even though the problem itself changes, problem facts do not really change during planning, instead they change between planning (because the Solver temporarily stops to apply the problem fact changes).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To create a good domain model, read the <a href="#domainModelingGuide">domain modeling guide</a>.</p>
</div>
<div class="paragraph">
<p><strong>In Planner, all problems facts and planning entities are plain old JavaBeans (POJOs).</strong> Load them from a database, an XML file, a data repository, a REST service, a noSQL cloud, &#8230;&#8203; (see <a href="#integration">integration</a>): it doesn&#8217;t matter.</p>
</div>
</div>
<div class="sect3">
<h4 id="problemFact"><a class="anchor" href="#problemFact"></a><a class="link" href="#problemFact">4.3.2. Problem Fact</a></h4>
<div class="paragraph">
<p>A problem fact is any JavaBean (POJO) with getters that does not change during planning.
Implementing the interface <code>Serializable</code> is recommended (but not required). For example in n queens, the columns and rows are problem facts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class Column implements Serializable {

    private int index;

    // ... getters
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class Row implements Serializable {

    private int index;

    // ... getters
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A problem fact can reference other problem facts of course:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class Course implements Serializable {

    private String code;

    private Teacher teacher; // Other problem fact
    private int lectureSize;
    private int minWorkingDaySize;

    private List&lt;Curriculum&gt; curriculumList; // Other problem facts
    private int studentSize;

    // ... getters
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A problem fact class does <em>not</em> require any Planner specific code.
For example, you can reuse your domain classes, which might have JPA annotations.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Generally, better designed domain classes lead to simpler and more efficient score constraints.
Therefore, when dealing with a messy (denormalized) legacy system, it can sometimes be worthwhile to convert the messy domain model into a Planner specific model first.
For example: if your domain model has two <code>Teacher</code> instances for the same teacher that teaches at two different departments, it is harder to write a correct score constraint that constrains a teacher&#8217;s spare time on the original model than on an adjusted model.</p>
</div>
<div class="paragraph">
<p>Alternatively, you can sometimes also introduce <a href="#cachedProblemFact"><em>a cached problem fact</em></a> to enrich the domain model for planning only.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="planningEntity"><a class="anchor" href="#planningEntity"></a><a class="link" href="#planningEntity">4.3.3. Planning Entity</a></h4>
<div class="sect4">
<h5 id="planningEntityAnnotation"><a class="anchor" href="#planningEntityAnnotation"></a><a class="link" href="#planningEntityAnnotation">4.3.3.1. Planning Entity Annotation</a></h5>
<div class="paragraph">
<p>A planning entity is a JavaBean (POJO) that changes during solving, for example a <code>Queen</code> that changes to another row.
A planning problem has multiple planning entities, for example for a single n queens problem, each <code>Queen</code> is a planning entity.
But there is usually only one planning entity class, for example the <code>Queen</code> class.</p>
</div>
<div class="paragraph">
<p>A planning entity class needs to be annotated with the <code>@PlanningEntity</code> annotation.</p>
</div>
<div class="paragraph">
<p>Each planning entity class has one or more <em>planning variables</em> (which can be <a href="#planningVariable">genuine</a> or <a href="#shadowVariable">shadows</a>). It should also have one or more <em>defining</em> properties.
For example in n queens, a <code>Queen</code> is defined by its <code>Column</code> and has a planning variable <code>Row</code>.
This means that a Queen&#8217;s column never changes during solving, while its row does change.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningEntity
public class Queen {

    private Column column;

    // Planning variables: changes during planning, between score calculations.
    private Row row;

    // ... getters and setters
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A planning entity class can have multiple planning variables.
For example, a <code>Lecture</code> is defined by its <code>Course</code> and its index in that course (because one course has multiple lectures). Each <code>Lecture</code> needs to be scheduled into a <code>Period</code> and a <code>Room</code> so it has two planning variables (period and room). For example: the course Mathematics has eight lectures per week, of which the first lecture is Monday morning at 08:00 in room 212.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningEntity
public class Lecture {

    private Course course;
    private int lectureIndexInCourse;

    // Planning variables: changes during planning, between score calculations.
    private Period period;
    private Room room;

    // ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Without <a href="#automaticScanningForAnnotations">automated scanning</a>, the solver configuration also needs to declare each planning entity class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">&lt;solver&gt;
  ...
  &lt;entityClass&gt;org.optaplanner.examples.nqueens.domain.Queen&lt;/entityClass&gt;
  ...
&lt;/solver&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Some uses cases have multiple planning entity classes.
For example: route freight and trains into railway network arcs, where each freight can use multiple trains over its journey and each train can carry multiple freights per arc.
Having multiple planning entity classes directly raises the implementation complexity of your use case.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><em>Do not create unnecessary planning entity classes.</em> This leads to difficult <code>Move</code> implementations and slower score calculation.</p>
</div>
<div class="paragraph">
<p>For example, do not create a planning entity class to hold the total free time of a teacher, which needs to be kept up to date as the <code>Lecture</code> planning entities change.
Instead, calculate the free time in the score constraints (or as a <a href="#shadowVariable">shadow variable</a>) and put the result per teacher into a logically inserted score object.</p>
</div>
<div class="paragraph">
<p>If historic data needs to be considered too, then create problem fact to hold the total of the historic assignments up to, but <em>not including</em>, the planning window (so that it does not change when a planning entity changes) and let the score constraints take it into account.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="planningEntityDifficulty"><a class="anchor" href="#planningEntityDifficulty"></a><a class="link" href="#planningEntityDifficulty">4.3.3.2. Planning Entity Difficulty</a></h5>
<div class="paragraph">
<p>Some optimization algorithms work more efficiently if they have an estimation of which planning entities are more difficult to plan.
For example: in bin packing bigger items are harder to fit, in course scheduling lectures with more students are more difficult to schedule, and in n queens the middle queens are more difficult to fit on the board.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Do not try to use planning entity difficulty to implement a business
          constraint.</strong> It will not affect the score function: if we have infinite solving time, the returned solution will be the same.</p>
</div>
<div class="paragraph">
<p>To attain a schedule in which certain entities are scheduled earlier in the schedule, <a href="#formalizeTheBusinessConstraints">add a score constraint</a> to change the score function so it prefers such solutions.
Only consider adding planning entity difficulty too if it can make the solver more efficient.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To allow the heuristics to take advantage of that domain specific information, set a <code>difficultyComparatorClass</code> to the <code>@PlanningEntity</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningEntity(difficultyComparatorClass = CloudProcessDifficultyComparator.class)
public class CloudProcess {
    // ...
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class CloudProcessDifficultyComparator implements Comparator&lt;CloudProcess&gt; {

    public int compare(CloudProcess a, CloudProcess b) {
        return new CompareToBuilder()
                .append(a.getRequiredMultiplicand(), b.getRequiredMultiplicand())
                .append(a.getId(), b.getId())
                .toComparison();
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can also set a <code>difficultyWeightFactoryClass</code> to the <code>@PlanningEntity</code> annotation, so that you have access to the rest of the problem facts from the <code>Solution</code> too:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningEntity(difficultyWeightFactoryClass = QueenDifficultyWeightFactory.class)
public class Queen {
    // ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="#sortedSelection">sorted selection</a> for more information.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Difficulty should be implemented ascending: easy entities are lower, difficult entities are higher.
For example, in bin packing: small item &lt; medium item &lt; big item.</p>
</div>
<div class="paragraph">
<p>Although most algorithms start with the more difficult entities first, they just reverse the ordering.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>None of the current planning variable states should be used to compare planning entity difficulty.</em> During Construction Heuristics, those variables are likely to be <code>null</code> anyway.
For example, a <code>Queen</code>'s <code>row</code> variable should not be used.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="planningVariable"><a class="anchor" href="#planningVariable"></a><a class="link" href="#planningVariable">4.3.4. Planning Variable (genuine)</a></h4>
<div class="sect4">
<h5 id="planningVariableAnnotation"><a class="anchor" href="#planningVariableAnnotation"></a><a class="link" href="#planningVariableAnnotation">4.3.4.1. Planning Variable Annotation</a></h5>
<div class="paragraph">
<p>A planning variable is a JavaBean property (so a getter and setter) on a planning entity.
It points to a planning value, which changes during planning.
For example, a <code>Queen</code>'s <code>row</code> property is a genuine planning variable.
Note that even though a <code>Queen</code>'s <code>row</code> property changes to another <code>Row</code> during planning, no <code>Row</code> instance itself is changed.
Normally planning variables are genuine, but advanced cases can also have <a href="#shadowVariable">shadows</a>.</p>
</div>
<div class="paragraph">
<p>A genuine planning variable getter needs to be annotated with the <code>@PlanningVariable</code> annotation, which needs a non-empty <code>valueRangeProviderRefs</code> property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningEntity
public class Queen {
    ...

    private Row row;

    @PlanningVariable(valueRangeProviderRefs = {"rowRange"})
    public Row getRow() {
        return row;
    }

    public void setRow(Row row) {
        this.row = row;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>valueRangeProviderRefs</code> property defines what are the possible planning values for this planning variable.
It references one or more <code>@ValueRangeProvider</code> <code>id</code>'s.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A @PlanningVariable annotation needs to be on a member in a class with a @PlanningEntity annotation.
It is ignored on parent classes or subclasses without that annotation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="#annotationAlternatives">Annotating the field</a> instead of the property works too:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningEntity
public class Queen {
    ...

    @PlanningVariable(valueRangeProviderRefs = {"rowRange"})
    private Row row;

}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="nullablePlanningVariable"><a class="anchor" href="#nullablePlanningVariable"></a><a class="link" href="#nullablePlanningVariable">4.3.4.2. Nullable Planning Variable</a></h5>
<div class="paragraph">
<p>By default, an initialized planning variable cannot be <code>null</code>, so an initialized solution will never use <code>null</code> for any of its planning variables.
In an over-constrained use case, this can be counterproductive.
For example: in task assignment with too many tasks for the workforce, we would rather leave low priority tasks unassigned instead of assigning them to an overloaded worker.</p>
</div>
<div class="paragraph">
<p>To allow an initialized planning variable to be <code>null</code>, set <code>nullable</code> to <code>true</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    @PlanningVariable(..., nullable = true)
    public Worker getWorker() {
        return worker;
    }</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Planner will automatically add the value <code>null</code> to the value range.
There is no need to add <code>null</code> in a collection used by a <code>ValueRangeProvider</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Using a nullable planning variable implies that your score calculation is responsible for punishing (or even rewarding) variables with a null value.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="#repeatedPlanning">Repeated planning</a> (especially <a href="#realTimePlanning">real-time planning</a>) does not mix well with a nullable planning variable.
Every time the Solver starts or a problem fact change is made,
the <a href="#constructionHeuristics">Construction Heuristics</a> will try to initialize all the <code>null</code> variables again, which can be a huge waste of time.
One way to deal with this, is to change when a planning entity should be reinitialized with an <code>reinitializeVariableEntityFilter</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    @PlanningVariable(..., nullable = true, reinitializeVariableEntityFilter = ReinitializeTaskFilter.class)
    public Worker getWorker() {
        return worker;
    }</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="whenIsAPlanningVariableInitialized"><a class="anchor" href="#whenIsAPlanningVariableInitialized"></a><a class="link" href="#whenIsAPlanningVariableInitialized">4.3.4.3. When is a Planning Variable Considered Initialized?</a></h5>
<div class="paragraph">
<p>A planning variable is considered initialized if its value is not <code>null</code> or if the variable is <code>nullable</code>.
So a nullable variable is always considered initialized, even when a custom <code>reinitializeVariableEntityFilter</code> triggers a reinitialization during construction heuristics.</p>
</div>
<div class="paragraph">
<p>A planning entity is initialized if all of its planning variables are initialized.</p>
</div>
<div class="paragraph">
<p>A <code>Solution</code> is initialized if all of its planning entities are initialized.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="planningValueAndPlanningValueRange"><a class="anchor" href="#planningValueAndPlanningValueRange"></a><a class="link" href="#planningValueAndPlanningValueRange">4.3.5. Planning Value and Planning Value Range</a></h4>
<div class="sect4">
<h5 id="planningValue"><a class="anchor" href="#planningValue"></a><a class="link" href="#planningValue">4.3.5.1. Planning Value</a></h5>
<div class="paragraph">
<p>A planning value is a possible value for a genuine planning variable.
Usually, a planning value is a problem fact, but it can also be any object, for example a <code>double</code>.
It can even be another planning entity or even a interface implemented by both a planning entity and a problem fact.</p>
</div>
<div class="paragraph">
<p>A planning value range is the set of possible planning values for a planning variable.
This set can be a countable (for example row <code>1</code>, <code>2</code>, <code>3</code> or <code>4</code>) or uncountable (for example any <code>double</code> between <code>0.0</code> and <code>1.0</code>).</p>
</div>
</div>
<div class="sect4">
<h5 id="planningValueRangeProvider"><a class="anchor" href="#planningValueRangeProvider"></a><a class="link" href="#planningValueRangeProvider">4.3.5.2. Planning Value Range Provider</a></h5>
<div class="sect5">
<h6 id="planningValueRangeProviderOverview"><a class="anchor" href="#planningValueRangeProviderOverview"></a><a class="link" href="#planningValueRangeProviderOverview">4.3.5.2.1. Overview</a></h6>
<div class="paragraph">
<p>The value range of a planning variable is defined with the <code>@ValueRangeProvider</code> annotation.
A <code>@ValueRangeProvider</code> annotation always has a property <code>id</code>, which is referenced by the <code>@PlanningVariable</code>'s property <code>valueRangeProviderRefs</code>.</p>
</div>
<div class="paragraph">
<p>This annotation can be located on two types of methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>On the Solution: All planning entities share the same value range.</p>
</li>
<li>
<p>On the planning entity: The value range differs per planning entity. This is less common.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A @ValueRangeProvider annotation needs to be on a member in a class with a @PlanningSolution or a @PlanningEntity annotation.
It is ignored on parent classes or subclasses without those annotations.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The return type of that method can be two types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Collection</code>: The value range is defined by a <code>Collection</code> (usually a <code>List</code>) of its possible values.</p>
</li>
<li>
<p><code>ValueRange</code>: The value range is defined by its bounds. This is less common.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="valueRangeProviderOnSolution"><a class="anchor" href="#valueRangeProviderOnSolution"></a><a class="link" href="#valueRangeProviderOnSolution">4.3.5.2.2. <code>ValueRangeProvider</code> on the <code>Solution</code></a></h6>
<div class="paragraph">
<p>All instances of the same planning entity class share the same set of possible planning values for that planning variable.
This is the most common way to configure a value range.</p>
</div>
<div class="paragraph">
<p>The <code>Solution</code> implementation has method that returns a <code>Collection</code> (or a <code>ValueRange</code>). Any value from that <code>Collection</code> is a possible planning value for this planning variable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    @PlanningVariable(valueRangeProviderRefs = {"rowRange"})
    public Row getRow() {
        return row;
    }</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningSolution
public class NQueens {
    ...

    @ValueRangeProvider(id = "rowRange")
    public List&lt;Row&gt; getRowList() {
        return rowList;
    }

}</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>That <code>Collection</code> (or <code>ValueRange</code>) must not contain the value <code>null</code>, not even for a <a href="#nullablePlanningVariable">nullable planning variable</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="#annotationAlternatives">Annotating the field</a> instead of the property works too:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningSolution
public class NQueens {
    ...

    @ValueRangeProvider(id = "rowRange")
    private List&lt;Row&gt; rowList;

}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="valueRangeProviderOnPlanningEntity"><a class="anchor" href="#valueRangeProviderOnPlanningEntity"></a><a class="link" href="#valueRangeProviderOnPlanningEntity">4.3.5.2.3. <code>ValueRangeProvider</code> on the Planning Entity</a></h6>
<div class="paragraph">
<p>Each planning entity has its own value range (a set of possible planning values) for the planning variable.
For example, if a teacher can <strong>never</strong> teach in a room that does not belong to his department, lectures of that teacher can limit their room value range to the rooms of his department.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    @PlanningVariable(valueRangeProviderRefs = {"departmentRoomRange"})
    public Room getRoom() {
        return room;
    }

    @ValueRangeProvider(id = "departmentRoomRange")
    public List&lt;Room&gt; getPossibleRoomList() {
        return getCourse().getTeacher().getDepartment().getRoomList();
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Never use this to enforce a soft constraint (or even a hard constraint when the problem might not have a feasible solution). For example: <em>Unless there is no other way</em>, a teacher can not teach in a room that does not belong to his department.
In this case, the teacher should <em>not</em> be limited in his room value range (because sometimes there is no other way).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>By limiting the value range specifically of one planning entity, you are effectively creating a <em>built-in hard constraint</em>.
This can have the benefit of severely lowering the number of possible solutions; however, it can also away the freedom of the optimization algorithms to temporarily break that constraint in order to escape from a local optimum.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A planning entity should <em>not</em> use other planning entities to determinate its value range.
That would only try to make the planning entity solve the planning problem itself and interfere with the optimization algorithms.</p>
</div>
<div class="paragraph">
<p>Every entity has its own <code>List</code> instance, unless multiple entities have the same value range.
For example, if teacher A and B belong to the same department, they use the same <code>List&lt;Room&gt;</code> instance.
Furthermore, each <code>List</code> contains a subset of the same set of planning value instances.
For example, if department A and B can both use room X, then their <code>List&lt;Room&gt;</code> instances contain the same <code>Room</code> instance.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A <code>ValueRangeProvider</code> on the planning entity consumes more memory than <code>ValueRangeProvider</code> on the Solution and disables certain automatic performance optimizations.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A <code>ValueRangeProvider</code> on the planning entity is not currently compatible with a <a href="#chainedPlanningVariable">chained</a> variable.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="valueRangeFactory"><a class="anchor" href="#valueRangeFactory"></a><a class="link" href="#valueRangeFactory">4.3.5.2.4. <code>ValueRangeFactory</code></a></h6>
<div class="paragraph">
<p>Instead of a <code>Collection</code>, you can also return a <code>ValueRange</code> or <code>CountableValueRange</code>, build by the <code>ValueRangeFactory</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    @ValueRangeProvider(id = "delayRange")
    public CountableValueRange&lt;Integer&gt; getDelayRange() {
        return ValueRangeFactory.createIntValueRange(0, 5000);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>ValueRange</code> uses far less memory, because it only holds the bounds.
In the example above, a <code>Collection</code> would need to hold all <code>5000</code> ints, instead of just the two bounds.</p>
</div>
<div class="paragraph">
<p>Furthermore, an <code>incrementUnit</code> can be specified, for example if you have to buy stocks in units of 200 pieces:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    @ValueRangeProvider(id = "stockAmountRange")
    public CountableValueRange&lt;Integer&gt; getStockAmountRange() {
         // Range: 0, 200, 400, 600, ..., 9999600, 9999800, 10000000
        return ValueRangeFactory.createIntValueRange(0, 10000000, 200);
    }</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Return <code>CountableValueRange</code> instead of <code>ValueRange</code> whenever possible (so Planner knows that it&#8217;s countable).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>ValueRangeFactory</code> has creation methods for several value class types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>boolean</code>: A boolean range.</p>
</li>
<li>
<p><code>int</code>: A 32bit integer range.</p>
</li>
<li>
<p><code>long</code>: A 64bit integer range.</p>
</li>
<li>
<p><code>double</code>: A 64bit floating point range which only supports random selection (because it does not implement <code>CountableValueRange</code>).</p>
</li>
<li>
<p><code>BigInteger</code>: An arbitrary-precision integer range.</p>
</li>
<li>
<p><code>BigDecimal</code>: A decimal point range. By default, the increment unit is the lowest non-zero value in the scale of the bounds.</p>
</li>
<li>
<p><code>Temporal</code> (such as <code>LocalDate</code>, <code>LocalDateTime</code>, &#8230;&#8203;): A time range.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="combineValueRangeProviders"><a class="anchor" href="#combineValueRangeProviders"></a><a class="link" href="#combineValueRangeProviders">4.3.5.2.5. Combine ValueRangeProviders</a></h6>
<div class="paragraph">
<p>Value range providers can be combined, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    @PlanningVariable(valueRangeProviderRefs = {"companyCarRange", "personalCarRange"})
    public Car getCar() {
        return car;
    }</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    @ValueRangeProvider(id = "companyCarRange")
    public List&lt;CompanyCar&gt; getCompanyCarList() {
        return companyCarList;
    }

    @ValueRangeProvider(id = "personalCarRange")
    public List&lt;PersonalCar&gt; getPersonalCarList() {
        return personalCarList;
    }</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="planningValueStrength"><a class="anchor" href="#planningValueStrength"></a><a class="link" href="#planningValueStrength">4.3.5.3. Planning Value Strength</a></h5>
<div class="paragraph">
<p>Some optimization algorithms work a bit more efficiently if they have an estimation of which planning values are stronger, which means they are more likely to satisfy a planning entity.
For example: in bin packing bigger containers are more likely to fit an item and in course scheduling bigger rooms are less likely to break the student capacity constraint.
Usually, the efficiency gain of planning value strength is far less than that of <a href="#planningEntityDifficulty">planning entity difficulty</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Do not try to use planning value strength to implement a business
          constraint.</strong> It will not affect the score function: if we have infinite solving time, the returned solution will be the same.</p>
</div>
<div class="paragraph">
<p>To affect the score function, <a href="#formalizeTheBusinessConstraints">add a score constraint</a>.
Only consider adding planning value strength too if it can make the solver more efficient.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To allow the heuristics to take advantage of that domain specific information, set a <code>strengthComparatorClass</code> to the <code>@PlanningVariable</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    @PlanningVariable(..., strengthComparatorClass = CloudComputerStrengthComparator.class)
    public CloudComputer getComputer() {
        return computer;
    }</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class CloudComputerStrengthComparator implements Comparator&lt;CloudComputer&gt; {

    public int compare(CloudComputer a, CloudComputer b) {
        return new CompareToBuilder()
                .append(a.getMultiplicand(), b.getMultiplicand())
                .append(b.getCost(), a.getCost()) // Descending (but this is debatable)
                .append(a.getId(), b.getId())
                .toComparison();
    }

}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you have multiple planning value classes in the <em>same</em> value range, the <code>strengthComparatorClass</code> needs to implement a <code>Comparator</code> of a common superclass (for example <code>Comparator&lt;Object&gt;</code>) and be able to handle comparing instances of those different classes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Alternatively, you can also set a <code>strengthWeightFactoryClass</code> to the <code>@PlanningVariable</code> annotation, so you have access to the rest of the problem facts from the solution too:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    @PlanningVariable(..., strengthWeightFactoryClass = RowStrengthWeightFactory.class)
    public Row getRow() {
        return row;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="#sortedSelection">sorted selection</a> for more information.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Strength should be implemented ascending: weaker values are lower, stronger values are higher.
For example in bin packing: small container &lt; medium container &lt; big container.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>None of the current planning variable state in any of the planning entities should be used to compare planning values.</em> During construction heuristics, those variables are likely to be <code>null</code>.
For example, none of the <code>row</code> variables of any <code>Queen</code> may be used to determine the strength of a <code>Row</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="chainedPlanningVariable"><a class="anchor" href="#chainedPlanningVariable"></a><a class="link" href="#chainedPlanningVariable">4.3.5.4. Chained Planning Variable (TSP, VRP, &#8230;&#8203;)</a></h5>
<div class="paragraph">
<p>Some use cases, such as TSP and Vehicle Routing, require <em>chaining</em>.
This means the planning entities point to each other and form a chain.
By modeling the problem as a set of chains (instead of a set of trees/loops), the search space is heavily reduced.</p>
</div>
<div class="paragraph">
<p>A planning variable that is chained either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Directly points to a problem fact (or planning entity), which is called an <em>anchor</em>.</p>
</li>
<li>
<p>Points to another planning entity with the same planning variable, which recursively points to an anchor.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here are some example of valid and invalid chains:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./PlannerConfiguration/chainPrinciples.png" alt="chainPrinciples">
</div>
</div>
<div class="paragraph">
<p><strong>Every initialized planning entity is part of an open-ended chain that begins from an anchor.</strong> A valid model means that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A chain is never a loop. The tail is always open.</p>
</li>
<li>
<p>Every chain always has exactly one anchor. The anchor is a problem fact, never a planning entity.</p>
</li>
<li>
<p>A chain is never a tree, it is always a line. Every anchor or planning entity has at most one trailing planning entity.</p>
</li>
<li>
<p>Every initialized planning entity is part of a chain.</p>
</li>
<li>
<p>An anchor with no planning entities pointing to it, is also considered a chain.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A planning problem instance given to the <code>Solver</code> must be valid.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If your constraints dictate a closed chain, model it as an open-ended chain (which is easier to persist in a database) and implement a score constraint for the last entity back to the anchor.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The optimization algorithms and built-in <code>Move</code>s do chain correction to guarantee that the model stays valid:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./PlannerConfiguration/chainCorrection.png" alt="chainCorrection">
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A custom <code>Move</code> implementation must leave the model in a valid state.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example, in TSP the anchor is a <code>Domicile</code> (in vehicle routing it is <code>Vehicle</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class Domicile ... implements Standstill {
    ...

    public City getCity() {...}

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The anchor (which is a problem fact) and the planning entity implement a common interface, for example TSP&#8217;s <code>Standstill</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public interface Standstill {

    City getCity();

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>That interface is the return type of the planning variable.
Furthermore, the planning variable is chained.
For example TSP&#8217;s <code>Visit</code> (in vehicle routing it is <code>Customer</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningEntity
public class Visit ... implements Standstill {
    ...

    public City getCity() {...}

    @PlanningVariable(graphType = PlanningVariableGraphType.CHAINED,
        valueRangeProviderRefs = {"domicileRange", "visitRange"})
    public Standstill getPreviousStandstill() {
        return previousStandstill;
    }

    public void setPreviousStandstill(Standstill previousStandstill) {
        this.previousStandstill = previousStandstill;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice how two value range providers are usually combined:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The value range provider that holds the anchors, for example <code>domicileList</code>.</p>
</li>
<li>
<p>The value range provider that holds the initialized planning entities, for example <code>visitList</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="shadowVariable"><a class="anchor" href="#shadowVariable"></a><a class="link" href="#shadowVariable">4.3.6. Shadow Variable</a></h4>
<div class="sect4">
<h5 id="shadowVariableIntroduction"><a class="anchor" href="#shadowVariableIntroduction"></a><a class="link" href="#shadowVariableIntroduction">4.3.6.1. Introduction</a></h5>
<div class="paragraph">
<p>A shadow variable is a planning variable whose correct value can be deduced from the state of the genuine planning variables.
Even though such a variable violates the principle of normalization by definition, in some use cases it can be very practical to use a shadow variable, especially to express the constraints more naturally.
For example in vehicle routing with time windows: the arrival time at a customer for a vehicle can be calculated based on the previously visited customers of that vehicle (and the known travel times between two locations).</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./PlannerConfiguration/planningVariableListener.png" alt="planningVariableListener">
</div>
</div>
<div class="paragraph">
<p>When the customers for a vehicle change, the arrival time for each customer is automatically adjusted.
For more information, see the <a href="#vehicleRoutingDomainModel">vehicle routing domain model</a>.</p>
</div>
<div class="paragraph">
<p>From a score calculation perspective, a shadow variable is like any other planning variable.
From an optimization perspective, Planner effectively only optimizes the genuine variables (and mostly ignores the shadow variables): it just assures that when a genuine variable changes, any dependent shadow variables are changed accordingly.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Any class that has at least one shadow variable, is a planning entity class</strong>, even if it has no genuine planning variables.
That entity class needs to be defined in the solver configuration (unless classes are <a href="#automaticScanningForAnnotations">automatically scanned</a>)
and be annotated accordingly.</p>
</div>
<div class="paragraph">
<p>An genuine planning entity class has at least one genuine planning variable, but can have shadow variables too.
A shadow planning entity class has no genuine planning variables and at least one shadow planning variable.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There are several built-in shadow variables:</p>
</div>
</div>
<div class="sect4">
<h5 id="bidirectionalVariable"><a class="anchor" href="#bidirectionalVariable"></a><a class="link" href="#bidirectionalVariable">4.3.6.2. Bi-directional Variable (Inverse Relation Shadow Variable)</a></h5>
<div class="paragraph">
<p>Two variables are bi-directional if their instances always point to each other (unless one side points to <code>null</code> and the other side does not exist). So if A references B, then B references A.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./PlannerConfiguration/bidirectionalVariable.png" alt="bidirectionalVariable">
</div>
</div>
<div class="paragraph">
<p>For a non-chained planning variable, the bi-directional relationship must be a many to one relationship.
To map a bi-directional relationship between two planning variables, annotate the master side (which is the genuine side) as a normal planning variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningEntity
public class CloudProcess {

    @PlanningVariable(...)
    public CloudComputer getComputer() {
        return computer;
    }
    public void setComputer(CloudComputer computer) {...}

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then annotate the other side (which is the shadow side) with a <code>@InverseRelationShadowVariable</code> annotation on a <code>Collection</code> (usually a <code>Set</code> or <code>List</code>) property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningEntity
public class CloudComputer {

    @InverseRelationShadowVariable(sourceVariableName = "computer")
    public List&lt;CloudProcess&gt; getProcessList() {
        return processList;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>sourceVariableName</code> property is the name of the genuine planning variable on the return type of the getter (so the name of the genuine planning variable on the <em>other</em> side).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The shadow property, which is a <code>Collection</code>, can never be <code>null</code>.
If no genuine variable is referencing that shadow entity, then it is an empty <code>Collection</code>.
Furthermore it must be a mutable <code>Collection</code> because once the Solver starts initializing or changing genuine planning variables, it will add and remove to the <code>Collection</code>s of those shadow variables accordingly.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For a chained planning variable, the bi-directional relationship must be a one to one relationship.
In that case, the genuine side looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningEntity
public class Customer ... {

    @PlanningVariable(graphType = PlanningVariableGraphType.CHAINED, ...)
    public Standstill getPreviousStandstill() {
        return previousStandstill;
    }
    public void setPreviousStandstill(Standstill previousStandstill) {...}

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the shadow side looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningEntity
public class Standstill {

    @InverseRelationShadowVariable(sourceVariableName = "previousStandstill")
    public Customer getNextCustomer() {
         return nextCustomer;
    }
    public void setNextCustomer(Customer nextCustomer) {...}

}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The input planning problem of a <code>Solver</code> must not violate bi-directional relationships.
If A points to B, then B must point to A.
Planner will not violate that principle during planning, but the input must not violate it.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="anchorShadowVariable"><a class="anchor" href="#anchorShadowVariable"></a><a class="link" href="#anchorShadowVariable">4.3.6.3. Anchor Shadow Variable</a></h5>
<div class="paragraph">
<p>An anchor shadow variable is the anchor of <a href="#chainedPlanningVariable">a chained variable</a>.</p>
</div>
<div class="paragraph">
<p>Annotate the anchor property as a <code>@AnchorShadowVariable</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningEntity
public class Customer {

    @AnchorShadowVariable(sourceVariableName = "previousStandstill")
    public Vehicle getVehicle() {...}
    public void setVehicle(Vehicle vehicle) {...}

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>sourceVariableName</code> property is the name of the chained variable on the same entity class.</p>
</div>
</div>
<div class="sect4">
<h5 id="customVariableListener"><a class="anchor" href="#customVariableListener"></a><a class="link" href="#customVariableListener">4.3.6.4. Custom <code>VariableListener</code></a></h5>
<div class="paragraph">
<p>To update a shadow variable, Planner uses a <code>VariableListener</code>.
To define a custom shadow variable, write a custom <code>VariableListener</code>: implement the interface and annotate it on the shadow variable that needs to change.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    @PlanningVariable(...)
    public Standstill getPreviousStandstill() {
        return previousStandstill;
    }

    @CustomShadowVariable(variableListenerClass = VehicleUpdatingVariableListener.class,
            sources = {@PlanningVariableReference(variableName = "previousStandstill")})
    public Vehicle getVehicle() {
        return vehicle;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>variableName</code> is the variable that triggers changes in the shadow variable(s).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the class of the trigger variable is different than the shadow variable, also specify the <code>entityClass</code> on <code>@PlanningVariableReference</code>.
In that case, make sure that that <code>entityClass</code> is also properly configured as a planning entity class in the solver config, or the <code>VariableListener</code> will simply never trigger.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example, the <code>VehicleUpdatingVariableListener</code> assures that every <code>Customer</code> in a chain has the same <code>Vehicle</code>, namely the chain&#8217;s anchor.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class VehicleUpdatingVariableListener implements VariableListener&lt;Customer&gt; {

    public void afterEntityAdded(ScoreDirector scoreDirector, Customer customer) {
        updateVehicle(scoreDirector, customer);
    }

    public void afterVariableChanged(ScoreDirector scoreDirector, Customer customer) {
        updateVehicle(scoreDirector, customer);
    }

    ...

    protected void updateVehicle(ScoreDirector scoreDirector, Customer sourceCustomer) {
        Standstill previousStandstill = sourceCustomer.getPreviousStandstill();
        Vehicle vehicle = previousStandstill == null ? null : previousStandstill.getVehicle();
        Customer shadowCustomer = sourceCustomer;
        while (shadowCustomer != null &amp;&amp; shadowCustomer.getVehicle() != vehicle) {
            scoreDirector.beforeVariableChanged(shadowCustomer, "vehicle");
            shadowCustomer.setVehicle(vehicle);
            scoreDirector.afterVariableChanged(shadowCustomer, "vehicle");
            shadowCustomer = shadowCustomer.getNextCustomer();
        }
    }

}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A <code>VariableListener</code> can only change shadow variables.
It must never change a genuine planning variable or a problem fact.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Any change of a shadow variable must be told to the <code>ScoreDirector</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If one <code>VariableListener</code> changes two shadow variables (because having two separate <code>VariableListener</code>s would be inefficient), then annotate only the first shadow variable with the <code>variableListenerClass</code> and let the other shadow variable(s) reference the first shadow variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    @PlanningVariable(...)
    public Standstill getPreviousStandstill() {
        return previousStandstill;
    }

    @CustomShadowVariable(variableListenerClass = TransportTimeAndCapacityUpdatingVariableListener.class,
            sources = {@PlanningVariableReference(variableName = "previousStandstill")})
    public Integer getTransportTime() {
        return transportTime;
    }

    @CustomShadowVariable(variableListenerRef = @PlanningVariableReference(variableName = "transportTime"))
    public Integer getCapacity() {
        return capacity;
    }</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="variableListenerTriggeringOrder"><a class="anchor" href="#variableListenerTriggeringOrder"></a><a class="link" href="#variableListenerTriggeringOrder">4.3.6.5. VariableListener triggering order</a></h5>
<div class="paragraph">
<p>All shadow variables are triggered by a <code>VariableListener</code>, regardless if it&#8217;s a built-in or a custom shadow variable.
The genuine and shadow variables form a graph, that determines the order in which the <code>afterEntityAdded()</code>, <code>afterVariableChanged()</code> and <code>afterEntityRemoved()</code> methods are called:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./PlannerConfiguration/shadowVariableOrder.png" alt="shadowVariableOrder">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In the example above, D could have also been ordered after E (or F) because there is no direct or indirect dependency between D and E (or F).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Planner guarantees that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The first <code>VariableListener</code>'s <code>after*()</code> methods trigger <em>after</em> the last genuine variable has changed. Therefore the genuine variables (A and B in the example above) are guaranteed to be in a consistent state across all its instances (with values A1, A2 and B1 in the example above) because the entire <code>Move</code> has been applied.</p>
</li>
<li>
<p>The second <code>VariableListener</code>'s <code>after*()</code> methods trigger <em>after</em> the last first shadow variable has changed. Therefore the first shadow variable (C in the example above) are guaranteed to be in consistent state across all its instances (with values C1 and C2 in the example above). And of course the genuine variables too.</p>
</li>
<li>
<p>And so forth.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Planner does not guarantee the order in which the <code>after*()</code> methods are called for the <em>same</em><code>VariableListener</code> with different parameters (such as A1 and A2 in the example above), although they are likely to be in the order in which they were affected.</p>
</div>
<div class="paragraph">
<p>By default, Planner does not guarantee that the events are unique.
For example, if a shadow variable on an entity is changed twice in the same move (for example by two different genuine variables), then that will cause the same event twice on the <code>VariableListener</code>s that are listening to that original shadow variable.
To avoid dealing with that complexity, overwrite the method <code>requiresUniqueEntityEvents()</code> to receive unique events at the cost of a small performance penalty:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class StartTimeUpdatingVariableListener implements VariableListener&lt;Task&gt; {

    @Override
    public boolean requiresUniqueEntityEvents() {
        return true;
    }

    ...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="planningProblemAndPlanningSolution"><a class="anchor" href="#planningProblemAndPlanningSolution"></a><a class="link" href="#planningProblemAndPlanningSolution">4.3.7. Planning Problem and Planning Solution</a></h4>
<div class="sect4">
<h5 id="planningProblemInstance"><a class="anchor" href="#planningProblemInstance"></a><a class="link" href="#planningProblemInstance">4.3.7.1. Planning Problem Instance</a></h5>
<div class="paragraph">
<p>A dataset for a planning problem needs to be wrapped in a class for the <code>Solver</code> to solve.
That solution class represents both the planning problem and (if solved) a solution.
It is annotated with a <code>@PlanningSolution</code> annotation.
For example in n queens, the solution class is the <code>NQueens</code> class, which contains a <code>Column</code> list, a <code>Row</code> list, and a <code>Queen</code> list.</p>
</div>
<div class="paragraph">
<p>A planning problem is actually an unsolved planning solution or - stated differently - an uninitialized solution.
For example in n queens, that <code>NQueens</code> class has the <code>@PlanningSolution</code> annotation, yet every <code>Queen</code> in an unsolved <code>NQueens</code> class is not yet assigned to a <code>Row</code> (their <code>row</code> property is <code>null</code>). That&#8217;s not a feasible solution.
It&#8217;s not even a possible solution.
It&#8217;s an uninitialized solution.</p>
</div>
</div>
<div class="sect4">
<h5 id="solutionClass"><a class="anchor" href="#solutionClass"></a><a class="link" href="#solutionClass">4.3.7.2. Solution Class</a></h5>
<div class="paragraph">
<p>A solution class holds all problem facts, planning entities and a score.
It is annotated with a <code>@PlanningSolution</code> annotation.
For example, an <code>NQueens</code> instance holds a list of all columns, all rows and all <code>Queen</code> instances:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningSolution
public class NQueens {

    // Problem facts
    private int n;
    private List&lt;Column&gt; columnList;
    private List&lt;Row&gt; rowList;

    // Planning entities
    private List&lt;Queen&gt; queenList;

    private SimpleScore score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Without <a href="#automaticScanningForAnnotations">automated scanning</a>, the solver configuration also needs to declare the planning solution class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">&lt;solver&gt;
  ...
  &lt;solutionClass&gt;org.optaplanner.examples.nqueens.domain.NQueens&lt;/solutionClass&gt;
  ...
&lt;/solver&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="planningEntitiesOfASolution"><a class="anchor" href="#planningEntitiesOfASolution"></a><a class="link" href="#planningEntitiesOfASolution">4.3.7.3. Planning Entities of a Solution (<code>@PlanningEntityCollectionProperty</code>)</a></h5>
<div class="paragraph">
<p>Planner needs to extract the entity instances from the solution instance.
It gets those collection(s) by calling every getter (or field) that is annotated with <code>@PlanningEntityCollectionProperty</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningSolution
public class NQueens {
    ...

    private List&lt;Queen&gt; queenList;

    @PlanningEntityCollectionProperty
    public List&lt;Queen&gt; getQueenList() {
        return queenList;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There can be multiple <code>@PlanningEntityCollectionProperty</code> annotated members.
Those can even return a <code>Collection</code> with the same entity class type.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A `@PlanningEntityCollectionProperty annotation needs to be on a member in a class with a @PlanningSolution annotation.
It is ignored on parent classes or subclasses without that annotation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In rare cases, a planning entity might be a singleton: use <code>@PlanningEntityProperty</code> on its getter (or field) instead.</p>
</div>
<div class="paragraph">
<p>Both annotations can also be <a href="#autoDiscoverSolutionProperties">auto discovered</a> if enabled.</p>
</div>
</div>
<div class="sect4">
<h5 id="scoreOfASolution"><a class="anchor" href="#scoreOfASolution"></a><a class="link" href="#scoreOfASolution">4.3.7.4. <code>Score</code> of a Solution (<code>@PlanningScore</code>)</a></h5>
<div class="paragraph">
<p>A <code>Solution</code> requires a score property (or field), which is annotated with a <code>@PlanningScore</code> annotation.
The score property is <code>null</code> if the the score hasn&#8217;t been calculated yet.
The <code>score</code> property is typed to the specific <code>Score</code> implementation of your use case.
For example, <code>NQueens</code> uses a <a href="#simpleScore">SimpleScore</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningSolution
public class NQueens {
    ...

    private SimpleScore score;

    @PlanningScore
    public SimpleScore getScore() {
        return score;
    }
    public void setScore(SimpleScore score) {
        this.score = score;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Most use cases use a <a href="#hardSoftScore">HardSoftScore</a> instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningSolution
public class CloudBalance {
    ...

    private HardSoftScore score;

    @PlanningScore
    public HardSoftScore getScore() {
        return score;
    }

    public void setScore(HardSoftScore score) {
        this.score = score;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Some use cases use <a href="#scoreType">other score types</a>.</p>
</div>
<div class="paragraph">
<p>This annotation can also be <a href="#autoDiscoverSolutionProperties">auto discovered</a> if enabled.</p>
</div>
</div>
<div class="sect4">
<h5 id="getProblemFacts"><a class="anchor" href="#getProblemFacts"></a><a class="link" href="#getProblemFacts">4.3.7.5. Problem Facts of a Solution (<code>@ProblemFactCollectionProperty</code>)</a></h5>
<div class="paragraph">
<p>For <a href="#droolsScoreCalculation">Drools score calculation</a>, Planner needs to extract the problem fact instances from the solution instance.
It gets those collection(s) by calling every method (or field) that is annotated with <code>@ProblemFactCollectionProperty</code>.
All objects returned by those methods will be inserted into the Drools session, so the score rules can access them.
For example in <code>NQueens</code> all <code>Column</code> and <code>Row</code> instances are problem facts.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningSolution
public class NQueens {
    ...

    private List&lt;Column&gt; columnList;
    private List&lt;Row&gt; rowList;

    @ProblemFactCollectionProperty
    public List&lt;Column&gt; getColumnList() {
        return columnList;
    }

    @ProblemFactCollectionProperty
    public List&lt;Row&gt; getRowList() {
        return rowList;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>All planning entities are automatically inserted into the Drools working memory.
Do note add an annotation on their properties.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The problem facts methods are not called often: at most only once per solver phase per solver thread.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There can be multiple <code>@ProblemFactCollectionProperty</code> annotated members.
Those can even return a <code>Collection</code> with the same class type, but they shouldn&#8217;t return the same instance twice.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A @ProblemFactCollectionProperty annotation needs to be on a member in a class with a @PlanningSolution annotation.
It is ignored on parent classes or subclasses without that annotation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In rare cases, a problem fact might be a singleton: use <code>@ProblemFactProperty</code> on its method (or field) instead.</p>
</div>
<div class="paragraph">
<p>Both annotations can also be <a href="#autoDiscoverSolutionProperties">auto discovered</a> if enabled.</p>
</div>
<div class="sect5">
<h6 id="cachedProblemFact"><a class="anchor" href="#cachedProblemFact"></a><a class="link" href="#cachedProblemFact">4.3.7.5.1. Cached Problem Fact</a></h6>
<div class="paragraph">
<p>A cached problem fact is a problem fact that does not exist in the real domain model, but is calculated before the <code>Solver</code> really starts solving.
The problem facts methods have the opportunity to enrich the domain model with such cached problem facts, which can lead to simpler and faster score constraints.</p>
</div>
<div class="paragraph">
<p>For example in examination, a cached problem fact <code>TopicConflict</code> is created for every two <code>Topic</code>s which share at least one <code>Student</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    @ProblemFactCollectionProperty
    private List&lt;TopicConflict&gt; calculateTopicConflictList() {
        List&lt;TopicConflict&gt; topicConflictList = new ArrayList&lt;TopicConflict&gt;();
        for (Topic leftTopic : topicList) {
            for (Topic rightTopic : topicList) {
                if (leftTopic.getId() &lt; rightTopic.getId()) {
                    int studentSize = 0;
                    for (Student student : leftTopic.getStudentList()) {
                        if (rightTopic.getStudentList().contains(student)) {
                            studentSize++;
                        }
                    }
                    if (studentSize &gt; 0) {
                        topicConflictList.add(new TopicConflict(leftTopic, rightTopic, studentSize));
                    }
                }
            }
        }
        return topicConflictList;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where a score constraint needs to check that no two exams with a topic that shares a student are scheduled close together (depending on the constraint: at the same time, in a row, or in the same day), the <code>TopicConflict</code> instance can be used as a problem fact, rather than having to combine every two <code>Student</code> instances.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="autoDiscoverSolutionProperties"><a class="anchor" href="#autoDiscoverSolutionProperties"></a><a class="link" href="#autoDiscoverSolutionProperties">4.3.7.6. Auto Discover Solution Properties</a></h5>
<div class="paragraph">
<p>Instead of configuring each property (or field) annotation explicitly,
some can also be deducted automatically by Planner.
For example, on the cloud balancing example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningSolution(autoDiscoverMemberType = AutoDiscoverMemberType.FIELD)
public class CloudBalance {

    // Auto discovered as @ProblemFactCollectionProperty
    @ValueRangeProvider(id = "computerRange") // Not (yet) auto discovered
    private List&lt;CloudComputer&gt; computerList;

    // Auto discovered as @PlanningEntityCollectionProperty
    private List&lt;CloudProcess&gt; processList;

    // Auto discovered as @PlanningScore
    private HardSoftScore score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>AutoDiscoverMemberType</code> can be:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>NONE</code>: No auto discovery.</p>
</li>
<li>
<p><code>FIELD</code>: Auto discover all fields on the <code>@PlanningSolution</code> class</p>
</li>
<li>
<p><code>GETTER</code>: Auto discover all getters on the <code>@PlanningSolution</code> class</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The automatic annotation is based on the field type (or getter return type):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@ProblemFactProperty</code>: when it isn&#8217;t a <code>Collection</code>, a <code>@PlanningEntity</code> class or a <code>Score</code></p>
</li>
<li>
<p><code>@ProblemFactCollectionProperty</code>: when it&#8217;s a <code>Collection</code> of a type that isn&#8217;t a <code>@PlanningEntity</code> class</p>
</li>
<li>
<p><code>@PlanningEntityProperty</code>: when it is a configured <code>@PlanningEntity</code> class or subclass</p>
</li>
<li>
<p><code>@PlanningEntityCollectionProperty</code>: when it&#8217;s a <code>Collection</code> of a type that is a configured <code>@PlanningEntity</code> class or subclass</p>
</li>
<li>
<p><code>@PlanningScore</code>: when it is a <code>Score</code> or subclass</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These automatic annotation can still be overwritten per field (or getter).
Specifically, a <a href="#bendableScore">BendableScore</a> always needs to override
with an explicit <code>@PlanningScore</code> annotation to define the number of hard and soft levels.</p>
</div>
</div>
<div class="sect4">
<h5 id="cloningASolution"><a class="anchor" href="#cloningASolution"></a><a class="link" href="#cloningASolution">4.3.7.7. Cloning a Solution</a></h5>
<div class="paragraph">
<p>Most (if not all) optimization algorithms clone the solution each time they encounter a new best solution (so they can recall it later) or to work with multiple solutions in parallel.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>There are many ways to clone, such as a shallow clone, deep clone, &#8230;&#8203; This context focuses on <em>a planning clone</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A planning clone of a solution must fulfill these requirements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The clone must represent the same planning problem. Usually it reuses the same instances of the problem facts and problem fact collections as the original.</p>
</li>
<li>
<p>The clone must use different, cloned instances of the entities and entity collections. Changes to an original <code>Solution</code> entity&#8217;s variables must not affect its clone.</p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./PlannerConfiguration/solutionCloning.png" alt="solutionCloning">
</div>
</div>
<div class="paragraph">
<p><strong>Implementing a planning clone method is hard, therefore you do not need to implement it.</strong></p>
</div>
<div class="sect5">
<h6 id="fieldAccessingSolutionCloner"><a class="anchor" href="#fieldAccessingSolutionCloner"></a><a class="link" href="#fieldAccessingSolutionCloner">4.3.7.7.1. <code>FieldAccessingSolutionCloner</code></a></h6>
<div class="paragraph">
<p>This <code>SolutionCloner</code> is used by default.
It works well for most use cases.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When the <code>FieldAccessingSolutionCloner</code> clones one of your collections or maps,
it may not recognize the implementation and replace it with <code>ArrayList</code>, <code>LinkedHashSet</code>, <code>TreeSet</code>, <code>LinkedHashMap</code>
or <code>TreeMap</code> (whichever is more applicable) .
It recognizes most of the common JDK collection and map implementations.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>FieldAccessingSolutionCloner</code> does not clone problem facts by default.
If any of your problem facts needs to be deep cloned for a planning clone, for example if the problem fact references a planning entity or the planning solution, mark it with a <code>@DeepPlanningClone</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@DeepPlanningClone
public class SeatDesignationDependency {
    private SeatDesignation leftSeatDesignation; // planning entity
    private SeatDesignation rightSeatDesignation; // planning entity
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above, because <code>SeatDesignation</code> is a planning entity (which is deep planning cloned automatically), <code>SeatDesignationDependency</code> must also be deep planning cloned.</p>
</div>
<div class="paragraph">
<p>Alternatively, the <code>@DeepPlanningClone</code> annotation can also be used on a getter method.</p>
</div>
</div>
<div class="sect5">
<h6 id="customCloning"><a class="anchor" href="#customCloning"></a><a class="link" href="#customCloning">4.3.7.7.2. Custom Cloning with a SolutionCloner</a></h6>
<div class="paragraph">
<p>To use a customer cloner, configure it on the planning solution:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningSolution(solutionCloner = NQueensSolutionCloner.class)
public class NQueens {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, a <code>NQueens</code> planning clone only deep clones all <code>Queen</code> instances.
So when the original solution changes (later on during planning) and one or more <code>Queen</code> instances change,
the planning clone isn&#8217;t affected.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class NQueensSolutionCloner implements SolutionCloner&lt;NQueens&gt; {

    @Override
    public NQueens cloneSolution(CloneLedger ledger, NQueens original) {
        NQueens clone = new NQueens();
        ledger.registerClone(original, clone);
        clone.setId(original.getId());
        clone.setN(original.getN());
        clone.setColumnList(original.getColumnList());
        clone.setRowList(original.getRowList());
        List&lt;Queen&gt; queenList = original.getQueenList();
        List&lt;Queen&gt; clonedQueenList = new ArrayList&lt;Queen&gt;(queenList.size());
        for (Queen originalQueen : queenList) {
            Queen cloneQueen = new Queen();
            ledger.registerClone(originalQueen, cloneQueen);
            cloneQueen.setId(originalQueen.getId());
            cloneQueen.setColumn(originalQueen.getColumn());
            cloneQueen.setRow(originalQueen.getRow());
            clonedQueenList.add(cloneQueen);
        }
        clone.setQueenList(clonedQueenList);
        clone.setScore(original.getScore());
        return clone;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>The <code>cloneSolution()</code> method should only deep clone the planning entities.</em>
Notice that the problem facts, such as <code>Column</code> and <code>Row</code> are normally <em>not</em> cloned: even their <code>List</code> instances are <em>not</em> cloned.
If the problem facts were cloned too, then you would have to make sure that the new planning entity clones also refer to the new problem facts clones used by the cloned solution.
For example, if you were to clone all <code>Row</code> instances, then each <code>Queen</code> clone and the <code>NQueens</code> clone itself should refer to those new <code>Row</code> clones.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Cloning an entity with a <a href="#chainedPlanningVariable">chained</a> variable is devious: a variable of an entity A might point to another entity B.
If A is cloned, then its variable must point to the clone of B, not the original B.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="createAnUninitializedSolution"><a class="anchor" href="#createAnUninitializedSolution"></a><a class="link" href="#createAnUninitializedSolution">4.3.7.8. Create an Uninitialized Solution</a></h5>
<div class="paragraph">
<p>Create a <code>Solution</code> instance to represent your planning problem&#8217;s dataset, so it can be set on the <code>Solver</code> as the planning problem to solve.
For example in n queens, an <code>NQueens</code> instance is created with the required <code>Column</code> and <code>Row</code> instances and every <code>Queen</code> set to a different <code>column</code> and every <code>row</code> set to <code>null</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    private NQueens createNQueens(int n) {
        NQueens nQueens = new NQueens();
        nQueens.setId(0L);
        nQueens.setN(n);
        nQueens.setColumnList(createColumnList(nQueens));
        nQueens.setRowList(createRowList(nQueens));
        nQueens.setQueenList(createQueenList(nQueens));
        return nQueens;
    }

    private List&lt;Queen&gt; createQueenList(NQueens nQueens) {
        int n = nQueens.getN();
        List&lt;Queen&gt; queenList = new ArrayList&lt;Queen&gt;(n);
        long id = 0L;
        for (Column column : nQueens.getColumnList()) {
            Queen queen = new Queen();
            queen.setId(id);
            id++;
            queen.setColumn(column);
            // Notice that we leave the PlanningVariable properties on null
            queenList.add(queen);
        }
        return queenList;
    }</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: left">
<div class="content">
<img src="./PlannerConfiguration/uninitializedNQueens04.png" alt="uninitializedNQueens04">
</div>
<div class="title">Figure 4. Uninitialized Solution for the Four Queens Puzzle</div>
</div>
<div class="paragraph">
<p>Usually, most of this data comes from your data layer, and your <code>Solution</code> implementation just aggregates that data and creates the uninitialized planning entity instances to plan:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">        private void createLectureList(CourseSchedule schedule) {
            List&lt;Course&gt; courseList = schedule.getCourseList();
            List&lt;Lecture&gt; lectureList = new ArrayList&lt;Lecture&gt;(courseList.size());
            long id = 0L;
            for (Course course : courseList) {
                for (int i = 0; i &lt; course.getLectureSize(); i++) {
                    Lecture lecture = new Lecture();
                    lecture.setId(id);
                    id++;
                    lecture.setCourse(course);
                    lecture.setLectureIndexInCourse(i);
                    // Notice that we leave the PlanningVariable properties (period and room) on null
                    lectureList.add(lecture);
                }
            }
            schedule.setLectureList(lectureList);
        }</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="useTheSolver"><a class="anchor" href="#useTheSolver"></a><a class="link" href="#useTheSolver">4.4. Use the <code>Solver</code></a></h3>
<div class="sect3">
<h4 id="theSolverInterface"><a class="anchor" href="#theSolverInterface"></a><a class="link" href="#theSolverInterface">4.4.1. The <code>Solver</code> Interface</a></h4>
<div class="paragraph">
<p>A <code>Solver</code> implementation will solve your planning problem.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public interface Solver&lt;Solution_&gt; {

    Solution_ solve(Solution_ planningProblem);

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>Solver</code> can only solve one planning problem instance at a time.
A <code>Solver</code> should only be accessed from a single thread, except for the methods that are specifically javadocced as being thread-safe.
It is built with a <code>SolverFactory</code>, there is no need to implement it yourself.</p>
</div>
</div>
<div class="sect3">
<h4 id="solvingAProblem"><a class="anchor" href="#solvingAProblem"></a><a class="link" href="#solvingAProblem">4.4.2. Solving a Problem</a></h4>
<div class="paragraph">
<p>Solving a problem is quite easy once you have:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>Solver</code> built from a solver configuration</p>
</li>
<li>
<p>A <code>Solution</code> that represents the planning problem instance</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Just provide the planning problem as argument to the <code>solve()</code> method and it will return the best solution found:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    NQueens bestSolution = solver.solve(planningProblem);</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example in n queens, the <code>solve()</code> method will return an <code>NQueens</code> instance with every <code>Queen</code> assigned to a <code>Row</code>.</p>
</div>
<div class="imageblock" style="text-align: left">
<div class="content">
<img src="./PlannerConfiguration/solvedNQueens04.png" alt="solvedNQueens04">
</div>
<div class="title">Figure 5. Best Solution for the Four Queens Puzzle in 8ms (Also an Optimal Solution)</div>
</div>
<div class="paragraph">
<p>The <code>solve(Solution)</code> method can take a long time (depending on the problem size and the solver configuration). The <code>Solver</code> intelligently wades through <a href="#searchSpaceSize">the search space</a> of possible solutions and remembers the best solution it encounters during solving.
Depending on a number factors (including problem size, how much time the <code>Solver</code> has, the solver configuration, &#8230;&#8203;), <a href="#doesPlannerFindTheOptimalSolution">that best solution might or might not be an optimal solution</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>Solution</code> instance given to the method <code>solve(Solution)</code> is changed by the <code>Solver</code>, but do not mistake it for the best solution.</p>
</div>
<div class="paragraph">
<p>The <code>Solution</code> instance returned by the methods <code>solve(Solution)</code> or <code>getBestSolution()</code> is most likely <a href="#cloningASolution">a planning clone</a> of the instance given to the method <code>solve(Solution)</code>, which implies it is a different instance.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>Solution</code> instance given to the <code>solve(Solution)</code> method does not need to be uninitialized.
It can be partially or fully initialized, which is often the case in <a href="#repeatedPlanning">repeated planning</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="environmentMode"><a class="anchor" href="#environmentMode"></a><a class="link" href="#environmentMode">4.4.3. Environment Mode: Are There Bugs in my Code?</a></h4>
<div class="paragraph">
<p>The environment mode allows you to detect common bugs in your implementation.
It does not affect the <a href="#logging">logging level</a>.</p>
</div>
<div class="paragraph">
<p>You can set the environment mode in the solver configuration XML file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;solver&gt;
  &lt;environmentMode&gt;FAST_ASSERT&lt;/environmentMode&gt;
  ...
&lt;/solver&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A solver has a single <code>Random</code> instance.
Some solver configurations use the <code>Random</code> instance a lot more than others.
For example, Simulated Annealing depends highly on random numbers, while Tabu Search only depends on it to deal with score ties.
The environment mode influences the seed of that <code>Random</code> instance.</p>
</div>
<div class="paragraph">
<p>These are the environment modes:</p>
</div>
<div class="sect4">
<h5 id="environmentModeFullAssert"><a class="anchor" href="#environmentModeFullAssert"></a><a class="link" href="#environmentModeFullAssert">4.4.3.1. FULL_ASSERT</a></h5>
<div class="paragraph">
<p>The FULL_ASSERT mode turns on all assertions (such as assert that the incremental score calculation is uncorrupted for each move) to fail-fast on a bug in a Move implementation, a score rule, the rule engine itself, &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>This mode is reproducible (see the reproducible mode). It is also intrusive because it calls the method <code>calculateScore()</code> more frequently than a non-assert mode.</p>
</div>
<div class="paragraph">
<p>The FULL_ASSERT mode is horribly slow (because it does not rely on incremental score calculation).</p>
</div>
</div>
<div class="sect4">
<h5 id="environmentModeNonIntrusiveFullAssert"><a class="anchor" href="#environmentModeNonIntrusiveFullAssert"></a><a class="link" href="#environmentModeNonIntrusiveFullAssert">4.4.3.2. NON_INTRUSIVE_FULL_ASSERT</a></h5>
<div class="paragraph">
<p>The NON_INTRUSIVE_FULL_ASSERT turns on several assertions to fail-fast on a bug in a Move implementation, a score rule, the rule engine itself, &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>This mode is reproducible (see the reproducible mode). It is non-intrusive because it does not call the method <code>calculateScore()</code> more frequently than a non assert mode.</p>
</div>
<div class="paragraph">
<p>The NON_INTRUSIVE_FULL_ASSERT mode is horribly slow (because it does not rely on incremental score calculation).</p>
</div>
</div>
<div class="sect4">
<h5 id="environmentModeFastAssert"><a class="anchor" href="#environmentModeFastAssert"></a><a class="link" href="#environmentModeFastAssert">4.4.3.3. FAST_ASSERT</a></h5>
<div class="paragraph">
<p>The FAST_ASSERT mode turns on most assertions (such as assert that an undoMove&#8217;s score is the same as before the Move) to fail-fast on a bug in a Move implementation, a score rule, the rule engine itself, &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>This mode is reproducible (see the reproducible mode). It is also intrusive because it calls the method <code>calculateScore()</code> more frequently than a non assert mode.</p>
</div>
<div class="paragraph">
<p>The FAST_ASSERT mode is slow.</p>
</div>
<div class="paragraph">
<p>It is recommended to write a test case that does a short run of your planning problem with the FAST_ASSERT mode on.</p>
</div>
</div>
<div class="sect4">
<h5 id="environmentModeReproducible"><a class="anchor" href="#environmentModeReproducible"></a><a class="link" href="#environmentModeReproducible">4.4.3.4. REPRODUCIBLE (default)</a></h5>
<div class="paragraph">
<p>The reproducible mode is the default mode because it is recommended during development.
In this mode, two runs in the same Planner version will execute the same code in the same order. <strong>Those two
        runs will have the same result at every step</strong>, except if the note below applies.
This enables you to reproduce bugs consistently.
It also allows you to benchmark certain refactorings (such as a score constraint performance optimization) fairly across runs.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Despite the reproducible mode, your application might still not be fully reproducible because of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use of <code>HashSet</code> (or another <code>Collection</code> which has an inconsistent order between JVM runs) for collections of planning entities or planning values (but not normal problem facts), especially in the <code>Solution</code> implementation. Replace it with <code>LinkedHashSet</code>.</p>
</li>
<li>
<p>Combining a time gradient dependent algorithms (most notably Simulated Annealing) together with time spent termination. A sufficiently large difference in allocated CPU time will influence the time gradient values. Replace Simulated Annealing with Late Acceptance. Or instead, replace time spent termination with step count termination.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The reproducible mode can be slightly slower than the non-reproducible mode.
If your production environment can benefit from reproducibility, use this mode in production.</p>
</div>
<div class="paragraph">
<p>In practice, this mode uses the default, fixed <a href="#randomNumberGenerator">random seed</a> if no seed is specified, and it also disables certain concurrency optimizations (such as work stealing).</p>
</div>
</div>
<div class="sect4">
<h5 id="environmentModeProduction"><a class="anchor" href="#environmentModeProduction"></a><a class="link" href="#environmentModeProduction">4.4.3.5. NON_REPRODUCIBLE</a></h5>
<div class="paragraph">
<p>The non-reproducible mode can be slightly faster than the reproducible mode.
Avoid using it during development as it makes debugging and bug fixing painful.
If your production environment doesn&#8217;t care about reproducibility, use this mode in production.</p>
</div>
<div class="paragraph">
<p>In practice, this mode uses no fixed <a href="#randomNumberGenerator">random seed</a> if no seed is specified.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="logging"><a class="anchor" href="#logging"></a><a class="link" href="#logging">4.4.4. Logging Level: What is the <code>Solver</code> Doing?</a></h4>
<div class="paragraph">
<p>The best way to illuminate the black box that is a <code>Solver</code>, is to play with the logging level:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>error</strong>: Log errors, except those that are thrown to the calling code as a <code>RuntimeException</code>.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>If an error happens, Planner normally fails fast</strong>: it throws a subclass of <code>RuntimeException</code> with a detailed message to the calling code.
It does not log it as an error itself to avoid duplicate log messages.
Except if the calling code explicitly catches and eats that <code>RuntimeException</code>, a <code>Thread</code>'s default <code>ExceptionHandler</code> will log it as an error anyway.
Meanwhile, the code is disrupted from doing further harm or obfuscating the error.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p><strong>warn</strong>: Log suspicious circumstances.</p>
</li>
<li>
<p><strong>info</strong>: Log every phase and the solver itself. See <a href="#scopeOverview">scope overview</a>.</p>
</li>
<li>
<p><strong>debug</strong>: Log every step of every phase. See <a href="#scopeOverview">scope overview</a>.</p>
</li>
<li>
<p><strong>trace</strong>: Log every move of every step of every phase. See <a href="#scopeOverview">scope overview</a>.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Turning on <code>trace</code> logging, will slow down performance considerably: it is often four times slower.
However, it is invaluable during development to discover a bottleneck.</p>
</div>
<div class="paragraph">
<p>Even <code>debug</code> logging can slow down performance considerably for fast stepping algorithms (such as Late Acceptance and Simulated Annealing),
but not for slow stepping algorithms (such as Tabu Search).</p>
</div>
<div class="paragraph">
<p>Both cause congestion in <a href="#multiThreadedSolving">multi-threaded solving</a> with most appenders, see below.</p>
</div>
<div class="paragraph">
<p>In Eclipse, <code>debug</code> logging to the console tends to cause congestion with a score calculation speeds above 10 000 per second.
Nor IntelliJ, nor the Maven command line suffer from this problem.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example, set it to <code>debug</code> logging, to see when the phases end and how fast steps are taken:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>INFO  Solving started: time spent (3), best score (-4init/0), random (JDK with seed 0).
DEBUG     CH step (0), time spent (5), score (-3init/0), selected move count (1), picked move (Queen-2 {null -&gt; Row-0}).
DEBUG     CH step (1), time spent (7), score (-2init/0), selected move count (3), picked move (Queen-1 {null -&gt; Row-2}).
DEBUG     CH step (2), time spent (10), score (-1init/0), selected move count (4), picked move (Queen-3 {null -&gt; Row-3}).
DEBUG     CH step (3), time spent (12), score (-1), selected move count (4), picked move (Queen-0 {null -&gt; Row-1}).
INFO  Construction Heuristic phase (0) ended: time spent (12), best score (-1), score calculation speed (9000/sec), step total (4).
DEBUG     LS step (0), time spent (19), score (-1),     best score (-1), accepted/selected move count (12/12), picked move (Queen-1 {Row-2 -&gt; Row-3}).
DEBUG     LS step (1), time spent (24), score (0), new best score (0), accepted/selected move count (9/12), picked move (Queen-3 {Row-3 -&gt; Row-2}).
INFO  Local Search phase (1) ended: time spent (24), best score (0), score calculation speed (4000/sec), step total (2).
INFO  Solving ended: time spent (24), best score (0), score calculation speed (7000/sec), phase total (2), environment mode (REPRODUCIBLE).</code></pre>
</div>
</div>
<div class="paragraph">
<p>All time spent values are in milliseconds.</p>
</div>
<div class="paragraph">
<p>Everything is logged to <a href="http://www.slf4j.org/">SLF4J</a>, which is a simple logging facade
which delegates every log message to Logback, Apache Commons Logging, Log4j or java.util.logging.
Add a dependency to the logging adaptor for your logging framework of choice.</p>
</div>
<div class="paragraph">
<p>If you are not using any logging framework yet, use Logback by adding this Maven dependency (there is no need to add an extra bridge dependency):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;dependency&gt;
      &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;
      &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;
      &lt;version&gt;1.x&lt;/version&gt;
    &lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Configure the logging level on the <code>org.optaplanner</code> package in your <code>logback.xml</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;configuration&gt;

  &lt;logger name="org.optaplanner" level="debug"/&gt;

  ...

&lt;/configuration&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If it isn&#8217;t picked up, temporarily add the system property <code>-Dlogback.debug=true</code> to figure out why.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When running multiple solvers or one <a href="#multiThreadedSolving">multi-threaded solver</a>,
most appenders (including the console) cause congestion with <code>debug</code> and <code>trace</code> logging.
Switch to an async appender to avoid this problem or turn off <code>debug</code> logging.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If instead, you are still using Log4J 1.x (and you do not want to switch to its faster successor, Logback), add the bridge dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;dependency&gt;
      &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
      &lt;artifactId&gt;slf4j-log4j12&lt;/artifactId&gt;
      &lt;version&gt;1.x&lt;/version&gt;
    &lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>And configure the logging level on the package <code>org.optaplanner</code> in your <code>log4j.xml</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;log4j:configuration xmlns:log4j="http://jakarta.apache.org/log4j/"&gt;

  &lt;category name="org.optaplanner"&gt;
    &lt;priority value="debug" /&gt;
  &lt;/category&gt;

  ...

&lt;/log4j:configuration&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In a multitenant application, multiple <code>Solver</code> instances might be running at the same time.
To separate their logging into distinct files, surround the <code>solve()</code> call with an <a href="http://logback.qos.ch/manual/mdc.html">MDC</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">        MDC.put("tenant.name",tenantName);
        MySolution bestSolution = solver.solve(planningProblem);
        MDC.remove("tenant.name");</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then configure your logger to use different files for each <code>${tenant.name}</code>.
For example in Logback, use a <code>SiftingAppender</code> in <code>logback.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;appender name="fileAppender" class="ch.qos.logback.classic.sift.SiftingAppender"&gt;
    &lt;discriminator&gt;
      &lt;key&gt;tenant.name&lt;/key&gt;
      &lt;defaultValue&gt;unknown&lt;/defaultValue&gt;
    &lt;/discriminator&gt;
    &lt;sift&gt;
      &lt;appender name="fileAppender.${tenant.name}" class="...FileAppender"&gt;
        &lt;file&gt;local/log/optaplanner-${tenant.name}.log&lt;/file&gt;
        ...
      &lt;/appender&gt;
    &lt;/sift&gt;
  &lt;/appender&gt;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="randomNumberGenerator"><a class="anchor" href="#randomNumberGenerator"></a><a class="link" href="#randomNumberGenerator">4.4.5. Random Number Generator</a></h4>
<div class="paragraph">
<p>Many heuristics and metaheuristics depend on a pseudorandom number generator for move selection, to resolve score ties, probability based move acceptance, &#8230;&#8203; During solving, the same <code>Random</code> instance is reused to improve reproducibility, performance and uniform distribution of random values.</p>
</div>
<div class="paragraph">
<p>To change the random seed of that <code>Random</code> instance, specify a <code>randomSeed</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;solver&gt;
  &lt;randomSeed&gt;0&lt;/randomSeed&gt;
  ...
&lt;/solver&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To change the pseudorandom number generator implementation, specify a <code>randomType</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;solver&gt;
  &lt;randomType&gt;MERSENNE_TWISTER&lt;/randomType&gt;
  ...
&lt;/solver&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following types are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>JDK</code> (default): Standard implementation (<code>java.util.Random</code>).</p>
</li>
<li>
<p><code>MERSENNE_TWISTER</code>: Implementation by <a href="http://commons.apache.org/proper/commons-math/userguide/random.html">Commons Math</a>.</p>
</li>
<li>
<p><code>WELL512A</code>, <code>WELL1024A</code>, <code>WELL19937A</code>, <code>WELL19937C</code>, <code>WELL44497A</code> and <code>WELL44497B</code>: Implementation by <a href="http://commons.apache.org/proper/commons-math/userguide/random.html">Commons Math</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For most use cases, the randomType has no significant impact on the average quality of the best solution on multiple datasets.
If you want to confirm this on your use case, use the <a href="#benchmarker">benchmarker</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="scoreCalculation"><a class="anchor" href="#scoreCalculation"></a><a class="link" href="#scoreCalculation">5. Score Calculation</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="scoreTerminology"><a class="anchor" href="#scoreTerminology"></a><a class="link" href="#scoreTerminology">5.1. Score Terminology</a></h3>
<div class="sect3">
<h4 id="whatIsAScore"><a class="anchor" href="#whatIsAScore"></a><a class="link" href="#whatIsAScore">5.1.1. What is a Score?</a></h4>
<div class="paragraph">
<p>Every <code>Solution</code> has a score.
The score is an objective way to compare two solutions.
The solution with the higher score is better.
The <code>Solver</code> aims to find the <code>Solution</code> with the highest <code>Score</code> of all possible solutions.
The <em>best solution</em> is the <code>Solution</code> with the highest <code>Score</code> that <code>Solver</code> has encountered during solving,
which might be the <em>optimal solution</em>.</p>
</div>
<div class="paragraph">
<p>Planner cannot automatically know which <code>Solution</code> is best for your business, so you need to tell it how to calculate the score of a given <code>Solution</code> according to your business needs.
If you forget or are unable to implement an important business constraint, the solution is probably useless:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./ScoreCalculation/optimalWithIncompleteConstraints.png" alt="optimalWithIncompleteConstraints">
</div>
</div>
</div>
<div class="sect3">
<h4 id="formalizeTheBusinessConstraints"><a class="anchor" href="#formalizeTheBusinessConstraints"></a><a class="link" href="#formalizeTheBusinessConstraints">5.1.2. Formalize the Business Constraints</a></h4>
<div class="paragraph">
<p>To implement a verbal business constraint, it needs to be formalized as a score constraint.
Luckily, defining constraints in Planner is very flexible through the following score techniques:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Score signum (positive or negative)</strong>: maximize or minimize a constraint type</p>
</li>
<li>
<p><strong>Score weight</strong>: put a cost/profit on a constraint type</p>
</li>
<li>
<p><strong>Score level (hard, soft, &#8230;&#8203;)</strong>: prioritize a group of constraint types</p>
</li>
<li>
<p><strong>Pareto scoring</strong> (rarely used)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Take the time to acquaint yourself with the first three techniques.
Once you understand them, formalizing most business constraints becomes straightforward.</p>
</div>
</div>
<div class="sect3">
<h4 id="scoreConstraintSignum"><a class="anchor" href="#scoreConstraintSignum"></a><a class="link" href="#scoreConstraintSignum">5.1.3. Score Constraint Signum (Positive or Negative)</a></h4>
<div class="paragraph">
<p>All score techniques are based on constraints.
A constraint can be a simple pattern (such as <em>Maximize the apple harvest in the solution</em>) or a more complex pattern.
A positive constraint is a constraint you want to maximize.
A negative constraint is a constraint you want to minimize.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./ScoreCalculation/positiveAndNegativeConstraints.png" alt="positiveAndNegativeConstraints">
</div>
</div>
<div class="paragraph">
<p>The image above illustrates that <strong>the optimal solution always has the highest score</strong>,
regardless if the constraints are positive or negative.</p>
</div>
<div class="paragraph">
<p>Most planning problems have only negative constraints and therefore have a negative score.
In that case, the score is the sum of the weight of the negative constraints being broken, with a perfect score of 0.
This explains why the score of a solution of four queens is the negative of the number of queen pairs which can attack each other.</p>
</div>
<div class="paragraph">
<p>Negative and positive constraints can be combined, even in the same score level.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not presume that your business knows all its score constraints in advance.
Expect score constraints to be added or changed after the first releases.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When a constraint activates (because the negative constraint is broken or the positive constraint is fulfilled) on a certain planning entity set, it is called a <em>constraint match</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="scoreConstraintWeight"><a class="anchor" href="#scoreConstraintWeight"></a><a class="link" href="#scoreConstraintWeight">5.1.4. Score Constraint Weight</a></h4>
<div class="paragraph">
<p>Not all score constraints are equally important.
If breaking one constraint is equally bad as breaking another constraint x times, then those two constraints have a different weight (but they are in the same score level). For example in vehicle routing, you can make one "unhappy driver" constraint match count as much as two "fuel tank usage" constraint matches:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./ScoreCalculation/scoreWeighting.png" alt="scoreWeighting">
</div>
</div>
<div class="paragraph">
<p>Score weighting is easy in use cases where you can <em>put a price tag on everything</em>.
In that case, the positive constraints maximize revenue and the negative constraints minimize expenses, so together they maximize profit.
Alternatively, score weighting is also often used to create social <a href="#fairnessScoreConstraints">fairness</a>.
For example, a nurse, who requests a free day, pays a higher weight on New Years eve than on a normal day.</p>
</div>
<div class="paragraph">
<p>The weight of a constraint match can be dynamically based on the planning entities involved.
For example in cloud balance, the weight of the soft constraint match for an active <code>Computer</code> is the <code>cost</code> of that <code>Computer</code> (which differs per computer).</p>
</div>
<div class="paragraph">
<p>Putting a good weight on a constraint can be a difficult analytical decision, because it is about making choices and tradeoffs with other constraints.
Don&#8217;t spend too much time on it at the start of an implementation.
A non-accurate weight is less damaging than mediocre algorithms:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./ScoreCalculation/scoreTradeoffInPerspective.png" alt="scoreTradeoffInPerspective">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When deciding the weights of some constraints is debatable, it&#8217;s recommended to make them configurable at runtime, as demonstrated in the exam timetabling example with the <code>InstitutionParametrization</code> class.
This allow the end-user to recalibrate constraint weights in the user interface and immediately discover the impact of the new weights by running the solver again.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Most use cases use a <code>Score</code> with <code>int</code> weights, such as <a href="#hardSoftScore">HardSoftScore</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="scoreLevel"><a class="anchor" href="#scoreLevel"></a><a class="link" href="#scoreLevel">5.1.5. Score Constraint Level (hard, soft, &#8230;&#8203;)</a></h4>
<div class="paragraph">
<p>Sometimes a score constraint outranks another score constraint, no matter how many times the other is broken.
In that case, those score constraints are in different levels.
For example, a nurse cannot do two shifts at the same time (due to the constraints of physical reality), this outranks all nurse happiness constraints.</p>
</div>
<div class="paragraph">
<p>Most use cases have only two score levels, hard and soft.
The levels of two scores are compared lexicographically.
The first score level gets compared first.
If those differ, the remaining score levels are ignored.
For example, a score that breaks <code>0</code> hard constraints and <code>1000000</code> soft constraints is better than a score that breaks <code>1</code> hard constraint and <code>0</code> soft constraints.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./ScoreCalculation/scoreLevels.png" alt="scoreLevels">
</div>
</div>
<div class="paragraph">
<p>If there are two (or more) score levels, for example a hard and soft level, then a score is <em>feasible</em> if no hard constraints are broken.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>By default, Planner will always assign all planning variables a planning value.
If there is no feasible solution, this means the best solution will be infeasible.
To instead leave some of the planning entities unassigned, apply <a href="#overconstrainedPlanning">overconstrained planning</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For each constraint, you need to pick a score level, a score weight and a score signum.
For example: <code>-1soft</code> which has score level of <code>soft</code>, a weight of <code>1</code> and a negative signum.
Do not use a big constraint weight when your business actually wants different score levels.
That hack, known as <em>score folding</em>, is broken:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./ScoreCalculation/scoreFoldingIsBroken.png" alt="scoreFoldingIsBroken">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Your business might tell you that your hard constraints all have the same weight, because they cannot be broken (so the weight does not matter). This is not true because if no feasible solution exists for a specific dataset, the least infeasible solution allows the business to estimate how many business resources they are lacking.
For example in cloud balancing, how many new computers to buy.</p>
</div>
<div class="paragraph">
<p>Furthermore, it will likely create a <a href="#scoreTrap">score trap</a>.
For example in cloud balance if a <code>Computer</code> has seven CPU too little for its <code>Process</code>es, then it must be weighted seven times as much as if it had only one CPU too little.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Three or more score levels are supported.
For example: a company might decide that profit outranks employee satisfaction (or vice versa), while both are outranked by the constraints of physical reality.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To model fairness or load balancing, there is <a href="#fairnessScoreConstraints">no need to use lots of score levels</a>
(even though Planner can handle many score levels).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Most use cases use a <code>Score</code> with two weights, such as <a href="#hardSoftScore">HardSoftScore</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="paretoScoring"><a class="anchor" href="#paretoScoring"></a><a class="link" href="#paretoScoring">5.1.6. Pareto Scoring (AKA Multi-objective Optimization Scoring)</a></h4>
<div class="paragraph">
<p>Far less common is the use case of pareto optimization, which is also known under the more confusing term multi-objective optimization.
In pareto scoring, score constraints are in the same score level, yet they are not weighted against each other.
When two scores are compared, each of the score constraints are compared individually and the score with the most dominating score constraints wins.
Pareto scoring can even be combined with score levels and score constraint weighting.</p>
</div>
<div class="paragraph">
<p>Consider this example with positive constraints, where we want to get the most apples and oranges.
Since it is impossible to compare apples and oranges, we can not weight them against each other.
Yet, despite that we can not compare them, we can state that two apples are better then one apple.
Similarly, we can state that two apples and one orange are better than just one orange.
So despite our inability to compare some Scores conclusively (at which point we declare them equal), we can find a set of optimal scores.
Those are called pareto optimal.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./ScoreCalculation/paretoOptimizationScoring.png" alt="paretoOptimizationScoring">
</div>
</div>
<div class="paragraph">
<p>Scores are considered equal far more often.
It is left up to a human to choose the better out of a set of best solutions (with equal scores) found by Planner.
In the example above, the user must choose between solution A (three apples and one orange) and solution B (one apple and six oranges). It is guaranteed that Planner has not found another solution which has more apples or more oranges or even a better combination of both (such as two apples and three oranges).</p>
</div>
<div class="paragraph">
<p>To implement pareto scoring in Planner, <a href="#customScore">implement a custom <code>ScoreDefinition</code> and <code>Score</code></a> (and replace the <code>BestSolutionRecaller</code>). Future versions will provide out-of-the-box support.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A pareto <code>Score</code>'s <code>compareTo</code> method is not transitive because it does a pareto comparison.
For example: having two apples is greater than one apple.
One apple is equal to One orange.
Yet, two apples are not greater than one orange (but actually equal). Pareto comparison violates the contract of the interface <code>java.lang.Comparable</code>'s <code>compareTo</code> method, but Planners systems are <em>pareto comparison safe</em>, unless explicitly stated otherwise in this documentation.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="combiningScoreTechniques"><a class="anchor" href="#combiningScoreTechniques"></a><a class="link" href="#combiningScoreTechniques">5.1.7. Combining Score Techniques</a></h4>
<div class="paragraph">
<p>All the score techniques mentioned above, can be combined seamlessly:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./ScoreCalculation/scoreComposition.png" alt="scoreComposition">
</div>
</div>
</div>
<div class="sect3">
<h4 id="scoreInterface"><a class="anchor" href="#scoreInterface"></a><a class="link" href="#scoreInterface">5.1.8. <code>Score</code> interface</a></h4>
<div class="paragraph">
<p>A score is represented by the <code>Score</code> interface, which naturally extends <code>Comparable</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public interface Score&lt;...&gt; extends Comparable&lt;...&gt; {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Score</code> implementation to use depends on your use case.
Your score might not efficiently fit in a single <code>long</code> value.
Planner has several built-in <code>Score</code> implementations, but you can implement a custom <code>Score</code> too.
Most use cases tend to use the built-in <code>HardSoftScore</code>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./ScoreCalculation/scoreClassDiagram.png" alt="scoreClassDiagram">
</div>
</div>
<div class="paragraph">
<p>All Score implementations also have an <code>initScore</code> (which is an <code>int</code>). It is mostly intended for internal use in Planner: it is the negative number of uninitialized planning variables.
From a user&#8217;s perspective this is <code>0</code>, unless a Construction Heuristic is terminated before it could initialize all planning variables (in which case <code>Score.isSolutionInitialized()</code> returns <code>false</code>).</p>
</div>
<div class="paragraph">
<p>The <code>Score</code> implementation (for example <code>HardSoftScore</code>) must be the same throughout a <code>Solver</code> runtime.
The <code>Score</code> implementation is configured in the solution domain class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningSolution
public class CloudBalance {
    ...

    @PlanningScore
    private HardSoftScore score;

}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="avoidFloatingPointNumbersInScoreCalculation"><a class="anchor" href="#avoidFloatingPointNumbersInScoreCalculation"></a><a class="link" href="#avoidFloatingPointNumbersInScoreCalculation">5.1.9. Avoid Floating Point Numbers in Score Calculation</a></h4>
<div class="paragraph">
<p>Avoid the use of <code>float</code> or <code>double</code> in score calculation.
Use <code>BigDecimal</code> or scaled <code>long</code> instead.</p>
</div>
<div class="paragraph">
<p>Floating point numbers (<code>float</code> and <code>double</code>) cannot represent a decimal number correctly.
For example: a <code>double</code> cannot hold the value <code>0.05</code> correctly.
Instead, it holds the nearest representable value.
Arithmetic (including addition and subtraction) with floating point numbers, especially for planning problems, leads to incorrect decisions:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./ScoreCalculation/scoreWeightType.png" alt="scoreWeightType">
</div>
</div>
<div class="paragraph">
<p>Additionally, floating point number addition is not associative:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">System.out.println( ((0.01 + 0.02) + 0.03) == (0.01 + (0.02 + 0.03)) ); // returns false</code></pre>
</div>
</div>
<div class="paragraph">
<p>This leads to <em>score corruption</em>.</p>
</div>
<div class="paragraph">
<p>Decimal numbers (<code>BigDecimal</code>) have none of these problems.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>BigDecimal arithmetic is considerably slower than <code>int</code>, <code>long</code> or <code>double</code> arithmetic.
In experiments we have seen the score calculation take five times longer.</p>
</div>
<div class="paragraph">
<p>Therefore, in many cases, it can be worthwhile to multiply <em>all</em> numbers for a single score weight by a plural of ten, so the score weight fits in a scaled <code>int</code> or <code>long</code>.
For example, if we multiple all weights by <code>1000</code>, a fuelCost of <code>0.07</code> becomes a fuelCostMillis of <code>70</code> and no longer uses a decimal score weight.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="scoreType"><a class="anchor" href="#scoreType"></a><a class="link" href="#scoreType">5.2. Choose a Score Type</a></h3>
<div class="paragraph">
<p>Depending on the number of score levels and type of score weights you need, choose a <code>Score</code> type.
Most use cases use a <code>HardSoftScore</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To properly write a <code>Score</code> to a database (with JPA/Hibernate) or to XML/JSON (with XStream/JAXB/Jackson), see <a href="#integration">the integration chapter</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="simpleScore"><a class="anchor" href="#simpleScore"></a><a class="link" href="#simpleScore">5.2.1. SimpleScore</a></h4>
<div class="paragraph">
<p>A <code>SimpleScore</code> has a single <code>int</code> value, for example <code>-123</code>.
It has a single score level.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    @PlanningScore
    private SimpleScore score;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Variants of this <code>Score</code> type:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SimpleLongScore</code> uses a <code>long</code> value instead of an <code>int</code> value.</p>
</li>
<li>
<p><code>SimpleDoubleScore</code> uses a <code>double</code> value instead of an <code>int</code> value. <a href="#avoidFloatingPointNumbersInScoreCalculation">Not recommended to use.</a></p>
</li>
<li>
<p><code>SimpleBigDecimalScore</code> uses a <code>BigDecimal</code> value instead of an <code>int</code> value.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="hardSoftScore"><a class="anchor" href="#hardSoftScore"></a><a class="link" href="#hardSoftScore">5.2.2. HardSoftScore (Recommended)</a></h4>
<div class="paragraph">
<p>A <code>HardSoftScore</code> has a hard <code>int</code> value and a soft <code>int</code> value, for example <code>-123hard/-456soft</code>.
It has two score levels (hard and soft).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    @PlanningScore
    private HardSoftScore score;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Variants of this <code>Score</code> type:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>HardSoftLongScore</code> uses <code>long</code> values instead of <code>int</code> values.</p>
</li>
<li>
<p><code>HardSoftDoubleScore</code> uses <code>double</code> values instead of <code>int</code> values. <a href="#avoidFloatingPointNumbersInScoreCalculation">Not recommended to use.</a></p>
</li>
<li>
<p><code>HardSoftBigDecimalScore</code> uses <code>BigDecimal</code> values instead of <code>int</code> values.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="hardMediumSoftScore"><a class="anchor" href="#hardMediumSoftScore"></a><a class="link" href="#hardMediumSoftScore">5.2.3. HardMediumSoftScore</a></h4>
<div class="paragraph">
<p>A <code>HardMediumSoftScore</code> which has a hard <code>int</code> value, a medium <code>int</code> value and a soft <code>int</code> value, for example <code>-123hard/-456medium/-789soft</code>.
It has three score levels (hard, medium and soft).
The hard level determines if the solution is feasible,
and the medium level and soft level score values determine
how well the solution meets business goals.
Higher medium values take precedence over soft values irrespective of the soft value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    @PlanningScore
    private HardMediumSoftScore score;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Variants of this <code>Score</code> type:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>HardMediumSoftLongScore</code> uses <code>long</code> values instead of <code>int</code> values.</p>
</li>
<li>
<p><code>HardMediumSoftBigDecimalScore</code> uses <code>BigDecimal</code> values instead of <code>int</code> values.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="bendableScore"><a class="anchor" href="#bendableScore"></a><a class="link" href="#bendableScore">5.2.4. BendableScore</a></h4>
<div class="paragraph">
<p>A <code>BendableScore</code> has a configurable number of score levels.
It has an array of hard <code>int</code> values and an array of soft <code>int</code> values,
for example with two hard levels and three soft levels, the score can be <code>[-123/-456]hard/[-789/-012/-345]soft</code>.
In that case, it has five score levels.
A solution is feasible if all hard levels are at least zero.</p>
</div>
<div class="paragraph">
<p>A BendableScore with one hard level and one soft level is equivalent to a HardSoftScore,
while a BendableScore with one hard level and two soft levels is equivalent to a HardMediumSoftScore.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    @PlanningScore(bendableHardLevelsSize = 2, bendableSoftLevelsSize = 3)
    private BendableScore score;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The number of hard and soft score levels need to be set at compilation time.
It is not flexible to change during solving.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not use a <code>BendableScore</code> with seven levels just because you have seven constraints.
It is extremely rare to use a different score level for each constraint, because that means one constraint match on soft 0 outweighs even a million constraint matches of soft 1.</p>
</div>
<div class="paragraph">
<p>Usually, multiple constraints share the same level and are weighted against each other.
Use <a href="#explainingTheScore">explaining the score</a> to get the weight of individual constraints in the same level.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Variants of this <code>Score</code> type:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>BendableLongScore</code> uses <code>long</code> values instead of <code>int</code> values.</p>
</li>
<li>
<p><code>BendableBigDecimalScore</code> uses <code>BigDecimal</code> values instead of <code>int</code> values.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="customScore"><a class="anchor" href="#customScore"></a><a class="link" href="#customScore">5.2.5. Implementing a Custom Score</a></h4>
<div class="paragraph">
<p>Internally, each <code>Score</code> implementation also has a <code>ScoreDefinition</code> implementation.
For example: <code>SimpleScore</code> is defined by <code>SimpleScoreDefinition</code>.
The <code>ScoreDefinition</code> interface defines the score representation.</p>
</div>
<div class="paragraph">
<p>To implement a custom <code>Score</code>, also implement such a custom <code>ScoreDefinition</code>.
Extend <code>AbstractScoreDefinition</code> (preferably by copy pasting <code>HardSoftScoreDefinition</code>) and start from there.
Then hook your custom <code>ScoreDefinition</code> in the domain:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    @PlanningScore(scoreDefinitionClass = MyCustomScoreDefinition.class)
    private MyCustomScore score;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To have it integrate seamlessly with <a href="#jpaAndHibernatePersistingAScore">JPA/Hibernate</a>, <a href="#integrationWithXStream">XStream</a>, &#8230;&#8203;, you&#8217;ll need to write some glue code.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="calculateTheScore"><a class="anchor" href="#calculateTheScore"></a><a class="link" href="#calculateTheScore">5.3. Calculate the <code>Score</code></a></h3>
<div class="sect3">
<h4 id="scoreCalculationTypes"><a class="anchor" href="#scoreCalculationTypes"></a><a class="link" href="#scoreCalculationTypes">5.3.1. Score Calculation Types</a></h4>
<div class="paragraph">
<p>There are several ways to calculate the <code>Score</code> of a <code>Solution</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Easy Java score calculation</strong>: implement a single Java method</p>
</li>
<li>
<p><strong>Incremental Java score calculation</strong>: implement multiple Java methods</p>
</li>
<li>
<p><strong>Drools score calculation</strong> (recommended): implement score rules</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Every score calculation type can use any Score definition.
For example, easy Java score calculation can output a <code>HardSoftScore</code>.</p>
</div>
<div class="paragraph">
<p>All score calculation types are Object Oriented and can reuse existing Java code.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The score calculation must be read-only.
It must not change the planning entities or the problem facts in any way.
For example, it must not call a setter method on a planning entity in a Drools score rule&#8217;s RHS.
This does not apply to <em>logically inserted</em> objects, which can be changed by the score rules that logically inserted them in the first place.</p>
</div>
<div class="paragraph">
<p>Planner will not recalculate the score of a <code>Solution</code> if it can predict it (unless an <a href="#environmentMode">environmentMode assertion</a> is enabled). For example, after a winning step is done, there is no need to calculate the score because that move was done and undone earlier.
As a result, there is no guarantee that such changes applied during score calculation are actually done.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="easyJavaScoreCalculation"><a class="anchor" href="#easyJavaScoreCalculation"></a><a class="link" href="#easyJavaScoreCalculation">5.3.2. Easy Java Score Calculation</a></h4>
<div class="paragraph">
<p>An easy way to implement your score calculation in Java.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Advantages:</p>
<div class="ulist">
<ul>
<li>
<p>Plain old Java: no learning curve</p>
</li>
<li>
<p>Opportunity to delegate score calculation to an existing code base or legacy system</p>
</li>
</ul>
</div>
</li>
<li>
<p>Disadvantages:</p>
<div class="ulist">
<ul>
<li>
<p>Slower and less scalable</p>
<div class="ulist">
<ul>
<li>
<p>Because there is no <a href="#incrementalScoreCalculation">incremental score calculation</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Just implement one method of the interface <code>EasyScoreCalculator</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public interface EasyScoreCalculator&lt;Solution_&gt; {

    Score calculateScore(Solution_ solution);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example in n queens:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class NQueensEasyScoreCalculator implements EasyScoreCalculator&lt;NQueens&gt; {

    public SimpleScore calculateScore(NQueens nQueens) {
        int n = nQueens.getN();
        List&lt;Queen&gt; queenList = nQueens.getQueenList();

        int score = 0;
        for (int i = 0; i &lt; n; i++) {
            for (int j = i + 1; j &lt; n; j++) {
                Queen leftQueen = queenList.get(i);
                Queen rightQueen = queenList.get(j);
                if (leftQueen.getRow() != null &amp;&amp; rightQueen.getRow() != null) {
                    if (leftQueen.getRowIndex() == rightQueen.getRowIndex()) {
                        score--;
                    }
                    if (leftQueen.getAscendingDiagonalIndex() == rightQueen.getAscendingDiagonalIndex()) {
                        score--;
                    }
                    if (leftQueen.getDescendingDiagonalIndex() == rightQueen.getDescendingDiagonalIndex()) {
                        score--;
                    }
                }
            }
        }
        return SimpleScore.valueOf(score);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Configure it in your solver configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;scoreDirectorFactory&gt;
    &lt;easyScoreCalculatorClass&gt;org.optaplanner.examples.nqueens.solver.score.NQueensEasyScoreCalculator&lt;/easyScoreCalculatorClass&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, build a <code>EasyScoreCalculator</code> instance at runtime and set it with the programmatic API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    solverFactory.getSolverConfig().getScoreDirectorFactoryConfig.setEasyScoreCalculator(easyScoreCalculator);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="incrementalJavaScoreCalculation"><a class="anchor" href="#incrementalJavaScoreCalculation"></a><a class="link" href="#incrementalJavaScoreCalculation">5.3.3. Incremental Java Score Calculation</a></h4>
<div class="paragraph">
<p>A way to implement your score calculation incrementally in Java.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Advantages:</p>
<div class="ulist">
<ul>
<li>
<p>Very fast and scalable</p>
<div class="ulist">
<ul>
<li>
<p>Currently the fastest if implemented correctly</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Disadvantages:</p>
<div class="ulist">
<ul>
<li>
<p>Hard to write</p>
<div class="ulist">
<ul>
<li>
<p>A scalable implementation heavily uses maps, indexes, &#8230;&#8203; (things the Drools rule engine can do for you)</p>
</li>
<li>
<p>You have to learn, design, write and improve all these performance optimizations yourself</p>
</li>
</ul>
</div>
</li>
<li>
<p>Hard to read</p>
<div class="ulist">
<ul>
<li>
<p>Regular score constraint changes can lead to a high maintenance cost</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Implement all the methods of the interface <code>IncrementalScoreCalculator</code> and extend the class <code>AbstractIncrementalScoreCalculator</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public interface IncrementalScoreCalculator&lt;Solution_&gt; {

    void resetWorkingSolution(Solution_ workingSolution);

    void beforeEntityAdded(Object entity);

    void afterEntityAdded(Object entity);

    void beforeVariableChanged(Object entity, String variableName);

    void afterVariableChanged(Object entity, String variableName);

    void beforeEntityRemoved(Object entity);

    void afterEntityRemoved(Object entity);

    Score calculateScore();

}</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./ScoreCalculation/incrementalScoreCalculatorSequenceDiagram.png" alt="incrementalScoreCalculatorSequenceDiagram">
</div>
</div>
<div class="paragraph">
<p>For example in n queens:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class NQueensAdvancedIncrementalScoreCalculator extends AbstractIncrementalScoreCalculator&lt;NQueens&gt; {

    private Map&lt;Integer, List&lt;Queen&gt;&gt; rowIndexMap;
    private Map&lt;Integer, List&lt;Queen&gt;&gt; ascendingDiagonalIndexMap;
    private Map&lt;Integer, List&lt;Queen&gt;&gt; descendingDiagonalIndexMap;

    private int score;

    public void resetWorkingSolution(NQueens nQueens) {
        int n = nQueens.getN();
        rowIndexMap = new HashMap&lt;Integer, List&lt;Queen&gt;&gt;(n);
        ascendingDiagonalIndexMap = new HashMap&lt;Integer, List&lt;Queen&gt;&gt;(n * 2);
        descendingDiagonalIndexMap = new HashMap&lt;Integer, List&lt;Queen&gt;&gt;(n * 2);
        for (int i = 0; i &lt; n; i++) {
            rowIndexMap.put(i, new ArrayList&lt;Queen&gt;(n));
            ascendingDiagonalIndexMap.put(i, new ArrayList&lt;Queen&gt;(n));
            descendingDiagonalIndexMap.put(i, new ArrayList&lt;Queen&gt;(n));
            if (i != 0) {
                ascendingDiagonalIndexMap.put(n - 1 + i, new ArrayList&lt;Queen&gt;(n));
                descendingDiagonalIndexMap.put((-i), new ArrayList&lt;Queen&gt;(n));
            }
        }
        score = 0;
        for (Queen queen : nQueens.getQueenList()) {
            insert(queen);
        }
    }

    public void beforeEntityAdded(Object entity) {
        // Do nothing
    }

    public void afterEntityAdded(Object entity) {
        insert((Queen) entity);
    }

    public void beforeVariableChanged(Object entity, String variableName) {
        retract((Queen) entity);
    }

    public void afterVariableChanged(Object entity, String variableName) {
        insert((Queen) entity);
    }

    public void beforeEntityRemoved(Object entity) {
        retract((Queen) entity);
    }

    public void afterEntityRemoved(Object entity) {
        // Do nothing
    }

    private void insert(Queen queen) {
        Row row = queen.getRow();
        if (row != null) {
            int rowIndex = queen.getRowIndex();
            List&lt;Queen&gt; rowIndexList = rowIndexMap.get(rowIndex);
            score -= rowIndexList.size();
            rowIndexList.add(queen);
            List&lt;Queen&gt; ascendingDiagonalIndexList = ascendingDiagonalIndexMap.get(queen.getAscendingDiagonalIndex());
            score -= ascendingDiagonalIndexList.size();
            ascendingDiagonalIndexList.add(queen);
            List&lt;Queen&gt; descendingDiagonalIndexList = descendingDiagonalIndexMap.get(queen.getDescendingDiagonalIndex());
            score -= descendingDiagonalIndexList.size();
            descendingDiagonalIndexList.add(queen);
        }
    }

    private void retract(Queen queen) {
        Row row = queen.getRow();
        if (row != null) {
            List&lt;Queen&gt; rowIndexList = rowIndexMap.get(queen.getRowIndex());
            rowIndexList.remove(queen);
            score += rowIndexList.size();
            List&lt;Queen&gt; ascendingDiagonalIndexList = ascendingDiagonalIndexMap.get(queen.getAscendingDiagonalIndex());
            ascendingDiagonalIndexList.remove(queen);
            score += ascendingDiagonalIndexList.size();
            List&lt;Queen&gt; descendingDiagonalIndexList = descendingDiagonalIndexMap.get(queen.getDescendingDiagonalIndex());
            descendingDiagonalIndexList.remove(queen);
            score += descendingDiagonalIndexList.size();
        }
    }

    public SimpleScore calculateScore() {
        return SimpleScore.valueOf(score);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Configure it in your solver configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;scoreDirectorFactory&gt;
    &lt;incrementalScoreCalculatorClass&gt;org.optaplanner.examples.nqueens.solver.score.NQueensAdvancedIncrementalScoreCalculator&lt;/incrementalScoreCalculatorClass&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A piece of incremental score calculator code can be difficult to write and to review.
Assert its correctness by using <a href="#invalidScoreDetection">an <code>EasyScoreCalculator</code> to do the assertions triggered by the <code>environmentMode</code></a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="constraintMatchAwareIncrementalScoreCalculator"><a class="anchor" href="#constraintMatchAwareIncrementalScoreCalculator"></a><a class="link" href="#constraintMatchAwareIncrementalScoreCalculator">5.3.3.1. <code>ConstraintMatchAwareIncrementalScoreCalculator</code></a></h5>
<div class="paragraph">
<p>Optionally, also implement the <code>ConstraintMatchAwareIncrementalScoreCalculator</code> interface to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Explain a score by splitting it up per score constraint with <code>ScoreDirector.getConstraintMatchTotals()</code>.</p>
</li>
<li>
<p>Visualize or sort planning entities by how many constraints each one breaks with <code>ScoreDirector.getIndictmentMap()</code>.</p>
</li>
<li>
<p>Receive a detailed analysis if the <code>IncrementalScoreCalculator</code> is corrupted in <code>FAST_ASSERT</code> or <code>FULL_ASSERT</code> <code>environmentMode</code>,</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public interface ConstraintMatchAwareIncrementalScoreCalculator&lt;Solution_&gt; {

    void resetWorkingSolution(Solution_ workingSolution, boolean constraintMatchEnabled);

    Collection&lt;ConstraintMatchTotal&gt; getConstraintMatchTotals();

    Map&lt;Object, Indictment&gt; getIndictmentMap();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example in machine reassignment, create one ConstraintMatchTotal per constraint type
and call <code>addConstraintMatch()</code> for each constraint match:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class MachineReassignmentIncrementalScoreCalculator
        implements ConstraintMatchAwareIncrementalScoreCalculator&lt;MachineReassignment&gt; {
    ...

    @Override
    public void resetWorkingSolution(MachineReassignment workingSolution, boolean constraintMatchEnabled) {
        resetWorkingSolution(workingSolution);
        // ignore constraintMatchEnabled, it is always presumed enabled
    }

    @Override
    public Collection&lt;ConstraintMatchTotal&gt; getConstraintMatchTotals() {
        ConstraintMatchTotal maximumCapacityMatchTotal = new ConstraintMatchTotal(
                CONSTRAINT_PACKAGE, "maximumCapacity", HardSoftLongScore.ZERO);
        ...
        for (MrMachineScorePart machineScorePart : machineScorePartMap.values()) {
            for (MrMachineCapacityScorePart machineCapacityScorePart : machineScorePart.machineCapacityScorePartList) {
                if (machineCapacityScorePart.maximumAvailable &lt; 0L) {
                    maximumCapacityMatchTotal.addConstraintMatch(
                            Arrays.asList(machineCapacityScorePart.machineCapacity),
                            HardSoftLongScore.valueOf(machineCapacityScorePart.maximumAvailable, 0));
                }
            }
        }
        ...
        List&lt;ConstraintMatchTotal&gt; constraintMatchTotalList = new ArrayList&lt;&gt;(4);
        constraintMatchTotalList.add(maximumCapacityMatchTotal);
        ...
        return constraintMatchTotalList;
    }

    @Override
    public Map&lt;Object, Indictment&gt; getIndictmentMap() {
        return null; // Calculate it non-incrementally from getConstraintMatchTotals()
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>That <code>getConstraintMatchTotals()</code> code often duplicates some of the logic of the normal <code>IncrementalScoreCalculator</code> methods.
Drools Score Calculation doesn&#8217;t have this disadvantage, because it is constraint match aware automatically when needed,
without any extra domain-specific code.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="droolsScoreCalculation"><a class="anchor" href="#droolsScoreCalculation"></a><a class="link" href="#droolsScoreCalculation">5.3.4. Drools Score Calculation</a></h4>
<div class="sect4">
<h5 id="droolsScoreCalculationOverview"><a class="anchor" href="#droolsScoreCalculationOverview"></a><a class="link" href="#droolsScoreCalculationOverview">5.3.4.1. Overview</a></h5>
<div class="paragraph">
<p>Implement your score calculation using the Drools rule engine.
Every score constraint is written as one or more score rules.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Advantages:</p>
<div class="ulist">
<ul>
<li>
<p>Incremental score calculation for free</p>
<div class="ulist">
<ul>
<li>
<p>Because most DRL syntax uses forward chaining, it does incremental calculation without any extra code</p>
</li>
</ul>
</div>
</li>
<li>
<p>Score constraints are isolated as separate rules</p>
<div class="ulist">
<ul>
<li>
<p>Easy to add or edit existing score rules</p>
</li>
</ul>
</div>
</li>
<li>
<p>Flexibility to augment your score constraints by</p>
<div class="ulist">
<ul>
<li>
<p>Defining them in decision tables</p>
<div class="ulist">
<ul>
<li>
<p>Excel (XLS) spreadsheet</p>
</li>
<li>
<p>KIE Workbench WebUI</p>
</li>
</ul>
</div>
</li>
<li>
<p>Translate them into natural language with DSL</p>
</li>
<li>
<p>Store and release in the KIE Workbench repository</p>
</li>
</ul>
</div>
</li>
<li>
<p>Performance optimizations in future versions for free</p>
<div class="ulist">
<ul>
<li>
<p>In every release, the Drools rule engine tends to become faster</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Disadvantages:</p>
<div class="ulist">
<ul>
<li>
<p>DRL learning curve</p>
</li>
<li>
<p>Usage of DRL</p>
<div class="ulist">
<ul>
<li>
<p>Polyglot fear can prohibit the use of a new language such as DRL in some organizations</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="droolsScoreRulesConfiguration"><a class="anchor" href="#droolsScoreRulesConfiguration"></a><a class="link" href="#droolsScoreRulesConfiguration">5.3.4.2. Drools Score Rules Configuration</a></h5>
<div class="paragraph">
<p>There are several ways to define where your score rules live.</p>
</div>
<div class="sect5">
<h6 id="droolsScoreCalculationScoreDrl"><a class="anchor" href="#droolsScoreCalculationScoreDrl"></a><a class="link" href="#droolsScoreCalculationScoreDrl">5.3.4.2.1. A scoreDrl Resource on the Classpath</a></h6>
<div class="paragraph">
<p>This is the easy way.
The score rules live in a DRL file which is provided as a classpath resource.
Just add the score rules DRL file in the solver configuration as a <code>&lt;scoreDrl&gt;</code> element:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;scoreDirectorFactory&gt;
    &lt;scoreDrl&gt;org/optaplanner/examples/nqueens/solver/nQueensScoreRules.drl&lt;/scoreDrl&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In a typical project (following the Maven directory structure), that DRL file would be located at <code>$PROJECT_DIR/src/main/resources/org/optaplanner/examples/nqueens/solver/nQueensScoreRules.drl</code> (even for a war project).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>&lt;scoreDrl&gt;</code> element expects a classpath resource, as defined by <code>ClassLoader.getResource(String)</code>, it does not accept a <code>File</code>, nor an URL, nor a webapp resource.
See below to use a <code>File</code> instead.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Add multiple <code>&lt;scoreDrl&gt;</code> elements if the score rules are split across multiple DRL files.</p>
</div>
<div class="paragraph">
<p>Optionally, you can also set drools configuration properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;scoreDirectorFactory&gt;
    &lt;scoreDrl&gt;org/optaplanner/examples/nqueens/solver/nQueensScoreRules.drl&lt;/scoreDrl&gt;
    &lt;kieBaseConfigurationProperties&gt;
      &lt;drools.equalityBehavior&gt;...&lt;/drools.equalityBehavior&gt;
    &lt;/kieBaseConfigurationProperties&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To enable property reactive by default, without a <code>@propertyReactive</code> on the domain classes,
add <code>&lt;drools.propertySpecific&gt;ALWAYS&lt;/drools.propertySpecific&gt;</code> in there.
Otherwise Planner automatically changes the Drools default to <code>ALLOWED</code> so property reactive is not active by default.</p>
</div>
</div>
<div class="sect5">
<h6 id="droolsScoreCalculationScoreDrlFile"><a class="anchor" href="#droolsScoreCalculationScoreDrlFile"></a><a class="link" href="#droolsScoreCalculationScoreDrlFile">5.3.4.2.2. A scoreDrlFile</a></h6>
<div class="paragraph">
<p>To use <code>File</code> on the local file system, instead of a classpath resource, add the score rules DRL file in the solver configuration as a <code>&lt;scoreDrlFile&gt;</code> element:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;scoreDirectorFactory&gt;
    &lt;scoreDrlFile&gt;/home/ge0ffrey/tmp/nQueensScoreRules.drl&lt;/scoreDrlFile&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For portability reasons, a classpath resource is recommended over a File.
An application build on one computer, but used on another computer, might not find the file on the same location.
Worse, if they use a different Operating System, it is hard to choose a portable file path.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Add multiple <code>&lt;scoreDrlFile&gt;</code> elements if the score rules are split across multiple DRL files.</p>
</div>
</div>
<div class="sect5">
<h6 id="droolsScoreCalculationKsessionName"><a class="anchor" href="#droolsScoreCalculationKsessionName"></a><a class="link" href="#droolsScoreCalculationKsessionName">5.3.4.2.3. A ksessionName in a Kjar from a Maven repository</a></h6>
<div class="paragraph">
<p>This way allows you to use score rules defined by the Workbench or build a kjar and deploy it to the Execution Server.
Both the score rules and the solver configuration are resources in a kjar.
Clients can obtain that kjar either from the local classpath, from a local Maven repository or even from a remote Maven repository.</p>
</div>
<div class="paragraph">
<p>The score rules still live in a DRL file, but the <code>KieContainer</code> finds that DRL file through the <code>META-INF/kmodule.xml</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;kmodule xmlns="http://www.drools.org/xsd/kmodule"&gt;
  &lt;configuration&gt;
    &lt;!-- Don't enable propertyReactive unless there is a @PropertyReactive annotation on the domain classes --&gt;
    &lt;property key="drools.propertySpecific" value="ALLOWED"/&gt;
  &lt;/configuration&gt;
  &lt;kbase name="nQueensKbase" packages="org.optaplanner.examples.nqueens.solver"&gt;
    &lt;ksession name="nQueensKsession"/&gt;
  &lt;/kbase&gt;
&lt;/kmodule&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The kmodule above will pick up all the DRL files in the package <code>org.optaplanner.examples.nqueens.solver</code>.
A kbase can even extend another kbase.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Starting from version 7.0, Drools enables property reactive by default for all classes.
This means if you have a non-simple getter and forget to apply <code>@Modifies</code> correctly, corruption occurs.
To avoid this, simply set <code>drools.propertySpecific</code> to <code>ALLOWED</code> as shown above.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Add the ksession name in the solver configuration as a <code>&lt;ksessionName&gt;</code> element:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;scoreDirectorFactory&gt;
    &lt;ksessionName&gt;nQueensKsession&lt;/ksessionName&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this approach, it&#8217;s required to use a <code>SolverFactory.createFromKieContainerXmlResource(&#8230;&#8203;)</code> method to <a href="#solverConfigurationByXML">build the <code>SolverFactory</code></a>.
If no <code>&lt;ksessionName&gt;</code> element is specified, the default ksession of the <code>kmodule.xml</code> is used.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="implementingAScoreRule"><a class="anchor" href="#implementingAScoreRule"></a><a class="link" href="#implementingAScoreRule">5.3.4.3. Implementing a Score Rule</a></h5>
<div class="paragraph">
<p>Here is an example of a score constraint implemented as a score rule in a DRL file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>rule "multipleQueensHorizontal"
    when
        Queen($id : id, row != null, $i : rowIndex)
        Queen(id &gt; $id, rowIndex == $i)
    then
        scoreHolder.addConstraintMatch(kcontext, -1);
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>This score rule will fire once for every two queens with the same <code>rowIndex</code>.
The <code>(id &gt; $id)</code> condition is needed to assure that for two queens A and B, it can only fire for (A, B) and not for (B, A), (A, A) or (B, B). Let us take a closer look at this score rule on this solution of four queens:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./ScoreCalculation/unsolvedNQueens04.png" alt="unsolvedNQueens04">
</div>
</div>
<div class="paragraph">
<p>In this solution the multipleQueensHorizontal score rule will fire for six queen couples: (A, B), (A, C), (A, D), (B, C), (B, D) and (C, D). Because none of the queens are on the same vertical or diagonal line, this solution will have a score of <code>-6</code>.
An optimal solution of four queens has a score of <code>0</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Notice that every score rule will relate to at least one planning entity class (directly or indirectly through a logically inserted fact).</p>
</div>
<div class="paragraph">
<p>This is a normal case.
It would be a waste of time to write a score rule that only relates to problem facts, as the consequence will never change during planning, no matter what the possible solution.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>kcontext</code> variable is a magic variable in Drools Expert.
The <code>scoreHolder</code>'s method uses it to do incremental score calculation correctly and to create a <code>ConstraintMatch</code> instance.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="weighingScoreRules"><a class="anchor" href="#weighingScoreRules"></a><a class="link" href="#weighingScoreRules">5.3.4.4. Weighing Score Rules</a></h5>
<div class="paragraph">
<p>A <code>ScoreHolder</code> instance is asserted into the <code>KieSession</code> as a global called <code>scoreHolder</code>.
The score rules need to (directly or indirectly) update that instance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>global SimpleScoreHolder scoreHolder;

rule "multipleQueensHorizontal"
    when
        Queen($id : id, row != null, $i : rowIndex)
        Queen(id &gt; $id, rowIndex == $i)
    then
        scoreHolder.addConstraintMatch(kcontext, -1);
end

// multipleQueensVertical is obsolete because it is always 0

rule "multipleQueensAscendingDiagonal"
    when
        Queen($id : id, row != null, $i : ascendingDiagonalIndex)
        Queen(id &gt; $id, ascendingDiagonalIndex == $i)
    then
        scoreHolder.addConstraintMatch(kcontext, -1);
end

rule "multipleQueensDescendingDiagonal"
    when
        Queen($id : id, row != null, $i : descendingDiagonalIndex)
        Queen(id &gt; $id, descendingDiagonalIndex == $i)
    then
        scoreHolder.addConstraintMatch(kcontext, -1);
end</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To learn more about the Drools rule language (DRL), consult <a href="https://drools.org/learn/documentation.html">the Drools documentation</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Most use cases also weigh their constraint types or even their matches differently, by using a specific weight for each constraint match.
For example in <a href="#curriculumCourse">course scheduling</a>, assigning a <code>Lecture</code> to a <code>Room</code> that is lacking two seats is weighted equally bad as having one isolated <code>Lecture</code> in a <code>Curriculum</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>global HardSoftScoreHolder scoreHolder;

// RoomCapacity: For each lecture, the number of students that attend the course must be less or equal
// than the number of seats of all the rooms that host its lectures.
rule "roomCapacity"
    when
        $room : Room($capacity : capacity)
        $lecture : Lecture(room == $room, studentSize &gt; $capacity, $studentSize : studentSize)
    then
        // Each student above the capacity counts as one point of penalty.
        scoreHolder.addSoftConstraintMatch(kcontext, ($capacity - $studentSize));
end

// CurriculumCompactness: Lectures belonging to a curriculum should be adjacent
// to each other (i.e., in consecutive periods).
// For a given curriculum we account for a violation every time there is one lecture not adjacent
// to any other lecture within the same day.
rule "curriculumCompactness"
    when
        ...
    then
        // Each isolated lecture in a curriculum counts as two points of penalty.
        scoreHolder.addSoftConstraintMatch(kcontext, -2);
end</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="initializingScoreTrend"><a class="anchor" href="#initializingScoreTrend"></a><a class="link" href="#initializingScoreTrend">5.3.5. InitializingScoreTrend</a></h4>
<div class="paragraph">
<p>The <code>InitializingScoreTrend</code> specifies how the Score will change as more and more variables are initialized (while the already initialized variables do not change). Some optimization algorithms (such Construction Heuristics and Exhaustive Search) run faster if they have such information.</p>
</div>
<div class="paragraph">
<p>For the Score (or each <a href="#scoreLevel">score level</a> separately), specify a trend:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ANY</code> (default): Initializing an extra variable can change the score positively or negatively. Gives no performance gain.</p>
</li>
<li>
<p><code>ONLY_UP</code> (rare): Initializing an extra variable can only change the score positively. Implies that:</p>
<div class="ulist">
<ul>
<li>
<p>There are only positive constraints</p>
</li>
<li>
<p>And initializing the next variable can not unmatch a positive constraint that was matched by a previous initialized variable.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>ONLY_DOWN</code>: Initializing an extra variable can only change the score negatively. Implies that:</p>
<div class="ulist">
<ul>
<li>
<p>There are only negative constraints</p>
</li>
<li>
<p>And initializing the next variable can not unmatch a negative constraint that was matched by a previous initialized variable.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Most use cases only have negative constraints.
Many of those have an <code>InitializingScoreTrend</code> that only goes down:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;scoreDirectorFactory&gt;
    &lt;scoreDrl&gt;.../cloudBalancingScoreRules.drl&lt;/scoreDrl&gt;
    &lt;initializingScoreTrend&gt;ONLY_DOWN&lt;/initializingScoreTrend&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can also specify the trend for each score level separately:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;scoreDirectorFactory&gt;
    &lt;scoreDrl&gt;.../cloudBalancingScoreRules.drl&lt;/scoreDrl&gt;
    &lt;initializingScoreTrend&gt;ONLY_DOWN/ONLY_DOWN&lt;/initializingScoreTrend&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="invalidScoreDetection"><a class="anchor" href="#invalidScoreDetection"></a><a class="link" href="#invalidScoreDetection">5.3.6. Invalid Score Detection</a></h4>
<div class="paragraph">
<p>When you put <a href="#environmentMode">the <code>environmentMode</code></a>in <code>FULL_ASSERT</code> (or <code>FAST_ASSERT</code>),
it will detect score corruption in the <a href="#incrementalScoreCalculation">incremental score calculation</a>.
However, that will not verify that your score calculator actually implements your score constraints as your business desires.
For example, one score rule might consistently match the wrong pattern.
To verify the score rules against an independent implementation, configure a <code>assertionScoreDirectorFactory</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;environmentMode&gt;FAST_ASSERT&lt;/environmentMode&gt;
  ...
  &lt;scoreDirectorFactory&gt;
    &lt;scoreDrl&gt;org/optaplanner/examples/nqueens/solver/nQueensScoreRules.drl&lt;/scoreDrl&gt;
    &lt;assertionScoreDirectorFactory&gt;
      &lt;easyScoreCalculatorClass&gt;org.optaplanner.examples.nqueens.solver.score.NQueensEasyScoreCalculator&lt;/easyScoreCalculatorClass&gt;
    &lt;/assertionScoreDirectorFactory&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This way, the <code>scoreDrl</code> will be validated by the <code>EasyScoreCalculator</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This works well to isolate score corruption,
but to verify that the score rules implement the real business needs,
<a href="#testingScoreConstraints">a unit test with a ScoreVerifier</a> is usually better.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="scoreCalculationPerformanceTricks"><a class="anchor" href="#scoreCalculationPerformanceTricks"></a><a class="link" href="#scoreCalculationPerformanceTricks">5.4. Score Calculation Performance Tricks</a></h3>
<div class="sect3">
<h4 id="scoreCalculationPerformanceTricksOverview"><a class="anchor" href="#scoreCalculationPerformanceTricksOverview"></a><a class="link" href="#scoreCalculationPerformanceTricksOverview">5.4.1. Overview</a></h4>
<div class="paragraph">
<p>The <code>Solver</code> will normally spend most of its execution time running the score calculation (which is called in its deepest loops). Faster score calculation will return the same solution in less time with the same algorithm, which normally means a better solution in equal time.</p>
</div>
</div>
<div class="sect3">
<h4 id="scoreCalculationSpeed"><a class="anchor" href="#scoreCalculationSpeed"></a><a class="link" href="#scoreCalculationSpeed">5.4.2. Score Calculation Speed</a></h4>
<div class="paragraph">
<p>After solving a problem, the <code>Solver</code> will log the <em>score calculation speed per second</em>.
This is a good measurement of Score calculation performance, despite that it is affected by non score calculation execution time.
It depends on the problem scale of the problem dataset.
Normally, even for high scale problems, it is higher than <code>1000</code>, except when you are using an <code>EasyScoreCalculator</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When improving your score calculation, focus on maximizing the score calculation speed, instead of maximizing the best score.
A big improvement in score calculation can sometimes yield little or no best score improvement, for example when the algorithm is stuck in a local or global optima.
If you are watching the calculation speed instead, score calculation improvements are far more visible.</p>
</div>
<div class="paragraph">
<p>Furthermore, watching the calculation speed, allows you to remove or add score constraints, and still compare it with the original calculation speed.
Comparing the best score with the original would be wrong, because it is comparing apples and oranges.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="incrementalScoreCalculation"><a class="anchor" href="#incrementalScoreCalculation"></a><a class="link" href="#incrementalScoreCalculation">5.4.3. Incremental Score Calculation (with Deltas)</a></h4>
<div class="paragraph">
<p>When a <code>Solution</code> changes, incremental score calculation (AKA delta based score calculation), will calculate the delta with the previous state to find the new <code>Score</code>, instead of recalculating the entire score on every solution evaluation.</p>
</div>
<div class="paragraph">
<p>For example, if a single queen A moves from row <code>1</code> to <code>2</code>, it will not bother to check if queen B and C can attack each other, since neither of them changed.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./ScoreCalculation/incrementalScoreCalculationNQueens04.png" alt="incrementalScoreCalculationNQueens04">
</div>
<div class="title">Figure 6. Incremental Score Calculation for the Four Queens Puzzle</div>
</div>
<div class="paragraph">
<p>This is a huge performance and scalability gain.
<strong>Drools score calculation gives you this huge scalability gain without forcing you to write a complicated incremental score calculation algorithm.</strong>
Just let the Drools rule engine do the hard work.</p>
</div>
<div class="paragraph">
<p>Notice that the speedup is relative to the size of your planning problem (your <em>n</em>), making incremental score calculation far more scalable.</p>
</div>
</div>
<div class="sect3">
<h4 id="avoidCallingRemoteServicesDuringScoreCalculation"><a class="anchor" href="#avoidCallingRemoteServicesDuringScoreCalculation"></a><a class="link" href="#avoidCallingRemoteServicesDuringScoreCalculation">5.4.4. Avoid Calling Remote Services During Score Calculation</a></h4>
<div class="paragraph">
<p>Do not call remote services in your score calculation (except if you are bridging <code>EasyScoreCalculator</code> to a legacy system). The network latency will kill your score calculation performance.
Cache the results of those remote services if possible.</p>
</div>
<div class="paragraph">
<p>If some parts of a constraint can be calculated once, when the <code>Solver</code> starts, and never change during solving, then turn them into <a href="#cachedProblemFact">cached problem facts</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="pointlessConstraints"><a class="anchor" href="#pointlessConstraints"></a><a class="link" href="#pointlessConstraints">5.4.5. Pointless Constraints</a></h4>
<div class="paragraph">
<p>If you know a certain constraint can never be broken (or it is always broken), you need not write a score constraint for it.
For example in n queens, the score calculation does not check if multiple queens occupy the same column, because a <code>Queen</code>'s <code>column</code> never changes and every <code>Solution</code> starts with each <code>Queen</code> on a different <code>column</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not go overboard with this.
If some datasets do not use a specific constraint but others do, just return out of the constraint as soon as you can.
There is no need to dynamically change your score calculation based on the dataset.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="buildInHardConstraint"><a class="anchor" href="#buildInHardConstraint"></a><a class="link" href="#buildInHardConstraint">5.4.6. Built-in Hard Constraint</a></h4>
<div class="paragraph">
<p>Instead of implementing a hard constraint, it can sometimes be built in.
For example, If <code>Lecture</code> A should never be assigned to <code>Room</code> X, but it uses <code>ValueRangeProvider</code> on Solution, so the <code>Solver</code> will often try to assign it to <code>Room</code> X too (only to find out that it breaks a hard constraint). Use <a href="#valueRangeProviderOnPlanningEntity">a ValueRangeProvider on the planning entity</a> or <a href="#filteredSelection">filtered selection</a> to define that Course A should only be assigned a <code>Room</code> different than X.</p>
</div>
<div class="paragraph">
<p>This can give a good performance gain in some use cases, not just because the score calculation is faster, but mainly because most optimization algorithms will spend less time evaluating infeasible solutions.
However, usually this not a good idea because there is a real risk of trading short term benefits for long term harm:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Many optimization algorithms rely on the freedom to break hard constraints when changing planning entities, to get out of local optima.</p>
</li>
<li>
<p>Both implementation approaches have limitations (feature compatibility, disabling automatic performance optimizations), as explained in their documentation.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="otherScoreCalculationPerformanceTricks"><a class="anchor" href="#otherScoreCalculationPerformanceTricks"></a><a class="link" href="#otherScoreCalculationPerformanceTricks">5.4.7. Other Score Calculation Performance Tricks</a></h4>
<div class="ulist">
<ul>
<li>
<p>Verify that your score calculation happens in the correct <code>Number</code> type. If you are making the sum of <code>int</code> values, do not let Drools sum it in a <code>double</code> which takes longer.</p>
</li>
<li>
<p>For optimal performance, always use server mode (<code>java -server</code>). We have seen performance increases of 50% by turning on server mode.</p>
</li>
<li>
<p>For optimal performance, use the latest Java version. For example, in the past we have seen performance increases of 30% by switching from java 1.5 to 1.6.</p>
</li>
<li>
<p>Always remember that premature optimization is the root of all evil. Make sure your design is flexible enough to allow configuration based tweaking.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="scoreTrap"><a class="anchor" href="#scoreTrap"></a><a class="link" href="#scoreTrap">5.4.8. Score Trap</a></h4>
<div class="paragraph">
<p>Make sure that none of your score constraints cause a score trap.
A trapped score constraint uses the same weight for different constraint matches, when it could just as easily use a different weight.
It effectively lumps its constraint matches together, which creates a flatlined score function for that constraint.
This can cause a solution state in which several moves need to be done to resolve or lower the weight of that single constraint.
Some examples of score traps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You need two doctors at each table, but you are only moving one doctor at a time. So the solver has no incentive to move a doctor to a table with no doctors. Punish a table with no doctors more then a table with only one doctor in that score constraint in the score function.</p>
</li>
<li>
<p>Two exams need to be conducted at the same time, but you are only moving one exam at a time. So the solver has to move one of those exams to another timeslot without moving the other in the same move. Add a coarse-grained move that moves both exams at the same time.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, consider this score trap.
If the blue item moves from an overloaded computer to an empty computer, the hard score should improve.
The trapped score implementation fails to do that:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./ScoreCalculation/scoreTrap.png" alt="scoreTrap">
</div>
</div>
<div class="paragraph">
<p>The Solver should eventually get out of this trap, but it will take a lot of effort (especially if there are even more processes on the overloaded computer). Before they do that, they might actually start moving more processes into that overloaded computer, as there is no penalty for doing so.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Avoiding score traps does not mean that your score function should be smart enough to avoid local optima.
Leave it to the optimization algorithms to deal with the local optima.</p>
</div>
<div class="paragraph">
<p>Avoiding score traps means to avoid, for each score constraint individually, a flatlined score function.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Always specify the degree of infeasibility.
The business will often say "if the solution is infeasible, it does not matter how infeasible it is." While that is true for the business, it is not true for score calculation as it benefits from knowing how infeasible it is.
In practice, soft constraints usually do this naturally and it is just a matter of doing it for the hard constraints too.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There are several ways to deal with a score trap:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Improve the score constraint to make a distinction in the score weight. For example, penalize <code>-1hard</code> for every missing CPU, instead of just <code>-1hard</code> if any CPU is missing.</p>
</li>
<li>
<p>If changing the score constraint is not allowed from the business perspective, add a lower score level with a score constraint that makes such a distinction. For example, penalize <code>-1subsoft</code> for every missing CPU, on top of <code>-1hard</code> if any CPU is missing. The business ignores the subsoft score level.</p>
</li>
<li>
<p>Add coarse-grained moves and union select them with the existing fine-grained moves. A coarse-grained move effectively does multiple moves to directly get out of a score trap with a single move. For example, move multiple items from the same container to another container.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="stepLimitBenchmark"><a class="anchor" href="#stepLimitBenchmark"></a><a class="link" href="#stepLimitBenchmark">5.4.9. stepLimit Benchmark</a></h4>
<div class="paragraph">
<p>Not all score constraints have the same performance cost.
Sometimes one score constraint can kill the score calculation performance outright.
Use the <a href="#benchmarker">Benchmarker</a> to do a one minute run and check what happens to the score calculation speed if you comment out all but one of the score constraints.</p>
</div>
</div>
<div class="sect3">
<h4 id="fairnessScoreConstraints"><a class="anchor" href="#fairnessScoreConstraints"></a><a class="link" href="#fairnessScoreConstraints">5.4.10. Fairness Score Constraints</a></h4>
<div class="paragraph">
<p>Some use cases have a business requirement to provide a fair schedule (usually as a soft score constraint), for example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Fairly distribute the workload amongst the employees, to avoid envy.</p>
</li>
<li>
<p>Evenly distribute the workload amongst assets, to improve reliability.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Implementing such a constraint can seem difficult (especially because there are different ways to formalize fairness), but usually the <em>squared workload</em> implementation behaves most desirable.
For each employee/asset, count the workload <code>w</code> and subtract <code>w</code> from the score.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./ScoreCalculation/fairnessScoreConstraint.png" alt="fairnessScoreConstraint">
</div>
</div>
<div class="paragraph">
<p>As shown above, the <em>squared workload</em> implementation guarantees that if you select two employees from a given solution and make their distribution between those two employees fairer, then the resulting new solution will have a better overall score.
Don not just use the difference from the average workload, as that can lead to unfairness, as demonstrated below.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./ScoreCalculation/fairnessScoreConstraintPitfall.png" alt="fairnessScoreConstraintPitfall">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Instead of the <em>squared workload</em>, it is also possible to use the <a href="http://en.wikipedia.org/wiki/Variance">variance</a> (squared difference to the average) or the <a href="http://en.wikipedia.org/wiki/Standard_deviation">standard deviation</a> (square root of the variance). This has no effect on the score comparison, because the average will not change during planning.
It is just more work to implement (because the average needs to be known) and trivially slower (because the calculation is a bit longer).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When the workload is perfect balanced, the user often likes to see a <code>0</code> score, instead of the distracting <code>-34soft</code> in the image above (for the last solution which is almost perfectly balanced). To nullify this, either add the average multiplied by the number of entities to the score or instead show the variance or standard deviation in the UI.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="explainingTheScore"><a class="anchor" href="#explainingTheScore"></a><a class="link" href="#explainingTheScore">5.5. Explaining the Score: Using Score Calculation Outside the <code>Solver</code></a></h3>
<div class="paragraph">
<p>If other parts of your application, for example your webUI, need to calculate the score of a solution,
reuse the <code>ScoreDirectorFactory</code> of the <code>Solver</code> to build a separate <code>ScoreDirector</code> for that webUI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">ScoreDirectorFactory&lt;CloudBalance&gt; scoreDirectorFactory = solver.getScoreDirectorFactory();
ScoreDirector&lt;CloudBalance&gt; guiScoreDirector = scoreDirectorFactory.buildScoreDirector();
...
guiScoreDirector.dispose();</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Don&#8217;t forget to call <code>ScoreDirector.dispose()</code> when the <code>ScoreDirector</code> becomes useless,
especially with <a href="#droolsScoreCalculation">Drools score calculation</a>, to avoid a memory leak.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then use it when you need to calculate the <code>Score</code> of a <code>Solution</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">guiScoreDirector.setWorkingSolution(cloudBalance);
Score score = guiScoreDirector.calculateScore();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Furthermore, the <code>ScoreDirector</code> can explain the score with constraint match totals and/or indictments:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./ScoreCalculation/scoreVisualization.png" alt="scoreVisualization">
</div>
</div>
<div class="sect3">
<h4 id="constraintMatchTotal"><a class="anchor" href="#constraintMatchTotal"></a><a class="link" href="#constraintMatchTotal">5.5.1. Constraint Match Total: Break down the Score by Constraint</a></h4>
<div class="paragraph">
<p>To break down the score per constraint (so per score rule with Drools score calculation),
get the <code>ConstraintMatchTotal</code>s from the <code>ScoreDirector</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">for (ConstraintMatchTotal constraintMatchTotal : guiScoreDirector.getConstraintMatchTotals()) {
    String constraintName = constraintMatchTotal.getConstraintName();
    // The score impact of that constraint
    Score scoreTotal = constraintMatchTotal.getScoreTotal();

    for (ConstraintMatch constraintMatch : constraintMatchTotal.getConstraintMatchSet()) {
        List&lt;Object&gt; justificationList = constraintMatch.getJustificationList();
        Score score = constraintMatch.getScore();
        ...
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each <code>ConstraintMatchTotal</code> is one constraint (so  one score rule) and has a part of the overall score.
The sum of <code>ConstraintMatchTotal.getScoreTotal()</code> equals the overall score.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="#droolsScoreCalculation">Drools score calculation</a> supports constraint matches automatically,
but <a href="#incrementalJavaScoreCalculation">incremental Java score calculation</a> requires
<a href="#constraintMatchAwareIncrementalScoreCalculator">implementing an extra interface</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="indictmentHeatMap"><a class="anchor" href="#indictmentHeatMap"></a><a class="link" href="#indictmentHeatMap">5.5.2. Indictment Heat Map: Visualize the Hot Planning Entities</a></h4>
<div class="paragraph">
<p>To show a heat map in the UI that highlights the planning entities and problem facts have an impact on the <code>Score</code>,
get the <code>Indictment</code> map from the <code>ScoreDirector</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">Map&lt;Object, Indictment&gt; indictmentMap = guiScoreDirector.getIndictmentMap();
for (CloudProcess process = cloudBalance.getProcessList()) {
    Indictment indictment = indictmentMap.get(process);
    if (indictment == null) {
        continue;
    }
    // The score impact of that planning entity
    Score scoreTotal = indictment.getScoreTotal();

    for (ConstraintMatch constraintMatch : indictment.getConstraintMatchSet()) {
        String constraintName = constraintMatch.getConstraintName();
        Score score = constraintMatch.getScore();
        ...
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each <code>Indictment</code> is the sum of all constraints where that justification object is involved with.
The sum of <code>Indictment.getScoreTotal()</code> differs from the overall score,
because multiple <code>Indictment</code>s can share the same <code>ConstraintMatch</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="#droolsScoreCalculation">Drools score calculation</a> supports indictments and constraint matches automatically,
but <a href="#incrementalJavaScoreCalculation">incremental Java score calculation</a> requires
<a href="#constraintMatchAwareIncrementalScoreCalculator">implementing an extra interface</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="testingScoreConstraints"><a class="anchor" href="#testingScoreConstraints"></a><a class="link" href="#testingScoreConstraints">5.6. Testing score constraints with JUnit</a></h3>
<div class="paragraph">
<p>It&#8217;s recommended to write a unit test for each score constraint individually to check that it behaves correctly.</p>
</div>
<div class="paragraph">
<p>Add a test scoped dependency to the <code>optaplanner-test</code> jar to take advantage of the JUnit integration
and use the <code>ScoreVerifier</code> classes to test score rules in DRL (or a constraint match aware incremental score calculator).
For example, suppose we want to test these score rules:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>global HardSoftScoreHolder scoreHolder;

rule "requiredCpuPowerTotal"
    when
        ...
    then
        scoreHolder.addHardConstraintMatch(...);
end

...

rule "computerCost"
    when
        ...
    then
        scoreHolder.addSoftConstraintMatch(...);
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>For each score rule, we have a separate <code>@Test</code> that only tests the effect of that score rule on the score:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class CloudBalancingScoreConstraintTest {

    private HardSoftScoreVerifier&lt;CloudBalance&gt; scoreVerifier = new HardSoftScoreVerifier&lt;&gt;(
            SolverFactory.createFromXmlResource(
                    "org/optaplanner/examples/cloudbalancing/solver/cloudBalancingSolverConfig.xml"));

    @Test
    public void requiredCpuPowerTotal() {
        CloudComputer c1 = new CloudComputer(1L, 1000, 1, 1, 1);
        CloudComputer c2 = new CloudComputer(2L, 200, 1, 1, 1);
        CloudProcess p1 = new CloudProcess(1L, 700, 0, 0);
        CloudProcess p2 = new CloudProcess(2L, 70, 0, 0);
        CloudBalance solution = new CloudBalance(0L,
                Arrays.asList(c1, c2),
                Arrays.asList(p1, p2));
        // Uninitialized
        scoreVerifier.assertHardWeight("requiredCpuPowerTotal", 0, solution);
        p1.setComputer(c1);
        p2.setComputer(c1);
        // Usage 700 + 70 is within capacity 1000 of c1
        scoreVerifier.assertHardWeight("requiredCpuPowerTotal", 0, solution);
        p1.setComputer(c2);
        p2.setComputer(c2);
        // Usage 700 + 70 is above capacity 200 of c2
        scoreVerifier.assertHardWeight("requiredCpuPowerTotal", -570, solution);
    }

    ...

    @Test
    public void computerCost() {
        CloudComputer c1 = new CloudComputer(1L, 1, 1, 1, 200);
        CloudComputer c2 = new CloudComputer(2L, 1, 1, 1, 30);
        CloudProcess p1 = new CloudProcess(1L, 0, 0, 0);
        CloudProcess p2 = new CloudProcess(2L, 0, 0, 0);
        CloudBalance solution = new CloudBalance(0L,
                Arrays.asList(c1, c2),
                Arrays.asList(p1, p2));
        // Uninitialized
        scoreVerifier.assertSoftWeight("computerCost", 0, solution);
        p1.setComputer(c1);
        p2.setComputer(c1);
        // Pay 200 for c1
        scoreVerifier.assertSoftWeight("computerCost", -200, solution);
        p2.setComputer(c2);
        // Pay 200 + 30 for c1 and c2
        scoreVerifier.assertSoftWeight("computerCost", -230, solution);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is a <code>ScoreVerifier</code> implementation for each <code>Score</code> implementation.
In the <code>assertHardWeight()</code> and <code>assertSoftWeight()</code> methods, the weight of the other score rules is ignored (even those of the same score level).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A ScoreVerifier does not work well to isolate score corruption,
use <a href="#invalidScoreDetection">an <code>assertionScoreDirectorFactory</code></a> instead.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="optimizationAlgorithms"><a class="anchor" href="#optimizationAlgorithms"></a><a class="link" href="#optimizationAlgorithms">6. Optimization Algorithms</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="searchSpaceSize"><a class="anchor" href="#searchSpaceSize"></a><a class="link" href="#searchSpaceSize">6.1. Search Space Size in the Real World</a></h3>
<div class="paragraph">
<p>The number of possible solutions for a planning problem can be mind blowing.
For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Four queens has <code>256</code> possible solutions (<code>4^4</code>) and two optimal solutions.</p>
</li>
<li>
<p>Five queens has <code>3125</code> possible solutions (<code>5^5</code>) and one optimal solution.</p>
</li>
<li>
<p>Eight queens has <code>16777216</code> possible solutions (<code>8^8</code>) and 92 optimal solutions.</p>
</li>
<li>
<p>64 queens has more than <code>10^115</code> possible solutions (<code>64^64</code>).</p>
</li>
<li>
<p>Most real-life planning problems have an incredible number of possible solutions and only one or a few optimal solutions.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For comparison: the minimal number of atoms in the known universe (10^80). As a planning problem gets bigger, the search space tends to blow up really fast.
Adding only one extra planning entity or planning value can heavily multiply the running time of some algorithms.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./OptimizationAlgorithms/cloudBalanceSearchSpaceSize.png" alt="cloudBalanceSearchSpaceSize">
</div>
</div>
<div class="paragraph">
<p>Calculating the number of possible solutions depends on the design of the domain model:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./OptimizationAlgorithms/searchSpaceSizeCalculation.png" alt="searchSpaceSizeCalculation">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This search space size calculation includes infeasible solutions (if they can be represented by the model), because:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The optimal solution might be infeasible.</p>
</li>
<li>
<p>There are many types of hard constraints that cannot be incorporated in the formula practically. For example, in Cloud Balancing, try incorporating the CPU capacity constraint in the formula.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Even in cases where adding some of the hard constraints in the formula is practical (for example, Course Scheduling), the resulting search space is still huge.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>An algorithm that checks every possible solution (even with pruning, such as in <a href="#branchAndBound">Branch And Bound</a>) can easily run for billions of years on a single real-life planning problem.
The aim is to find the best solution in the available timeframe.
Planning competitions (such as the International Timetabling Competition) show that Local Search variations
(<a href="#tabuSearch">Tabu Search</a>, <a href="#simulatedAnnealing">Simulated Annealing</a>, <a href="#lateAcceptance">Late Acceptance</a>, &#8230;&#8203;)
usually perform best for real-world problems given real-world time limitations.</p>
</div>
</div>
<div class="sect2">
<h3 id="doesPlannerFindTheOptimalSolution"><a class="anchor" href="#doesPlannerFindTheOptimalSolution"></a><a class="link" href="#doesPlannerFindTheOptimalSolution">6.2. Does Planner Find the Optimal Solution?</a></h3>
<div class="paragraph">
<p>The business wants the optimal solution, but they also have other requirements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Scale out: Large production data sets must not crash and have also good results.</p>
</li>
<li>
<p>Optimize the right problem: The constraints must match the actual business needs.</p>
</li>
<li>
<p>Available time: The solution must be found in time, before it becomes useless to execute.</p>
</li>
<li>
<p>Reliability: Every data set must have at least a decent result (better than a human planner).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Given these requirements, and despite the promises of some salesmen, it is usually impossible for anyone or anything to find the optimal solution.
Therefore, Planner focuses on finding the best solution in available time.
In <a href="#examplesOverview">realistic, independent competitions</a>, it often comes out as the best <em>reusable</em> software.</p>
</div>
<div class="paragraph">
<p>The nature of NP-complete problems make scaling a prime concern.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The quality of a result from a small data set is no indication of the quality of a result from a large data set.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Scaling issues cannot be mitigated by hardware purchases later on.
Start testing with a production sized data set as soon as possible.
Do not assess quality on small data sets (unless production encounters only such data sets). Instead, solve a production sized data set and compare the results of longer executions, different algorithms and - if available - the human planner.</p>
</div>
</div>
<div class="sect2">
<h3 id="architectureOverview"><a class="anchor" href="#architectureOverview"></a><a class="link" href="#architectureOverview">6.3. Architecture Overview</a></h3>
<div class="paragraph">
<p>Planner is the first framework to combine optimization algorithms (metaheuristics, &#8230;&#8203;) with score calculation by a rule engine (such as Drools Expert). This combination is very efficient, because:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A rule engine, such as Drools Expert, is <strong>great for calculating the score</strong> of a solution of a planning problem. It makes it easy and scalable to add additional soft or hard constraints such as, "a teacher should not teach more then seven hours a day". It does delta-based score calculation without any extra code. However it tends to be not suitable to actually find new solutions.</p>
</li>
<li>
<p>An optimization algorithm is <strong>great at finding new improving solutions</strong> for a planning problem, without necessarily brute-forcing every possibility. However, it needs to know the score of a solution and offers no support in calculating that score efficiently.</p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./OptimizationAlgorithms/architectureOverview.png" alt="architectureOverview">
</div>
</div>
</div>
<div class="sect2">
<h3 id="optimizationAlgorithmsOverview"><a class="anchor" href="#optimizationAlgorithmsOverview"></a><a class="link" href="#optimizationAlgorithmsOverview">6.4. Optimization Algorithms Overview</a></h3>
<div class="paragraph">
<p>Planner supports three <em>families</em> of optimization algorithms: Exhaustive Search, Construction Heuristics and Metaheuristics.
In practice, Metaheuristics (in combination with Construction Heuristics to initialize) are the recommended choice:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./OptimizationAlgorithms/scalabilityOfOptimizationAlgorithms.png" alt="scalabilityOfOptimizationAlgorithms">
</div>
</div>
<div class="paragraph">
<p>Each of these algorithm families have multiple optimization algorithms:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 4. Optimization Algorithms Overview</caption>
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Algorithm</th>
<th class="tableblock halign-left valign-top">Scalable?</th>
<th class="tableblock halign-left valign-top">Optimal?</th>
<th class="tableblock halign-left valign-top">Easy to use?</th>
<th class="tableblock halign-left valign-top">Tweakable?</th>
<th class="tableblock halign-left valign-top">Requires CH?</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" colspan="6"><p class="tableblock"><strong>Exhaustive Search (ES)</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#bruteForce">Brute Force</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#branchAndBound">Branch And Bound</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="6"><p class="tableblock"><strong>Construction heuristics (CH)</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#firstFit">First Fit</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#firstFitDecreasing">First Fit Decreasing</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#weakestFit">Weakest Fit</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#weakestFitDecreasing">Weakest Fit Decreasing</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#strongestFit">Strongest Fit</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#strongestFitDecreasing">Strongest Fit Decreasing</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#cheapestInsertion">Cheapest Insertion</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#regretInsertion">Regret Insertion</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="6"><p class="tableblock"><strong>Metaheuristics (MH)</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="6"><p class="tableblock">Local Search (LS)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#hillClimbing">Hill Climbing</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#tabuSearch">Tabu Search</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#simulatedAnnealing">Simulated Annealing</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#lateAcceptance">Late Acceptance</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#stepCountingHillClimbing">Step Counting Hill Climbing</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="6"><p class="tableblock">Evolutionary Algorithms (EA)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#evolutionaryStrategies">Evolutionary Strategies</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#geneticAlgorithms">Genetic Algorithms</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>To learn more about metaheuristics, see  <a href="http://www.cs.gmu.edu/~sean/book/metaheuristics/">Essentials of Metaheuristics</a> or <a href="http://www.cleveralgorithms.com/">Clever Algorithms</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="whichOptimizationAlgorithmsShouldIUse"><a class="anchor" href="#whichOptimizationAlgorithmsShouldIUse"></a><a class="link" href="#whichOptimizationAlgorithmsShouldIUse">6.5. Which Optimization Algorithms Should I Use?</a></h3>
<div class="paragraph">
<p>The best optimization algorithms configuration to use depends heavily on your use case.
However, this basic procedure provides a good starting configuration that will produce better than average results.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start with a quick configuration that involves little or no configuration and optimization code:
See <a href="#firstFit">First Fit</a>.</p>
</li>
<li>
<p>Next, implement <a href="#planningEntityDifficulty">planning entity difficulty</a> comparison and turn it into <a href="#firstFitDecreasing">First Fit Decreasing</a>.</p>
</li>
<li>
<p>Next, add Late Acceptance behind it:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>First Fit Decreasing.</p>
</li>
<li>
<p><a href="#lateAcceptance">Late Acceptance</a>.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>At this point, the return on invested time lowers and the result is likely to be sufficient.</p>
</div>
<div class="paragraph">
<p>However, this can be improved at a lower return on invested time.
Use the <a href="#benchmarker">Benchmarker</a> and try a couple of different Tabu Search, Simulated Annealing and Late Acceptance configurations, for example:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First Fit Decreasing: <a href="#tabuSearch">Tabu Search</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Use the <a href="#benchmarker">Benchmarker</a> to improve the values for the size parameters.</p>
</div>
<div class="paragraph">
<p>Other experiments can also be run. For example, the following multiple algorithms can be combined together:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First Fit Decreasing</p>
</li>
<li>
<p>Late Acceptance (relatively long time)</p>
</li>
<li>
<p>Tabu Search (relatively short time)</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="powerTweaking"><a class="anchor" href="#powerTweaking"></a><a class="link" href="#powerTweaking">6.6. Power tweaking or default parameter values</a></h3>
<div class="paragraph">
<p>Many optimization algorithms have parameters that affect results and scalability.
Planner applies <em>configuration by exception</em>, so all optimization algorithms have default parameter values.
This is very similar to the Garbage Collection parameters in a JVM: most users have no need to tweak them, but power users often do.</p>
</div>
<div class="paragraph">
<p>The default parameter values are sufficient for many cases (and especially for prototypes), but if development time allows, it may be beneficial to power tweak them with the <a href="#benchmarker">benchmarker</a> for better results and scalability on a specific use case.
The documentation for each optimization algorithm also declares the advanced configuration for power tweaking.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The default value of parameters will change between minor versions, to improve them for most users. The advanced configuration can be used to prevent unwanted changes, however, this is not recommended.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="solverPhase"><a class="anchor" href="#solverPhase"></a><a class="link" href="#solverPhase">6.7. Solver Phase</a></h3>
<div class="paragraph">
<p>A <code>Solver</code> can use multiple optimization algorithms in sequence.
<strong>Each optimization algorithm is represented by one solver <code>Phase</code>.</strong>
There is never more than one <code>Phase</code> solving at the same time.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Some <code>Phase</code> implementations can combine techniques from multiple optimization algorithms, but it is still just one <code>Phase</code>.
For example: a Local Search <code>Phase</code> can do Simulated Annealing with entity Tabu.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here is a configuration that runs three phases in sequence:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;solver&gt;
  ...
  &lt;constructionHeuristic&gt;
    ... &lt;!-- First phase: First Fit Decreasing --&gt;
  &lt;/constructionHeuristic&gt;
  &lt;localSearch&gt;
    ... &lt;!-- Second phase: Late Acceptance --&gt;
  &lt;/localSearch&gt;
  &lt;localSearch&gt;
    ... &lt;!-- Third phase: Tabu Search --&gt;
  &lt;/localSearch&gt;
&lt;/solver&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The solver phases are run in the order defined by solver configuration.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When the first <code>Phase</code> terminates, the second <code>Phase</code> starts, and so on.</p>
</li>
<li>
<p>When the last <code>Phase</code> terminates, the <code>Solver</code> terminates.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Usually, a <code>Solver</code> will first run a construction heuristic and then run one or multiple metaheuristics:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./OptimizationAlgorithms/generalPhaseSequence.png" alt="generalPhaseSequence">
</div>
</div>
<div class="paragraph">
<p>If no phases are configured, Planner will default to a Construction Heuristic phase followed by a Local Search phase.</p>
</div>
<div class="paragraph">
<p>Some phases (especially construction heuristics) will terminate automatically.
Other phases (especially metaheuristics) will only terminate if the <code>Phase</code> is configured to terminate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;solver&gt;
  ...
  &lt;termination&gt;&lt;!-- Solver termination --&gt;
    &lt;secondsSpentLimit&gt;90&lt;/secondsSpentLimit&gt;
  &lt;/termination&gt;
  &lt;localSearch&gt;
    &lt;termination&gt;&lt;!-- Phase termination --&gt;
      &lt;secondsSpentLimit&gt;60&lt;/secondsSpentLimit&gt;&lt;!-- Give the next phase a chance to run too, before the Solver terminates --&gt;
    &lt;/termination&gt;
    ...
  &lt;/localSearch&gt;
  &lt;localSearch&gt;
    ...
  &lt;/localSearch&gt;
&lt;/solver&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the <code>Solver</code> terminates (before the last <code>Phase</code> terminates itself,
the current phase is terminated and all subsequent phases will not run.</p>
</div>
</div>
<div class="sect2">
<h3 id="scopeOverview"><a class="anchor" href="#scopeOverview"></a><a class="link" href="#scopeOverview">6.8. Scope Overview</a></h3>
<div class="paragraph">
<p>A solver will iteratively run phases. Each phase will usually iteratively run steps. Each step, in turn, usually iteratively runs moves.
These form four nested scopes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Solver</p>
</li>
<li>
<p>Phase</p>
</li>
<li>
<p>Step</p>
</li>
<li>
<p>Move</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./OptimizationAlgorithms/scopeOverview.png" alt="scopeOverview">
</div>
</div>
<div class="paragraph">
<p>Configure <a href="#logging">logging</a> to display the log messages of each scope.</p>
</div>
</div>
<div class="sect2">
<h3 id="termination"><a class="anchor" href="#termination"></a><a class="link" href="#termination">6.9. Termination</a></h3>
<div class="paragraph">
<p>Not all phases terminate automatically and may take a significant amount of time.
A <code>Solver</code> can be terminated synchronously by up-front configuration, or asynchronously from another thread.</p>
</div>
<div class="paragraph">
<p>Metaheuristic phases in particular need to be instructed to stop solving.
This can be because of a number of reasons, for example, if the time is up, or the perfect score has been reached just before its solution is used.
Finding the optimal solution cannot be relied on (unless you know the optimal score), because a metaheuristic algorithm is generally unaware of the optimal solution.</p>
</div>
<div class="paragraph">
<p>This is not an issue for real-life problems, as finding the optimal solution may take more time than is available.
Finding the best solution in the available time is the most important outcome.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If no termination is configured (and a metaheuristic algorithm is used), the <code>Solver</code> will run forever, until <a href="#asynchronousTermination">terminateEarly()</a> is called from another thread.
This is especially common during <a href="#realTimePlanning">real-time planning</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For synchronous termination, configure a <code>Termination</code> on a <code>Solver</code> or a <code>Phase</code> when it needs to stop.
The built-in implementations of these should be sufficient, however a custom <code>Termination</code> can also be used.
Every <code>Termination</code> can calculate a <em>time gradient</em> (needed for some optimization algorithms), which is a ratio between the time already spent solving and the estimated entire solving time of the <code>Solver</code> or <code>Phase</code>.</p>
</div>
<div class="sect3">
<h4 id="timeMillisSpentTermination"><a class="anchor" href="#timeMillisSpentTermination"></a><a class="link" href="#timeMillisSpentTermination">6.9.1. TimeMillisSpentTermination</a></h4>
<div class="paragraph">
<p>Terminates when an amount of time has been used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;termination&gt;
    &lt;millisecondsSpentLimit&gt;500&lt;/millisecondsSpentLimit&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;termination&gt;
    &lt;secondsSpentLimit&gt;10&lt;/secondsSpentLimit&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;termination&gt;
    &lt;minutesSpentLimit&gt;5&lt;/minutesSpentLimit&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;termination&gt;
    &lt;hoursSpentLimit&gt;1&lt;/hoursSpentLimit&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;termination&gt;
    &lt;daysSpentLimit&gt;2&lt;/daysSpentLimit&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Multiple time types can be used together, for example to configure 150 minutes, either configure it directly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;termination&gt;
    &lt;minutesSpentLimit&gt;150&lt;/minutesSpentLimit&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or use a combination that sums up to 150 minutes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;termination&gt;
    &lt;hoursSpentLimit&gt;2&lt;/hoursSpentLimit&gt;
    &lt;minutesSpentLimit&gt;30&lt;/minutesSpentLimit&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This <code>Termination</code> will most likely sacrifice perfect reproducibility (even with <code>environmentMode</code> <code>REPRODUCIBLE</code>) because the available CPU time differs frequently between runs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The available CPU time influences the number of steps that can be taken, which might be a few more or less.</p>
</li>
<li>
<p>The <code>Termination</code> might produce slightly different time gradient values, which will send time gradient-based algorithms (such as Simulated Annealing) on a radically different path.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="unimprovedTimeMillisSpentTermination"><a class="anchor" href="#unimprovedTimeMillisSpentTermination"></a><a class="link" href="#unimprovedTimeMillisSpentTermination">6.9.2. UnimprovedTimeMillisSpentTermination</a></h4>
<div class="paragraph">
<p>Terminates when the best score has not improved in a specified amount of time.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;localSearch&gt;
    &lt;termination&gt;
      &lt;unimprovedMillisecondsSpentLimit&gt;500&lt;/unimprovedMillisecondsSpentLimit&gt;
    &lt;/termination&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;localSearch&gt;
    &lt;termination&gt;
      &lt;unimprovedSecondsSpentLimit&gt;10&lt;/unimprovedSecondsSpentLimit&gt;
    &lt;/termination&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;localSearch&gt;
    &lt;termination&gt;
      &lt;unimprovedMinutesSpentLimit&gt;5&lt;/unimprovedMinutesSpentLimit&gt;
    &lt;/termination&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;localSearch&gt;
    &lt;termination&gt;
      &lt;unimprovedHoursSpentLimit&gt;1&lt;/unimprovedHoursSpentLimit&gt;
    &lt;/termination&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;localSearch&gt;
    &lt;termination&gt;
      &lt;unimprovedDaysSpentLimit&gt;1&lt;/unimprovedDaysSpentLimit&gt;
    &lt;/termination&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This termination should not be applied to Construction Heuristics as they only update the best solution at the end.
Configuring it on a specific <code>Phase</code> (such as <code>&lt;localSearch&gt;</code>), instead of on the <code>Solver</code> itself may be a better option.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This <code>Termination</code> will most likely sacrifice perfect reproducibility (even with <code>environmentMode</code> <code>REPRODUCIBLE</code>) as the available CPU time differs frequently between runs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The available CPU time influences the number of steps that can be taken, which might be a few more or less.</p>
</li>
<li>
<p>The <code>Termination</code> might produce slightly different time gradient values, which will send time gradient based algorithms (such as Simulated Annealing) on a radically different path.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="bestScoreTermination"><a class="anchor" href="#bestScoreTermination"></a><a class="link" href="#bestScoreTermination">6.9.3. BestScoreTermination</a></h4>
<div class="paragraph">
<p><code>BestScoreTermination</code> terminates when a certain score has been reached.
Use this <code>Termination</code> where the perfect score is known, for example for four queens (which uses a <a href="#simpleScore">SimpleScore</a>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;termination&gt;
    &lt;bestScoreLimit&gt;0&lt;/bestScoreLimit&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A planning problem with a <a href="#hardSoftScore">HardSoftScore</a> may look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;termination&gt;
    &lt;bestScoreLimit&gt;0hard/-5000soft&lt;/bestScoreLimit&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A planning problem with a <a href="#bendableScore">BendableScore</a> with three hard levels and one soft level may look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;termination&gt;
    &lt;bestScoreLimit&gt;[0/0/0]hard/[-5000]soft&lt;/bestScoreLimit&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this instance, <code>Termination</code> once a feasible solution has been reached is not practical because it requires a <code>bestScoreLimit</code> such as <code>0hard/-2147483648soft</code>. Use the next termination instead.</p>
</div>
</div>
<div class="sect3">
<h4 id="bestScoreFeasibleTermination"><a class="anchor" href="#bestScoreFeasibleTermination"></a><a class="link" href="#bestScoreFeasibleTermination">6.9.4. BestScoreFeasibleTermination</a></h4>
<div class="paragraph">
<p>Terminates when a certain score is feasible.
Requires that <code>Score</code> implements <code>FeasibilityScore</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;termination&gt;
    &lt;bestScoreFeasible&gt;true&lt;/bestScoreFeasible&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This <code>Termination</code> is usually combined with other terminations.</p>
</div>
</div>
<div class="sect3">
<h4 id="stepCountTermination"><a class="anchor" href="#stepCountTermination"></a><a class="link" href="#stepCountTermination">6.9.5. StepCountTermination</a></h4>
<div class="paragraph">
<p>Terminates when a number of steps has been reached.
This is useful for hardware performance independent runs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;localSearch&gt;
    &lt;termination&gt;
      &lt;stepCountLimit&gt;100&lt;/stepCountLimit&gt;
    &lt;/termination&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This <code>Termination</code> can only be used for a <code>Phase</code> (such as <code>&lt;localSearch&gt;</code>), not for the <code>Solver</code> itself.</p>
</div>
</div>
<div class="sect3">
<h4 id="unimprovedStepCountTermination"><a class="anchor" href="#unimprovedStepCountTermination"></a><a class="link" href="#unimprovedStepCountTermination">6.9.6. UnimprovedStepCountTermination</a></h4>
<div class="paragraph">
<p>Terminates when the best score has not improved in a number of steps.
This is useful for hardware performance independent runs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;localSearch&gt;
    &lt;termination&gt;
      &lt;unimprovedStepCountLimit&gt;100&lt;/unimprovedStepCountLimit&gt;
    &lt;/termination&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the score has not improved recently, it is unlikely to improve in a reasonable timeframe.
It has been observed that once a new best solution is found (even after a long time without improvement on the best solution), the next few steps tend to improve the best solution.</p>
</div>
<div class="paragraph">
<p>This <code>Termination</code> can only be used for a <code>Phase</code> (such as <code>&lt;localSearch&gt;</code>), not for the <code>Solver</code> itself.</p>
</div>
</div>
<div class="sect3">
<h4 id="scoreCalculationCountTermination"><a class="anchor" href="#scoreCalculationCountTermination"></a><a class="link" href="#scoreCalculationCountTermination">6.9.7. ScoreCalculationCountTermination</a></h4>
<div class="paragraph">
<p><code>ScoreCalculationCountTermination</code> terminates when a number of score calculations have been reached.
This is often the sum of the number of moves and the number of steps.
This is useful for benchmarking.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;termination&gt;
    &lt;scoreCalculationCountLimit&gt;100000&lt;/scoreCalculationCountLimit&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Switching <a href="#environmentMode">EnvironmentMode</a> can heavily impact when this termination ends.</p>
</div>
</div>
<div class="sect3">
<h4 id="combiningMultipleTerminations"><a class="anchor" href="#combiningMultipleTerminations"></a><a class="link" href="#combiningMultipleTerminations">6.9.8. Combining Multiple Terminations</a></h4>
<div class="paragraph">
<p>Terminations can be combined, for example: terminate after <code>100</code> steps or if a score of <code>0</code> has been reached:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;termination&gt;
    &lt;terminationCompositionStyle&gt;OR&lt;/terminationCompositionStyle&gt;
    &lt;stepCountLimit&gt;100&lt;/stepCountLimit&gt;
    &lt;bestScoreLimit&gt;0&lt;/bestScoreLimit&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively you can use <code>AND</code>, for example: terminate after reaching a feasible score of at least <code>-100</code> and no improvements in <code>5</code> steps:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;termination&gt;
    &lt;terminationCompositionStyle&gt;AND&lt;/terminationCompositionStyle&gt;
    &lt;unimprovedStepCountLimit&gt;5&lt;/unimprovedStepCountLimit&gt;
    &lt;bestScoreLimit&gt;-100&lt;/bestScoreLimit&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example ensures it does not just terminate after finding a feasible solution, but also completes any obvious improvements on that solution before terminating.</p>
</div>
</div>
<div class="sect3">
<h4 id="asynchronousTermination"><a class="anchor" href="#asynchronousTermination"></a><a class="link" href="#asynchronousTermination">6.9.9. Asynchronous Termination from Another Thread</a></h4>
<div class="paragraph">
<p>Asychronous termination from another thread occurs when a <code>Solver</code> needs to be terminated early from another thread, for example, due to a user action or a server restart.
This cannot be configured by a <code>Termination</code> as it is impossible to predict when and if it will occur.
Therefore the <code>Solver</code> interface has the following thread-safe methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public interface Solver&lt;Solution_&gt; {
    ...

    boolean terminateEarly();
    boolean isTerminateEarly();

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When calling the <code>terminateEarly()</code> method from another thread, the <code>Solver</code> will terminate at its earliest convenience and the <code>solve(Solution)</code> method will return (in the original <code>Solver</code> thread).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Interrupting the Solver thread (which is the thread that called <code>Solver.solve(Solution)</code>) has the same affect as calling <code>terminateEarly()</code> except that it leaves that thread in the interrupted state.
This guarantees a graceful shutdown when an <code>ExecutorService</code> (such as a thread pool) is shutdown because that only interrupts all active threads in the pool.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="SolverEventListener"><a class="anchor" href="#SolverEventListener"></a><a class="link" href="#SolverEventListener">6.10. SolverEventListener</a></h3>
<div class="paragraph">
<p>Each time a new best solution is found, a new <code>BestSolutionChangedEvent</code> is fired in the <code>Solver</code> thread.</p>
</div>
<div class="paragraph">
<p>To listen to such events, add a <code>SolverEventListener</code> to the <code>Solver</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public interface Solver&lt;Solution_&gt; {
    ...

    void addEventListener(SolverEventListener&lt;S&gt; eventListener);
    void removeEventListener(SolverEventListener&lt;S&gt; eventListener);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>BestSolutionChangedEvent</code>'s <code>newBestSolution</code> may not be initialized or feasible.
Use the <code>isFeasible()</code> method on <code>BestSolutionChangedEvent</code>'s new best <code>Score</code> to detect such cases:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    solver.addEventListener(new SolverEventListener&lt;CloudBalance&gt;() {
        public void bestSolutionChanged(BestSolutionChangedEvent&lt;CloudBalance&gt; event) {
            // Ignore infeasible (including uninitialized) solutions
            if (event.getNewBestSolution().getScore().isFeasible()) {
                ...
            }
        }
    });</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use <code>Score.isSolutionInitialized()</code> instead of <code>Score.isFeasible()</code> to only ignore uninitialized solutions, but also accept infeasible solutions.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>bestSolutionChanged()</code> method is called in the solver&#8217;s thread, as part of <code>Solver.solve()</code>.
So it should return quickly to avoid slowing down the solving.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="customSolverPhase"><a class="anchor" href="#customSolverPhase"></a><a class="link" href="#customSolverPhase">6.11. Custom Solver Phase</a></h3>
<div class="paragraph">
<p>Run a custom optmization algorithm etween phases or before the first phase to initialize the <code>Solution</code>, or to get a better score quickly.
You will still want to reuse the score calculation.
For example, to implement a custom Construction Heuristic without implementing an entire <code>Phase</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Most of the time, a custom solver phase is not worth the development time investment.
The supported <a href="#constructionHeuristics">Constructions Heuristics</a> are configurable (use the <a href="#benchmarker">Benchmarker</a> to tweak them),
<code>Termination</code> aware and support partially initialized solutions too.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>CustomPhaseCommand</code> interface appears as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public interface CustomPhaseCommand&lt;Solution_&gt; {
    ...

    void changeWorkingSolution(ScoreDirector&lt;Solution_&gt; scoreDirector);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, extend <code>AbstractCustomPhaseCommand</code> and implement the <code>changeWorkingSolution()</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class ToOriginalMachineSolutionInitializer extends AbstractCustomPhaseCommand&lt;MachineReassignment&gt; {

    public void changeWorkingSolution(ScoreDirector&lt;MachineReassignment&gt; scoreDirector) {
        MachineReassignment machineReassignment = scoreDirector.getWorkingSolution();
        for (MrProcessAssignment processAssignment : machineReassignment.getProcessAssignmentList()) {
            scoreDirector.beforeVariableChanged(processAssignment, "machine");
            processAssignment.setMachine(processAssignment.getOriginalMachine());
            scoreDirector.afterVariableChanged(processAssignment, "machine");
            scoreDirector.triggerVariableListeners();
        }
    }

}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Any change on the planning entities in a <code>CustomPhaseCommand</code> must be notified to the <code>ScoreDirector</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not change any of the problem facts in a <code>CustomPhaseCommand</code>.
That will corrupt the <code>Solver</code> because any previous score or solution was for a different problem.
To do that, read about <a href="#repeatedPlanning">repeated planning</a> and do it with a <a href="#problemFactChange">ProblemFactChange</a> instead.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>CustomPhaseCommand</code> can be configured using the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;solver&gt;
  ...
  &lt;customPhase&gt;
    &lt;customPhaseCommandClass&gt;org.optaplanner.examples.machinereassignment.solver.solution.initializer.ToOriginalMachineSolutionInitializer&lt;/customPhaseCommandClass&gt;
  &lt;/customPhase&gt;
  ... &lt;!-- Other phases --&gt;
&lt;/solver&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Configure multiple <code>customPhaseCommandClass</code> instances to run them in sequence.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the changes of a <code>CustomPhaseCommand</code> do not result in a better score, the best solution will not be changed
(so effectively nothing will have changed for the next <code>Phase</code> or <code>CustomPhaseCommand</code>).
To force such changes anyway, use <code>forceUpdateBestSolution</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;customPhase&gt;
    &lt;customPhaseCommandClass&gt;...MyCustomPhase&lt;/customPhaseCommandClass&gt;
    &lt;forceUpdateBestSolution&gt;true&lt;/forceUpdateBestSolution&gt;
  &lt;/customPhase&gt;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the <code>Solver</code> or a <code>Phase</code> wants to terminate while a <code>CustomPhaseCommand</code> is still running,
it will wait to terminate until the <code>CustomPhaseCommand</code> is complete.
This may take a significant amount of time.
The built-in solver phases do not have this issue.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To configure values of a <code>CustomPhaseCommand</code> dynamically in the solver configuration
(so the <a href="#benchmarker">Benchmarker</a> can tweak those parameters), add the <code>customProperties</code> element:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;customPhase&gt;
    &lt;customProperties&gt;
      &lt;mySelectionSize&gt;5&lt;/mySelectionSize&gt;
    &lt;/customProperties&gt;
  &lt;/customPhase&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then add a public setter for each custom property, which is called when a <code>Solver</code> is build.
Most value types are supported (including boolean, integers, doubles and strings).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class MyCustomPhase extends AbstractCustomPhaseCommand&lt;MySolution&gt; {

    private int mySelectionSize = 10;

    @SuppressWarnings("unused")
    public void setMySelectionSize(int mySelectionSize) {
        this.mySelectionSize = mySelectionSize;
    }

    ...
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="noChangeSolverPhase"><a class="anchor" href="#noChangeSolverPhase"></a><a class="link" href="#noChangeSolverPhase">6.12. No Change Solver Phase</a></h3>
<div class="paragraph">
<p>In rare cases, it can be useful to configure that no solver phase should be run.
But by default, configuring no phase will trigger the use of the default phases.
To avoid those, configure a <code>NoChangePhase</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;solver&gt;
  ...
  &lt;noChangePhase/&gt;
&lt;/solver&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="multiThreadedSolving"><a class="anchor" href="#multiThreadedSolving"></a><a class="link" href="#multiThreadedSolving">6.13. Multi-threaded Solving</a></h3>
<div class="paragraph">
<p>There are several ways of doing multi-threaded solving:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./OptimizationAlgorithms/multiThreadingStrategies.png" alt="multiThreadingStrategies">
</div>
</div>
<div class="paragraph">
<p>For now, only Partitioned Search is supported out of the box.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A <a href="#logging">logging level</a> of <code>debug</code> or <code>trace</code> might cause congestion multi-threaded solving
and slow down the <a href="#scoreCalculationSpeed">score calculation speed</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="moveAndNeighborhoodSelection"><a class="anchor" href="#moveAndNeighborhoodSelection"></a><a class="link" href="#moveAndNeighborhoodSelection">7. <code>Move</code> and Neighborhood Selection</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="moveAndNeighborhoodSelectionIntroduction"><a class="anchor" href="#moveAndNeighborhoodSelectionIntroduction"></a><a class="link" href="#moveAndNeighborhoodSelectionIntroduction">7.1. <code>Move</code> and Neighborhood Introduction</a></h3>
<div class="sect3">
<h4 id="whatIsAMove"><a class="anchor" href="#whatIsAMove"></a><a class="link" href="#whatIsAMove">7.1.1. What is a <code>Move</code>?</a></h4>
<div class="paragraph">
<p>A <code>Move</code> is a change (or set of changes) from a solution A to a solution B.
For example, the move below changes queen <code>C</code> from row <code>0</code> to row <code>2</code>:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./MoveAndNeighborhoodSelection/singleMoveNQueens04.png" alt="singleMoveNQueens04">
</div>
</div>
<div class="paragraph">
<p>The new solution is called a <em>neighbor</em> of the original solution, because it can be reached in a single <code>Move</code>.
Although a single move can change multiple queens, the neighbors of a solution should always be a very small subset of all possible solutions.
For example, on that original solution, these are all possible <code>changeMove</code>'s:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./MoveAndNeighborhoodSelection/possibleMovesNQueens04.png" alt="possibleMovesNQueens04">
</div>
</div>
<div class="paragraph">
<p>If we ignore the four <code>changeMove</code>'s that have not impact and are therefore not doable, we can see that number of moves is <code>n * (n - 1) = 12</code>.
This is far less than the number of possible solutions, which is <code>n ^ n = 256</code>.
As the problem scales out, the number of possible moves increases far less than the number of possible solutions.</p>
</div>
<div class="paragraph">
<p>Yet, in four <code>changeMove</code>'s or less we can reach any solution.
For example we can reach a very different solution in three <code>changeMove</code>'s:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./MoveAndNeighborhoodSelection/sequentialMovesNQueens04.png" alt="sequentialMovesNQueens04">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>There are many other types of moves besides <code>changeMove</code>'s.
Many move types are included out-of-the-box, but you can also implement custom moves.</p>
</div>
<div class="paragraph">
<p>A <code>Move</code> can affect multiple entities or even create/delete entities.
But it must not change the problem facts.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>All optimization algorithms use <code>Move</code>'s to transition from one solution to a neighbor solution.
Therefore, all the optimization algorithms are confronted with <code>Move</code> selection: the craft of creating and iterating moves efficiently and the art of finding the most promising subset of random moves to evaluate first.</p>
</div>
</div>
<div class="sect3">
<h4 id="whatIsAMoveSelector"><a class="anchor" href="#whatIsAMoveSelector"></a><a class="link" href="#whatIsAMoveSelector">7.1.2. What is a <code>MoveSelector</code>?</a></h4>
<div class="paragraph">
<p>A <code>MoveSelector</code>'s main function is to create <code>Iterator&lt;Move&gt;</code> when needed.
An optimization algorithm will iterate through a subset of those moves.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s an example how to configure a <code>changeMoveSelector</code> for the optimization algorithm Local Search:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;localSearch&gt;
    &lt;changeMoveSelector/&gt;
    ...
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Out of the box, this works and all properties of the <code>changeMoveSelector</code> are defaulted sensibly (unless that fails fast due to ambiguity). On the other hand, the configuration can be customized significantly for specific use cases.
For example: you might want to configure a <a href="#filteredSelection">filter</a> to discard pointless moves.</p>
</div>
</div>
<div class="sect3">
<h4 id="subselectingOfEntitiesValuesAndOtherMoves"><a class="anchor" href="#subselectingOfEntitiesValuesAndOtherMoves"></a><a class="link" href="#subselectingOfEntitiesValuesAndOtherMoves">7.1.3. Subselecting of Entities, Values and Other Moves</a></h4>
<div class="paragraph">
<p>To create a <code>Move</code>, a <code>MoveSelector</code> needs to select one or more planning entities and/or planning values to move.
Just like <code>MoveSelector</code>s, <code>EntitySelector</code>s and <code>ValueSelector</code>s need to support a similar feature set (such as scalable just-in-time selection). Therefore, they all implement a common interface <code>Selector</code> and they are configured similarly.</p>
</div>
<div class="paragraph">
<p>A MoveSelector is often composed out of <code>EntitySelector</code>s, <code>ValueSelector</code>s or even other <code>MoveSelector</code>s, which can be configured individually if desired:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;unionMoveSelector&gt;
      &lt;changeMoveSelector&gt;
        &lt;entitySelector&gt;
          ...
        &lt;/entitySelector&gt;
        &lt;valueSelector&gt;
          ...
        &lt;/valueSelector&gt;
        ...
      &lt;/changeMoveSelector&gt;
      &lt;swapMoveSelector&gt;
        ...
      &lt;/swapMoveSelector&gt;
    &lt;/unionMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Together, this structure forms a <code>Selector</code> tree:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./MoveAndNeighborhoodSelection/selectorTree.png" alt="selectorTree">
</div>
</div>
<div class="paragraph">
<p>The root of this tree is a <code>MoveSelector</code> which is injected into the optimization algorithm implementation to be (partially) iterated in every step.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="genericMoveSelectors"><a class="anchor" href="#genericMoveSelectors"></a><a class="link" href="#genericMoveSelectors">7.2. Generic MoveSelectors</a></h3>
<div class="sect3">
<h4 id="changeMoveSelector"><a class="anchor" href="#changeMoveSelector"></a><a class="link" href="#changeMoveSelector">7.2.1. changeMoveSelector</a></h4>
<div class="paragraph">
<p>For one planning variable, the <code>ChangeMove</code> selects one planning entity and one planning value and assigns the entity&#8217;s variable to that value.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./MoveAndNeighborhoodSelection/changeMove.png" alt="changeMove">
</div>
</div>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;changeMoveSelector/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If there are multiple entity classes or multiple planning variables for one entity class, a simple configuration will automatically unfold into a <a href="#unionMoveSelector">union</a> of <code>ChangeMove</code> selectors for every planning variable.</p>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;changeMoveSelector&gt;
      ... &lt;!-- Normal selector properties --&gt;
      &lt;entitySelector&gt;
        &lt;entityClass&gt;...Lecture&lt;/entityClass&gt;
        ...
      &lt;/entitySelector&gt;
      &lt;valueSelector&gt;
        &lt;variableName&gt;room&lt;/variableName&gt;
        ...
        &lt;nearbySelection&gt;...&lt;/nearbySelection&gt;
      &lt;/valueSelector&gt;
    &lt;/changeMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>ChangeMove</code> is the finest grained move.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Almost every <code>moveSelector</code> configuration injected into a metaheuristic algorithm should include a changeMoveSelector or a custom implementation.
This guarantees that every possible <code>Solution</code> can be reached through applying a number of moves in sequence (not taking <a href="#scoreTrap">score traps</a> into account). Of course, normally it is unioned with other, more coarse grained move selectors.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="swapMoveSelector"><a class="anchor" href="#swapMoveSelector"></a><a class="link" href="#swapMoveSelector">7.2.2. swapMoveSelector</a></h4>
<div class="paragraph">
<p>The <code>SwapMove</code> selects two different planning entities and swaps the planning values of all their planning variables.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./MoveAndNeighborhoodSelection/swapMove.png" alt="swapMove">
</div>
</div>
<div class="paragraph">
<p>Although a <code>SwapMove</code> on a single variable is essentially just two <code>ChangeMove</code>s, it&#8217;s often the winning step where the first of the two <code>ChangeMove</code>s would not be the winning step because it leaves the solution in a state with broken hard constraints.
For example: swapping the room of two lectures doesn&#8217;t bring the solution in a intermediate state where both lectures are in the same room which breaks a hard constraint.</p>
</div>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;swapMoveSelector/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If there are multiple entity classes, a simple configuration will automatically unfold into a <a href="#unionMoveSelector">union</a> of <code>SwapMove</code> selectors for every entity class.</p>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;swapMoveSelector&gt;
      ... &lt;!-- Normal selector properties --&gt;
      &lt;entitySelector&gt;
        &lt;entityClass&gt;...Lecture&lt;/entityClass&gt;
        ...
      &lt;/entitySelector&gt;
      &lt;secondaryEntitySelector&gt;
        &lt;entityClass&gt;...Lecture&lt;/entityClass&gt;
        ...
        &lt;nearbySelection&gt;...&lt;/nearbySelection&gt;
      &lt;/secondaryEntitySelector&gt;
      &lt;variableNameInclude&gt;room&lt;/variableNameInclude&gt;
      &lt;variableNameInclude&gt;...&lt;/variableNameInclude&gt;
    &lt;/swapMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>secondaryEntitySelector</code> is rarely needed: if it is not specified, entities from the same <code>entitySelector</code> are swapped.</p>
</div>
<div class="paragraph">
<p>If one or more <code>variableNameInclude</code> properties are specified, not all planning variables will be swapped, but only those specified.
For example for course scheduling, specifying only <code>variableNameInclude</code> room will make it only swap room, not period.</p>
</div>
</div>
<div class="sect3">
<h4 id="pillarChangeMoveSelector"><a class="anchor" href="#pillarChangeMoveSelector"></a><a class="link" href="#pillarChangeMoveSelector">7.2.3. pillarChangeMoveSelector</a></h4>
<div class="paragraph">
<p>A <em>pillar</em> is a set of planning entities which have the same planning value(s) for their planning variable(s). The <code>PillarChangeMove</code> selects one entity pillar (or subset of those) and changes the value of one variable (which is the same for all entities) to another value.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./MoveAndNeighborhoodSelection/pillarChangeMove.png" alt="pillarChangeMove">
</div>
</div>
<div class="paragraph">
<p>In the example above, queen A and C have the same value (row 0) and are moved to row 2.
Also the yellow and blue process have the same value (computer Y) and are moved to computer X.</p>
</div>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;pillarChangeMoveSelector/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;pillarSwapMoveSelector&gt;
      ... &lt;!-- Normal selector properties --&gt;
      &lt;pillarSelector&gt;
        &lt;entitySelector&gt;
          &lt;entityClass&gt;...Lecture&lt;/entityClass&gt;
          ...
        &lt;/entitySelector&gt;
        &lt;subPillarEnabled&gt;true&lt;/subPillarEnabled&gt;
        &lt;minimumSubPillarSize&gt;1&lt;/minimumSubPillarSize&gt;
        &lt;maximumSubPillarSize&gt;1000&lt;/maximumSubPillarSize&gt;
      &lt;/pillarSelector&gt;
      &lt;valueSelector&gt;
        &lt;variableName&gt;room&lt;/variableName&gt;
        ...
      &lt;/valueSelector&gt;
    &lt;/pillarSwapMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A sub pillar is a subset of entities that share the same value(s) for their variable(s). For example if queen A, B, C and D are all located on row 0, they are a pillar and <code>[A, D]</code> is one of the many sub pillars.
If <code>subPillarEnabled</code> (defaults to <code>true</code>) is false, no sub pillars are selected.
If sub pillars are enabled, the pillar itself is also included and the properties <code>minimumSubPillarSize</code> (defaults to <code>1</code>) and <code>maximumSubPillarSize</code> (defaults to <code>infinity</code>) limit the size of the selected (sub) pillar.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The number of sub pillars of a pillar is exponential to the size of the pillar.
For example a pillar of size 32 has <code>(2^32 - 1)</code> subpillars.
Therefore a <code>pillarSelector</code> only supports <a href="#justInTimeRandomSelection">JIT random selection</a> (which is the default).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The other properties are explained in <a href="#changeMoveSelector">changeMoveSelector</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="pillarSwapMoveSelector"><a class="anchor" href="#pillarSwapMoveSelector"></a><a class="link" href="#pillarSwapMoveSelector">7.2.4. pillarSwapMoveSelector</a></h4>
<div class="paragraph">
<p>A <em>pillar</em> is a set of planning entities which have the same planning value(s) for their planning variable(s). The <code>PillarSwapMove</code> selects two different entity pillars and swaps the values of all their variables for all their entities.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./MoveAndNeighborhoodSelection/pillarSwapMove.png" alt="pillarSwapMove">
</div>
</div>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;pillarSwapMoveSelector/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;pillarSwapMoveSelector&gt;
      ... &lt;!-- Normal selector properties --&gt;
      &lt;pillarSelector&gt;
        &lt;entitySelector&gt;
          &lt;entityClass&gt;...Lecture&lt;/entityClass&gt;
          ...
        &lt;/entitySelector&gt;
        &lt;subPillarEnabled&gt;true&lt;/subPillarEnabled&gt;
        &lt;minimumSubPillarSize&gt;1&lt;/minimumSubPillarSize&gt;
        &lt;maximumSubPillarSize&gt;1000&lt;/maximumSubPillarSize&gt;
      &lt;/pillarSelector&gt;
      &lt;secondaryPillarSelector&gt;
        &lt;entitySelector&gt;
          ...
        &lt;/entitySelector&gt;
        ...
      &lt;/secondaryPillarSelector&gt;
      &lt;variableNameInclude&gt;room&lt;/variableNameInclude&gt;
      &lt;variableNameInclude&gt;...&lt;/variableNameInclude&gt;
    &lt;/pillarSwapMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>secondaryPillarSelector</code> is rarely needed: if it is not specified, entities from the same <code>pillarSelector</code> are swapped.</p>
</div>
<div class="paragraph">
<p>The other properties are explained in <a href="#swapMoveSelector">swapMoveSelector</a> and <a href="#pillarChangeMoveSelector">pillarChangeMoveSelector</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="tailChainSwapMoveSelector"><a class="anchor" href="#tailChainSwapMoveSelector"></a><a class="link" href="#tailChainSwapMoveSelector">7.2.5. tailChainSwapMoveSelector or 2-opt (chained variables only)</a></h4>
<div class="paragraph">
<p>A <em>tailChain</em> is a set of planning entities with a chained planning variable which form a last part of a chain.
The <code>tailChainSwapMove</code> selects a tail chain and swaps it with the tail chain of another planning value (in a different or the same anchor chain). If the targeted planning value, doesn&#8217;t have a tail chain, it swaps with nothing (resulting in a change like move). If it occurs within the same anchor chain, a partial chain reverse occurs.
In academic papers, this is often called a 2-opt move.</p>
</div>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;tailChainSwapMoveSelector/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;subChainChangeMoveSelector&gt;
      ... &lt;!-- Normal selector properties --&gt;
      &lt;entitySelector&gt;
        &lt;entityClass&gt;...Customer&lt;/entityClass&gt;
        ...
      &lt;/entitySelector&gt;
      &lt;valueSelector&gt;
        &lt;variableName&gt;previousStandstill&lt;/variableName&gt;
        ...
        &lt;nearbySelection&gt;...&lt;/nearbySelection&gt;
      &lt;/valueSelector&gt;
    &lt;/subChainChangeMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>entitySelector</code> selects the start of the tail chain that is being moved.
The valueSelector selects to where that tail chain is moved.
If it has a tail chain itself, that is moved to the location of the original tail chain.
It uses a <code>valueSelector</code> instead of a <code>secondaryEntitySelector</code> to be able to include all possible 2opt moves (such as moving to the end of a tail) and to work correctly with <a href="#nearbySelection">nearby selection</a> (because of asymmetric distances and also swapped entity distance gives an incorrect selection probability).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Although <code>subChainChangeMoveSelector</code> and <code>subChainSwapMoveSelector</code> include almost every possible <code>tailChainSwapMove</code>, experiments have shown that focusing on <code>tailChainSwapMove</code>s increases efficiency.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="subChainChangeMoveSelector"><a class="anchor" href="#subChainChangeMoveSelector"></a><a class="link" href="#subChainChangeMoveSelector">7.2.6. subChainChangeMoveSelector (chained variables only)</a></h4>
<div class="paragraph">
<p>A <em>subChain</em> is a set of planning entities with a chained planning variable which form part of a chain.
The <code>subChainChangeMoveSelector</code> selects a subChain and moves it to another place (in a different or the same anchor chain).</p>
</div>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;subChainChangeMoveSelector/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;subChainChangeMoveSelector&gt;
      ... &lt;!-- Normal selector properties --&gt;
      &lt;entityClass&gt;...Customer&lt;/entityClass&gt;
      &lt;subChainSelector&gt;
        &lt;valueSelector&gt;
          &lt;variableName&gt;previousStandstill&lt;/variableName&gt;
          ...
        &lt;/valueSelector&gt;
        &lt;minimumSubChainSize&gt;2&lt;/minimumSubChainSize&gt;
        &lt;maximumSubChainSize&gt;40&lt;/maximumSubChainSize&gt;
      &lt;/subChainSelector&gt;
      &lt;valueSelector&gt;
        &lt;variableName&gt;previousStandstill&lt;/variableName&gt;
        ...
      &lt;/valueSelector&gt;
      &lt;selectReversingMoveToo&gt;true&lt;/selectReversingMoveToo&gt;
    &lt;/subChainChangeMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>subChainSelector</code> selects a number of entities, no less than <code>minimumSubChainSize</code> (defaults to <code>1</code>) and no more than <code>maximumSubChainSize</code> (defaults to <code>infinity</code>).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If <code>minimumSubChainSize</code> is <code>1</code> (which is the default), this selector might select the same move as a <code>ChangeMoveSelector</code>, at a far lower selection probability (because each move <em>type</em> has the same selection chance by default (not every move instance) and there are far more <code>SubChainChangeMove</code> instances than <code>ChangeMove</code> instances). However, don&#8217;t just remove the <code>ChangeMoveSelector</code>, because experiments show that it&#8217;s good to focus on <code>ChangeMove</code>s.</p>
</div>
<div class="paragraph">
<p>Furthermore, in a <code>SubChainSwapMoveSelector</code>, setting <code>minimumSubChainSize</code> prevents swapping a subchain of size <code>1</code> with a subchain of at least size <code>2</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>selectReversingMoveToo</code> property (defaults to true) enables selecting the reverse of every subchain too.</p>
</div>
</div>
<div class="sect3">
<h4 id="subChainSwapMoveSelector"><a class="anchor" href="#subChainSwapMoveSelector"></a><a class="link" href="#subChainSwapMoveSelector">7.2.7. subChainSwapMoveSelector (chained variables only)</a></h4>
<div class="paragraph">
<p>The <code>subChainSwapMoveSelector</code> selects two different subChains and moves them to another place in a different or the same anchor chain.</p>
</div>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;subChainSwapMoveSelector/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;subChainSwapMoveSelector&gt;
      ... &lt;!-- Normal selector properties --&gt;
      &lt;entityClass&gt;...Customer&lt;/entityClass&gt;
      &lt;subChainSelector&gt;
        &lt;valueSelector&gt;
          &lt;variableName&gt;previousStandstill&lt;/variableName&gt;
          ...
        &lt;/valueSelector&gt;
        &lt;minimumSubChainSize&gt;2&lt;/minimumSubChainSize&gt;
        &lt;maximumSubChainSize&gt;40&lt;/maximumSubChainSize&gt;
      &lt;/subChainSelector&gt;
      &lt;secondarySubChainSelector&gt;
        &lt;valueSelector&gt;
          &lt;variableName&gt;previousStandstill&lt;/variableName&gt;
          ...
        &lt;/valueSelector&gt;
        &lt;minimumSubChainSize&gt;2&lt;/minimumSubChainSize&gt;
        &lt;maximumSubChainSize&gt;40&lt;/maximumSubChainSize&gt;
      &lt;/secondarySubChainSelector&gt;
      &lt;selectReversingMoveToo&gt;true&lt;/selectReversingMoveToo&gt;
    &lt;/subChainSwapMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>secondarySubChainSelector</code> is rarely needed: if it is not specified, entities from the same <code>subChainSelector</code> are swapped.</p>
</div>
<div class="paragraph">
<p>The other properties are explained in <a href="#subChainChangeMoveSelector">subChainChangeMoveSelector</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="combiningMultipleMoveSelectors"><a class="anchor" href="#combiningMultipleMoveSelectors"></a><a class="link" href="#combiningMultipleMoveSelectors">7.3. Combining Multiple <code>MoveSelector</code>s</a></h3>
<div class="sect3">
<h4 id="unionMoveSelector"><a class="anchor" href="#unionMoveSelector"></a><a class="link" href="#unionMoveSelector">7.3.1. unionMoveSelector</a></h4>
<div class="paragraph">
<p>A <code>unionMoveSelector</code> selects a <code>Move</code> by selecting one of its <code>MoveSelector</code> children to supply the next <code>Move</code>.</p>
</div>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;unionMoveSelector&gt;
      &lt;...MoveSelector/&gt;
      &lt;...MoveSelector/&gt;
      &lt;...MoveSelector/&gt;
      ...
    &lt;/unionMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;unionMoveSelector&gt;
      ... &lt;!-- Normal selector properties --&gt;
      &lt;selectorProbabilityWeightFactoryClass&gt;...ProbabilityWeightFactory&lt;/selectorProbabilityWeightFactoryClass&gt;
      &lt;changeMoveSelector&gt;
        &lt;fixedProbabilityWeight&gt;...&lt;/fixedProbabilityWeight&gt;
        ...
      &lt;/changeMoveSelector&gt;
      &lt;swapMoveSelector&gt;
        &lt;fixedProbabilityWeight&gt;...&lt;/fixedProbabilityWeight&gt;
        ...
      &lt;/swapMoveSelector&gt;
      &lt;...MoveSelector&gt;
        &lt;fixedProbabilityWeight&gt;...&lt;/fixedProbabilityWeight&gt;
        ...
      &lt;/...MoveSelector&gt;
      ...
    &lt;/unionMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>selectorProbabilityWeightFactory</code> determines in <code>selectionOrder</code> <code>RANDOM</code> how often a <code>MoveSelector</code> child is selected to supply the next Move.
By default, each <code>MoveSelector</code> child has the same chance of being selected.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./MoveAndNeighborhoodSelection/selectorProbabilityInUnion.png" alt="selectorProbabilityInUnion">
</div>
</div>
<div class="paragraph">
<p>Change the <code>fixedProbabilityWeight</code> of such a child to select it more often.
For example, the <code>unionMoveSelector</code> can return a <code>SwapMove</code> twice as often as a <code>ChangeMove</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;unionMoveSelector&gt;
      &lt;changeMoveSelector&gt;
        &lt;fixedProbabilityWeight&gt;1.0&lt;/fixedProbabilityWeight&gt;
        ...
      &lt;/changeMoveSelector&gt;
      &lt;swapMoveSelector&gt;
        &lt;fixedProbabilityWeight&gt;2.0&lt;/fixedProbabilityWeight&gt;
        ...
      &lt;/swapMoveSelector&gt;
    &lt;/unionMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The number of possible <code>ChangeMove</code>s is very different from the number of possible <code>SwapMove</code>s and furthermore it&#8217;s problem dependent.
To give each individual <code>Move</code> the same selection chance (as opposed to each <code>MoveSelector</code>), use the <code>FairSelectorProbabilityWeightFactory</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;unionMoveSelector&gt;
      &lt;selectorProbabilityWeightFactoryClass&gt;org.optaplanner.core.impl.heuristic.selector.common.decorator.FairSelectorProbabilityWeightFactory&lt;/selectorProbabilityWeightFactoryClass&gt;
      &lt;changeMoveSelector/&gt;
      &lt;swapMoveSelector/&gt;
    &lt;/unionMoveSelector&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cartesianProductMoveSelector"><a class="anchor" href="#cartesianProductMoveSelector"></a><a class="link" href="#cartesianProductMoveSelector">7.3.2. cartesianProductMoveSelector</a></h4>
<div class="paragraph">
<p>A <code>cartesianProductMoveSelector</code> selects a new <code>CompositeMove</code>.
It builds that <code>CompositeMove</code> by selecting one <code>Move</code> per <code>MoveSelector</code> child and adding it to the <code>CompositeMove</code>.</p>
</div>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;cartesianProductMoveSelector&gt;
      &lt;...MoveSelector/&gt;
      &lt;...MoveSelector/&gt;
      &lt;...MoveSelector/&gt;
      ...
    &lt;/cartesianProductMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;cartesianProductMoveSelector&gt;
      ... &lt;!-- Normal selector properties --&gt;
      &lt;ignoreEmptyChildIterators&gt;true&lt;/ignoreEmptyChildIterators&gt;
      &lt;changeMoveSelector&gt;
        ...
      &lt;/changeMoveSelector&gt;
      &lt;swapMoveSelector&gt;
        ...
      &lt;/swapMoveSelector&gt;
      &lt;...MoveSelector&gt;
        ...
      &lt;/...MoveSelector&gt;
      ...
    &lt;/cartesianProductMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>ignoreEmptyChildIterators</code> property (true by default) will ignore every empty <code>childMoveSelector</code> to avoid returning no moves.
For example: a cartesian product of <code>changeMoveSelector</code> A and B, for which B is empty (because all it&#8217;s entities are immovable) returns no move if <code>ignoreEmptyChildIterators</code> is <code>false</code> and the moves of A if <code>ignoreEmptyChildIterators</code> is <code>true</code>.</p>
</div>
<div class="paragraph">
<p>To enforce that two child selectors use the same entity or value efficiently, use <a href="#mimicSelection">mimic selection</a>, not move filtering.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="entitySelector"><a class="anchor" href="#entitySelector"></a><a class="link" href="#entitySelector">7.4. EntitySelector</a></h3>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">      &lt;entitySelector/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">      &lt;entitySelector&gt;
        ... &lt;!-- Normal selector properties --&gt;
        &lt;entityClass&gt;org.optaplanner.examples.curriculumcourse.domain.Lecture&lt;/entityClass&gt;
      &lt;/entitySelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>entityClass</code> property is only required if it cannot be deduced automatically because there are multiple entity classes.</p>
</div>
</div>
<div class="sect2">
<h3 id="valueSelector"><a class="anchor" href="#valueSelector"></a><a class="link" href="#valueSelector">7.5. ValueSelector</a></h3>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">      &lt;valueSelector/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">      &lt;valueSelector&gt;
        ... &lt;!-- Normal selector properties --&gt;
        &lt;variableName&gt;room&lt;/variableName&gt;
      &lt;/valueSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>variableName</code> property is only required if it cannot be deduced automatically because there are multiple variables (for the related entity class).</p>
</div>
<div class="paragraph">
<p>In exotic Construction Heuristic configurations, the <code>entityClass</code> from the <code>EntitySelector</code> sometimes needs to be downcasted, which can be done with the property <code>downcastEntityClass</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">      &lt;valueSelector&gt;
        &lt;downcastEntityClass&gt;...LeadingExam&lt;/downcastEntityClass&gt;
        &lt;variableName&gt;period&lt;/variableName&gt;
      &lt;/valueSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If a selected entity cannot be downcasted, the <code>ValueSelector</code> is empty for that entity.</p>
</div>
</div>
<div class="sect2">
<h3 id="generalSelectorFeatures"><a class="anchor" href="#generalSelectorFeatures"></a><a class="link" href="#generalSelectorFeatures">7.6. General <code>Selector</code> Features</a></h3>
<div class="sect3">
<h4 id="cacheType"><a class="anchor" href="#cacheType"></a><a class="link" href="#cacheType">7.6.1. <code>CacheType</code>: Create Moves Ahead of Time or Just In Time</a></h4>
<div class="paragraph">
<p>A <code>Selector</code>'s <code>cacheType</code> determines when a selection (such as a <code>Move</code>, an entity, a value, &#8230;&#8203;) is created and how long it lives.</p>
</div>
<div class="paragraph">
<p>Almost every <code>Selector</code> supports setting a <code>cacheType</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;changeMoveSelector&gt;
      &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      ...
    &lt;/changeMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following <code>cacheType</code>s are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>JUST_IN_TIME</code> (default): Not cached. Construct each selection (<code>Move</code>, &#8230;&#8203;) just before it&#8217;s used. This scales up well in memory footprint.</p>
</li>
<li>
<p><code>STEP</code>: Cached. Create each selection (<code>Move</code>, &#8230;&#8203;) at the beginning of a step and cache them in a list for the remainder of the step. This scales up badly in memory footprint.</p>
</li>
<li>
<p><code>PHASE</code>: Cached. Create each selection (<code>Move</code>, &#8230;&#8203;) at the beginning of a solver phase and cache them in a list for the remainder of the phase. Some selections cannot be phase cached because the list changes every step. This scales up badly in memory footprint, but has a slight performance gain.</p>
</li>
<li>
<p><code>SOLVER</code>: Cached. Create each selection (<code>Move</code>, &#8230;&#8203;) at the beginning of a <code>Solver</code> and cache them in a list for the remainder of the <code>Solver</code>. Some selections cannot be solver cached because the list changes every step. This scales up badly in memory footprint, but has a slight performance gain.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A <code>cacheType</code> can be set on composite selectors too:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;unionMoveSelector&gt;
      &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;changeMoveSelector/&gt;
      &lt;swapMoveSelector/&gt;
      ...
    &lt;/unionMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nested selectors of a cached selector cannot be configured to be cached themselves, unless it&#8217;s a higher <code>cacheType</code>.
For example: a <code>STEP</code> cached <code>unionMoveSelector</code> can hold a <code>PHASE</code> cached <code>changeMoveSelector</code>, but not a <code>STEP</code> cached <code>changeMoveSelector</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="selectionOrder"><a class="anchor" href="#selectionOrder"></a><a class="link" href="#selectionOrder">7.6.2. SelectionOrder: Original, Sorted, Random, Shuffled or Probabilistic</a></h4>
<div class="paragraph">
<p>A <code>Selector</code>'s <code>selectionOrder</code> determines the order in which the selections (such as <code>Move</code>s, entities, values, &#8230;&#8203;) are iterated.
An optimization algorithm will usually only iterate through a subset of its <code>MoveSelector</code>'s selections, starting from the start, so the <code>selectionOrder</code> is critical to decide which <code>Move</code>s are actually evaluated.</p>
</div>
<div class="paragraph">
<p>Almost every <code>Selector</code> supports setting a <code>selectionOrder</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;changeMoveSelector&gt;
      ...
      &lt;selectionOrder&gt;RANDOM&lt;/selectionOrder&gt;
      ...
    &lt;/changeMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following <code>selectionOrder</code>s are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ORIGINAL</code>: Select the selections (<code>Move</code>s, entities, values, &#8230;&#8203;) in default order. Each selection will be selected only once.</p>
<div class="ulist">
<ul>
<li>
<p>For example: A0, A1, A2, A3, &#8230;&#8203;, B0, B1, B2, B3, &#8230;&#8203;, C0, C1, C2, C3, &#8230;&#8203;</p>
</li>
</ul>
</div>
</li>
<li>
<p>SORTED: Select the selections (<code>Move</code>s, entities, values, &#8230;&#8203;) in sorted order. Each selection will be selected only once. Requires <code>cacheType &gt;= STEP</code>. Mostly used on an <code>entitySelector</code> or <code>valueSelector</code> for construction heuristics. See <a href="#sortedSelection">sorted selection</a>.</p>
<div class="ulist">
<ul>
<li>
<p>For example: A0, B0, C0, &#8230;&#8203;, A2, B2, C2, &#8230;&#8203;, A1, B1, C1, &#8230;&#8203;</p>
</li>
</ul>
</div>
</li>
<li>
<p>RANDOM (default): Select the selections (<code>Move</code>s, entities, values, &#8230;&#8203;) in non-shuffled random order. A selection might be selected multiple times. This scales up well in performance because it does not require caching.</p>
<div class="ulist">
<ul>
<li>
<p>For example: C2, A3, B1, C2, A0, C0, &#8230;&#8203;</p>
</li>
</ul>
</div>
</li>
<li>
<p>SHUFFLED: Select the selections (<code>Move</code>s, entities, values, &#8230;&#8203;) in shuffled random order. Each selection will be selected only once. Requires <code>cacheType &gt;= STEP</code>. This scales up badly in performance, not just because it requires caching, but also because a random number is generated for each element, even if it&#8217;s not selected (which is the grand majority when scaling up).</p>
<div class="ulist">
<ul>
<li>
<p>For example: C2, A3, B1, A0, C0, &#8230;&#8203;</p>
</li>
</ul>
</div>
</li>
<li>
<p>PROBABILISTIC: Select the selections (<code>Move</code>s, entities, values, &#8230;&#8203;) in random order, based on the selection probability of each element. A selection with a higher probability has a higher chance to be selected than elements with a lower probability. A selection might be selected multiple times. Requires <code>cacheType &gt;= STEP</code>. Mostly used on an <code>entitySelector</code> or <code>valueSelector</code>. See <a href="#probabilisticSelection">probabilistic selection</a>.</p>
<div class="ulist">
<ul>
<li>
<p>For example: B1, B1, A1, B2, B1, C2, B1, B1, &#8230;&#8203;</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>A <code>selectionOrder</code> can be set on composite selectors too.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When a <code>Selector</code> is cached, all of its nested <code>Selector</code>s will naturally default to <code>selectionOrder</code> <code>ORIGINAL</code>.
Avoid overwriting the <code>selectionOrder</code> of those nested <code>Selector</code>s.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="recommendedCombinationsOfCacheTypeAndSelectionOrder"><a class="anchor" href="#recommendedCombinationsOfCacheTypeAndSelectionOrder"></a><a class="link" href="#recommendedCombinationsOfCacheTypeAndSelectionOrder">7.6.3. Recommended Combinations of <code>CacheType</code> and <code>SelectionOrder</code></a></h4>
<div class="sect4">
<h5 id="justInTimeRandomSelection"><a class="anchor" href="#justInTimeRandomSelection"></a><a class="link" href="#justInTimeRandomSelection">7.6.3.1. Just in Time Random Selection (default)</a></h5>
<div class="paragraph">
<p>This combination is great for big use cases (10 000 entities or more), as it scales up well in memory footprint and performance.
Other combinations are often not even viable on such sizes.
It works for smaller use cases too, so it&#8217;s a good way to start out.
It&#8217;s the default, so this explicit configuration of <code>cacheType</code> and <code>selectionOrder</code> is actually obsolete:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;unionMoveSelector&gt;
      &lt;cacheType&gt;JUST_IN_TIME&lt;/cacheType&gt;
      &lt;selectionOrder&gt;RANDOM&lt;/selectionOrder&gt;

      &lt;changeMoveSelector/&gt;
      &lt;swapMoveSelector/&gt;
    &lt;/unionMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s how it works.
When <code>Iterator&lt;Move&gt;.next()</code> is called, a child <code>MoveSelector</code> is randomly selected (1), which creates a random <code>Move</code> (2, 3, 4) and is then returned (5):</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./MoveAndNeighborhoodSelection/jitRandomSelection.png" alt="jitRandomSelection">
</div>
</div>
<div class="paragraph">
<p>Notice that <strong>it never creates a list of <code><strong>Move</strong></code>s</strong> and it generates random numbers only for <code>Move</code>s that are actually selected.</p>
</div>
</div>
<div class="sect4">
<h5 id="cachedShuffledSelection"><a class="anchor" href="#cachedShuffledSelection"></a><a class="link" href="#cachedShuffledSelection">7.6.3.2. Cached Shuffled Selection</a></h5>
<div class="paragraph">
<p>This combination often wins for small and medium use cases (5000 entities or less). Beyond that size, it scales up badly in memory footprint and performance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;unionMoveSelector&gt;
      &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;selectionOrder&gt;SHUFFLED&lt;/selectionOrder&gt;

      &lt;changeMoveSelector/&gt;
      &lt;swapMoveSelector/&gt;
    &lt;/unionMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s how it works: At the start of the phase (or step depending on the <code>cacheType</code>), all moves are created (1) and cached (2). When <code>MoveSelector.iterator()</code> is called, the moves are shuffled (3). When <code>Iterator&lt;Move&gt;.next()</code> is called, the next element in the shuffled list is returned (4):</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./MoveAndNeighborhoodSelection/cachedShuffledSelection.png" alt="cachedShuffledSelection">
</div>
</div>
<div class="paragraph">
<p>Notice that <strong>each <code></strong>Move<strong></code> will only be selected once</strong>, even though they are selected in random order.</p>
</div>
<div class="paragraph">
<p>Use cacheType PHASE if none of the (possibly nested) Selectors require <code>STEP</code>.
Otherwise, do something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;unionMoveSelector&gt;
      &lt;cacheType&gt;STEP&lt;/cacheType&gt;
      &lt;selectionOrder&gt;SHUFFLED&lt;/selectionOrder&gt;

      &lt;changeMoveSelector&gt;
        &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;/changeMoveSelector&gt;
      &lt;swapMoveSelector/&gt;
        &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;/swapMoveSelector&gt;
      &lt;pillarSwapMoveSelector/&gt;&lt;!-- Does not support cacheType PHASE --&gt;
    &lt;/unionMoveSelector&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="cachedRandomSelection"><a class="anchor" href="#cachedRandomSelection"></a><a class="link" href="#cachedRandomSelection">7.6.3.3. Cached Random Selection</a></h5>
<div class="paragraph">
<p>This combination is often a worthy competitor for medium use cases, especially with fast stepping optimization algorithms (such as Simulated Annealing). Unlike cached shuffled selection, it doesn&#8217;t waste time shuffling the moves list at the beginning of every step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;unionMoveSelector&gt;
      &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;selectionOrder&gt;RANDOM&lt;/selectionOrder&gt;

      &lt;changeMoveSelector/&gt;
      &lt;swapMoveSelector/&gt;
    &lt;/unionMoveSelector&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="filteredSelection"><a class="anchor" href="#filteredSelection"></a><a class="link" href="#filteredSelection">7.6.4. Filtered Selection</a></h4>
<div class="paragraph">
<p>There can be certain moves that you don&#8217;t want to select, because:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The move is pointless and would only waste CPU time. For example, swapping two lectures of the same course will result in the same score and the same schedule because all lectures of one course are interchangeable (same teacher, same students, same topic).</p>
</li>
<li>
<p>Doing the move would break <a href="#buildInHardConstraint">a built-in hard constraint</a>, so the solution would be infeasible but the score function doesn&#8217;t check built-in hard constraints (for performance gain). For example, don&#8217;t change a gym lecture to a room which is not a gym room.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Any built-in hard constraint must probably be filtered on every move type of every solver phase.
For example if it&#8217;s filters the change move of Local Search, it must also filter the swap move that swaps the room of a gym lecture with another lecture for which the other lecture&#8217;s original room isn&#8217;t a gym room.
Furthermore, it must also filter the change moves of the Construction Heuristics (which requires an advanced configuration).</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>If a move is unaccepted by the filter, it&#8217;s not executed and the score isn&#8217;t calculated.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./MoveAndNeighborhoodSelection/filteredSelection.png" alt="filteredSelection">
</div>
</div>
<div class="paragraph">
<p>Filtering uses the interface <code>SelectionFilter</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public interface SelectionFilter&lt;Solution_, T&gt; {

    boolean accept(ScoreDirector&lt;Solution_&gt; scoreDirector, T selection);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Implement the <code>accept</code> method to return <code>false</code> on a discarded <code>selection</code> (see below). Filtered selection can happen on any Selector in the selector tree, including any <code>MoveSelector</code>, <code>EntitySelector</code> or <code>ValueSelector</code>.
It works with any <code>cacheType</code> and <code>selectionOrder</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Apply the filter on the lowest level possible.
In most cases, you&#8217;ll need to know both the entity and the value involved so you&#8217;ll have to apply it on the move selector.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="filteredMoveSelection"><a class="anchor" href="#filteredMoveSelection"></a><a class="link" href="#filteredMoveSelection">7.6.4.1. Filtered Move Selection</a></h5>
<div class="paragraph">
<p>Unaccepted moves will not be selected and will therefore never have their <code>doMove()</code> method called:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class DifferentCourseSwapMoveFilter implements SelectionFilter&lt;SwapMove&gt; {

    @Override
    public boolean accept(ScoreDirector scoreDirector, SwapMove move) {
        Lecture leftLecture = (Lecture) move.getLeftEntity();
        Lecture rightLecture = (Lecture) move.getRightEntity();
        return !leftLecture.getCourse().equals(rightLecture.getCourse());
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Configure the <code>filterClass</code> on every targeted <code>moveSelector</code> (potentially both in the Local Search and the Construction Heuristics if it filters <code>ChangeMove</code>s):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;swapMoveSelector&gt;
      &lt;filterClass&gt;org.optaplanner.examples.curriculumcourse.solver.move.DifferentCourseSwapMoveFilter&lt;/filterClass&gt;
    &lt;/swapMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can configure multiple <code>filterClass</code> elements on a single move selector.</p>
</div>
</div>
<div class="sect4">
<h5 id="filteredEntitySelection"><a class="anchor" href="#filteredEntitySelection"></a><a class="link" href="#filteredEntitySelection">7.6.4.2. Filtered Entity Selection</a></h5>
<div class="paragraph">
<p>Unaccepted entities will not be selected and will therefore never be used to create a move.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class LongLectureSelectionFilter implements SelectionFilter&lt;Lecture&gt; {

    @Override
    public boolean accept(ScoreDirector&lt;CourseSchedule&gt; scoreDirector, Lecture lecture) {
        return lecture.isLong();
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Configure the <code>filterClass</code> on every targeted <code>entitySelector</code> (potentially both in the Local Search and the Construction Heuristics):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;changeMoveSelector&gt;
      &lt;entitySelector&gt;
        &lt;filterClass&gt;org.optaplanner.examples.curriculumcourse.solver.move.LongLectureSelectionFilter&lt;/filterClass&gt;
      &lt;/entitySelector&gt;
    &lt;/changeMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If that filter should apply on all entities, configure it as a <a href="#immovablePlanningEntities">global movableEntitySelectionFilter</a> instead.</p>
</div>
<div class="paragraph">
<p>You can configure multiple <code>filterClass</code> elements on a single entity selector.</p>
</div>
</div>
<div class="sect4">
<h5 id="filteredValueSelection"><a class="anchor" href="#filteredValueSelection"></a><a class="link" href="#filteredValueSelection">7.6.4.3. Filtered Value Selection</a></h5>
<div class="paragraph">
<p>Unaccepted values will not be selected and will therefore never be used to create a move.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class LongPeriodSelectionFilter implements SelectionFilter&lt;Period&gt; {

    @Override
    public boolean accept(ScoreDirector&lt;CourseSchedule&gt; scoreDirector, Period period) {
        return period();
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Configure the <code>filterClass</code> on every targeted <code>valueSelector</code> (potentially both in the Local Search and the Construction Heuristics):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;changeMoveSelector&gt;
      &lt;valueSelector&gt;
        &lt;filterClass&gt;org.optaplanner.examples.curriculumcourse.solver.move.LongPeriodSelectionFilter&lt;/filterClass&gt;
      &lt;/valueSelector&gt;
    &lt;/changeMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can configure multiple <code>filterClass</code> elements on a single value selector.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sortedSelection"><a class="anchor" href="#sortedSelection"></a><a class="link" href="#sortedSelection">7.6.5. Sorted Selection</a></h4>
<div class="paragraph">
<p>Sorted selection can happen on any Selector in the selector tree, including any <code>MoveSelector</code>, <code>EntitySelector</code> or <code>ValueSelector</code>.
It does not work with <code>cacheType</code> <code>JUST_IN_TIME</code> and it only works with <code>selectionOrder</code> <code>SORTED</code>.</p>
</div>
<div class="paragraph">
<p>It&#8217;s mostly used in construction heuristics.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the chosen construction heuristic implies sorting, for example <code>FIRST_FIT_DECREASING</code> implies that the <code>EntitySelector</code> is sorted, there is no need to explicitly configure a <code>Selector</code> with sorting.
If you do explicitly configure the <code>Selector</code>, it overwrites the default settings of that construction heuristic.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="sortedSelectionBySorterManner"><a class="anchor" href="#sortedSelectionBySorterManner"></a><a class="link" href="#sortedSelectionBySorterManner">7.6.5.1. Sorted Selection by <code>SorterManner</code></a></h5>
<div class="paragraph">
<p>Some <code>Selector</code> types implement a <code>SorterManner</code> out of the box:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>EntitySelector</code> supports:</p>
<div class="ulist">
<ul>
<li>
<p><code>DECREASING_DIFFICULTY</code>: Sorts the planning entities according to decreasing <a href="#planningEntityDifficulty">planning entity difficulty</a>. Requires that planning entity difficulty is annotated on the domain model.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;entitySelector&gt;
      &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;selectionOrder&gt;SORTED&lt;/selectionOrder&gt;
      &lt;sorterManner&gt;DECREASING_DIFFICULTY&lt;/sorterManner&gt;
    &lt;/entitySelector&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><code>ValueSelector</code> supports:</p>
<div class="ulist">
<ul>
<li>
<p><code>INCREASING_STRENGTH</code>: Sorts the planning values according to increasing <a href="#planningValueStrength">planning value strength</a>. Requires that planning value strength is annotated on the domain model.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;valueSelector&gt;
      &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;selectionOrder&gt;SORTED&lt;/selectionOrder&gt;
      &lt;sorterManner&gt;INCREASING_STRENGTH&lt;/sorterManner&gt;
    &lt;/valueSelector&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="sortedSelectionByComparator"><a class="anchor" href="#sortedSelectionByComparator"></a><a class="link" href="#sortedSelectionByComparator">7.6.5.2. Sorted Selection by <code>Comparator</code></a></h5>
<div class="paragraph">
<p>An easy way to sort a <code>Selector</code> is with a plain old <code>Comparator</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class CloudProcessDifficultyComparator implements Comparator&lt;CloudProcess&gt; {

    public int compare(CloudProcess a, CloudProcess b) {
        return new CompareToBuilder()
                .append(a.getRequiredMultiplicand(), b.getRequiredMultiplicand())
                .append(a.getId(), b.getId())
                .toComparison();
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You 'll also need to configure it (unless it&#8217;s annotated on the domain model and automatically applied by the optimization algorithm):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;entitySelector&gt;
      &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;selectionOrder&gt;SORTED&lt;/selectionOrder&gt;
      &lt;sorterComparatorClass&gt;...CloudProcessDifficultyComparator&lt;/sorterComparatorClass&gt;
      &lt;sorterOrder&gt;DESCENDING&lt;/sorterOrder&gt;
    &lt;/entitySelector&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="sortedSelectionBySelectionSorterWeightFactory"><a class="anchor" href="#sortedSelectionBySelectionSorterWeightFactory"></a><a class="link" href="#sortedSelectionBySelectionSorterWeightFactory">7.6.5.3. Sorted Selection by <code>SelectionSorterWeightFactory</code></a></h5>
<div class="paragraph">
<p>If you need the entire <code>Solution</code> to sort a <code>Selector</code>, use a <code>SelectionSorterWeightFactory</code> instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public interface SelectionSorterWeightFactory&lt;Solution_, T&gt; {

    Comparable createSorterWeight(Solution_ solution, T selection);

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class QueenDifficultyWeightFactory implements SelectionSorterWeightFactory&lt;NQueens, Queen&gt; {

    public Comparable createSorterWeight(NQueens nQueens, Queen queen) {
        int distanceFromMiddle = calculateDistanceFromMiddle(nQueens.getN(), queen.getColumnIndex());
        return new QueenDifficultyWeight(queen, distanceFromMiddle);
    }

    ...

    public static class QueenDifficultyWeight implements Comparable&lt;QueenDifficultyWeight&gt; {

        private final Queen queen;
        private final int distanceFromMiddle;

        public QueenDifficultyWeight(Queen queen, int distanceFromMiddle) {
            this.queen = queen;
            this.distanceFromMiddle = distanceFromMiddle;
        }

        public int compareTo(QueenDifficultyWeight other) {
            return new CompareToBuilder()
                    // The more difficult queens have a lower distance to the middle
                    .append(other.distanceFromMiddle, distanceFromMiddle) // Decreasing
                    // Tie breaker
                    .append(queen.getColumnIndex(), other.queen.getColumnIndex())
                    .toComparison();
        }

    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You 'll also need to configure it (unless it&#8217;s annotated on the domain model and automatically applied by the optimization algorithm):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;entitySelector&gt;
      &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;selectionOrder&gt;SORTED&lt;/selectionOrder&gt;
      &lt;sorterWeightFactoryClass&gt;...QueenDifficultyWeightFactory&lt;/sorterWeightFactoryClass&gt;
      &lt;sorterOrder&gt;DESCENDING&lt;/sorterOrder&gt;
    &lt;/entitySelector&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="sortedSelectionBySelectionSorter"><a class="anchor" href="#sortedSelectionBySelectionSorter"></a><a class="link" href="#sortedSelectionBySelectionSorter">7.6.5.4. Sorted Selection by <code>SelectionSorter</code></a></h5>
<div class="paragraph">
<p>Alternatively, you can also use the interface <code>SelectionSorter</code> directly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public interface SelectionSorter&lt;Solution_, T&gt; {

    void sort(ScoreDirector&lt;Solution_&gt; scoreDirector, List&lt;T&gt; selectionList);

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;entitySelector&gt;
      &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;selectionOrder&gt;SORTED&lt;/selectionOrder&gt;
      &lt;sorterClass&gt;...MyEntitySorter&lt;/sorterClass&gt;
    &lt;/entitySelector&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="probabilisticSelection"><a class="anchor" href="#probabilisticSelection"></a><a class="link" href="#probabilisticSelection">7.6.6. Probabilistic Selection</a></h4>
<div class="paragraph">
<p>Probabilistic selection can happen on any Selector in the selector tree, including any <code>MoveSelector</code>, <code>EntitySelector</code> or <code>ValueSelector</code>.
It does not work with <code>cacheType</code> <code>JUST_IN_TIME</code> and it only works with <code>selectionOrder</code> <code>PROBABILISTIC</code>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./MoveAndNeighborhoodSelection/probabilisticSelection.png" alt="probabilisticSelection">
</div>
</div>
<div class="paragraph">
<p>Each selection has a <code>probabilityWeight</code>, which determines the chance that selection will be selected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public interface SelectionProbabilityWeightFactory&lt;Solution_, T&gt; {

    double createProbabilityWeight(ScoreDirector&lt;Solution_&gt; scoreDirector, T selection);

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;entitySelector&gt;
      &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;selectionOrder&gt;PROBABILISTIC&lt;/selectionOrder&gt;
      &lt;probabilityWeightFactoryClass&gt;...MyEntityProbabilityWeightFactoryClass&lt;/probabilityWeightFactoryClass&gt;
    &lt;/entitySelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, if there are three entities: process A (probabilityWeight 2.0), process B (probabilityWeight 0.5) and process C (probabilityWeight 0.5), then process A will be selected four times more than B and C.</p>
</div>
</div>
<div class="sect3">
<h4 id="limitedSelection"><a class="anchor" href="#limitedSelection"></a><a class="link" href="#limitedSelection">7.6.7. Limited Selection</a></h4>
<div class="paragraph">
<p>Selecting all possible moves sometimes does not scale well enough, especially for construction heuristics (which don&#8217;t support <a href="#acceptedCountLimit">acceptedCountLimit</a>).</p>
</div>
<div class="paragraph">
<p>To limit the number of selected selection per step, apply a <code>selectedCountLimit</code> on the selector:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;changeMoveSelector&gt;
      &lt;selectedCountLimit&gt;100&lt;/selectedCountLimit&gt;
    &lt;/changeMoveSelector&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To scale Local Search, setting <a href="#acceptedCountLimit">acceptedCountLimit</a> is usually better than using <code>selectedCountLimit</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mimicSelection"><a class="anchor" href="#mimicSelection"></a><a class="link" href="#mimicSelection">7.6.8. Mimic Selection (Record/Replay)</a></h4>
<div class="paragraph">
<p>During mimic selection, one normal selector records its selection and one or multiple other special selectors replay that selection.
The recording selector acts as a normal selector and supports all other configuration properties.
A replaying selector mimics the recording selection and support no other configuration properties.</p>
</div>
<div class="paragraph">
<p>The recording selector needs an <code>id</code>.
A replaying selector must reference a recorder&#8217;s id with a <code>mimicSelectorRef</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">      &lt;cartesianProductMoveSelector&gt;
        &lt;changeMoveSelector&gt;
          &lt;entitySelector id="entitySelector"/&gt;
          &lt;valueSelector&gt;
            &lt;variableName&gt;period&lt;/variableName&gt;
          &lt;/valueSelector&gt;
        &lt;/changeMoveSelector&gt;
        &lt;changeMoveSelector&gt;
          &lt;entitySelector mimicSelectorRef="entitySelector"/&gt;
          &lt;valueSelector&gt;
            &lt;variableName&gt;room&lt;/variableName&gt;
          &lt;/valueSelector&gt;
        &lt;/changeMoveSelector&gt;
      &lt;/cartesianProductMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Mimic selection is useful to create <a href="#cartesianProductMoveSelector">a composite move</a> from two moves that affect the same entity.</p>
</div>
</div>
<div class="sect3">
<h4 id="nearbySelection"><a class="anchor" href="#nearbySelection"></a><a class="link" href="#nearbySelection">7.6.9. Nearby Selection</a></h4>
<div class="paragraph">
<p>In some use cases (such as TSP and VRP, but also in non-chained variable cases), changing entities to nearby values or swapping nearby entities can <strong>heavily increase scalability</strong> and improve solution quality.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./MoveAndNeighborhoodSelection/nearbySelectionMotivation.png" alt="nearbySelectionMotivation">
</div>
</div>
<div class="paragraph">
<p>Nearby selection increases the probability of selecting an entity or value which is nearby to the first entity being moved in that move.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./MoveAndNeighborhoodSelection/nearbySelectionRandomDistribution.png" alt="nearbySelectionRandomDistribution">
</div>
</div>
<div class="paragraph">
<p>The distance between two entities or values is domain specific.
Therefore, implement the <code>NearbyDistanceMeter</code> interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public interface NearbyDistanceMeter&lt;O, D&gt; {

    double getNearbyDistance(O origin, D destination);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It returns a <code>double</code> which represents the distance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class CustomerNearbyDistanceMeter implements NearbyDistanceMeter&lt;Customer, Standstill&gt; {

    public double getNearbyDistance(Customer origin, Standstill destination) {
        return origin.getDistanceTo(destination);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To configure nearby selection, add a <code>nearbySelection</code> element in the <code>entitySelector</code> or <code>valueSelector</code>
and use <a href="#mimicSelection">mimic selection</a> to specify which entity should be near by the selection.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;unionMoveSelector&gt;
      &lt;changeMoveSelector&gt;
        &lt;entitySelector id="entitySelector1"/&gt;
        &lt;valueSelector&gt;
          &lt;nearbySelection&gt;
            &lt;originEntitySelector mimicSelectorRef="entitySelector1"/&gt;
            &lt;nearbyDistanceMeterClass&gt;...CustomerNearbyDistanceMeter&lt;/nearbyDistanceMeterClass&gt;
            &lt;parabolicDistributionSizeMaximum&gt;40&lt;/parabolicDistributionSizeMaximum&gt;
          &lt;/nearbySelection&gt;
        &lt;/valueSelector&gt;
      &lt;/changeMoveSelector&gt;
      &lt;swapMoveSelector&gt;
        &lt;entitySelector id="entitySelector2"/&gt;
        &lt;secondaryEntitySelector&gt;
          &lt;nearbySelection&gt;
            &lt;originEntitySelector mimicSelectorRef="entitySelector2"/&gt;
            &lt;nearbyDistanceMeterClass&gt;...CustomerNearbyDistanceMeter&lt;/nearbyDistanceMeterClass&gt;
            &lt;parabolicDistributionSizeMaximum&gt;40&lt;/parabolicDistributionSizeMaximum&gt;
          &lt;/nearbySelection&gt;
        &lt;/secondaryEntitySelector&gt;
      &lt;/swapMoveSelector&gt;
      &lt;tailChainSwapMoveSelector&gt;
        &lt;entitySelector id="entitySelector3"/&gt;
        &lt;valueSelector&gt;
          &lt;nearbySelection&gt;
            &lt;originEntitySelector mimicSelectorRef="entitySelector3"/&gt;
            &lt;nearbyDistanceMeterClass&gt;...CustomerNearbyDistanceMeter&lt;/nearbyDistanceMeterClass&gt;
            &lt;parabolicDistributionSizeMaximum&gt;40&lt;/parabolicDistributionSizeMaximum&gt;
          &lt;/nearbySelection&gt;
        &lt;/valueSelector&gt;
      &lt;/tailChainSwapMoveSelector&gt;
    &lt;/unionMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>distributionSizeMaximum</code> parameter should not be 1 because if the nearest is already the planning value of the current entity, then the only move that is selectable is not doable.</p>
</div>
<div class="paragraph">
<p>To allow every element to be selected, regardless of the number of entities, only set the distribution type (so without a <code>distributionSizeMaximum</code> parameter):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;nearbySelection&gt;
    &lt;nearbySelectionDistributionType&gt;PARABOLIC_DISTRIBUTION&lt;/nearbySelectionDistributionType&gt;
  &lt;/nearbySelection&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following <code>NearbySelectionDistributionType</code>s are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>BLOCK_DISTRIBUTION</code>: Only the n nearest are selected, with an equal probability. For example, select the 20 nearest:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;nearbySelection&gt;
    &lt;blockDistributionSizeMaximum&gt;20&lt;/blockDistributionSizeMaximum&gt;
  &lt;/nearbySelection&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><code>LINEAR_DISTRIBUTION</code>: Nearest elements are selected with a higher probability. The probability decreases linearly.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;nearbySelection&gt;
    &lt;linearDistributionSizeMaximum&gt;40&lt;/linearDistributionSizeMaximum&gt;
  &lt;/nearbySelection&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><code>PARABOLIC_DISTRIBUTION</code> (recommended): Nearest elements are selected with a higher probability.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;nearbySelection&gt;
    &lt;parabolicDistributionSizeMaximum&gt;80&lt;/parabolicDistributionSizeMaximum&gt;
  &lt;/nearbySelection&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><code>BETA_DISTRIBUTION</code>: Selection according to a beta distribution. Slows down the solver significantly.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;nearbySelection&gt;
    &lt;betaDistributionAlpha&gt;1&lt;/betaDistributionAlpha&gt;
    &lt;betaDistributionBeta&gt;5&lt;/betaDistributionBeta&gt;
  &lt;/nearbySelection&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>As always, use the <a href="#benchmarker">Benchmarker</a> to tweak values if desired.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="customMoves"><a class="anchor" href="#customMoves"></a><a class="link" href="#customMoves">7.7. Custom Moves</a></h3>
<div class="sect3">
<h4 id="whichMoveTypesMightBeMissing"><a class="anchor" href="#whichMoveTypesMightBeMissing"></a><a class="link" href="#whichMoveTypesMightBeMissing">7.7.1. Which Move Types Might be Missing in my Implementation?</a></h4>
<div class="paragraph">
<p>To determine which move types might be missing in your implementation, run a <a href="#benchmarker">Benchmarker</a><em>for a short amount of time</em> and <a href="#writeTheOutputSolutionOfBenchmarkRuns">configure it to write the best solutions to disk</a>.
Take a look at such a best solution: it will likely be a local optima.
Try to figure out if there&#8217;s a move that could get out of that local optima faster.</p>
</div>
<div class="paragraph">
<p>If you find one, implement that coarse-grained move, mix it with the existing moves and benchmark it against the previous configurations to see if you want to keep it.</p>
</div>
</div>
<div class="sect3">
<h4 id="customMovesIntroduction"><a class="anchor" href="#customMovesIntroduction"></a><a class="link" href="#customMovesIntroduction">7.7.2. Custom Moves Introduction</a></h4>
<div class="paragraph">
<p>Instead of using the generic <code>Move</code>s (such as <code>ChangeMove</code>) you can also implement your own <code>Move</code>.
Generic and custom <code>MoveSelector</code>s can be <a href="#combiningMultipleMoveSelectors">combined</a> as desired.</p>
</div>
<div class="paragraph">
<p>A custom <code>Move</code> can be tailored to work to the advantage of your constraints.
For example in examination scheduling, changing the period of an exam A
would also change the period of all the other exams that need to coincide with exam A.</p>
</div>
<div class="paragraph">
<p>A custom <code>Move</code> is also slightly faster than a generic <code>Move</code>.
However, it&#8217;s far more work to implement and much harder to avoid bugs.
After implementing a custom <code>Move</code>, turn on <code>environmentMode</code> <code>FULL_ASSERT</code> to check for score corruptions.</p>
</div>
</div>
<div class="sect3">
<h4 id="theInterfaceMove"><a class="anchor" href="#theInterfaceMove"></a><a class="link" href="#theInterfaceMove">7.7.3. The Interface <code>Move</code></a></h4>
<div class="paragraph">
<p>All moves implements the <code>Move</code> interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public interface Move&lt;Solution_&gt; {

    boolean isMoveDoable(ScoreDirector&lt;Solution_&gt; scoreDirector);
    Move&lt;Solution_&gt; doMove(ScoreDirector&lt;Solution_&gt; scoreDirector);

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To implement a custom move, it&#8217;s recommend to extend <code>AbstractMove</code> instead implementing <code>Move</code> directly.
Planner calls <code>AbstractMove.doMove(ScoreDirector)</code>, which calls <code>doMoveOnGenuineVariables(ScoreDirector)</code>.
For example in cloud balancing, this move changes one process to another computer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class CloudComputerChangeMove extends AbstractMove&lt;CloudBalance&gt; {

    private CloudProcess cloudProcess;
    private CloudComputer toCloudComputer;

    public CloudComputerChangeMove(CloudProcess cloudProcess, CloudComputer toCloudComputer) {
        this.cloudProcess = cloudProcess;
        this.toCloudComputer = toCloudComputer;
    }

    @Override
    protected void doMoveOnGenuineVariables(ScoreDirector&lt;CloudBalance&gt; scoreDirector) {
        scoreDirector.beforeVariableChanged(cloudProcess, "computer");
        cloudProcess.setComputer(toCloudComputer);
        scoreDirector.afterVariableChanged(cloudProcess, "computer");
    }

    // ...

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation must notify the <code>ScoreDirector</code> of any changes it makes to planning entity&#8217;s variables:
Call the <code>scoreDirector.beforeVariableChanged(Object, String)</code> and <code>scoreDirector.afterVariableChanged(Object, String)</code>
methods directly before and after modifying an entity&#8217;s planning variable.</p>
</div>
<div class="paragraph">
<p>The example move above is a fine-grained move because changes only one planning variable.
On the other hand, a coarse-grained move changes multiple entities or multiple planning variables
in a single move, usually to avoid breaking hard constraints by making multiple related changes at once.
For example, a swap move is really just two change moves, but it keeps those two changes together.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A <code>Move</code> can only change/add/remove planning entities,
it must not change any of the problem facts as that will cause score corruption.
Use <a href="#realTimePlanning">real-time planning</a> to change problem facts while solving.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Planner automatically filters out <em>non doable moves</em> by calling the <code>isMoveDoable(ScoreDirector)</code> method on each selected move.
A <em>non doable move</em> is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A move that changes nothing on the current solution.
For example, moving process <code>P1</code> on computer <code>X</code> to computer <code>X</code> is not doable, because it is already there.</p>
</li>
<li>
<p>A move that is impossible to do on the current solution.
For example, moving process <code>P1</code> to computer <code>Q</code>  (when <code>Q</code> isn&#8217;t in the list of computers) is not doable
because it would assign a planning value that&#8217;s not inside the planning variable&#8217;s value range.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the cloud balancing example, a move which assigns a process to the computer it&#8217;s already assigned to is not doable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    @Override
    public boolean isMoveDoable(ScoreDirector&lt;CloudBalance&gt; scoreDirector) {
        return !Objects.equals(cloudProcess.getComputer(), toCloudComputer);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>We don&#8217;t need to check if <code>toCloudComputer</code> is in the value range,
because we only generates moves for which that is the case.
A move that is currently not doable can become doable when the working <code>Solution</code> changes in a later step,
otherwise we probably shouldn&#8217;t have created it in the first place.</p>
</div>
<div class="paragraph">
<p>Each move has an <em>undo move</em>: a move (normally of the same type) which does the exact opposite.
In the cloud balancing example the undo move of <code>P1 {X &#8594; Y}</code> is the move <code>P1 {Y &#8594; X}</code>.
The undo move of a move is created when the <code>Move</code> is being done on the current solution,
before the genuine variables change:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    @Override
    public CloudComputerChangeMove createUndoMove(ScoreDirector&lt;CloudBalance&gt; scoreDirector) {
        return new CloudComputerChangeMove(cloudProcess, cloudProcess.getComputer());
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that if <code>P1</code> would have already been moved to <code>Y</code>, the undo move would create the move <code>P1 {Y &#8594; Y}</code>,
instead of the move <code>P1 {Y &#8594; X}</code>.</p>
</div>
<div class="paragraph">
<p>A solver phase might do and undo the same <code>Move</code> more than once.
In fact, many solver phases will iteratively do and undo a number of moves to evaluate them,
before selecting one of those and doing that move again (without undoing it the last time).</p>
</div>
<div class="paragraph">
<p>A <code>Move</code> must also implement the <code>getPlanningEntities()</code> and <code>getPlanningValues()</code> methods.
Those are used by <a href="#tabuSearch">entity tabu and value tabu</a> respectively.
They are called after the <code>Move</code> has already been done.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    @Override
    public Collection&lt;? extends Object&gt; getPlanningEntities() {
        return Collections.singletonList(cloudProcess);
    }

    @Override
    public Collection&lt;? extends Object&gt; getPlanningValues() {
        return Collections.singletonList(toCloudComputer);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the <code>Move</code> changes multiple planning entities, such as in a swap move,
return all of them in <code>getPlanningEntities()</code>
and return all their values (to which they are changing) in <code>getPlanningValues()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    @Override
    public Collection&lt;? extends Object&gt; getPlanningEntities() {
        return Arrays.asList(leftCloudProcess, rightCloudProcess);
    }

    @Override
    public Collection&lt;? extends Object&gt; getPlanningValues() {
        return Arrays.asList(leftCloudProcess.getComputer(), rightCloudProcess.getComputer());
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>Move</code> must implement the <code>equals()</code> and <code>hashCode()</code> methods for <a href="#tabuSearch">move tabu</a>.
Two moves which make the same change on a solution, should be equal ideally.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    @Override
    public boolean equals(Object o) {
        if (this == o) {
            return true;
        } else if (o instanceof CloudComputerChangeMove) {
            CloudComputerChangeMove other = (CloudComputerChangeMove) o;
            return new EqualsBuilder()
                    .append(cloudProcess, other.cloudProcess)
                    .append(toCloudComputer, other.toCloudComputer)
                    .isEquals();
        } else {
            return false;
        }
    }

    @Override
    public int hashCode() {
        return new HashCodeBuilder()
                .append(cloudProcess)
                .append(toCloudComputer)
                .toHashCode();
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that it checks if the other move is an instance of the same move type.
This <code>instanceof</code> check is important because a move will be compared to a move with another move type
if you have multiple move selectors.</p>
</div>
<div class="paragraph">
<p>Implement the <code>toString()</code> method to keep Planner&#8217;s logs readable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    public String toString() {
        return cloudProcess + " {" + cloudProcess.getComputer() + " -&gt; " + toCloudComputer + "}";
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, let&#8217;s generate instances of this custom <code>Move</code> class.</p>
</div>
</div>
<div class="sect3">
<h4 id="moveListFactory"><a class="anchor" href="#moveListFactory"></a><a class="link" href="#moveListFactory">7.7.4. <code>MoveListFactory</code>: the Easy Way to Generate Custom Moves</a></h4>
<div class="paragraph">
<p>The easiest way to generate custom moves is by implementing the interface <code>MoveListFactory</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public interface MoveListFactory&lt;Solution_&gt; {

    List&lt;Move&gt; createMoveList(Solution_ solution);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class CloudComputerChangeMoveFactory implements MoveListFactory&lt;CloudBalance&gt; {

    @Override
    public List&lt;CloudComputerChangeMove&gt; createMoveList(CloudBalance cloudBalance) {
        List&lt;CloudComputerChangeMove&gt; moveList = new ArrayList&lt;&gt;();
        List&lt;CloudComputer&gt; cloudComputerList = cloudBalance.getComputerList();
        for (CloudProcess cloudProcess : cloudBalance.getProcessList()) {
            for (CloudComputer cloudComputer : cloudComputerList) {
                moveList.add(new CloudComputerChangeMove(cloudProcess, cloudComputer));
            }
        }
        return moveList;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Simple configuration (which can be nested in a <code>unionMoveSelector</code> just like any other <code>MoveSelector</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;moveListFactory&gt;
      &lt;moveListFactoryClass&gt;org.optaplanner.examples.cloudbalancing.optional.move.CloudComputerChangeMoveFactory&lt;/moveListFactoryClass&gt;
    &lt;/moveListFactory&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;moveListFactory&gt;
      ... &lt;!-- Normal moveSelector properties --&gt;
      &lt;moveListFactoryClass&gt;org.optaplanner.examples.cloudbalancing.optional.move.CloudComputerChangeMoveFactory&lt;/moveListFactoryClass&gt;
    &lt;/moveListFactory&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because the <code>MoveListFactory</code> generates all moves at once in a <code>List&lt;Move&gt;</code>,
it does not support <code>cacheType</code> <code>JUST_IN_TIME</code>.
Therefore, <code>moveListFactory</code> uses <code>cacheType</code> <code>STEP</code> by default and it scales badly.</p>
</div>
</div>
<div class="sect3">
<h4 id="moveIteratorFactory"><a class="anchor" href="#moveIteratorFactory"></a><a class="link" href="#moveIteratorFactory">7.7.5. <code>MoveIteratorFactory</code>: Generate Custom Moves Just in Time</a></h4>
<div class="paragraph">
<p>Use this advanced form to generate custom moves Just In Time
by implementing the <code>MoveIteratorFactory</code> interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public interface MoveIteratorFactory&lt;Solution_&gt; {

    long getSize(ScoreDirector&lt;Solution_&gt; scoreDirector);

    Iterator&lt;Move&gt; createOriginalMoveIterator(ScoreDirector&lt;Solution_&gt; scoreDirector);

    Iterator&lt;Move&gt; createRandomMoveIterator(ScoreDirector&lt;Solution_&gt; scoreDirector, Random workingRandom);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>getSize()</code> method must return an estimation of the size.
It doesn&#8217;t need to be correct, but it&#8217;s better too big than too small.
The <code>createOriginalMoveIterator</code> method is called if the <code>selectionOrder</code> is <code>ORIGINAL</code> or if it is cached.
The <code>createRandomMoveIterator</code> method is called for <code>selectionOrder</code> <code>RANDOM</code> combined with cacheType <code>JUST_IN_TIME</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Don&#8217;t create a collection (array, list, set or map) of <code>Move</code>s when creating the <code>Iterator&lt;Move&gt;</code>:
the whole purpose of <code>MoveIteratorFactory</code> over <code>MoveListFactory</code> is to create a <code>Move</code> just in time
in a custom <code>Iterator.next()</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Simple configuration (which can be nested in a <code>unionMoveSelector</code> just like any other <code>MoveSelector</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;moveIteratorFactory&gt;
      &lt;moveIteratorFactoryClass&gt;...&lt;/moveIteratorFactoryClass&gt;
    &lt;/moveIteratorFactory&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;moveIteratorFactory&gt;
      ... &lt;!-- Normal moveSelector properties --&gt;
      &lt;moveIteratorFactoryClass&gt;...&lt;/moveIteratorFactoryClass&gt;
    &lt;/moveIteratorFactory&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="exhaustiveSearch"><a class="anchor" href="#exhaustiveSearch"></a><a class="link" href="#exhaustiveSearch">8. Exhaustive Search</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="exhaustiveSearchOverview"><a class="anchor" href="#exhaustiveSearchOverview"></a><a class="link" href="#exhaustiveSearchOverview">8.1. Overview</a></h3>
<div class="paragraph">
<p>Exhaustive Search will always find the global optimum and recognize it too.
That being said, it doesn&#8217;t scale (not even beyond toy data sets) and is therefore mostly useless.</p>
</div>
</div>
<div class="sect2">
<h3 id="bruteForce"><a class="anchor" href="#bruteForce"></a><a class="link" href="#bruteForce">8.2. Brute Force</a></h3>
<div class="sect3">
<h4 id="bruteForceAlgorithm"><a class="anchor" href="#bruteForceAlgorithm"></a><a class="link" href="#bruteForceAlgorithm">8.2.1. Algorithm Description</a></h4>
<div class="paragraph">
<p>The Brute Force algorithm creates and evaluates every possible solution.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./ExhaustiveSearch/bruteForceNQueens04.png" alt="bruteForceNQueens04">
</div>
</div>
<div class="paragraph">
<p>Notice that it creates a search tree that explodes exponentially as the problem size increases, so it hits a scalability wall.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Brute Force is mostly unusable for a real-world problem due to time limitations</strong>,
as shown in <a href="#scalabilityOfExhaustiveSearch">scalability of Exhaustive  Search</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="bruteForceConfiguration"><a class="anchor" href="#bruteForceConfiguration"></a><a class="link" href="#bruteForceConfiguration">8.2.2. Configuration</a></h4>
<div class="paragraph">
<p>Simplest configuration of Brute Force:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;solver&gt;
  ...
  &lt;exhaustiveSearch&gt;
    &lt;exhaustiveSearchType&gt;BRUTE_FORCE&lt;/exhaustiveSearchType&gt;
  &lt;/exhaustiveSearch&gt;
&lt;/solver&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="branchAndBound"><a class="anchor" href="#branchAndBound"></a><a class="link" href="#branchAndBound">8.3. Branch And Bound</a></h3>
<div class="sect3">
<h4 id="branchAndBoundAlgorithm"><a class="anchor" href="#branchAndBoundAlgorithm"></a><a class="link" href="#branchAndBoundAlgorithm">8.3.1. Algorithm Description</a></h4>
<div class="paragraph">
<p>Branch And Bound also explores nodes in an exponential search tree, but it investigates more promising nodes first and prunes away worthless nodes.</p>
</div>
<div class="paragraph">
<p>For each node, Branch And Bound calculates the optimistic bound: the best possible score to which that node can lead to.
If the optimistic bound of a node is lower or equal to the global pessimistic bound, then it prunes away that node (including the entire branch of all its subnodes).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Academic papers use the term lower bound instead of optimistic bound (and the term upper bound instead of pessimistic bound), because they minimize the score.</p>
</div>
<div class="paragraph">
<p>Planner maximizes the score (because it supports combining negative and positive constraints). Therefore, for clarity, it uses different terms, as it would be confusing to use the term lower bound for a bound which is always higher.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example: at index 14, it sets the global pessimistic bound to <code>-2</code>.
Because all solutions reachable from the node visited at index 11 will have a score lower or equal to <code>-2</code> (the node&#8217;s optimistic bound), they can be pruned away.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./ExhaustiveSearch/depthFirstBranchAndBoundNQueens04.png" alt="depthFirstBranchAndBoundNQueens04">
</div>
</div>
<div class="paragraph">
<p>Notice that Branch And Bound (much like <a href="#bruteForce">Brute Force</a>) creates a search tree that explodes exponentially as the problem size increases.
So it hits the same scalability wall, only a little bit later.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Branch And Bound is mostly unusable for a real-world problem due to time limitations</strong>,
as shown in <a href="#scalabilityOfExhaustiveSearch">scalability of Exhaustive Search</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="branchAndBoundConfiguration"><a class="anchor" href="#branchAndBoundConfiguration"></a><a class="link" href="#branchAndBoundConfiguration">8.3.2. Configuration</a></h4>
<div class="paragraph">
<p>Simplest configuration of Branch And Bound:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;solver&gt;
  ...
  &lt;exhaustiveSearch&gt;
    &lt;exhaustiveSearchType&gt;BRANCH_AND_BOUND&lt;/exhaustiveSearchType&gt;
  &lt;/exhaustiveSearch&gt;
&lt;/solver&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For the pruning to work with the default <code>ScoreBounder</code>, the <a href="#initializingScoreTrend">InitializingScoreTrend</a> should be set.
Especially an <a href="#initializingScoreTrend">InitializingScoreTrend</a> of <code>ONLY_DOWN</code> (or at least has <code>ONLY_DOWN</code> in the leading score levels) prunes a lot.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;exhaustiveSearch&gt;
    &lt;exhaustiveSearchType&gt;BRANCH_AND_BOUND&lt;/exhaustiveSearchType&gt;
    &lt;nodeExplorationType&gt;DEPTH_FIRST&lt;/nodeExplorationType&gt;
    &lt;entitySorterManner&gt;DECREASING_DIFFICULTY_IF_AVAILABLE&lt;/entitySorterManner&gt;
    &lt;valueSorterManner&gt;INCREASING_STRENGTH_IF_AVAILABLE&lt;/valueSorterManner&gt;
  &lt;/exhaustiveSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>nodeExplorationType</code> options are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>DEPTH_FIRST</code> (default): Explore deeper nodes first (and then a better score and then a better optimistic bound). Deeper nodes (especially leaf nodes) often improve the pessimistic bound. A better pessimistic bound allows pruning more nodes to reduce the search space.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;exhaustiveSearch&gt;
    &lt;exhaustiveSearchType&gt;BRANCH_AND_BOUND&lt;/exhaustiveSearchType&gt;
    &lt;nodeExplorationType&gt;DEPTH_FIRST&lt;/nodeExplorationType&gt;
  &lt;/exhaustiveSearch&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><code>BREADTH_FIRST</code> (not recommended): Explore nodes layer by layer (and then a better score and then a better optimistic bound). Scales terribly in memory (and usually in performance too).</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;exhaustiveSearch&gt;
    &lt;exhaustiveSearchType&gt;BRANCH_AND_BOUND&lt;/exhaustiveSearchType&gt;
    &lt;nodeExplorationType&gt;BREADTH_FIRST&lt;/nodeExplorationType&gt;
  &lt;/exhaustiveSearch&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><code>SCORE_FIRST</code>: Explore nodes with a better score first (and then a better optimistic bound and then deeper nodes first). Might scale as terribly as <code>BREADTH_FIRST</code> in some cases.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;exhaustiveSearch&gt;
    &lt;exhaustiveSearchType&gt;BRANCH_AND_BOUND&lt;/exhaustiveSearchType&gt;
    &lt;nodeExplorationType&gt;SCORE_FIRST&lt;/nodeExplorationType&gt;
  &lt;/exhaustiveSearch&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><code>OPTIMISTIC_BOUND_FIRST</code>: Explore nodes with a better optimistic bound first (and then a better score and then deeper nodes first). Might scale as terribly as <code>BREADTH_FIRST</code> in some cases.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;exhaustiveSearch&gt;
    &lt;exhaustiveSearchType&gt;BRANCH_AND_BOUND&lt;/exhaustiveSearchType&gt;
    &lt;nodeExplorationType&gt;OPTIMISTIC_BOUND_FIRST&lt;/nodeExplorationType&gt;
  &lt;/exhaustiveSearch&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>entitySorterManner</code> options are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>DECREASING_DIFFICULTY</code>: Initialize the more difficult planning entities first. This usually increases pruning (and therefore improves scalability).
Requires the model to support <a href="#planningEntityDifficulty">planning entity difficulty comparison</a>.</p>
</li>
<li>
<p><code>DECREASING_DIFFICULTY_IF_AVAILABLE</code> (default): If the model supports <a href="#planningEntityDifficulty">planning entity difficulty comparison</a>, behave like <code>DECREASING_DIFFICULTY</code>, else like <code>NONE</code>.</p>
</li>
<li>
<p><code>NONE</code>: Initialize the planning entities in original order.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>valueSorterManner</code> options are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>INCREASING_STRENGTH</code>: Evaluate the planning values in increasing strength. Requires the model to support <a href="#planningValueStrength">planning value strength comparison</a>.</p>
</li>
<li>
<p><code>INCREASING_STRENGTH_IF_AVAILABLE</code> (default): If the model supports <a href="#planningValueStrength">planning value strength comparison</a>, behave like <code>INCREASING_STRENGTH</code>, else like <code>NONE</code>.</p>
</li>
<li>
<p><code>DECREASING_STRENGTH</code>: Evaluate the planning values in decreasing strength. Requires the model to support <a href="#planningValueStrength">planning value strength comparison</a>.</p>
</li>
<li>
<p><code>DECREASING_STRENGTH_IF_AVAILABLE</code>: If the model supports <a href="#planningValueStrength">planning value strength comparison</a>, behave like <code>DECREASING_STRENGTH</code>, else like <code>NONE</code>.</p>
</li>
<li>
<p><code>NONE</code>: Try the planning values in original order.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="scalabilityOfExhaustiveSearch"><a class="anchor" href="#scalabilityOfExhaustiveSearch"></a><a class="link" href="#scalabilityOfExhaustiveSearch">8.4. Scalability of Exhaustive Search</a></h3>
<div class="paragraph">
<p>Exhaustive Search variants suffer from two big scalability issues:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>They scale terribly memory wise.</p>
</li>
<li>
<p>They scale horribly performance wise.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As shown in these time spent graphs from the <a href="#benchmarker">Benchmarker</a>, Brute Force and Branch And Bound both hit a performance scalability wall.
For example, on N queens it hits wall at a few dozen queens:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./ExhaustiveSearch/exhaustiveSearchScalabilityNQueens.png" alt="exhaustiveSearchScalabilityNQueens">
</div>
</div>
<div class="paragraph">
<p>In most use cases, such as Cloud Balancing, the wall appears out of thin air:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./ExhaustiveSearch/exhaustiveSearchScalabilityCloudBalance.png" alt="exhaustiveSearchScalabilityCloudBalance">
</div>
</div>
<div class="paragraph">
<p><strong>Exhaustive Search hits this wall on small datasets already, so in production these optimizations algorithms are mostly useless.</strong> Use Construction Heuristics with Local Search instead: those can handle thousands of queens/computers easily.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Throwing hardware at these scalability issues has no noticeable impact.
Newer and more hardware are just a drop in the ocean.
Moore&#8217;s law cannot win against the onslaught of a few more planning entities in the dataset.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="constructionHeuristics"><a class="anchor" href="#constructionHeuristics"></a><a class="link" href="#constructionHeuristics">9. Construction Heuristics</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="constructionHeuristicsOverview"><a class="anchor" href="#constructionHeuristicsOverview"></a><a class="link" href="#constructionHeuristicsOverview">9.1. Overview</a></h3>
<div class="paragraph">
<p>A construction heuristic builds a pretty good initial solution in a finite length of time.
Its solution isn&#8217;t always feasible, but it finds it fast so metaheuristics can finish the job.</p>
</div>
<div class="paragraph">
<p>Construction heuristics terminate automatically, so there&#8217;s usually no need to configure a <code>Termination</code> on the construction heuristic phase specifically.</p>
</div>
</div>
<div class="sect2">
<h3 id="firstFit"><a class="anchor" href="#firstFit"></a><a class="link" href="#firstFit">9.2. First Fit</a></h3>
<div class="sect3">
<h4 id="firstFitAlgorithm"><a class="anchor" href="#firstFitAlgorithm"></a><a class="link" href="#firstFitAlgorithm">9.2.1. Algorithm Description</a></h4>
<div class="paragraph">
<p>The First Fit algorithm cycles through all the planning entities (in default order), initializing one planning entity at a time.
It assigns the planning entity to the best available planning value, taking the already initialized planning entities into account.
It terminates when all planning entities have been initialized.
It never changes a planning entity after it has been assigned.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./ConstructionHeuristics/firstFitNQueens04.png" alt="firstFitNQueens04">
</div>
</div>
<div class="paragraph">
<p>Notice that it starts with putting <code>Queen</code> A into row 0 (and never moving it later), which makes it impossible to reach the optimal solution.
Suffixing this construction heuristic with metaheuristics can remedy that.</p>
</div>
</div>
<div class="sect3">
<h4 id="firstFitConfiguration"><a class="anchor" href="#firstFitConfiguration"></a><a class="link" href="#firstFitConfiguration">9.2.2. Configuration</a></h4>
<div class="paragraph">
<p>Configure this solver phase:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;FIRST_FIT&lt;/constructionHeuristicType&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the <a href="#initializingScoreTrend">InitializingScoreTrend</a> is <code>ONLY_DOWN</code>, this algorithm is faster: for an entity, it picks the first move for which the score does not deteriorate the last step score, ignoring all subsequent moves.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For advanced configuration, see <a href="#allocateEntityFromQueue">Allocate Entity From Queue</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="firstFitDecreasing"><a class="anchor" href="#firstFitDecreasing"></a><a class="link" href="#firstFitDecreasing">9.3. First Fit Decreasing</a></h3>
<div class="sect3">
<h4 id="firstFitDecreasingAlgorithm"><a class="anchor" href="#firstFitDecreasingAlgorithm"></a><a class="link" href="#firstFitDecreasingAlgorithm">9.3.1. Algorithm Description</a></h4>
<div class="paragraph">
<p>Like First Fit, but assigns the more difficult planning entities first, because they are less likely to fit in the leftovers.
So it sorts the planning entities on decreasing difficulty.</p>
</div>
<div class="paragraph">
<p>Requires the model to support <a href="#planningEntityDifficulty">planning entity difficulty comparison</a>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./ConstructionHeuristics/firstFitDecreasingNQueens04.png" alt="firstFitDecreasingNQueens04">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>One would expect that this algorithm has better results than First Fit.
That&#8217;s usually the case, but not always.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="firstFitDecreasingConfiguration"><a class="anchor" href="#firstFitDecreasingConfiguration"></a><a class="link" href="#firstFitDecreasingConfiguration">9.3.2. Configuration</a></h4>
<div class="paragraph">
<p>Configure this solver phase:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;FIRST_FIT_DECREASING&lt;/constructionHeuristicType&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the <a href="#initializingScoreTrend">InitializingScoreTrend</a> is <code>ONLY_DOWN</code>, this algorithm is faster: for an entity, it picks the first move for which the score does not deteriorate the last step score, ignoring all subsequent moves.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For advanced configuration, see <a href="#allocateEntityFromQueue">Allocate Entity From Queue</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="weakestFit"><a class="anchor" href="#weakestFit"></a><a class="link" href="#weakestFit">9.4. Weakest Fit</a></h3>
<div class="sect3">
<h4 id="weakestFitAlgorithm"><a class="anchor" href="#weakestFitAlgorithm"></a><a class="link" href="#weakestFitAlgorithm">9.4.1. Algorithm Description</a></h4>
<div class="paragraph">
<p>Like First Fit, but uses the weaker planning values first, because the strong planning values are more likely to be able to accommodate later planning entities.
So it sorts the planning values on increasing strength.</p>
</div>
<div class="paragraph">
<p>Requires the model to support <a href="#planningValueStrength">planning value strength comparison</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not presume that this algorithm has better results than First Fit.
That&#8217;s often not the case.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="weakestFitConfiguration"><a class="anchor" href="#weakestFitConfiguration"></a><a class="link" href="#weakestFitConfiguration">9.4.2. Configuration</a></h4>
<div class="paragraph">
<p>Configure this solver phase:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;WEAKEST_FIT&lt;/constructionHeuristicType&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the <a href="#initializingScoreTrend">InitializingScoreTrend</a> is <code>ONLY_DOWN</code>, this algorithm is faster: for an entity, it picks the first move for which the score does not deteriorate the last step score, ignoring all subsequent moves.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For advanced configuration, see <a href="#allocateEntityFromQueue">Allocate Entity From Queue</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="weakestFitDecreasing"><a class="anchor" href="#weakestFitDecreasing"></a><a class="link" href="#weakestFitDecreasing">9.5. Weakest Fit Decreasing</a></h3>
<div class="sect3">
<h4 id="weakestFitDecreasingAlgorithm"><a class="anchor" href="#weakestFitDecreasingAlgorithm"></a><a class="link" href="#weakestFitDecreasingAlgorithm">9.5.1. Algorithm Description</a></h4>
<div class="paragraph">
<p>Combines First Fit Decreasing and Weakest Fit.
So it sorts the planning entities on decreasing difficulty and the planning values on increasing strength.</p>
</div>
<div class="paragraph">
<p>Requires the model to support <a href="#planningEntityDifficulty">planning entity difficulty comparison</a>
and <a href="#planningValueStrength">planning value strength comparison</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not presume that this algorithm has better results than First Fit Decreasing.
That&#8217;s often not the case.
However, it is usually better than Weakest Fit.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="weakestFitDecreasingConfiguration"><a class="anchor" href="#weakestFitDecreasingConfiguration"></a><a class="link" href="#weakestFitDecreasingConfiguration">9.5.2. Configuration</a></h4>
<div class="paragraph">
<p>Configure this solver phase:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;WEAKEST_FIT_DECREASING&lt;/constructionHeuristicType&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the <a href="#initializingScoreTrend">InitializingScoreTrend</a> is <code>ONLY_DOWN</code>, this algorithm is faster: for an entity, it picks the first move for which the score does not deteriorate the last step score, ignoring all subsequent moves.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For advanced configuration, see <a href="#allocateEntityFromQueue">Allocate Entity From Queue</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="strongestFit"><a class="anchor" href="#strongestFit"></a><a class="link" href="#strongestFit">9.6. Strongest Fit</a></h3>
<div class="sect3">
<h4 id="strongestFitAlgorithm"><a class="anchor" href="#strongestFitAlgorithm"></a><a class="link" href="#strongestFitAlgorithm">9.6.1. Algorithm Description</a></h4>
<div class="paragraph">
<p>Like First Fit, but uses the strong planning values first, because the strong planning values are more likely to have a lower soft cost to use.
So it sorts the planning values on decreasing strength.</p>
</div>
<div class="paragraph">
<p>Requires the model to support <a href="#planningValueStrength">planning value strength comparison</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not presume that this algorithm has better results than First Fit or Weakest Fit.
That&#8217;s often not the case.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="strongestFitConfiguration"><a class="anchor" href="#strongestFitConfiguration"></a><a class="link" href="#strongestFitConfiguration">9.6.2. Configuration</a></h4>
<div class="paragraph">
<p>Configure this solver phase:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;STRONGEST_FIT&lt;/constructionHeuristicType&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the <a href="#initializingScoreTrend">InitializingScoreTrend</a> is <code>ONLY_DOWN</code>, this algorithm is faster: for an entity, it picks the first move for which the score does not deteriorate the last step score, ignoring all subsequent moves.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For advanced configuration, see <a href="#allocateEntityFromQueue">Allocate Entity From Queue</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="strongestFitDecreasing"><a class="anchor" href="#strongestFitDecreasing"></a><a class="link" href="#strongestFitDecreasing">9.7. Strongest Fit Decreasing</a></h3>
<div class="sect3">
<h4 id="strongestFitDecreasingAlgorithm"><a class="anchor" href="#strongestFitDecreasingAlgorithm"></a><a class="link" href="#strongestFitDecreasingAlgorithm">9.7.1. Algorithm Description</a></h4>
<div class="paragraph">
<p>Combines First Fit Decreasing and Strongest Fit.
So it sorts the planning entities on decreasing difficulty and the planning values on decreasing strength.</p>
</div>
<div class="paragraph">
<p>Requires the model to support <a href="#planningEntityDifficulty">planning entity difficulty comparison</a>
and <a href="#planningValueStrength">planning value strength comparison</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not presume that this algorithm has better results than First Fit Decreasing or Weakest Fit Decreasing.
That&#8217;s often not the case.
However, it is usually better than Strongest Fit.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="strongestFitDecreasingConfiguration"><a class="anchor" href="#strongestFitDecreasingConfiguration"></a><a class="link" href="#strongestFitDecreasingConfiguration">9.7.2. Configuration</a></h4>
<div class="paragraph">
<p>Configure this solver phase:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;STRONGEST_FIT_DECREASING&lt;/constructionHeuristicType&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the <a href="#initializingScoreTrend">InitializingScoreTrend</a> is <code>ONLY_DOWN</code>, this algorithm is faster: for an entity, it picks the first move for which the score does not deteriorate the last step score, ignoring all subsequent moves.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For advanced configuration, see <a href="#allocateEntityFromQueue">Allocate Entity From Queue</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="allocateEntityFromQueue"><a class="anchor" href="#allocateEntityFromQueue"></a><a class="link" href="#allocateEntityFromQueue">9.8. Allocate Entity From Queue</a></h3>
<div class="sect3">
<h4 id="allocateEntityFromQueueAlgorithm"><a class="anchor" href="#allocateEntityFromQueueAlgorithm"></a><a class="link" href="#allocateEntityFromQueueAlgorithm">9.8.1. Algorithm Description</a></h4>
<div class="paragraph">
<p>Allocate Entity From Queue is a versatile, generic form of <a href="#firstFit">First Fit</a>, <a href="#firstFitDecreasing">First Fit Decreasing</a>, <a href="#weakestFit">Weakest Fit</a> and <a href="#weakestFitDecreasing">Weakest Fit Decreasing</a>.
It works like this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Put all entities in a queue.</p>
</li>
<li>
<p>Assign the first entity (from that queue) to the best value.</p>
</li>
<li>
<p>Repeat until all entities are assigned.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="allocateEntityFromQueueConfiguration"><a class="anchor" href="#allocateEntityFromQueueConfiguration"></a><a class="link" href="#allocateEntityFromQueueConfiguration">9.8.2. Configuration</a></h4>
<div class="paragraph">
<p>Simple configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;ALLOCATE_ENTITY_FROM_QUEUE&lt;/constructionHeuristicType&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verbose simple configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;ALLOCATE_ENTITY_FROM_QUEUE&lt;/constructionHeuristicType&gt;
    &lt;entitySorterManner&gt;DECREASING_DIFFICULTY_IF_AVAILABLE&lt;/entitySorterManner&gt;
    &lt;valueSorterManner&gt;INCREASING_STRENGTH_IF_AVAILABLE&lt;/valueSorterManner&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>entitySorterManner</code> options are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>DECREASING_DIFFICULTY</code>: Initialize the more difficult planning entities first. This usually increases pruning (and therefore improves scalability). Requires the model to support <a href="#planningEntityDifficulty">planning entity difficulty comparison</a>.</p>
</li>
<li>
<p><code>DECREASING_DIFFICULTY_IF_AVAILABLE</code> (default): If the model supports <a href="#planningEntityDifficulty">planning entity difficulty comparison</a>, behave like <code>DECREASING_DIFFICULTY</code>, else like <code>NONE</code>.</p>
</li>
<li>
<p><code>NONE</code>: Initialize the planning entities in original order.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>valueSorterManner</code> options are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>INCREASING_STRENGTH</code>: Evaluate the planning values in increasing strength. Requires the model to support <a href="#planningValueStrength">planning value strength comparison</a>.</p>
</li>
<li>
<p><code>INCREASING_STRENGTH_IF_AVAILABLE</code> (default): If the model supports <a href="#planningValueStrength">planning value strength comparison</a>, behave like <code>INCREASING_STRENGTH</code>, else like <code>NONE</code>.</p>
</li>
<li>
<p><code>DECREASING_STRENGTH</code>: Evaluate the planning values in decreasing strength. Requires the model to support <a href="#planningValueStrength">planning value strength comparison</a>.</p>
</li>
<li>
<p><code>DECREASING_STRENGTH_IF_AVAILABLE</code>: If the model supports <a href="#planningValueStrength">planning value strength comparison</a>, behave like <code>DECREASING_STRENGTH</code>, else like <code>NONE</code>.</p>
</li>
<li>
<p><code>NONE</code>: Try the planning values in original order.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Advanced detailed configuration.
For example, a Weakest Fit Decreasing configuration for a single entity class with a single variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;constructionHeuristic&gt;
    &lt;queuedEntityPlacer&gt;
      &lt;entitySelector id="placerEntitySelector"&gt;
        &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
        &lt;selectionOrder&gt;SORTED&lt;/selectionOrder&gt;
        &lt;sorterManner&gt;DECREASING_DIFFICULTY&lt;/sorterManner&gt;
      &lt;/entitySelector&gt;
      &lt;changeMoveSelector&gt;
        &lt;entitySelector mimicSelectorRef="placerEntitySelector"/&gt;
        &lt;valueSelector&gt;
          &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
          &lt;selectionOrder&gt;SORTED&lt;/selectionOrder&gt;
          &lt;sorterManner&gt;INCREASING_STRENGTH&lt;/sorterManner&gt;
        &lt;/valueSelector&gt;
      &lt;/changeMoveSelector&gt;
    &lt;/queuedEntityPlacer&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Per step, the <code>QueuedEntityPlacer</code> selects one uninitialized entity from the <code>EntitySelector</code> and applies the winning <code>Move</code> (out of all the moves for that entity generated by the <code>MoveSelector</code>).
The <a href="#mimicSelection">mimic selection</a> ensures that the winning <code>Move</code> changes (only) the selected entity.</p>
</div>
<div class="paragraph">
<p>To customize the entity or value sorting, see <a href="#sortedSelection">sorted selection</a>.
Other <code>Selector</code> customization (such as <a href="#filteredSelection">filtering</a> and <a href="#limitedSelection">limiting</a>) is supported too.</p>
</div>
</div>
<div class="sect3">
<h4 id="allocateEntityFromQueueMultipleVariables"><a class="anchor" href="#allocateEntityFromQueueMultipleVariables"></a><a class="link" href="#allocateEntityFromQueueMultipleVariables">9.8.3. Multiple Variables</a></h4>
<div class="paragraph">
<p>There are two ways to deal with multiple variables, depending on how their <code>ChangeMove</code>s are combined:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cartesian product of the <code>ChangeMove</code>s (default): All variables of the selected entity are assigned together. Has far better results (especially for timetabling use cases).</p>
</li>
<li>
<p>Sequential <code>ChangeMove</code>s: One variable is assigned at a time. Scales much better, especially for three or more variables.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, presume a course scheduling example with 200 rooms and 40 periods.</p>
</div>
<div class="paragraph">
<p>This First Fit configuration for a single entity class with two variables, using a <a href="#cartesianProductMoveSelector">cartesian product</a> of their <code>ChangeMove</code>s, will select 8000 moves per entity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;constructionHeuristic&gt;
    &lt;queuedEntityPlacer&gt;
      &lt;entitySelector id="placerEntitySelector"&gt;
        &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;/entitySelector&gt;
      &lt;cartesianProductMoveSelector&gt;
        &lt;changeMoveSelector&gt;
          &lt;entitySelector mimicSelectorRef="placerEntitySelector"/&gt;
          &lt;valueSelector&gt;
            &lt;variableName&gt;room&lt;/variableName&gt;
          &lt;/valueSelector&gt;
        &lt;/changeMoveSelector&gt;
        &lt;changeMoveSelector&gt;
          &lt;entitySelector mimicSelectorRef="placerEntitySelector"/&gt;
          &lt;valueSelector&gt;
            &lt;variableName&gt;period&lt;/variableName&gt;
          &lt;/valueSelector&gt;
        &lt;/changeMoveSelector&gt;
      &lt;/cartesianProductMoveSelector&gt;
    &lt;/queuedEntityPlacer&gt;
    ...
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>With three variables of 1000 values each, a cartesian product selects 1000000000 values per entity, which will take far too long.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This First Fit configuration for a single entity class with two variables, using sequential <code>ChangeMove</code>s, will select 240 moves per entity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;constructionHeuristic&gt;
    &lt;queuedEntityPlacer&gt;
      &lt;entitySelector id="placerEntitySelector"&gt;
        &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;/entitySelector&gt;
      &lt;changeMoveSelector&gt;
        &lt;entitySelector mimicSelectorRef="placerEntitySelector"/&gt;
        &lt;valueSelector&gt;
          &lt;variableName&gt;period&lt;/variableName&gt;
        &lt;/valueSelector&gt;
      &lt;/changeMoveSelector&gt;
      &lt;changeMoveSelector&gt;
        &lt;entitySelector mimicSelectorRef="placerEntitySelector"/&gt;
        &lt;valueSelector&gt;
          &lt;variableName&gt;room&lt;/variableName&gt;
        &lt;/valueSelector&gt;
      &lt;/changeMoveSelector&gt;
    &lt;/queuedEntityPlacer&gt;
    ...
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Especially for sequential <code>ChangeMove</code>s, the order of the variables is important.
In the example above, it&#8217;s better to select the period first (instead of the other way around), because there are more hard constraints that do not involve the room (for example: no teacher should teach two lectures at the same time). Let the <a href="#benchmarker">Benchmarker</a> guide you.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With three or more variables, it&#8217;s possible to combine the cartesian product and sequential techniques:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;constructionHeuristic&gt;
    &lt;queuedEntityPlacer&gt;
      ...
      &lt;cartesianProductMoveSelector&gt;
        &lt;changeMoveSelector&gt;...&lt;/changeMoveSelector&gt;
        &lt;changeMoveSelector&gt;...&lt;/changeMoveSelector&gt;
      &lt;/cartesianProductMoveSelector&gt;
      &lt;changeMoveSelector&gt;...&lt;/changeMoveSelector&gt;
    &lt;/queuedEntityPlacer&gt;
    ...
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="allocateEntityFromQueueMultipleEntityClasses"><a class="anchor" href="#allocateEntityFromQueueMultipleEntityClasses"></a><a class="link" href="#allocateEntityFromQueueMultipleEntityClasses">9.8.4. Multiple Entity Classes</a></h4>
<div class="paragraph">
<p>The easiest way to deal with multiple entity classes is to run a separate construction heuristic for each entity class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;constructionHeuristic&gt;
    &lt;queuedEntityPlacer&gt;
      &lt;entitySelector id="placerEntitySelector"&gt;
        &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
        &lt;entityClass&gt;...DogEntity&lt;/entityClass&gt;
      &lt;/entitySelector&gt;
      &lt;changeMoveSelector&gt;
        &lt;entitySelector mimicSelectorRef="placerEntitySelector"/&gt;
      &lt;/changeMoveSelector&gt;
    &lt;/queuedEntityPlacer&gt;
    ...
  &lt;/constructionHeuristic&gt;
  &lt;constructionHeuristic&gt;
    &lt;queuedEntityPlacer&gt;
      &lt;entitySelector id="placerEntitySelector"&gt;
        &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
        &lt;entityClass&gt;...CatEntity&lt;/entityClass&gt;
      &lt;/entitySelector&gt;
      &lt;changeMoveSelector&gt;
        &lt;entitySelector mimicSelectorRef="placerEntitySelector"/&gt;
      &lt;/changeMoveSelector&gt;
    &lt;/queuedEntityPlacer&gt;
    ...
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="constructionHeuristicsPickEarlyType"><a class="anchor" href="#constructionHeuristicsPickEarlyType"></a><a class="link" href="#constructionHeuristicsPickEarlyType">9.8.5. Pick Early Type</a></h4>
<div class="paragraph">
<p>There are several pick early types for Construction Heuristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>NEVER</code>: Evaluate all the selected moves to initialize the variable(s). This is the default if the <a href="#initializingScoreTrend">InitializingScoreTrend</a> is not <code>ONLY_DOWN</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;constructionHeuristic&gt;
    ...
    &lt;forager&gt;
      &lt;pickEarlyType&gt;NEVER&lt;/pickEarlyType&gt;
    &lt;/forager&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><code>FIRST_NON_DETERIORATING_SCORE</code>: Initialize the variable(s) with the first move that doesn&#8217;t deteriorate the score, ignore the remaining selected moves. This is the default if the <a href="#initializingScoreTrend">InitializingScoreTrend</a> is <code>ONLY_DOWN</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;constructionHeuristic&gt;
    ...
    &lt;forager&gt;
      &lt;pickEarlyType&gt;FIRST_NON_DETERIORATING_SCORE&lt;/pickEarlyType&gt;
    &lt;/forager&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If there are only negative constraints, but the <a href="#initializingScoreTrend">InitializingScoreTrend</a> is strictly not <code>ONLY_DOWN</code>,
it can sometimes make sense to apply FIRST_NON_DETERIORATING_SCORE.
Use the <a href="#benchmarker">Benchmarker</a> to decide if the score quality loss is worth the time gain.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p><code>FIRST_FEASIBLE_SCORE</code>: Initialize the variable(s) with the first move that has a feasible score.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;constructionHeuristic&gt;
    ...
    &lt;forager&gt;
      &lt;pickEarlyType&gt;FIRST_FEASIBLE_SCORE&lt;/pickEarlyType&gt;
    &lt;/forager&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the <a href="#initializingScoreTrend">InitializingScoreTrend</a> is <code>ONLY_DOWN</code>, use <code>FIRST_FEASIBLE_SCORE_OR_NON_DETERIORATING_HARD</code> instead, because that&#8217;s faster without any disadvantages.</p>
</div>
</li>
<li>
<p><code>FIRST_FEASIBLE_SCORE_OR_NON_DETERIORATING_HARD</code>: Initialize the variable(s) with the first move that doesn&#8217;t deteriorate the feasibility of the score any further.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;constructionHeuristic&gt;
    ...
    &lt;forager&gt;
      &lt;pickEarlyType&gt;FIRST_FEASIBLE_SCORE_OR_NON_DETERIORATING_HARD&lt;/pickEarlyType&gt;
    &lt;/forager&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="allocateToValueFromQueue"><a class="anchor" href="#allocateToValueFromQueue"></a><a class="link" href="#allocateToValueFromQueue">9.9. Allocate To Value From Queue</a></h3>
<div class="sect3">
<h4 id="allocateToValueFromQueueAlgorithm"><a class="anchor" href="#allocateToValueFromQueueAlgorithm"></a><a class="link" href="#allocateToValueFromQueueAlgorithm">9.9.1. Algorithm Description</a></h4>
<div class="paragraph">
<p>Allocate To Value From Queue works like this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Put all values in a round-robin queue.</p>
</li>
<li>
<p>Assign the best entity to the first value (from that queue).</p>
</li>
<li>
<p>Repeat until all entities are assigned.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="allocateToValueFromQueueConfiguration"><a class="anchor" href="#allocateToValueFromQueueConfiguration"></a><a class="link" href="#allocateToValueFromQueueConfiguration">9.9.2. Configuration</a></h4>
<div class="paragraph">
<p>Simple configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;ALLOCATE_TO_VALUE_FROM_QUEUE&lt;/constructionHeuristicType&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verbose simple configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;ALLOCATE_TO_VALUE_FROM_QUEUE&lt;/constructionHeuristicType&gt;
    &lt;entitySorterManner&gt;DECREASING_DIFFICULTY_IF_AVAILABLE&lt;/entitySorterManner&gt;
    &lt;valueSorterManner&gt;INCREASING_STRENGTH_IF_AVAILABLE&lt;/valueSorterManner&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced detailed configuration.
For example, a configuration for a single entity class with a single variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;constructionHeuristic&gt;
    &lt;queuedValuePlacer&gt;
      &lt;valueSelector id="placerValueSelector"&gt;
        &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
        &lt;selectionOrder&gt;SORTED&lt;/selectionOrder&gt;
        &lt;sorterManner&gt;INCREASING_STRENGTH&lt;/sorterManner&gt;
      &lt;/valueSelector&gt;
      &lt;changeMoveSelector&gt;
        &lt;entitySelector&gt;
          &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
          &lt;selectionOrder&gt;SORTED&lt;/selectionOrder&gt;
          &lt;sorterManner&gt;DECREASING_DIFFICULTY&lt;/sorterManner&gt;
        &lt;/entitySelector&gt;
        &lt;valueSelector mimicSelectorRef="placerValueSelector"/&gt;
      &lt;/changeMoveSelector&gt;
    &lt;/queuedValuePlacer&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cheapestInsertion"><a class="anchor" href="#cheapestInsertion"></a><a class="link" href="#cheapestInsertion">9.10. Cheapest Insertion</a></h3>
<div class="sect3">
<h4 id="cheapestInsertionAlgorithm"><a class="anchor" href="#cheapestInsertionAlgorithm"></a><a class="link" href="#cheapestInsertionAlgorithm">9.10.1. Algorithm Description</a></h4>
<div class="paragraph">
<p>The Cheapest Insertion algorithm cycles through all the planning values for all the planning entities, initializing one planning entity at a time.
It assigns a planning entity to the best available planning value (out of all the planning entities and values), taking the already initialized planning entities into account.
It terminates when all planning entities have been initialized.
It never changes a planning entity after it has been assigned.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./ConstructionHeuristics/cheapestInsertionNQueens04.png" alt="cheapestInsertionNQueens04">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Cheapest Insertion scales considerably worse than First Fit, etc.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="cheapestInsertionConfiguration"><a class="anchor" href="#cheapestInsertionConfiguration"></a><a class="link" href="#cheapestInsertionConfiguration">9.10.2. Configuration</a></h4>
<div class="paragraph">
<p>Simplest configuration of Cheapest Insertion:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;CHEAPEST_INSERTION&lt;/constructionHeuristicType&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the <a href="#initializingScoreTrend">InitializingScoreTrend</a> is <code>ONLY_DOWN</code>, this algorithm is faster: for an entity, it picks the first move for which the score does not deteriorate the last step score, ignoring all subsequent moves.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For advanced configuration, see <a href="#allocateFromPool">Allocate from pool</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="regretInsertion"><a class="anchor" href="#regretInsertion"></a><a class="link" href="#regretInsertion">9.11. Regret Insertion</a></h3>
<div class="sect3">
<h4 id="regretInsertionAlgorithm"><a class="anchor" href="#regretInsertionAlgorithm"></a><a class="link" href="#regretInsertionAlgorithm">9.11.1. Algorithm Description</a></h4>
<div class="paragraph">
<p>The Regret Insertion algorithm behaves like the Cheapest Insertion algorithm.
It also cycles through all the planning values for all the planning entities, initializing one planning entity at a time.
But instead of picking the entity-value combination with the best score, it picks the entity which has the largest score loss between its best and second best value assignment.
It then assigns that entity to its best value, to avoid regretting not having done that.</p>
</div>
</div>
<div class="sect3">
<h4 id="regretInsertionConfiguration"><a class="anchor" href="#regretInsertionConfiguration"></a><a class="link" href="#regretInsertionConfiguration">9.11.2. Configuration</a></h4>
<div class="paragraph">
<p>This algorithm has not been implemented yet.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="allocateFromPool"><a class="anchor" href="#allocateFromPool"></a><a class="link" href="#allocateFromPool">9.12. Allocate From Pool</a></h3>
<div class="sect3">
<h4 id="allocateFromPoolAlgorithm"><a class="anchor" href="#allocateFromPoolAlgorithm"></a><a class="link" href="#allocateFromPoolAlgorithm">9.12.1. Algorithm Description</a></h4>
<div class="paragraph">
<p>Allocate From Pool is a versatile, generic form of <a href="#cheapestInsertion">Cheapest Insertion</a> and <a href="#regretInsertion">Regret Insertion</a>.
It works like this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Put all entity-value combinations in a pool.</p>
</li>
<li>
<p>Assign the best entity to best value.</p>
</li>
<li>
<p>Repeat until all entities are assigned.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="allocateFromPoolConfiguration"><a class="anchor" href="#allocateFromPoolConfiguration"></a><a class="link" href="#allocateFromPoolConfiguration">9.12.2. Configuration</a></h4>
<div class="paragraph">
<p>Simple configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;ALLOCATE_FROM_POOL&lt;/constructionHeuristicType&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verbose simple configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;ALLOCATE_FROM_POOL&lt;/constructionHeuristicType&gt;
    &lt;entitySorterManner&gt;DECREASING_DIFFICULTY_IF_AVAILABLE&lt;/entitySorterManner&gt;
    &lt;valueSorterManner&gt;INCREASING_STRENGTH_IF_AVAILABLE&lt;/valueSorterManner&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>entitySorterManner</code> and <code>valueSorterManner</code> options are described in <a href="#allocateEntityFromQueue">Allocate Entity From Queue</a>.</p>
</div>
<div class="paragraph">
<p>Advanced detailed configuration.
For example, a Cheapest Insertion configuration for a single entity class with a single variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;constructionHeuristic&gt;
    &lt;pooledEntityPlacer&gt;
      &lt;changeMoveSelector&gt;
        &lt;entitySelector id="placerEntitySelector"&gt;
          &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
          &lt;selectionOrder&gt;SORTED&lt;/selectionOrder&gt;
          &lt;sorterManner&gt;DECREASING_DIFFICULTY&lt;/sorterManner&gt;
        &lt;/entitySelector&gt;
        &lt;valueSelector&gt;
          &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
          &lt;selectionOrder&gt;SORTED&lt;/selectionOrder&gt;
          &lt;sorterManner&gt;INCREASING_STRENGTH&lt;/sorterManner&gt;
        &lt;/valueSelector&gt;
      &lt;/changeMoveSelector&gt;
    &lt;/pooledEntityPlacer&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Per step, the <code>PooledEntityPlacer</code> applies the winning <code>Move</code> (out of all the moves for that entity generated by the <code>MoveSelector</code>).</p>
</div>
<div class="paragraph">
<p>To customize the entity or value sorting, see <a href="#sortedSelection">sorted selection</a>.
Other <code>Selector</code> customization (such as <a href="#filteredSelection">filtering</a> and <a href="#limitedSelection">limiting</a>) is supported too.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="localSearch"><a class="anchor" href="#localSearch"></a><a class="link" href="#localSearch">10. Local Search</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="localSearchOverview"><a class="anchor" href="#localSearchOverview"></a><a class="link" href="#localSearchOverview">10.1. Overview</a></h3>
<div class="paragraph">
<p>Local Search starts from an initial solution and evolves that single solution into a mostly better and better solution.
It uses a single search path of solutions, not a search tree.
At each solution in this path it evaluates a number of moves on the solution and applies the most suitable move to take the step to the next solution.
It does that for a high number of iterations until it&#8217;s terminated (usually because its time has run out).</p>
</div>
<div class="paragraph">
<p>Local Search acts a lot like a human planner: it uses a single search path and moves facts around to find a good feasible solution.
Therefore it&#8217;s pretty natural to implement.</p>
</div>
<div class="paragraph">
<p><strong>Local Search needs to start from an initialized solution</strong>, therefore it&#8217;s usually required to configure a Construction Heuristic phase before it.</p>
</div>
</div>
<div class="sect2">
<h3 id="localSearchConcepts"><a class="anchor" href="#localSearchConcepts"></a><a class="link" href="#localSearchConcepts">10.2. Local Search Concepts</a></h3>
<div class="sect3">
<h4 id="localSearchStepByStep"><a class="anchor" href="#localSearchStepByStep"></a><a class="link" href="#localSearchStepByStep">10.2.1. Step by Step</a></h4>
<div class="paragraph">
<p>A step is the winning <code>Move</code>.
Local Search tries a number of moves on the current solution and picks the best accepted move as the step:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./LocalSearch/decideNextStepNQueens04.png" alt="decideNextStepNQueens04">
</div>
<div class="title">Figure 7. Decide the next step at step 0 (four queens example)</div>
</div>
<div class="paragraph">
<p>Because the move <em>B0 to B3</em> has the highest score (<code>-3</code>), it is picked as the next step.
If multiple moves have the same highest score, one is picked randomly, in this case <em>B0 to B3</em>.
Note that <em>C0 to C3</em> (not shown) could also have been picked because it also has the score <code>-3</code>.</p>
</div>
<div class="paragraph">
<p>The step is applied on the solution.
From that new solution, Local Search tries every move again, to decide the next step after that.
It continually does this in a loop, and we get something like this:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./LocalSearch/allStepsNQueens04.png" alt="allStepsNQueens04">
</div>
<div class="title">Figure 8. All steps (four queens example)</div>
</div>
<div class="paragraph">
<p>Notice that Local Search doesn&#8217;t use a search tree, but a search path.
The search path is highlighted by the green arrows.
At each step it tries all selected moves, but unless it&#8217;s the step, it doesn&#8217;t investigate that solution further.
This is one of the reasons why Local Search is very scalable.</p>
</div>
<div class="paragraph">
<p>As shown above, Local Search solves the four queens problem by starting with the starting solution and make the following steps sequentially:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><em>B0 to B3</em></p>
</li>
<li>
<p><em>D0 to B2</em></p>
</li>
<li>
<p><em>A0 to B1</em></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Turn on <code>debug</code> logging for the category <code>org.optaplanner</code> to show those steps in the log:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>INFO  Solving started: time spent (0), best score (-6), environment mode (REPRODUCIBLE), random (JDK with seed 0).
DEBUG     LS step (0), time spent (20), score (-3), new best score (-3), accepted/selected move count (12/12), picked move (Queen-1 {Row-0 -&gt; Row-3}).
DEBUG     LS step (1), time spent (31), score (-1), new best score (-1), accepted/selected move count (12/12), picked move (Queen-3 {Row-0 -&gt; Row-2}).
DEBUG     LS step (2), time spent (40), score (0), new best score (0), accepted/selected move count (12/12), picked move (Queen-0 {Row-0 -&gt; Row-1}).
INFO  Local Search phase (0) ended: time spent (41), best score (0), score calculation speed (5000/sec), step total (3).
INFO  Solving ended: time spent (41), best score (0), score calculation speed (5000/sec), phase total (1), environment mode (REPRODUCIBLE).</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that a log message includes the <code>toString()</code> method of the <code>Move</code> implementation which returns for example "<code>Queen-1 {Row-0 &#8594; Row-3}</code>".</p>
</div>
<div class="paragraph">
<p>A naive Local Search configuration solves the four queens problem in three steps, by evaluating only 37 possible solutions (three steps with 12 moves each + one starting solution), which is only fraction of all 256 possible solutions.
It solves 16 queens in 31 steps, by evaluating only 7441 out of 18446744073709551616 possible solutions.
By using a <a href="#constructionHeuristics">Construction Heuristics</a> phase first, it&#8217;s even a lot more efficient.</p>
</div>
</div>
<div class="sect3">
<h4 id="localSearchConceptsDecideTheNextStep"><a class="anchor" href="#localSearchConceptsDecideTheNextStep"></a><a class="link" href="#localSearchConceptsDecideTheNextStep">10.2.2. Decide the Next Step</a></h4>
<div class="paragraph">
<p>Local Search decides the next step with the aid of three configurable components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>MoveSelector</code> which selects the possible moves of the current solution. See the chapter <a href="#moveAndNeighborhoodSelection">move and neighborhood selection</a>.</p>
</li>
<li>
<p>An <code>Acceptor</code> which filters out unacceptable moves.</p>
</li>
<li>
<p>A <code>Forager</code> which gathers accepted moves and picks the next step from them.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The solver phase configuration looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;localSearch&gt;
    &lt;unionMoveSelector&gt;
      ...
    &lt;/unionMoveSelector&gt;
    &lt;acceptor&gt;
      ...
    &lt;/acceptor&gt;
    &lt;forager&gt;
      ...
    &lt;/forager&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example below, the <code>MoveSelector</code> generated the moves shown with the blue lines, the <code>Acceptor</code> accepted all of them and the <code>Forager</code> picked the move <em>B0 to B3</em>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./LocalSearch/decideNextStepNQueens04.png" alt="decideNextStepNQueens04">
</div>
</div>
<div class="paragraph">
<p><a href="#logging">Turn on <code>trace</code> logging</a> to show the decision making in the log:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>INFO  Solver started: time spent (0), score (-6), new best score (-6), random (JDK with seed 0).
TRACE         Move index (0) not doable, ignoring move (Queen-0 {Row-0 -&gt; Row-0}).
TRACE         Move index (1), score (-4), accepted (true), move (Queen-0 {Row-0 -&gt; Row-1}).
TRACE         Move index (2), score (-4), accepted (true), move (Queen-0 {Row-0 -&gt; Row-2}).
TRACE         Move index (3), score (-4), accepted (true), move (Queen-0 {Row-0 -&gt; Row-3}).
...
TRACE         Move index (6), score (-3), accepted (true), move (Queen-1 {Row-0 -&gt; Row-3}).
...
TRACE         Move index (9), score (-3), accepted (true), move (Queen-2 {Row-0 -&gt; Row-3}).
...
TRACE         Move index (12), score (-4), accepted (true), move (Queen-3 {Row-0 -&gt; Row-3}).
DEBUG     LS step (0), time spent (6), score (-3), new best score (-3), accepted/selected move count (12/12), picked move (Queen-1 {Row-0 -&gt; Row-3}).
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because the last solution can degrade (for example in Tabu Search), the <code>Solver</code> remembers the best solution it has encountered through the entire search path.
Each time the current solution is better than the last best solution, the current solution is <a href="#cloningASolution">cloned</a> and referenced as the new best solution.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./LocalSearch/localSearchScoreOverTime.png" alt="localSearchScoreOverTime">
</div>
</div>
</div>
<div class="sect3">
<h4 id="localSearchAcceptor"><a class="anchor" href="#localSearchAcceptor"></a><a class="link" href="#localSearchAcceptor">10.2.3. Acceptor</a></h4>
<div class="paragraph">
<p>An <code>Acceptor</code> is used (together with a <code>Forager</code>) to active Tabu Search, Simulated Annealing, Late Acceptance, &#8230;&#8203; For each move it checks whether it is accepted or not.</p>
</div>
<div class="paragraph">
<p>By changing a few lines of configuration, you can easily switch from Tabu Search to Simulated Annealing or Late Acceptance and back.</p>
</div>
<div class="paragraph">
<p>You can implement your own <code>Acceptor</code>, but the built-in acceptors should suffice for most needs.
You can also combine multiple acceptors.</p>
</div>
</div>
<div class="sect3">
<h4 id="localSearchForager"><a class="anchor" href="#localSearchForager"></a><a class="link" href="#localSearchForager">10.2.4. Forager</a></h4>
<div class="paragraph">
<p>A <code>Forager</code> gathers all accepted moves and picks the move which is the next step.
Normally it picks the accepted move with the highest score.
If several accepted moves have the highest score, one is picked randomly to break the tie.
Breaking ties randomly leads to better results.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is possible to disable breaking ties randomly by explicitly setting <code>breakTieRandomly</code> to <code>false</code>, but that&#8217;s almost never a good idea:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If an earlier move is better than a later move with the same score, the score calculator should add an extra softer <a href="#scoreLevel">score level</a> to score the first move as slightly better. Don&#8217;t rely on move selection order to enforce that.</p>
</li>
<li>
<p>Random tie breaking does not affect <a href="#environmentMode">reproducibility</a>.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="acceptedCountLimit"><a class="anchor" href="#acceptedCountLimit"></a><a class="link" href="#acceptedCountLimit">10.2.4.1. Accepted Count Limit</a></h5>
<div class="paragraph">
<p>When there are many possible moves, it becomes inefficient to evaluate all of them at every step.
To evaluate only a random subset of all the moves, use:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An <code>acceptedCountLimit</code> integer, which specifies how many accepted moves should be evaluated during each step. By default, all accepted moves are evaluated at every step.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;forager&gt;
    &lt;acceptedCountLimit&gt;1000&lt;/acceptedCountLimit&gt;
  &lt;/forager&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Unlike the n queens problem, real world problems require the use of <code>acceptedCountLimit</code>.
Start from an <code>acceptedCountLimit</code> that takes a step in less then two seconds. <a href="#logging">Turn on INFO logging</a> to see the step times.
Use the <a href="#benchmarker">Benchmarker</a> to tweak the value.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>With a low <code>acceptedCountLimit</code> (so a fast stepping algorithm), it is recommended to avoid using <code>selectionOrder</code> SHUFFLED because the shuffling generates a random number for every element in the selector, taking up a lot of time, but only a few elements are actually selected.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="localSearchPickEarlyType"><a class="anchor" href="#localSearchPickEarlyType"></a><a class="link" href="#localSearchPickEarlyType">10.2.4.2. Pick Early Type</a></h5>
<div class="paragraph">
<p>A forager can pick a move early during a step, ignoring subsequent selected moves.
There are three pick early types for Local Search:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>NEVER</code>: A move is never picked early: all accepted moves are evaluated that the selection allows. This is the default.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;forager&gt;
      &lt;pickEarlyType&gt;NEVER&lt;/pickEarlyType&gt;
    &lt;/forager&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><code>FIRST_BEST_SCORE_IMPROVING</code>: Pick the first accepted move that improves the best score. If none improve the best score, it behaves exactly like the pickEarlyType NEVER.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;forager&gt;
      &lt;pickEarlyType&gt;FIRST_BEST_SCORE_IMPROVING&lt;/pickEarlyType&gt;
    &lt;/forager&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><code>FIRST_LAST_STEP_SCORE_IMPROVING</code>: Pick the first accepted move that improves the last step score. If none improve the last step score, it behaves exactly like the pickEarlyType NEVER.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;forager&gt;
      &lt;pickEarlyType&gt;FIRST_LAST_STEP_SCORE_IMPROVING&lt;/pickEarlyType&gt;
    &lt;/forager&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="hillClimbing"><a class="anchor" href="#hillClimbing"></a><a class="link" href="#hillClimbing">10.3. Hill Climbing (Simple Local Search)</a></h3>
<div class="sect3">
<h4 id="hillClimbingAlgorithm"><a class="anchor" href="#hillClimbingAlgorithm"></a><a class="link" href="#hillClimbingAlgorithm">10.3.1. Algorithm Description</a></h4>
<div class="paragraph">
<p>Hill Climbing tries all selected moves and then takes the best move, which is the move which leads to the solution with the highest score.
That best move is called the step move.
From that new solution, it again tries all selected moves and takes the best move and continues like that iteratively.
If multiple selected moves tie for the best move, one of them is randomly chosen as the best move.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./LocalSearch/hillClimbingNQueens04.png" alt="hillClimbingNQueens04">
</div>
</div>
<div class="paragraph">
<p>Notice that once a queen has moved, it can be moved again later.
This is a good thing, because in an NP-complete problem it&#8217;s impossible to predict what will be the optimal final value for a planning variable.</p>
</div>
</div>
<div class="sect3">
<h4 id="hillClimbingStuckInLocalOptima"><a class="anchor" href="#hillClimbingStuckInLocalOptima"></a><a class="link" href="#hillClimbingStuckInLocalOptima">10.3.2. Stuck in Local Optima</a></h4>
<div class="paragraph">
<p>Hill Climbing always takes improving moves.
This may seem like a good thing, but it&#8217;s not: <strong>Hill Climbing can easily get stuck in a local optimum.</strong> This happens when it reaches a solution for which all the moves deteriorate the score.
Even if it picks one of those moves, the next step might go back to the original solution and which case chasing its own tail:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./LocalSearch/hillClimbingGetsStuckInLocalOptimaNQueens04.png" alt="hillClimbingGetsStuckInLocalOptimaNQueens04">
</div>
</div>
<div class="paragraph">
<p>Improvements upon Hill Climbing (such as Tabu Search, Simulated Annealing and Late Acceptance) address the problem of being stuck in local optima.
Therefore, it&#8217;s recommend to never use Hill Climbing, unless you&#8217;re absolutely sure there are no local optima in your planning problem.</p>
</div>
</div>
<div class="sect3">
<h4 id="hillClimbingConfigure"><a class="anchor" href="#hillClimbingConfigure"></a><a class="link" href="#hillClimbingConfigure">10.3.3. Configuration</a></h4>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;localSearch&gt;
    &lt;localSearchType&gt;HILL_CLIMBING&lt;/localSearchType&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;localSearch&gt;
    ...
    &lt;acceptor&gt;
      &lt;acceptorType&gt;HILL_CLIMBING&lt;/acceptorType&gt;
    &lt;/acceptor&gt;
    &lt;forager&gt;
      &lt;acceptedCountLimit&gt;1&lt;/acceptedCountLimit&gt;
    &lt;/forager&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tabuSearch"><a class="anchor" href="#tabuSearch"></a><a class="link" href="#tabuSearch">10.4. Tabu Search</a></h3>
<div class="sect3">
<h4 id="tabuSearchAlgorithm"><a class="anchor" href="#tabuSearchAlgorithm"></a><a class="link" href="#tabuSearchAlgorithm">10.4.1. Algorithm Description</a></h4>
<div class="paragraph">
<p>Tabu Search works like Hill Climbing, but it maintains a tabu list to avoid getting stuck in local optima.
The tabu list holds recently used objects that are <em>taboo</em> to use for now.
Moves that involve an object in the tabu list, are not accepted.
The tabu list objects can be anything related to the move, such as the planning entity, planning value, move, solution, &#8230;&#8203;
Here&#8217;s an example with entity tabu for four queens, so the queens are put in the tabu list:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./LocalSearch/entityTabuSearch.png" alt="entityTabuSearch">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It&#8217;s called Tabu Search, not Taboo Search.
There is no spelling error.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Scientific paper: <em>Tabu Search - Part 1 and Part 2</em> by Fred Glover (1989 - 1990)</p>
</div>
</div>
<div class="sect3">
<h4 id="tabuSearchConfiguration"><a class="anchor" href="#tabuSearchConfiguration"></a><a class="link" href="#tabuSearchConfiguration">10.4.2. Configuration</a></h4>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;localSearch&gt;
    &lt;localSearchType&gt;TABU_SEARCH&lt;/localSearchType&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When Tabu Search takes steps it creates one or more tabu&#8217;s.
For a number of steps, it does not accept a move if that move breaks tabu.
That number of steps is the tabu size.
Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;localSearch&gt;
    ...
    &lt;acceptor&gt;
      &lt;entityTabuSize&gt;7&lt;/entityTabuSize&gt;
    &lt;/acceptor&gt;
    &lt;forager&gt;
      &lt;acceptedCountLimit&gt;1000&lt;/acceptedCountLimit&gt;
    &lt;/forager&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A Tabu Search acceptor should be combined with a high <code>acceptedCountLimit</code>, such as <code>1000</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Planner implements several tabu types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Planning entity tabu</em> (recommended) makes the planning entities of recent steps tabu. For example, for N queens it makes the recently moved queens tabu. It&#8217;s recommended to start with this tabu type.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;acceptor&gt;
      &lt;entityTabuSize&gt;7&lt;/entityTabuSize&gt;
    &lt;/acceptor&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To avoid hard coding the tabu size, configure a tabu ratio, relative to the number of entities, for example 2%:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;acceptor&gt;
      &lt;entityTabuRatio&gt;0.02&lt;/entityTabuRatio&gt;
    &lt;/acceptor&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><em>Planning value tabu</em> makes the planning values of recent steps tabu. For example, for N queens it makes the recently moved to rows tabu.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;acceptor&gt;
      &lt;valueTabuSize&gt;7&lt;/valueTabuSize&gt;
    &lt;/acceptor&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To avoid hard coding the tabu size, configure a tabu ratio, relative to the number of values, for example 2%:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;acceptor&gt;
      &lt;valueTabuRatio&gt;0.02&lt;/valueTabuRatio&gt;
    &lt;/acceptor&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><em>Move tabu</em> makes recent steps tabu. It does not accept a move equal to one of those steps.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;acceptor&gt;
      &lt;moveTabuSize&gt;7&lt;/moveTabuSize&gt;
    &lt;/acceptor&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><em>Undo move tabu </em>makes the undo move of recent steps tabu.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;acceptor&gt;
      &lt;undoMoveTabuSize&gt;7&lt;/undoMoveTabuSize&gt;
    &lt;/acceptor&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><em>Solution tabu</em> makes recently visited solutions tabu. It does not accept a move that leads to one of those solutions. It requires that the <code>Solution</code> implements <code>equals()</code> and <code>hashCode()</code> properly. If you can spare the memory, don&#8217;t be cheap on the tabu size.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;acceptor&gt;
      &lt;solutionTabuSize&gt;1000&lt;/solutionTabuSize&gt;
    &lt;/acceptor&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For non-trivial cases, solution tabu is usually useless because the <a href="#searchSpaceSize">search space size</a> makes it statistically highly unlikely to reach the same solution twice.
Therefore its use is not recommended, except for small datasets.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Sometimes it&#8217;s useful to combine tabu types:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;acceptor&gt;
      &lt;entityTabuSize&gt;7&lt;/entityTabuSize&gt;
      &lt;valueTabuSize&gt;3&lt;/valueTabuSize&gt;
    &lt;/acceptor&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the tabu size is too small, the solver can still get stuck in a local optimum.
On the other hand, if the tabu size is too large, the solver can be inefficient by bouncing of the walls.
Use the <a href="#benchmarker">Benchmarker</a> to fine tweak your configuration.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="simulatedAnnealing"><a class="anchor" href="#simulatedAnnealing"></a><a class="link" href="#simulatedAnnealing">10.5. Simulated Annealing</a></h3>
<div class="sect3">
<h4 id="simulatedAnnealingAlgorithm"><a class="anchor" href="#simulatedAnnealingAlgorithm"></a><a class="link" href="#simulatedAnnealingAlgorithm">10.5.1. Algorithm Description</a></h4>
<div class="paragraph">
<p>Simulated Annealing evaluates only a few moves per step, so it steps quickly.
In the classic implementation, the first accepted move is the winning step.
A move is accepted if it doesn&#8217;t decrease the score or - in case it does decrease the score - it passes a random check.
The chance that a decreasing move passes the random check decreases relative to the size of the score decrement and the time the phase has been running (which is represented as the temperature).</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./LocalSearch/simulatedAnnealing.png" alt="simulatedAnnealing">
</div>
</div>
<div class="paragraph">
<p>Simulated Annealing does not always pick the move with the highest score, neither does it evaluate many moves per step.
At least at first.
Instead, it gives non improving moves also a chance to be picked, depending on its score and the time gradient of the <code>Termination</code>.
In the end, it gradually turns into Hill Climbing, only accepting improving moves.</p>
</div>
</div>
<div class="sect3">
<h4 id="simulatedAnnealingConfiguration"><a class="anchor" href="#simulatedAnnealingConfiguration"></a><a class="link" href="#simulatedAnnealingConfiguration">10.5.2. Configuration</a></h4>
<div class="paragraph">
<p>Start with a <code>simulatedAnnealingStartingTemperature</code> set to the maximum score delta a single move can cause.
Use the <a href="#benchmarker">Benchmarker</a> to tweak the value.
Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;localSearch&gt;
    ...
    &lt;acceptor&gt;
      &lt;simulatedAnnealingStartingTemperature&gt;2hard/100soft&lt;/simulatedAnnealingStartingTemperature&gt;
    &lt;/acceptor&gt;
    &lt;forager&gt;
      &lt;acceptedCountLimit&gt;1&lt;/acceptedCountLimit&gt;
    &lt;/forager&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Simulated Annealing should use a low <code>acceptedCountLimit</code>.
The classic algorithm uses an <code>acceptedCountLimit</code> of <code>1</code>, but often <code>4</code> performs better.</p>
</div>
<div class="paragraph">
<p>Simulated Annealing can be combined with a tabu acceptor at the same time.
That gives Simulated Annealing salted with a bit of Tabu.
Use a lower tabu size than in a pure Tabu Search configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;localSearch&gt;
    ...
    &lt;acceptor&gt;
      &lt;simulatedAnnealingStartingTemperature&gt;2hard/100soft&lt;/simulatedAnnealingStartingTemperature&gt;
      &lt;entityTabuSize&gt;5&lt;/entityTabuSize&gt;
    &lt;/acceptor&gt;
    &lt;forager&gt;
      &lt;acceptedCountLimit&gt;1&lt;/acceptedCountLimit&gt;
    &lt;/forager&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="lateAcceptance"><a class="anchor" href="#lateAcceptance"></a><a class="link" href="#lateAcceptance">10.6. Late Acceptance</a></h3>
<div class="sect3">
<h4 id="lateAcceptanceAlgorithm"><a class="anchor" href="#lateAcceptanceAlgorithm"></a><a class="link" href="#lateAcceptanceAlgorithm">10.6.1. Algorithm Description</a></h4>
<div class="paragraph">
<p>Late Acceptance (also known as Late Acceptance Hill Climbing) also evaluates only a few moves per step.
A move is accepted if it does not decrease the score, or if it leads to a score that is at least the late score (which is the winning score of a fixed number of steps ago).</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./LocalSearch/lateAcceptance.png" alt="lateAcceptance">
</div>
</div>
<div class="paragraph">
<p>Scientific paper: <a href="http://www.cs.stir.ac.uk/research/publications/techreps/pdf/TR192.pdf">The Late Acceptance Hill-Climbing Heuristic by Edmund K. Burke, Yuri Bykov (2012)</a></p>
</div>
</div>
<div class="sect3">
<h4 id="lateAcceptanceConfiguration"><a class="anchor" href="#lateAcceptanceConfiguration"></a><a class="link" href="#lateAcceptanceConfiguration">10.6.2. Configuration</a></h4>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;localSearch&gt;
    &lt;localSearchType&gt;LATE_ACCEPTANCE&lt;/localSearchType&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Late Acceptance accepts any move that has a score which is higher than the best score of a number of steps ago.
That number of steps is the <code>lateAcceptanceSize</code>.
Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;localSearch&gt;
    ...
    &lt;acceptor&gt;
      &lt;lateAcceptanceSize&gt;400&lt;/lateAcceptanceSize&gt;
    &lt;/acceptor&gt;
    &lt;forager&gt;
      &lt;acceptedCountLimit&gt;1&lt;/acceptedCountLimit&gt;
    &lt;/forager&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Late Acceptance should use a low <code>acceptedCountLimit</code>.</p>
</div>
<div class="paragraph">
<p>Late Acceptance can be combined with a tabu acceptor at the same time.
That gives Late Acceptance salted with a bit of Tabu.
Use a lower tabu size than in a pure Tabu Search configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;localSearch&gt;
    ...
    &lt;acceptor&gt;
      &lt;lateAcceptanceSize&gt;400&lt;/lateAcceptanceSize&gt;
      &lt;entityTabuSize&gt;5&lt;/entityTabuSize&gt;
    &lt;/acceptor&gt;
    &lt;forager&gt;
      &lt;acceptedCountLimit&gt;1&lt;/acceptedCountLimit&gt;
    &lt;/forager&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="stepCountingHillClimbing"><a class="anchor" href="#stepCountingHillClimbing"></a><a class="link" href="#stepCountingHillClimbing">10.7. Step Counting Hill Climbing</a></h3>
<div class="sect3">
<h4 id="stepCountingHillClimbingAlgorithm"><a class="anchor" href="#stepCountingHillClimbingAlgorithm"></a><a class="link" href="#stepCountingHillClimbingAlgorithm">10.7.1. Algorithm Description</a></h4>
<div class="paragraph">
<p>Step Counting Hill Climbing also evaluates only a few moves per step.
For a number of steps, it keeps the step score as a threshold.
A move is accepted if it does not decrease the score, or if it leads to a score that is at least the threshold score.</p>
</div>
<div class="paragraph">
<p>Scientific paper: <a href="https://www.cs.nott.ac.uk/~yxb/SCHC/SCHC_mista2013_79.pdf">An initial study of a novel Step Counting Hill Climbing heuristic applied to timetabling problems by Yuri Bykov, Sanja Petrovic (2013)</a></p>
</div>
</div>
<div class="sect3">
<h4 id="stepCountingHillClimbingConfiguration"><a class="anchor" href="#stepCountingHillClimbingConfiguration"></a><a class="link" href="#stepCountingHillClimbingConfiguration">10.7.2. Configuration</a></h4>
<div class="paragraph">
<p>Step Counting Hill Climbing accepts any move that has a score which is higher than a threshold score.
Every number of steps (specified by <code>stepCountingHillClimbingSize</code>), the threshold score is set to the step score.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;localSearch&gt;
    ...
    &lt;acceptor&gt;
      &lt;stepCountingHillClimbingSize&gt;400&lt;/stepCountingHillClimbingSize&gt;
    &lt;/acceptor&gt;
    &lt;forager&gt;
      &lt;acceptedCountLimit&gt;1&lt;/acceptedCountLimit&gt;
    &lt;/forager&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step Counting Hill Climbing should use a low <code>acceptedCountLimit</code>.</p>
</div>
<div class="paragraph">
<p>Step Counting Hill Climbing can be combined with a tabu acceptor at the same time, similar as shown in <a href="#lateAcceptance">the Late Acceptance section</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="strategicOscillation"><a class="anchor" href="#strategicOscillation"></a><a class="link" href="#strategicOscillation">10.8. Strategic Oscillation</a></h3>
<div class="sect3">
<h4 id="strategicOscillationAlgorithm"><a class="anchor" href="#strategicOscillationAlgorithm"></a><a class="link" href="#strategicOscillationAlgorithm">10.8.1. Algorithm Description</a></h4>
<div class="paragraph">
<p>Strategic Oscillation is an add-on, which works especially well with <a href="#tabuSearch">Tabu Search</a>.
Instead of picking the accepted move with the highest score, it employs a different mechanism: If there&#8217;s an improving move, it picks it.
If there&#8217;s no improving move however, it prefers moves which improve a softer score level, over moves which break a harder score level less.</p>
</div>
</div>
<div class="sect3">
<h4 id="strategicOscillationConfiguration"><a class="anchor" href="#strategicOscillationConfiguration"></a><a class="link" href="#strategicOscillationConfiguration">10.8.2. Configuration</a></h4>
<div class="paragraph">
<p>Configure a <code>finalistPodiumType</code>, for example in a Tabu Search configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;localSearch&gt;
    ...
    &lt;acceptor&gt;
      &lt;entityTabuSize&gt;7&lt;/entityTabuSize&gt;
    &lt;/acceptor&gt;
    &lt;forager&gt;
      &lt;acceptedCountLimit&gt;1000&lt;/acceptedCountLimit&gt;
      &lt;finalistPodiumType&gt;STRATEGIC_OSCILLATION&lt;/finalistPodiumType&gt;
    &lt;/forager&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following <code>finalistPodiumType</code>s are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>HIGHEST_SCORE</code> (default): Pick the accepted move with the highest score.</p>
</li>
<li>
<p><code>STRATEGIC_OSCILLATION</code>: Alias for the default strategic oscillation variant.</p>
</li>
<li>
<p><code>STRATEGIC_OSCILLATION_BY_LEVEL</code>: If there is an accepted improving move, pick it. If no such move exists, prefer an accepted move which improves a softer score level over one that doesn&#8217;t (even if it has a better harder score level). A move is improving if it&#8217;s better than the last completed step score.</p>
</li>
<li>
<p><code>STRATEGIC_OSCILLATION_BY_LEVEL_ON_BEST_SCORE</code>: Like <code>STRATEGIC_OSCILLATION_BY_LEVEL</code>, but define improving as better than the best score (instead of the last completed step score).</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="customTerminationSelectorOrAcceptor"><a class="anchor" href="#customTerminationSelectorOrAcceptor"></a><a class="link" href="#customTerminationSelectorOrAcceptor">10.9. Using a Custom Termination, MoveSelector, EntitySelector, ValueSelector or Acceptor</a></h3>
<div class="paragraph">
<p>You can plug in a custom <code>Termination</code>, <code>MoveSelector</code>, <code>EntitySelector</code>, <code>ValueSelector</code> or <code>Acceptor</code> by extending the abstract class and also the related <code>\*Config</code> class.</p>
</div>
<div class="paragraph">
<p>For example, to use a custom <code>MoveSelector</code>, extend the <code>AbstractMoveSelector</code> class, extend the <code>MoveSelectorConfig</code> class and configure it in the solver configuration.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It&#8217;s not possible to inject a <code>Termination</code>, &#8230;&#8203; instance directly (to avoid extending a <code>Config</code> class too) because:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>SolverFactory</code> can build multiple <code>Solver</code> instances, which each require a distinct <code>Termination</code>, &#8230;&#8203; instance.</p>
</li>
<li>
<p>A solver configuration needs to be serializable to and from XML. This makes benchmarking with <code>PlannerBenchmark</code> particularly easy because you can configure different <code>Solver</code> variants in XML.</p>
</li>
<li>
<p>A <code>Config</code> class is often easier and clearer to configure. For example: <code>TerminationConfig</code> translates <code>minutesSpentLimit</code> and <code>secondsSpentLimit</code> into <code>timeMillisSpentLimit</code>.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you build a better implementation that&#8217;s not domain specific, consider contributing it back as a pull request on github: we&#8217;ll optimize it and take it along in future refactorings.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="evolutionaryAlgorithms"><a class="anchor" href="#evolutionaryAlgorithms"></a><a class="link" href="#evolutionaryAlgorithms">11. Evolutionary Algorithms</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="evolutionaryAlgorithmsOverview"><a class="anchor" href="#evolutionaryAlgorithmsOverview"></a><a class="link" href="#evolutionaryAlgorithmsOverview">11.1. Overview</a></h3>
<div class="paragraph">
<p>Evolutionary Algorithms work on a population of solutions and evolve that population.</p>
</div>
</div>
<div class="sect2">
<h3 id="evolutionaryStrategies"><a class="anchor" href="#evolutionaryStrategies"></a><a class="link" href="#evolutionaryStrategies">11.2. Evolutionary Strategies</a></h3>
<div class="paragraph">
<p>This algorithm has not been implemented yet.</p>
</div>
</div>
<div class="sect2">
<h3 id="geneticAlgorithms"><a class="anchor" href="#geneticAlgorithms"></a><a class="link" href="#geneticAlgorithms">11.3. Genetic Algorithms</a></h3>
<div class="paragraph">
<p>This algorithm has not been implemented yet.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A good Genetic Algorithms prototype in Planner was written some time ago, but it wasn&#8217;t practical to merge and support it at the time.
The results of Genetic Algorithms were consistently and seriously inferior to all the <a href="#localSearch">Local Search</a> variants (except Hill Climbing) on all use cases tried.
Nevertheless, a future version of Planner will add support for Genetic Algorithms, so you can easily benchmark Genetic Algorithms on your use case too.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="hyperheuristics"><a class="anchor" href="#hyperheuristics"></a><a class="link" href="#hyperheuristics">12. Hyperheuristics</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="hyperheuristicsOverview"><a class="anchor" href="#hyperheuristicsOverview"></a><a class="link" href="#hyperheuristicsOverview">12.1. Overview</a></h3>
<div class="paragraph">
<p>A hyperheuristic automates the decision which heuristic(s) to use on a specific data set.</p>
</div>
<div class="paragraph">
<p>A future version of Planner will have native support for hyperheuristics.
Meanwhile, it&#8217;s pretty easy to implement it yourself: Based on the size or difficulty of a data set (which is a criterion), use a different <code>Solver</code> configuration (or adjust the default configuration using the Solver configuration API). The <a href="#benchmarker">Benchmarker</a> can help to identify such criteria.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="partitionedSearch"><a class="anchor" href="#partitionedSearch"></a><a class="link" href="#partitionedSearch">13. Partitioned Search</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="partitionedSearchAlgorithm"><a class="anchor" href="#partitionedSearchAlgorithm"></a><a class="link" href="#partitionedSearchAlgorithm">13.1. Algorithm Description</a></h3>
<div class="paragraph">
<p>It is often more efficient to partition large data sets (usually above 5000 planning entities)
into smaller pieces and solve them separately.
Partition Search is <a href="#multiThreadedSolving">multi-threaded</a>, so it provides a performance boost on multi-core machines
due to higher CPU utilization.
Additionally, even when only using one CPU, it finds an initial solution faster,
because the search space sum of a partitioned Construction Heuristic is far less than its non-partitioned variant.</p>
</div>
<div class="paragraph">
<p>However, <strong>partitioning does lead to suboptimal results</strong>, even if the pieces are solved optimally, as shown below:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./PartitionedSearch/mapReduceIsTerribleForTsp.png" alt="mapReduceIsTerribleForTsp">
</div>
</div>
<div class="paragraph">
<p>It effectively trades a short term gain in solution quality for long term loss.
One way to compensate for this loss,
is to run a non-partitioned Local Search after the Partitioned Search phase.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Not all use cases can be partitioned.
It only works on use cases for which the planning entities and value ranges can be split into n partition,
such that none of the constraints cross the boundaries between partitions.
Partitioning only works for use cases where the planning entities and value ranges can be split into n partitions,
without any of the constraints crossing boundaries between partitions.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="partitionedSearchConfiguration"><a class="anchor" href="#partitionedSearchConfiguration"></a><a class="link" href="#partitionedSearchConfiguration">13.2. Configuration</a></h3>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;partitionedSearch&gt;
    &lt;solutionPartitionerClass&gt;org.optaplanner.examples.cloudbalancing.optional.partitioner.CloudBalancePartitioner&lt;/solutionPartitionerClass&gt;
  &lt;/partitionedSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are several ways to <a href="#partitioningASolution">partition a solution</a>.</p>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;partitionedSearch&gt;
    ...
    &lt;solutionPartitionerClass&gt;org.optaplanner.examples.cloudbalancing.optional.partitioner.CloudBalancePartitioner&lt;/solutionPartitionerClass&gt;
    &lt;threadFactoryClass&gt;...MyAppServerThreadFactory&lt;/threadFactoryClass&gt;
    &lt;runnablePartThreadLimit&gt;4&lt;/runnablePartThreadLimit&gt;

    &lt;constructionHeuristic&gt;...&lt;/constructionHeuristic&gt;
    &lt;localSearch&gt;...&lt;/localSearch&gt;
  &lt;/partitionedSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>threadFactoryClass</code> allows to plug in a custom <code>ThreadFactory</code> for environments
where arbitrary thread creation should be avoided, such as most application servers, Android, or Google App Engine.</p>
</div>
<div class="paragraph">
<p>The <code>runnablePartThreadLimit</code> allows limiting CPU usage to avoid hanging your machine, see below.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A <a href="#logging">logging level</a> of <code>debug</code> or <code>trace</code> causes congestion in multi-threaded Partitioned Search
and slows down the <a href="#scoreCalculationSpeed">score calculation speed</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Just like a <code>&lt;solver&gt;</code> element, the <code>&lt;partitionedSearch&gt;</code> element can contain one or more <a href="#solverPhase">phases</a>.
Each of those phases will be run on each partition.</p>
</div>
<div class="paragraph">
<p>A common configuration is to first run a Partitioned Search phase
(which includes a Construction Heuristic and a Local Search)
followed by a non-partitioned Local Search phase:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;partitionedSearch&gt;
    &lt;solutionPartitionerClass&gt;...CloudBalancePartitioner&lt;/solutionPartitionerClass&gt;

    &lt;constructionHeuristic/&gt;
    &lt;localSearch&gt;
      &lt;secondsSpentLimit&gt;60&lt;/secondsSpentLimit&gt;
    &lt;/localSearch&gt;
  &lt;/partitionedSearch&gt;
  &lt;localSearch/&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="partitioningASolution"><a class="anchor" href="#partitioningASolution"></a><a class="link" href="#partitioningASolution">13.3. Partitioning a Solution</a></h3>
<div class="sect3">
<h4 id="customSolutionPartitioner"><a class="anchor" href="#customSolutionPartitioner"></a><a class="link" href="#customSolutionPartitioner">13.3.1. Custom SolutionPartitioner</a></h4>
<div class="paragraph">
<p>To use a custom <code>SolutionPartitioner</code>, configure one on the Partitioned Search phase:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;partitionedSearch&gt;
    &lt;solutionPartitionerClass&gt;org.optaplanner.examples.cloudbalancing.optional.partitioner.CloudBalancePartitioner&lt;/solutionPartitionerClass&gt;
  &lt;/partitionedSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Implement the <code>SolutionPartitioner</code> interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public interface SolutionPartitioner&lt;Solution_&gt; {

    List&lt;Solution_&gt; splitWorkingSolution(ScoreDirector&lt;Solution_&gt; scoreDirector, Integer runnablePartThreadLimit);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>size()</code> of the returned <code>List</code> is the <code>partCount</code> (the number of partitions).
This can be decided dynamically, for example, based on the size of the non-partitioned solution.
The <code>partCount</code> is unrelated to the <code>runnablePartThreadLimit</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class CloudBalancePartitioner implements SolutionPartitioner&lt;CloudBalance&gt; {

    private int partCount = 4;
    private int minimumProcessListSize = 75;

    @Override
    public List&lt;CloudBalance&gt; splitWorkingSolution(ScoreDirector&lt;CloudBalance&gt; scoreDirector, Integer runnablePartThreadLimit) {
        CloudBalance originalSolution = scoreDirector.getWorkingSolution();
        List&lt;CloudComputer&gt; originalComputerList = originalSolution.getComputerList();
        List&lt;CloudProcess&gt; originalProcessList = originalSolution.getProcessList();
        int partCount = this.partCount;
        if (originalProcessList.size() / partCount &lt; minimumProcessListSize) {
            partCount = originalProcessList.size() / minimumProcessListSize;
        }
        List&lt;CloudBalance&gt; partList = new ArrayList&lt;&gt;(partCount);
        for (int i = 0; i &lt; partCount; i++) {
            CloudBalance partSolution = new CloudBalance(originalSolution.getId(),
                    new ArrayList&lt;&gt;(originalComputerList.size() / partCount + 1),
                    new ArrayList&lt;&gt;(originalProcessList.size() / partCount + 1));
            partList.add(partSolution);
        }

        int partIndex = 0;
        Map&lt;Long, Pair&lt;Integer, CloudComputer&gt;&gt; idToPartIndexAndComputerMap = new HashMap&lt;&gt;(originalComputerList.size());
        for (CloudComputer originalComputer : originalComputerList) {
            CloudBalance part = partList.get(partIndex);
            CloudComputer computer = new CloudComputer(
                    originalComputer.getId(),
                    originalComputer.getCpuPower(), originalComputer.getMemory(),
                    originalComputer.getNetworkBandwidth(), originalComputer.getCost());
            part.getComputerList().add(computer);
            idToPartIndexAndComputerMap.put(computer.getId(), Pair.of(partIndex, computer));
            partIndex = (partIndex + 1) % partList.size();
        }

        partIndex = 0;
        for (CloudProcess originalProcess : originalProcessList) {
            CloudBalance part = partList.get(partIndex);
            CloudProcess process = new CloudProcess(
                    originalProcess.getId(),
                    originalProcess.getRequiredCpuPower(), originalProcess.getRequiredMemory(),
                    originalProcess.getRequiredNetworkBandwidth());
            part.getProcessList().add(process);
            if (originalProcess.getComputer() != null) {
                Pair&lt;Integer, CloudComputer&gt; partIndexAndComputer = idToPartIndexAndComputerMap.get(
                        originalProcess.getComputer().getId());
                if (partIndexAndComputer == null) {
                    throw new IllegalStateException("The initialized process (" + originalProcess
                            + ") has a computer (" + originalProcess.getComputer()
                            + ") which doesn't exist in the originalSolution (" + originalSolution + ").");
                }
                if (partIndex != partIndexAndComputer.getLeft().intValue()) {
                    throw new IllegalStateException("The initialized process (" + originalProcess
                            + ") with partIndex (" + partIndex
                            + ") has a computer (" + originalProcess.getComputer()
                            + ") which belongs to another partIndex (" + partIndexAndComputer.getLeft() + ").");
                }
                process.setComputer(partIndexAndComputer.getRight());
            }
            partIndex = (partIndex + 1) % partList.size();
        }
        return partList;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To configure values of a <code>SolutionPartitioner</code> dynamically in the solver configuration
(so the <a href="#benchmarker">Benchmarker</a> can tweak those parameters), use the <code>solutionPartitionerCustomProperties</code> element:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;partitionedSearch&gt;
    &lt;solutionPartitionerClass&gt;...CloudBalancePartitioner&lt;/solutionPartitionerClass&gt;
    &lt;solutionPartitionerCustomProperties&gt;
      &lt;partCount&gt;8&lt;/partCount&gt;
      &lt;minimumProcessListSize&gt;100&lt;/minimumProcessListSize&gt;
    &lt;/solutionPartitionerCustomProperties&gt;
  &lt;/partitionedSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then add a public setter for each custom property, which is called when a <code>Solver</code> is build.
Most value types are supported (including boolean, integers, doubles and strings).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class CloudBalancePartitioner implements SolutionPartitioner&lt;CloudBalance&gt; {

    private int partCount = 4;
    private int minimumProcessListSize = 25;

    @SuppressWarnings("unused")
    public void setPartCount(int partCount) {
        this.partCount = partCount;
    }

    @SuppressWarnings("unused")
    public void setMinimumProcessListSize(int minimumProcessListSize) {
        this.minimumProcessListSize = minimumProcessListSize;
    }

    ...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="runnablePartThreadLimit"><a class="anchor" href="#runnablePartThreadLimit"></a><a class="link" href="#runnablePartThreadLimit">13.4. Runnable Part Thread Limit</a></h3>
<div class="paragraph">
<p>When running a multi-threaded solver, such as Partitioned Search, CPU power can quickly become a scarce resource,
which can cause other processes or threads to hang or freeze.
However, Planner has a system to prevent CPU starving of
other processes (such as an SSH connection in production or your IDE in development)
or other threads (such as the servlet threads that handle REST requests).</p>
</div>
<div class="paragraph">
<p>As explained in <a href="#sizingHardwareAndSoftware">sizing hardware and software</a>,
each solver (including each child solver) does no IO during <code>solve()</code> and therefore saturates one CPU core completely.
In Partitioned Search, every partition always has its own thread, called a part thread.
It is impossible for two partitions to share a thread,
because of <a href="#asynchronousTermination">asynchronous termination</a>: the second thread would never run.
Every part thread will try to consume one CPU core entirely, so if there are more partitions than CPU cores,
this will probably hang the system.
<code>Thread.setPriority()</code> is often too weak to solve this hogging problem, so another approach is used.</p>
</div>
<div class="paragraph">
<p>The <code>runnablePartThreadLimit</code> parameter specifies how many part threads are runnable at the same time.
The other part threads will temporarily block and therefore will not consume any CPU power.
<strong>This parameter basically specifies how many CPU cores are donated to Planner.</strong>
All part threads share the CPU cores in a round-robin manner
to consume (more or less) the same number of CPU cycles:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./PartitionedSearch/partitionedSearchThreading.png" alt="partitionedSearchThreading">
</div>
</div>
<div class="paragraph">
<p>The following <code>runnablePartThreadLimit</code> options are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>UNLIMITED</code>: Allow Planner to occupy all CPU cores, do not avoid hogging.
Useful if a no hogging CPU policy is configured on the OS level.</p>
</li>
<li>
<p><code>AUTO</code> (default): Let Planner decide how many CPU cores to occupy. This formula is based on experience.
It does not hog all CPU cores on a multi-core machine.</p>
</li>
<li>
<p>Static number: The number of CPU cores to consume. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;runnablePartThreadLimit&gt;2&lt;/runnablePartThreadLimit&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>JavaScript formula: Formula for the number of CPU cores to occupy.
It can use the variable <code>availableProcessorCount</code>. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;runnablePartThreadLimit&gt;availableProcessorCount - 2&lt;/runnablePartThreadLimit&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the <code>runnablePartThreadLimit</code> is equal to or higher than the number of available processors,
the host is likely to hang or freeze,
unless there is an OS specific policy in place to avoid Planner from hogging all the CPU processors.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="benchmarker"><a class="anchor" href="#benchmarker"></a><a class="link" href="#benchmarker">14. Benchmarking And Tweaking</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="findTheBestSolverConfiguration"><a class="anchor" href="#findTheBestSolverConfiguration"></a><a class="link" href="#findTheBestSolverConfiguration">14.1. Find The Best <code>Solver</code> Configuration</a></h3>
<div class="paragraph">
<p>Planner supports several optimization algorithms, so you&#8217;re probably wondering which is the best one?
Although some optimization algorithms generally perform better than others, it really depends on your problem domain.
Most solver phases have parameters which can be tweaked.
Those parameters can influence the results a lot, even though most solver phases work pretty well out-of-the-box.</p>
</div>
<div class="paragraph">
<p>Luckily, Planner includes a benchmarker, which allows you to play out different solver phases with different settings
against each other in development, so you can use the best configuration for your planning problem in production.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./BenchmarkingAndTweaking/benchmarkOverview.png" alt="benchmarkOverview">
</div>
</div>
</div>
<div class="sect2">
<h3 id="benchmarkConfiguration"><a class="anchor" href="#benchmarkConfiguration"></a><a class="link" href="#benchmarkConfiguration">14.2. Benchmark Configuration</a></h3>
<div class="sect3">
<h4 id="benchmarker.addDependency"><a class="anchor" href="#benchmarker.addDependency"></a><a class="link" href="#benchmarker.addDependency">14.2.1. Add Dependency On <code>optaplanner-benchmark</code></a></h4>
<div class="paragraph">
<p>The benchmarker is in a separate artifact called <code>optaplanner-benchmark</code>.</p>
</div>
<div class="paragraph">
<p>If you use Maven, add a dependency in your <em class="path">pom.xml</em> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;dependency&gt;
      &lt;groupId&gt;org.optaplanner&lt;/groupId&gt;
      &lt;artifactId&gt;optaplanner-benchmark&lt;/artifactId&gt;
    &lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is similar for Gradle, Ivy and Buildr.
The version must be exactly the same as the <code>optaplanner-core</code> version used (which is automatically the case if you import <code>optaplanner-bom</code>).</p>
</div>
<div class="paragraph">
<p>If you use ANT, you&#8217;ve probably already copied the required jars from the download zip&#8217;s <em class="path">binaries</em>
 directory.</p>
</div>
</div>
<div class="sect3">
<h4 id="buildAndRunAPlannerBenchmark"><a class="anchor" href="#buildAndRunAPlannerBenchmark"></a><a class="link" href="#buildAndRunAPlannerBenchmark">14.2.2. Build And Run A <code>PlannerBenchmark</code></a></h4>
<div class="paragraph">
<p>Build a <code>PlannerBenchmark</code> instance with a <code>PlannerBenchmarkFactory</code>.
Configure it with a benchmark configuration XML file, provided as a classpath resource:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">        PlannerBenchmarkFactory plannerBenchmarkFactory = PlannerBenchmarkFactory.createFromXmlResource(
                "org/optaplanner/examples/nqueens/benchmark/nqueensBenchmarkConfig.xml");
        PlannerBenchmark plannerBenchmark = plannerBenchmarkFactory.buildPlannerBenchmark();
        plannerBenchmark.benchmark();</code></pre>
</div>
</div>
<div class="paragraph">
<p>A benchmark configuration file looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;plannerBenchmark&gt;
  &lt;benchmarkDirectory&gt;local/data/nqueens&lt;/benchmarkDirectory&gt;

  &lt;inheritedSolverBenchmark&gt;
    &lt;problemBenchmarks&gt;
      ...
      &lt;inputSolutionFile&gt;data/nqueens/unsolved/32queens.xml&lt;/inputSolutionFile&gt;
      &lt;inputSolutionFile&gt;data/nqueens/unsolved/64queens.xml&lt;/inputSolutionFile&gt;
    &lt;/problemBenchmarks&gt;
    &lt;solver&gt;
      ...&lt;!-- Common solver configuration --&gt;
    &lt;/solver&gt;
  &lt;/inheritedSolverBenchmark&gt;

  &lt;solverBenchmark&gt;
    &lt;name&gt;Tabu Search&lt;/name&gt;
    &lt;solver&gt;
      ...&lt;!-- Tabu Search specific solver configuration --&gt;
    &lt;/solver&gt;
  &lt;/solverBenchmark&gt;
  &lt;solverBenchmark&gt;
    &lt;name&gt;Simulated Annealing&lt;/name&gt;
    &lt;solver&gt;
      ...&lt;!-- Simulated Annealing specific solver configuration --&gt;
    &lt;/solver&gt;
  &lt;/solverBenchmark&gt;
  &lt;solverBenchmark&gt;
    &lt;name&gt;Late Acceptance&lt;/name&gt;
    &lt;solver&gt;
      ...&lt;!-- Late Acceptance specific solver configuration --&gt;
    &lt;/solver&gt;
  &lt;/solverBenchmark&gt;
&lt;/plannerBenchmark&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This <code>PlannerBenchmark</code> will try three configurations (Tabu Search, Simulated Annealing and Late Acceptance) on two data sets (32queens and 64queens), so it will run six solvers.</p>
</div>
<div class="paragraph">
<p>Every <code>&lt;solverBenchmark&gt;</code> element contains a solver configuration and one or more <code>&lt;inputSolutionFile&gt;</code> elements.
It will run the solver configuration on each of those unsolved solution files.
The element <code>name</code> is optional, because it is generated if absent.
The <code>inputSolutionFile</code> is read by a <a href="#solutionFileIO">SolutionFileIO</a> (relative to the working directory).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Use a forward slash (<code>/</code>) as the file separator (for example in the element <code>&lt;inputSolutionFile&gt;</code>). That will work on any platform (including Windows).</p>
</div>
<div class="paragraph">
<p>Do not use backslash (<code>\</code>) as the file separator: that breaks portability because it does not work on Linux and Mac.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The benchmark report will be written in the directory specified the <code>&lt;benchmarkDirectory&gt;</code> element (relative to the working directory).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It&#8217;s recommended that the <code>benchmarkDirectory</code> is a directory ignored for source control and not cleaned by your build system.
This way the generated files are not bloating your source control and they aren&#8217;t lost when doing a build.
Usually that directory is called <code>local</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If an <code>Exception</code> or <code>Error</code> occurs in a single benchmark, the entire Benchmarker will not fail-fast (unlike everything else in Planner).
Instead, the Benchmarker will continue to run all other benchmarks, write the benchmark report and then fail (if there is at least one failing single benchmark).
The failing benchmarks will be clearly marked as such in the benchmark report.</p>
</div>
<div class="sect4">
<h5 id="inheritedSolverBenchmark"><a class="anchor" href="#inheritedSolverBenchmark"></a><a class="link" href="#inheritedSolverBenchmark">14.2.2.1. Inherited solver benchmark</a></h5>
<div class="paragraph">
<p>To lower verbosity, the common parts of multiple <code>&lt;solverBenchmark&gt;</code> elements are extracted to the <code>&lt;inheritedSolverBenchmark&gt;</code> element.
Every property can still be overwritten per <code>&lt;solverBenchmark&gt;</code> element.
Note that inherited solver phases such as <code>&lt;constructionHeuristic&gt;</code> or <code>&lt;localSearch&gt;</code> are not overwritten
but instead are added to the tail of the solver phases list.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="solutionFileIO"><a class="anchor" href="#solutionFileIO"></a><a class="link" href="#solutionFileIO">14.2.3. SolutionFileIO: Input And Output Of Solution Files</a></h4>
<div class="sect4">
<h5 id="solutionFileIOInterface"><a class="anchor" href="#solutionFileIOInterface"></a><a class="link" href="#solutionFileIOInterface">14.2.3.1. <code>SolutionFileIO</code> Interface</a></h5>
<div class="paragraph">
<p>The benchmarker needs to be able to read the input files to load a <code>Solution</code>.
Also, it optionally writes the best <code>Solution</code> of each benchmark to an output file.
It does that through the <code>SolutionFileIO</code> interface which has a read and write method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public interface SolutionFileIO&lt;Solution_&gt; {
    ...

    Solution_ read(File inputSolutionFile);
    void write(Solution_ solution, File outputSolutionFile);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>SolutionFileIO</code> interface is in the <code>optaplanner-persistence-common</code> jar (which is a dependency of the <code>optaplanner-benchmark</code> jar).
There are several ways to serialize a solution:</p>
</div>
</div>
<div class="sect4">
<h5 id="xStreamSolutionFileIO"><a class="anchor" href="#xStreamSolutionFileIO"></a><a class="link" href="#xStreamSolutionFileIO">14.2.3.2. <code>XStreamSolutionFileIO</code>: Serialize To And From An XML Format</a></h5>
<div class="paragraph">
<p>To use the <code>XStreamSolutionFileIO</code> instance to read and write solutions, just configure your <code>Solution</code> class as an <code>xStreamAnnotatedClass</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;problemBenchmarks&gt;
      &lt;xStreamAnnotatedClass&gt;org.optaplanner.examples.nqueens.domain.NQueens&lt;/xStreamAnnotatedClass&gt;
      &lt;inputSolutionFile&gt;data/nqueens/unsolved/32queens.xml&lt;/inputSolutionFile&gt;
      ...
    &lt;/problemBenchmarks&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Those input files need to have been written with a <code>XStreamSolutionFileIO</code> instance, not just any <code>XStream</code> instance,
because the <code>XStreamSolutionFileIO</code> uses a customized <code>XStream</code> instance.
Add XStream annotations (such as <code>@XStreamAlias</code>) on your domain classes to use a less verbose XML format.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>XML is a very verbose format.
Reading or writing large datasets in this format can cause an <code>OutOfMemoryError</code>, <code>StackOverflowError</code> or large performance degradation.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="customSolutionFileIO"><a class="anchor" href="#customSolutionFileIO"></a><a class="link" href="#customSolutionFileIO">14.2.3.3. Custom <code>SolutionFileIO</code>: Serialize To And From A Custom Format</a></h5>
<div class="paragraph">
<p>Implement your own <code>SolutionFileIO</code> implementation and configure it with the <code>solutionFileIOClass</code> element to write to a custom format (such as a txt or a binary format):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;problemBenchmarks&gt;
      &lt;solutionFileIOClass&gt;org.optaplanner.examples.machinereassignment.persistence.MachineReassignmentFileIO&lt;/solutionFileIOClass&gt;
      &lt;inputSolutionFile&gt;data/machinereassignment/import/model_a1_1.txt&lt;/inputSolutionFile&gt;
      ...
    &lt;/problemBenchmarks&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s recommended that output files can be read as input files,
which implies that <code>getInputFileExtension()</code> and <code>getOutputFileExtension()</code> return the same value.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A <code>SolutionFileIO</code> implementation must be thread-safe.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="readingAnInputSolutionFromADatabase"><a class="anchor" href="#readingAnInputSolutionFromADatabase"></a><a class="link" href="#readingAnInputSolutionFromADatabase">14.2.3.4. Reading An Input Solution From A Database (Or Other Repository)</a></h5>
<div class="paragraph">
<p>The benchmark configuration currently expects an <code>&lt;inputSolutionFile&gt;</code> element, so a separate file, for each dataset.
There are two ways to deal with this if your dataset is in a relational database or another type of repository:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Extract the datasets from the database and serialize them to a local file (for example as XML with <code>XStreamSolutionFileIO</code> if XML isn&#8217;t too verbose).
Then use those files an <code>&lt;inputSolutionFile&gt;</code> elements.</p>
</li>
<li>
<p>For each dataset, create a txt file that holds the unique id of the dataset.
Write <a href="#customSolutionFileIO">a custom <code>SolutionFileIO</code></a> that reads that identifier, connects to the database and extract the problem identified by that id. Configure those txt files as <code>&lt;inputSolutionFile&gt;</code> elements.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Local files are always better: they allow for faster, more reliable, offline benchmarking.
Otherwise, an unstable network connection can ruin a long running benchmark.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="warmingUpTheHotSpotCompiler"><a class="anchor" href="#warmingUpTheHotSpotCompiler"></a><a class="link" href="#warmingUpTheHotSpotCompiler">14.2.4. Warming Up The HotSpot Compiler</a></h4>
<div class="paragraph">
<p>Without a warm up, the results of the first (or first few) benchmarks are not reliable,
because they will lose CPU time on HotSpot JIT compilation (and possibly DRL compilation too).</p>
</div>
<div class="paragraph">
<p>To avoid that distortion, the benchmarker runs some of the benchmarks for 30 seconds,
before running the real benchmarks.
That default warm up of 30 seconds usually suffices. Change it, for example to give it 60 seconds:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;plannerBenchmark&gt;
  ...
  &lt;warmUpSecondsSpentLimit&gt;60&lt;/warmUpSecondsSpentLimit&gt;
  ...
&lt;/plannerBenchmark&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Turn off the warm up phase altogether by setting it to zero:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;plannerBenchmark&gt;
  ...
  &lt;warmUpSecondsSpentLimit&gt;0&lt;/warmUpSecondsSpentLimit&gt;
  ...
&lt;/plannerBenchmark&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The warm up time budget does not include the time it takes to load the datasets.
With large datasets, this can cause the warm up to run considerably longer than specified in the configuration.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkBlueprint"><a class="anchor" href="#benchmarkBlueprint"></a><a class="link" href="#benchmarkBlueprint">14.2.5. Benchmark Blueprint: A Predefined Configuration</a></h4>
<div class="paragraph">
<p>To quickly configure and run a benchmark for typical solver configs, use a <code>solverBenchmarkBluePrint</code> instead of <code>solverBenchmark</code>s:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;plannerBenchmark&gt;
  &lt;benchmarkDirectory&gt;local/data/nqueens&lt;/benchmarkDirectory&gt;

  &lt;inheritedSolverBenchmark&gt;
    &lt;problemBenchmarks&gt;
      &lt;xStreamAnnotatedClass&gt;org.optaplanner.examples.nqueens.domain.NQueens&lt;/xStreamAnnotatedClass&gt;
      &lt;inputSolutionFile&gt;data/nqueens/unsolved/32queens.xml&lt;/inputSolutionFile&gt;
      &lt;inputSolutionFile&gt;data/nqueens/unsolved/64queens.xml&lt;/inputSolutionFile&gt;
      &lt;problemStatisticType&gt;BEST_SCORE&lt;/problemStatisticType&gt;
    &lt;/problemBenchmarks&gt;
    &lt;solver&gt;
      &lt;scanAnnotatedClasses/&gt;
      &lt;scoreDirectorFactory&gt;
        &lt;scoreDrl&gt;org/optaplanner/examples/nqueens/solver/nQueensScoreRules.drl&lt;/scoreDrl&gt;
        &lt;initializingScoreTrend&gt;ONLY_DOWN&lt;/initializingScoreTrend&gt;
      &lt;/scoreDirectorFactory&gt;
      &lt;termination&gt;
        &lt;minutesSpentLimit&gt;1&lt;/minutesSpentLimit&gt;
      &lt;/termination&gt;
    &lt;/solver&gt;
  &lt;/inheritedSolverBenchmark&gt;

  &lt;solverBenchmarkBluePrint&gt;
    &lt;solverBenchmarkBluePrintType&gt;EVERY_CONSTRUCTION_HEURISTIC_TYPE_WITH_EVERY_LOCAL_SEARCH_TYPE&lt;/solverBenchmarkBluePrintType&gt;
  &lt;/solverBenchmarkBluePrint&gt;
&lt;/plannerBenchmark&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following <code>SolverBenchmarkBluePrintType</code>s are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>EVERY_CONSTRUCTION_HEURISTIC_TYPE</code>: Run every Construction Heuristic type (First Fit, First Fit Decreasing, Cheapest Insertion, &#8230;&#8203;).</p>
</li>
<li>
<p><code>EVERY_LOCAL_SEARCH_TYPE</code>: Run every Local Search type (Tabu Search, Late Acceptance, &#8230;&#8203;) with the default Construction Heuristic.</p>
</li>
<li>
<p><code>EVERY_CONSTRUCTION_HEURISTIC_TYPE_WITH_EVERY_LOCAL_SEARCH_TYPE</code>: Run every Construction Heuristic type with every Local Search type.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="writeTheOutputSolutionOfBenchmarkRuns"><a class="anchor" href="#writeTheOutputSolutionOfBenchmarkRuns"></a><a class="link" href="#writeTheOutputSolutionOfBenchmarkRuns">14.2.6. Write The Output Solution Of Benchmark Runs</a></h4>
<div class="paragraph">
<p>The best solution of each benchmark run can be written in the <code>benchmarkDirectory</code>.
By default, this is disabled, because the files are rarely used and considered bloat.
Also, on large datasets, writing the best solution of each single benchmark can take quite some time and memory (causing an <code>OutOfMemoryError</code>), especially in a verbose format like XStream XML.</p>
</div>
<div class="paragraph">
<p>To write those solutions in the <code>benchmarkDirectory</code>, enable <code>writeOutputSolutionEnabled</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;problemBenchmarks&gt;
      ...
      &lt;writeOutputSolutionEnabled&gt;true&lt;/writeOutputSolutionEnabled&gt;
      ...
    &lt;/problemBenchmarks&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkLogging"><a class="anchor" href="#benchmarkLogging"></a><a class="link" href="#benchmarkLogging">14.2.7. Benchmark Logging</a></h4>
<div class="paragraph">
<p>Benchmark logging is configured like <a href="#logging">solver logging</a>.</p>
</div>
<div class="paragraph">
<p>To separate the log messages of each single benchmark run into a separate file, use the <a href="http://logback.qos.ch/manual/mdc.html">MDC</a> with key <code>singleBenchmark.name</code> in a sifting appender.
For example with Logback in <code>logback.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;appender name="fileAppender" class="ch.qos.logback.classic.sift.SiftingAppender"&gt;
    &lt;discriminator&gt;
      &lt;key&gt;singleBenchmark.name&lt;/key&gt;
      &lt;defaultValue&gt;app&lt;/defaultValue&gt;
    &lt;/discriminator&gt;
    &lt;sift&gt;
      &lt;appender name="fileAppender.${singleBenchmark.name}" class="...FileAppender"&gt;
        &lt;file&gt;local/log/optaplannerBenchmark-${singleBenchmark.name}.log&lt;/file&gt;
        ...
      &lt;/appender&gt;
    &lt;/sift&gt;
  &lt;/appender&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="benchmarkReport"><a class="anchor" href="#benchmarkReport"></a><a class="link" href="#benchmarkReport">14.3. Benchmark Report</a></h3>
<div class="sect3">
<h4 id="benchmarkHtmlReport"><a class="anchor" href="#benchmarkHtmlReport"></a><a class="link" href="#benchmarkHtmlReport">14.3.1. HTML Report</a></h4>
<div class="paragraph">
<p>After running a benchmark, an HTML report will be written in the <code>benchmarkDirectory</code> with the <em class="path">index.html</em>
 filename.
Open it in your browser.
It has a nice overview of your benchmark including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Summary statistics: graphs and tables</p>
</li>
<li>
<p>Problem statistics per <code>inputSolutionFile</code>: graphs and CSV</p>
</li>
<li>
<p>Each solver configuration (ranked): Handy to copy and paste</p>
</li>
<li>
<p>Benchmark information: settings, hardware, &#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Graphs are generated by the excellent <a href="http://www.jfree.org/jfreechart/">JFreeChart</a> library.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The HTML report will use your default locale to format numbers.
If you share the benchmark report with people from another country, consider overwriting the <code>locale</code> accordingly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;plannerBenchmark&gt;
  ...
  &lt;benchmarkReport&gt;
    &lt;locale&gt;en_US&lt;/locale&gt;
  &lt;/benchmarkReport&gt;
  ...
&lt;/plannerBenchmark&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="rankingTheSolvers"><a class="anchor" href="#rankingTheSolvers"></a><a class="link" href="#rankingTheSolvers">14.3.2. Ranking The <code>Solver</code>s</a></h4>
<div class="paragraph">
<p>The benchmark report automatically ranks the solvers.
The <code>Solver</code> with rank <code>0</code> is called the favorite <code>Solver</code>: it performs best overall, but it might not be the best on every problem.
It&#8217;s recommended to use that favorite <code>Solver</code> in production.</p>
</div>
<div class="paragraph">
<p>However, there are different ways of ranking the solvers.
Configure it like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;plannerBenchmark&gt;
  ...
  &lt;benchmarkReport&gt;
    &lt;solverRankingType&gt;TOTAL_SCORE&lt;/solverRankingType&gt;
  &lt;/benchmarkReport&gt;
  ...
&lt;/plannerBenchmark&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following <code>solverRankingType</code>s are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>TOTAL_SCORE</code> (default): Maximize the overall score, so minimize the overall cost if all solutions would be executed.</p>
</li>
<li>
<p><code>WORST_SCORE</code>: Minimize the worst case scenario.</p>
</li>
<li>
<p><code>TOTAL_RANKING</code>: Maximize the overall ranking. Use this if your datasets differ greatly in size or difficulty, producing a difference in <code>Score</code> magnitude.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>Solver</code>s with at least one failed single benchmark do not get a ranking.
<code>Solver</code>s with not fully initialized solutions are ranked worse.</p>
</div>
<div class="paragraph">
<p>To use a custom ranking, implement a <code>Comparator</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;benchmarkReport&gt;
    &lt;solverRankingComparatorClass&gt;...TotalScoreSolverRankingComparator&lt;/solverRankingComparatorClass&gt;
  &lt;/benchmarkReport&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or by implementing a weight factory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">  &lt;benchmarkReport&gt;
    &lt;solverRankingWeightFactoryClass&gt;...TotalRankSolverRankingWeightFactory&lt;/solverRankingWeightFactoryClass&gt;
  &lt;/benchmarkReport&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="benchmarkReportSummaryStatistics"><a class="anchor" href="#benchmarkReportSummaryStatistics"></a><a class="link" href="#benchmarkReportSummaryStatistics">14.4. Summary Statistics</a></h3>
<div class="sect3">
<h4 id="benchmarkReportBestScoreSummary"><a class="anchor" href="#benchmarkReportBestScoreSummary"></a><a class="link" href="#benchmarkReportBestScoreSummary">14.4.1. Best Score Summary (Graph And Table)</a></h4>
<div class="paragraph">
<p>Shows the best score per <code>inputSolutionFile</code> for each solver configuration.</p>
</div>
<div class="paragraph">
<p>Useful for visualizing the best solver configuration.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./BenchmarkingAndTweaking/bestScoreSummary.png" alt="bestScoreSummary">
</div>
<div class="title">Figure 9. Best Score Summary Statistic</div>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportBestScoreScalabilitySummary"><a class="anchor" href="#benchmarkReportBestScoreScalabilitySummary"></a><a class="link" href="#benchmarkReportBestScoreScalabilitySummary">14.4.2. Best Score Scalability Summary (Graph)</a></h4>
<div class="paragraph">
<p>Shows the best score per problem scale for each solver configuration.</p>
</div>
<div class="paragraph">
<p>Useful for visualizing the scalability of each solver configuration.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The problem scale will report <code>0</code> if any <code>@ValueRangeProvider</code> method signature returns ValueRange (instead of <code>CountableValueRange</code> or <code>Collection</code>).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportBestScoreDistributionSummary"><a class="anchor" href="#benchmarkReportBestScoreDistributionSummary"></a><a class="link" href="#benchmarkReportBestScoreDistributionSummary">14.4.3. Best Score Distribution Summary (Graph)</a></h4>
<div class="paragraph">
<p>Shows the best score distribution per <code>inputSolutionFile</code> for each solver configuration.</p>
</div>
<div class="paragraph">
<p>Useful for visualizing the reliability of each solver configuration.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./BenchmarkingAndTweaking/bestScoreDistributionSummary.png" alt="bestScoreDistributionSummary">
</div>
<div class="title">Figure 10. Best Score Distribution Summary Statistic</div>
</div>
<div class="paragraph">
<p>Enable <a href="#statisticalBenchmarking">statistical benchmarking</a> to use this summary.</p>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportWinningScoreDifferenceSummary"><a class="anchor" href="#benchmarkReportWinningScoreDifferenceSummary"></a><a class="link" href="#benchmarkReportWinningScoreDifferenceSummary">14.4.4. Winning Score Difference Summary (Graph And Table)</a></h4>
<div class="paragraph">
<p>Shows the winning score difference per <code>inputSolutionFile</code> for each solver configuration.
The winning score difference is the score difference with the score of the winning solver configuration for that particular <code>inputSolutionFile</code>.</p>
</div>
<div class="paragraph">
<p>Useful for zooming in on the results of the best score summary.</p>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportWorstScoreDifferencePercentageSummary"><a class="anchor" href="#benchmarkReportWorstScoreDifferencePercentageSummary"></a><a class="link" href="#benchmarkReportWorstScoreDifferencePercentageSummary">14.4.5. Worst Score Difference Percentage (ROI) Summary (Graph and Table)</a></h4>
<div class="paragraph">
<p>Shows the return on investment (ROI) per <code>inputSolutionFile</code> for each solver configuration if you&#8217;d upgrade from the worst solver configuration for that particular <code>inputSolutionFile</code>.</p>
</div>
<div class="paragraph">
<p>Useful for visualizing the return on investment (ROI) to decision makers.</p>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportScoreCalculationSpeedSummary"><a class="anchor" href="#benchmarkReportScoreCalculationSpeedSummary"></a><a class="link" href="#benchmarkReportScoreCalculationSpeedSummary">14.4.6. Score Calculation Speed Summary (Graph and Table)</a></h4>
<div class="paragraph">
<p>Shows the score calculation speed: a count per second per problem scale for each solver configuration.</p>
</div>
<div class="paragraph">
<p>Useful for comparing different score calculators and/or score rule implementations (presuming that the solver configurations do not differ otherwise). Also useful to measure the scalability cost of an extra constraint.</p>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportTimeSpentSummary"><a class="anchor" href="#benchmarkReportTimeSpentSummary"></a><a class="link" href="#benchmarkReportTimeSpentSummary">14.4.7. Time Spent Summary (Graph And Table)</a></h4>
<div class="paragraph">
<p>Shows the time spent per <code>inputSolutionFile</code> for each solver configuration.
This is pointless if it&#8217;s benchmarking against a fixed time limit.</p>
</div>
<div class="paragraph">
<p>Useful for visualizing the performance of construction heuristics (presuming that no other solver phases are configured).</p>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportTimeSpentScalabilitySummary"><a class="anchor" href="#benchmarkReportTimeSpentScalabilitySummary"></a><a class="link" href="#benchmarkReportTimeSpentScalabilitySummary">14.4.8. Time Spent Scalability Summary (Graph)</a></h4>
<div class="paragraph">
<p>Shows the time spent per problem scale for each solver configuration.
This is pointless if it&#8217;s benchmarking against a fixed time limit.</p>
</div>
<div class="paragraph">
<p>Useful for extrapolating the scalability of construction heuristics (presuming that no other solver phases are configured).</p>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportBestScorePerTimeSpentSummary"><a class="anchor" href="#benchmarkReportBestScorePerTimeSpentSummary"></a><a class="link" href="#benchmarkReportBestScorePerTimeSpentSummary">14.4.9. Best Score Per Time Spent Summary (Graph)</a></h4>
<div class="paragraph">
<p>Shows the best score per time spent for each solver configuration.
This is pointless if it&#8217;s benchmarking against a fixed time limit.</p>
</div>
<div class="paragraph">
<p>Useful for visualizing trade-off between the best score versus the time spent for construction heuristics (presuming that no other solver phases are configured).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="benchmarkReportStatisticPerDataset"><a class="anchor" href="#benchmarkReportStatisticPerDataset"></a><a class="link" href="#benchmarkReportStatisticPerDataset">14.5. Statistic Per Dataset (Graph And CSV)</a></h3>
<div class="sect3">
<h4 id="enableAProblemStatistic"><a class="anchor" href="#enableAProblemStatistic"></a><a class="link" href="#enableAProblemStatistic">14.5.1. Enable A Problem Statistic</a></h4>
<div class="paragraph">
<p>The benchmarker supports outputting problem statistics as graphs and CSV (comma separated values) files to the <code>benchmarkDirectory</code>.
To configure one, add a <code>problemStatisticType</code> line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;plannerBenchmark&gt;
  &lt;benchmarkDirectory&gt;local/data/nqueens/solved&lt;/benchmarkDirectory&gt;
  &lt;inheritedSolverBenchmark&gt;
    &lt;problemBenchmarks&gt;
      ...
      &lt;problemStatisticType&gt;BEST_SCORE&lt;/problemStatisticType&gt;
      &lt;problemStatisticType&gt;SCORE_CALCULATION_SPEED&lt;/problemStatisticType&gt;
    &lt;/problemBenchmarks&gt;
    ...
  &lt;/inheritedSolverBenchmark&gt;
  ...
&lt;/plannerBenchmark&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Multiple <code>problemStatisticType</code> elements are allowed.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>These statistic per dataset can slow down the solver noticeably, which affects the benchmark results.
That&#8217;s why they are optional and not enabled by default.</p>
</div>
<div class="paragraph">
<p>The non-optional summary statistics cannot slow down the solver noticeably.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following types are supported:</p>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportBestScoreOverTimeStatistic"><a class="anchor" href="#benchmarkReportBestScoreOverTimeStatistic"></a><a class="link" href="#benchmarkReportBestScoreOverTimeStatistic">14.5.2. Best Score Over Time Statistic (Graph And CSV)</a></h4>
<div class="paragraph">
<p>To see how the best score evolves over time, add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;problemBenchmarks&gt;
      ...
      &lt;problemStatisticType&gt;BEST_SCORE&lt;/problemStatisticType&gt;
    &lt;/problemBenchmarks&gt;</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./BenchmarkingAndTweaking/bestScoreStatistic.png" alt="bestScoreStatistic">
</div>
<div class="title">Figure 11. Best Score Over Time Statistic</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A time gradient based algorithm (such as Simulated Annealing) will have a different statistic if it&#8217;s run with a different time limit configuration.
That&#8217;s because this Simulated Annealing implementation automatically determines its velocity based on the amount of time that can be spent.
On the other hand, for the Tabu Search and Late Annealing, what you see is what you&#8217;d get.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>The best score over time statistic is very useful to detect abnormalities, such as a
potential <a href="#scoreTrap">score trap</a> which gets the solver temporarily stuck in a local optima.</strong></p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./BenchmarkingAndTweaking/letTheBestScoreStatisticGuideYou.png" alt="letTheBestScoreStatisticGuideYou">
</div>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportStepScoreOverTimeStatistic"><a class="anchor" href="#benchmarkReportStepScoreOverTimeStatistic"></a><a class="link" href="#benchmarkReportStepScoreOverTimeStatistic">14.5.3. Step Score Over Time Statistic (Graph And CSV)</a></h4>
<div class="paragraph">
<p>To see how the step score evolves over time, add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;problemBenchmarks&gt;
      ...
      &lt;problemStatisticType&gt;STEP_SCORE&lt;/problemStatisticType&gt;
    &lt;/problemBenchmarks&gt;</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./BenchmarkingAndTweaking/stepScoreStatistic.png" alt="stepScoreStatistic">
</div>
<div class="title">Figure 12. Step Score Over Time Statistic</div>
</div>
<div class="paragraph">
<p>Compare the step score statistic with the best score statistic (especially on parts for which the best score flatlines). If it hits a local optima, the solver should take deteriorating steps to escape it.
But it shouldn&#8217;t deteriorate too much either.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The step score statistic has been seen to slow down the solver noticeably due to GC stress, especially for fast stepping algorithms (such as Simulated Annealing and Late Acceptance).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportScoreCalculationSpeedtatistic"><a class="anchor" href="#benchmarkReportScoreCalculationSpeedtatistic"></a><a class="link" href="#benchmarkReportScoreCalculationSpeedtatistic">14.5.4. Score Calculation Speed Statistic (Graph And CSV)</a></h4>
<div class="paragraph">
<p>To see how fast the scores are calculated, add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;problemBenchmarks&gt;
      ...
      &lt;problemStatisticType&gt;SCORE_CALCULATION_SPEED&lt;/problemStatisticType&gt;
    &lt;/problemBenchmarks&gt;</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./BenchmarkingAndTweaking/scoreCalculationSpeedStatistic.png" alt="scoreCalculationSpeedStatistic">
</div>
<div class="title">Figure 13. Score Calculation Speed Statistic</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The initial high calculation speed is typical during solution initialization: it&#8217;s far easier to calculate the score of a solution if only a handful planning entities have been initialized, than when all the planning entities are initialized.</p>
</div>
<div class="paragraph">
<p>After those few seconds of initialization, the calculation speed is relatively stable, apart from an occasional stop-the-world garbage collector disruption.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportBestSolutionMutationOverTimeStatistic"><a class="anchor" href="#benchmarkReportBestSolutionMutationOverTimeStatistic"></a><a class="link" href="#benchmarkReportBestSolutionMutationOverTimeStatistic">14.5.5. Best Solution Mutation Over Time Statistic (Graph And CSV)</a></h4>
<div class="paragraph">
<p>To see how much each new best solution differs from the <em>previous best solution</em>, by counting the number of planning variables which have a different value (not including the variables that have changed multiple times but still end up with the same value), add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;problemBenchmarks&gt;
      ...
      &lt;problemStatisticType&gt;BEST_SOLUTION_MUTATION&lt;/problemStatisticType&gt;
    &lt;/problemBenchmarks&gt;</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./BenchmarkingAndTweaking/bestSolutionMutationStatistic.png" alt="bestSolutionMutationStatistic">
</div>
<div class="title">Figure 14. Best Solution Mutation Over Time Statistic</div>
</div>
<div class="paragraph">
<p>Use Tabu Search - an algorithm that behaves like a human - to get an estimation on how difficult it would be for a human to improve the previous best solution to that new best solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportMoveCountPerStepStatistic"><a class="anchor" href="#benchmarkReportMoveCountPerStepStatistic"></a><a class="link" href="#benchmarkReportMoveCountPerStepStatistic">14.5.6. Move Count Per Step Statistic (Graph And CSV)</a></h4>
<div class="paragraph">
<p>To see how the selected and accepted move count per step evolves over time, add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;problemBenchmarks&gt;
      ...
      &lt;problemStatisticType&gt;MOVE_COUNT_PER_STEP&lt;/problemStatisticType&gt;
    &lt;/problemBenchmarks&gt;</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./BenchmarkingAndTweaking/moveCountPerStepStatistic.png" alt="moveCountPerStepStatistic">
</div>
<div class="title">Figure 15. Move Count Per Step Statistic</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This statistic has been seen to slow down the solver noticeably due to GC stress, especially for fast stepping algorithms (such as Simulated Annealing and Late Acceptance).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportMemoryUseStatistic"><a class="anchor" href="#benchmarkReportMemoryUseStatistic"></a><a class="link" href="#benchmarkReportMemoryUseStatistic">14.5.7. Memory Use Statistic (Graph And CSV)</a></h4>
<div class="paragraph">
<p>To see how much memory is used, add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;problemBenchmarks&gt;
      ...
      &lt;problemStatisticType&gt;MEMORY_USE&lt;/problemStatisticType&gt;
    &lt;/problemBenchmarks&gt;</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./BenchmarkingAndTweaking/memoryUseStatistic.png" alt="memoryUseStatistic">
</div>
<div class="title">Figure 16. Memory Use Statistic</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The memory use statistic has been seen to affect the solver noticeably.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="benchmarkReportStatisticPerSingleBenchmark"><a class="anchor" href="#benchmarkReportStatisticPerSingleBenchmark"></a><a class="link" href="#benchmarkReportStatisticPerSingleBenchmark">14.6. Statistic Per Single Benchmark (Graph And CSV)</a></h3>
<div class="sect3">
<h4 id="enableASingleStatistic"><a class="anchor" href="#enableASingleStatistic"></a><a class="link" href="#enableASingleStatistic">14.6.1. Enable A Single Statistic</a></h4>
<div class="paragraph">
<p>A single statistic is a statics for one dataset for one solver configuration.
Unlike a problem statistic, it does not aggregate over solver configurations.</p>
</div>
<div class="paragraph">
<p>The benchmarker supports outputting single statistics as graphs and CSV (comma separated values) files to the <code>benchmarkDirectory</code>.
To configure one, add a <code>singleStatisticType</code> line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;plannerBenchmark&gt;
  &lt;benchmarkDirectory&gt;local/data/nqueens/solved&lt;/benchmarkDirectory&gt;
  &lt;inheritedSolverBenchmark&gt;
    &lt;problemBenchmarks&gt;
      ...
      &lt;problemStatisticType&gt;...&lt;/problemStatisticType&gt;
      &lt;singleStatisticType&gt;PICKED_MOVE_TYPE_BEST_SCORE_DIFF&lt;/singleStatisticType&gt;
    &lt;/problemBenchmarks&gt;
    ...
  &lt;/inheritedSolverBenchmark&gt;
  ...
&lt;/plannerBenchmark&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Multiple <code>singleStatisticType</code> elements are allowed.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>These statistic per single benchmark can slow down the solver noticeably, which affects the benchmark results.
That&#8217;s why they are optional and not enabled by default.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following types are supported:</p>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportConstraintMatchTotalBestScoreOverTimeStatistic"><a class="anchor" href="#benchmarkReportConstraintMatchTotalBestScoreOverTimeStatistic"></a><a class="link" href="#benchmarkReportConstraintMatchTotalBestScoreOverTimeStatistic">14.6.2. Constraint Match Total Best Score Over Time Statistic (Graph And CSV)</a></h4>
<div class="paragraph">
<p>To see which constraints are matched in the best score (and how much) over time, add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;problemBenchmarks&gt;
      ...
      &lt;singleStatisticType&gt;CONSTRAINT_MATCH_TOTAL_BEST_SCORE&lt;/singleStatisticType&gt;
    &lt;/problemBenchmarks&gt;</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./BenchmarkingAndTweaking/constraintMatchTotalBestScoreStatistic.png" alt="constraintMatchTotalBestScoreStatistic">
</div>
<div class="title">Figure 17. Constraint Match Total Best Score Diff Over Time Statistic</div>
</div>
<div class="paragraph">
<p>Requires the score calculation to support <a href="#explainingTheScore">constraint matches</a>. <a href="#droolsScoreCalculation">Drools score calculation</a> supports constraint matches automatically, but <a href="#incrementalJavaScoreCalculation">incremental Java score calculation</a> requires more work.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The constraint match total statistics has been seen to affect the solver noticeably.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportConstraintMatchTotalStepScoreOverTimeStatistic"><a class="anchor" href="#benchmarkReportConstraintMatchTotalStepScoreOverTimeStatistic"></a><a class="link" href="#benchmarkReportConstraintMatchTotalStepScoreOverTimeStatistic">14.6.3. Constraint Match Total Step Score Over Time Statistic (Graph And CSV)</a></h4>
<div class="paragraph">
<p>To see which constraints are matched in the step score (and how much) over time, add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;problemBenchmarks&gt;
      ...
      &lt;singleStatisticType&gt;CONSTRAINT_MATCH_TOTAL_STEP_SCORE&lt;/singleStatisticType&gt;
    &lt;/problemBenchmarks&gt;</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./BenchmarkingAndTweaking/constraintMatchTotalStepScoreStatistic.png" alt="constraintMatchTotalStepScoreStatistic">
</div>
<div class="title">Figure 18. Constraint Match Total Step Score Diff Over Time Statistic</div>
</div>
<div class="paragraph">
<p>Requires the score calculation to support <a href="#explainingTheScore">constraint matches</a>. <a href="#droolsScoreCalculation">Drools score calculation</a> supports constraint matches automatically, but <a href="#incrementalJavaScoreCalculation">incremental Java score calculation</a> requires more work.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The constraint match total statistics has been seen to affect the solver noticeably.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportPickedMoveTypeBestScoreDiffOverTimeStatistic"><a class="anchor" href="#benchmarkReportPickedMoveTypeBestScoreDiffOverTimeStatistic"></a><a class="link" href="#benchmarkReportPickedMoveTypeBestScoreDiffOverTimeStatistic">14.6.4. Picked Move Type Best Score Diff Over Time Statistic (Graph And CSV)</a></h4>
<div class="paragraph">
<p>To see which move types improve the best score (and how much) over time, add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;problemBenchmarks&gt;
      ...
      &lt;singleStatisticType&gt;PICKED_MOVE_TYPE_BEST_SCORE_DIFF&lt;/singleStatisticType&gt;
    &lt;/problemBenchmarks&gt;</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./BenchmarkingAndTweaking/pickedMoveTypeBestScoreDiffStatistic.png" alt="pickedMoveTypeBestScoreDiffStatistic">
</div>
<div class="title">Figure 19. Picked Move Type Best Score Diff Over Time Statistic</div>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportPickedMoveTypeStepScoreDiffOverTimeStatistic"><a class="anchor" href="#benchmarkReportPickedMoveTypeStepScoreDiffOverTimeStatistic"></a><a class="link" href="#benchmarkReportPickedMoveTypeStepScoreDiffOverTimeStatistic">14.6.5. Picked Move Type Step Score Diff Over Time Statistic (Graph And CSV)</a></h4>
<div class="paragraph">
<p>To see how much each winning step affects the step score over time, add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">    &lt;problemBenchmarks&gt;
      ...
      &lt;singleStatisticType&gt;PICKED_MOVE_TYPE_STEP_SCORE_DIFF&lt;/singleStatisticType&gt;
    &lt;/problemBenchmarks&gt;</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./BenchmarkingAndTweaking/pickedMoveTypeStepScoreDiffStatistic.png" alt="pickedMoveTypeStepScoreDiffStatistic">
</div>
<div class="title">Figure 20. Picked Move Type Step Score Diff Over Time Statistic</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="advancedBenchmarking"><a class="anchor" href="#advancedBenchmarking"></a><a class="link" href="#advancedBenchmarking">14.7. Advanced Benchmarking</a></h3>
<div class="sect3">
<h4 id="benchmarkingPerformanceTricks"><a class="anchor" href="#benchmarkingPerformanceTricks"></a><a class="link" href="#benchmarkingPerformanceTricks">14.7.1. Benchmarking Performance Tricks</a></h4>
<div class="sect4">
<h5 id="parallelBenchmarkingOnMultipleThreads"><a class="anchor" href="#parallelBenchmarkingOnMultipleThreads"></a><a class="link" href="#parallelBenchmarkingOnMultipleThreads">14.7.1.1. Parallel Benchmarking On Multiple Threads</a></h5>
<div class="paragraph">
<p>If you have multiple processors available on your computer, you can run multiple benchmarks in parallel on multiple threads to get your benchmarks results faster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;plannerBenchmark&gt;
  ...
  &lt;parallelBenchmarkCount&gt;AUTO&lt;/parallelBenchmarkCount&gt;
  ...
&lt;/plannerBenchmark&gt;</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Running too many benchmarks in parallel will affect the results of benchmarks negatively.
Leave some processors unused for garbage collection and other processes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following <code>parallelBenchmarkCount</code>s are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>1</code> (default): Run all benchmarks sequentially.</p>
</li>
<li>
<p><code>AUTO</code>: Let Planner decide how many benchmarks to run in parallel. This formula is based on experience. It&#8217;s recommended to prefer this over the other parallel enabling options.</p>
</li>
<li>
<p>Static number: The number of benchmarks to run in parallel.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;parallelBenchmarkCount&gt;2&lt;/parallelBenchmarkCount&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>JavaScript formula: Formula for the number of benchmarks to run in parallel. It can use the variable <code>availableProcessorCount</code>. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;parallelBenchmarkCount&gt;(availableProcessorCount / 2) + 1&lt;/parallelBenchmarkCount&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>parallelBenchmarkCount</code> is always limited to the number of available processors.
If it&#8217;s higher, it will be automatically decreased.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you have a computer with slow or unreliable cooling, increasing the <code>parallelBenchmarkCount</code> above one (even on <code>AUTO</code>) may overheat your CPU.</p>
</div>
<div class="paragraph">
<p>The <code>sensors</code> command can help you detect if this is the case.
It is available in the package <code>lm_sensors</code> or <code>lm-sensors</code> in most Linux distributions.
There are several freeware tools available for Windows too.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The benchmarker uses a thread pool internally, but you can optionally plug in a custom <code>ThreadFactory</code>,
for example when running benchmarks on an application server or a cloud platform:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;plannerBenchmark&gt;
  ...
  &lt;threadFactoryClass&gt;...MyCustomThreadFactory&lt;/threadFactoryClass&gt;
  ...
&lt;/plannerBenchmark&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In the future, we will also support multi-JVM benchmarking.
This feature is independent of <a href="https://issues.jboss.org/browse/PLANNER-76">multi-threaded solving</a> or multi-JVM solving.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="statisticalBenchmarking"><a class="anchor" href="#statisticalBenchmarking"></a><a class="link" href="#statisticalBenchmarking">14.7.2. Statistical Benchmarking</a></h4>
<div class="paragraph">
<p>To minimize the influence of your environment and the Random Number Generator on the benchmark results, configure the number of times each single benchmark run is repeated.
The results of those runs are statistically aggregated.
Each individual result is also visible in the report, as well as plotted in <a href="#benchmarkReportBestScoreDistributionSummary">the best score distribution summary</a>.</p>
</div>
<div class="paragraph">
<p>Just add a <code>&lt;subSingleCount&gt;</code> element to an <a href="#inheritedSolverBenchmark"><code>&lt;inheritedSolverBenchmark&gt;</code></a> element or in a <code>&lt;solverBenchmark&gt;</code> element:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;plannerBenchmark&gt;
  ...
  &lt;inheritedSolverBenchmark&gt;
    ...
    &lt;solver&gt;
      ...
    &lt;/solver&gt;
    &lt;subSingleCount&gt;10&lt;subSingleCount&gt;
  &lt;/inheritedSolverBenchmark&gt;
  ...
&lt;/plannerBenchmark&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>subSingleCount</code> defaults to <code>1</code> (so no statistical benchmarking).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If <code>subSingleCount</code> is higher than <code>1</code>, the benchmarker will automatically use a <em>different</em><a href="#randomNumberGenerator"><code>Random</code> seed</a> for every sub single run, without losing reproducibility (for each sub single index) in <a href="#environmentMode">EnvironmentMode</a><code>REPRODUCIBLE</code> and lower.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="templateBasedBenchmarking"><a class="anchor" href="#templateBasedBenchmarking"></a><a class="link" href="#templateBasedBenchmarking">14.7.3. Template Based Benchmarking And Matrix Benchmarking</a></h4>
<div class="paragraph">
<p>Matrix benchmarking is benchmarking a combination of value sets.
For example: benchmark four <code>entityTabuSize</code> values (<code>5</code>, <code>7</code>, <code>11</code> and <code>13</code>) combined with three <code>acceptedCountLimit</code> values (<code>500</code>, <code>1000</code> and <code>2000</code>), resulting in 12 solver configurations.</p>
</div>
<div class="paragraph">
<p>To reduce the verbosity of such a benchmark configuration, you can use a <a href="http://freemarker.org//">Freemarker</a> template for the benchmark configuration instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;plannerBenchmark&gt;
  ...
  &lt;inheritedSolverBenchmark&gt;
    ...
  &lt;/inheritedSolverBenchmark&gt;

&lt;#list [5, 7, 11, 13] as entityTabuSize&gt;
&lt;#list [500, 1000, 2000] as acceptedCountLimit&gt;
  &lt;solverBenchmark&gt;
    &lt;name&gt;Tabu Search entityTabuSize ${entityTabuSize} acceptedCountLimit ${acceptedCountLimit}&lt;/name&gt;
    &lt;solver&gt;
      &lt;localSearch&gt;
        &lt;unionMoveSelector&gt;
          &lt;changeMoveSelector/&gt;
          &lt;swapMoveSelector/&gt;
        &lt;/unionMoveSelector&gt;
        &lt;acceptor&gt;
          &lt;entityTabuSize&gt;${entityTabuSize}&lt;/entityTabuSize&gt;
        &lt;/acceptor&gt;
        &lt;forager&gt;
          &lt;acceptedCountLimit&gt;${acceptedCountLimit}&lt;/acceptedCountLimit&gt;
        &lt;/forager&gt;
      &lt;/localSearch&gt;
    &lt;/solver&gt;
  &lt;/solverBenchmark&gt;
&lt;/#list&gt;
&lt;/#list&gt;
&lt;/plannerBenchmark&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To configure Matrix Benchmarking for Simulated Annealing (or any other configuration that involves a <code>Score</code> template variable), use the <code>replace()</code> method in the solver benchmark name element:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;plannerBenchmark&gt;
  ...
  &lt;inheritedSolverBenchmark&gt;
    ...
  &lt;/inheritedSolverBenchmark&gt;

&lt;#list ["1hard/10soft", "1hard/20soft", "1hard/50soft", "1hard/70soft"] as startingTemperature&gt;
  &lt;solverBenchmark&gt;
    &lt;name&gt;Simulated Annealing startingTemperature ${startingTemperature?replace("/", "_")}&lt;/name&gt;
    &lt;solver&gt;
      &lt;localSearch&gt;
        &lt;acceptor&gt;
          &lt;simulatedAnnealingStartingTemperature&gt;${startingTemperature}&lt;/simulatedAnnealingStartingTemperature&gt;
        &lt;/acceptor&gt;
      &lt;/localSearch&gt;
    &lt;/solver&gt;
  &lt;/solverBenchmark&gt;
&lt;/#list&gt;
&lt;/plannerBenchmark&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A solver benchmark name doesn&#8217;t allow some characters (such a <code>/</code>) because the name is also used a file name.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And build it with the class <code>PlannerBenchmarkFactory</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">        PlannerBenchmarkFactory plannerBenchmarkFactory = PlannerBenchmarkFactory.createFromFreemarkerXmlResource(
                "org/optaplanner/examples/cloudbalancing/optional/benchmark/cloudBalancingBenchmarkConfigTemplate.xml.ftl");
        PlannerBenchmark plannerBenchmark = plannerBenchmarkFactory.buildPlannerBenchmark();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportAggregation"><a class="anchor" href="#benchmarkReportAggregation"></a><a class="link" href="#benchmarkReportAggregation">14.7.4. Benchmark Report Aggregation</a></h4>
<div class="paragraph">
<p>The <code>BenchmarkAggregator</code> takes one or more existing benchmarks and merges them into new benchmark report, without actually running the benchmarks again.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./BenchmarkingAndTweaking/benchmarkAggregator.png" alt="benchmarkAggregator">
</div>
</div>
<div class="paragraph">
<p>This is useful to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Report on the impact of code changes</strong>: Run the same benchmark configuration before and after the code changes, then aggregate a report.</p>
</li>
<li>
<p><strong>Report on the impact of dependency upgrades</strong>: Run the same benchmark configuration before and after upgrading the dependency, then aggregate a report.</p>
</li>
<li>
<p><strong>Condense a too verbose report</strong>: Select only the interesting solver benchmarks from the existing report. This especially useful on template reports to make the graphs readable.</p>
</li>
<li>
<p><strong>Partially rerun a benchmark</strong>: Rerun part of an existing report (for example only the failed or invalid solvers), then recreate the original intended report with the new values.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To use it, provide a <code>PlannerBenchmarkFactory</code> to the <code>BenchmarkAggregatorFrame</code> to display the GUI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    public static void main(String[] args) {
        PlannerBenchmarkFactory plannerBenchmarkFactory = PlannerBenchmarkFactory.createFromXmlResource(
                "org/optaplanner/examples/nqueens/benchmark/nqueensBenchmarkConfig.xml");
        BenchmarkAggregatorFrame.createAndDisplay(plannerBenchmarkFactory);
    }</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Despite that it uses a benchmark configuration as input, it ignores all elements of that configuration, except for the elements <code>&lt;benchmarkDirectory&gt;</code> and <code>&lt;benchmarkReport&gt;</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the GUI, select the interesting benchmarks and click the button to generate the report.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>All the input reports which are being merged should have been generated with the same Planner version (excluding hotfix differences) as the <code>BenchmarkAggregator</code>.
Using reports from different Planner major or minor versions are not guaranteed to succeed and deliver correct information, because the benchmark report data structure often changes.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="repeatedPlanning"><a class="anchor" href="#repeatedPlanning"></a><a class="link" href="#repeatedPlanning">15. Repeated Planning</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="introductionToRepeatedPlanning"><a class="anchor" href="#introductionToRepeatedPlanning"></a><a class="link" href="#introductionToRepeatedPlanning">15.1. Introduction to Repeated Planning</a></h3>
<div class="paragraph">
<p>The world constantly changes.
The problem facts used to create a solution, might change before or during the execution of that solution.
There are different situations (which can be combined):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Unforeseen fact changes</em>: For example: an employee assigned to a shift calls in sick, an airplane scheduled to take off has a technical delay, one of the machines or vehicles break down, &#8230;&#8203; Use <strong>backup planning</strong>.</p>
</li>
<li>
<p><em>Impossible to assign all entities now</em>: Leave some unassigned. For example: there are 10 shifts at the same time to assign but only nine employees to handle shifts. Use <strong>overconstrained planning</strong>.</p>
</li>
<li>
<p><em>Unknown long term future facts</em>: For example: The hospital admissions for the next two weeks are reliable, but those for week three and four are less reliable and for week five and beyond are not worth planning yet. Use <strong>continuous planning</strong>.</p>
</li>
<li>
<p><em>Constantly changing problem facts</em>: Use <strong>real-time planning</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Waiting to start planning - to lower the risk of problem facts changing - usually isn&#8217;t a good way to deal with that.
More CPU time means a better planning solution.
An incomplete plan is better than no plan.</p>
</div>
<div class="paragraph">
<p>Luckily, the optimization algorithms support planning a solution that&#8217;s already (partially) planned, known as repeated planning.</p>
</div>
</div>
<div class="sect2">
<h3 id="backupPlanning"><a class="anchor" href="#backupPlanning"></a><a class="link" href="#backupPlanning">15.2. Backup Planning</a></h3>
<div class="paragraph">
<p>Backup planning is the technique of adding extra score constraints to create space in the planning for when things go wrong.
That creates a backup plan in the plan.
For example: try to assign an employee as the spare employee (one for every 10 shifts at the same time), keep one hospital bed open in each department, &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Then, when things go wrong (one of the employees calls in sick), change the problem facts on the original solution (delete the sick employee leave his/her shifts unassigned) and just restart the planning, starting from that solution, which has a different score now.
The construction heuristics will fill in the newly created gaps (probably with the spare employee) and the metaheuristics will even improve it further.</p>
</div>
</div>
<div class="sect2">
<h3 id="overconstrainedPlanning"><a class="anchor" href="#overconstrainedPlanning"></a><a class="link" href="#overconstrainedPlanning">15.3. Overconstrained Planning</a></h3>
<div class="paragraph">
<p>When there is no feasible solution to assign all planning entities, it&#8217;s often desired to assign as many entities as possible without breaking hard constraints.
This is called overconstrained planning.</p>
</div>
<div class="paragraph">
<p>By default, Planner will assign all planning entities, overload the planning values and therefore break hard constraints.
There are two ways to avoid that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use <a href="#nullablePlanningVariable">nullable</a> planning variables, so some entities are unassigned.</p>
</li>
<li>
<p>Add virtual values to catch the unassigned entities.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="overconstrainedPlanningWithNullableVariables"><a class="anchor" href="#overconstrainedPlanningWithNullableVariables"></a><a class="link" href="#overconstrainedPlanningWithNullableVariables">15.3.1. Overconstrained Planning with Nullable Variables</a></h4>
<div class="paragraph">
<p>If we handle overconstrained planning with nullable variables, the overload entities will be left unassigned:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./RepeatedPlanning/overconstrainedPlanning.png" alt="overconstrainedPlanning">
</div>
</div>
<div class="paragraph">
<p>To implement this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add a additional score level (usually a medium level between the hard and soft level) by switching <a href="#scoreType"><code>Score</code> type</a>.</p>
</li>
<li>
<p>Make the planning variable <a href="#nullablePlanningVariable">nullable</a>.</p>
</li>
<li>
<p>Add a score constraint on the new level (so usually a medium constraint) to penalize the number of unassigned entities (or a weighted sum of them).</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="overconstrainedPlanningWithVirutalValues"><a class="anchor" href="#overconstrainedPlanningWithVirutalValues"></a><a class="link" href="#overconstrainedPlanningWithVirutalValues">15.3.2. Overconstrained Planning with Virtual Values</a></h4>
<div class="paragraph">
<p>In overconstrained planning it&#8217;s often useful to know which resources are lacking.
In overconstrained planning with virtual values, the solution indicates which resources to buy.</p>
</div>
<div class="paragraph">
<p>To implement this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add a additional score level (usually a medium level between the hard and soft level) by switching <a href="#scoreType"><code>Score</code> type</a>.</p>
</li>
<li>
<p>Add a number of virtual values. It can be difficult to determine a good formula to calculate that number:</p>
<div class="ulist">
<ul>
<li>
<p>Don&#8217;t add too many, as that will decrease solver efficiency.</p>
</li>
<li>
<p>Definitely don&#8217;t add too few as that will lead to an infeasible solution.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Add a score constraint on the new level (so usually a medium constraint) to penalize the number of virtual assigned entities (or a weighted sum of them).</p>
</li>
<li>
<p>Optionally change all soft constraints to ignore virtual assigned entities.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="continuousPlanning"><a class="anchor" href="#continuousPlanning"></a><a class="link" href="#continuousPlanning">15.4. Continuous Planning (Windowed Planning)</a></h3>
<div class="paragraph">
<p>Continuous planning is the technique of planning one or more upcoming planning periods at the same time and repeating that process monthly, weekly, daily, hourly or even more frequently.
Time is infinite, so planning all future time periods is impossible.
Instead, plan a planning window of a fixed number of upcoming planning time periods, and consider anything beyond that out of scope.</p>
</div>
<div class="paragraph">
<p>The planning window can be split up in several parts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>History</strong>: Past time periods that immutable. It contains only immovable entities.</p>
<div class="ulist">
<ul>
<li>
<p>Historic entities can affect score constraints that apply to movable entities too. For example in nurse rostering, a nurse that has worked the last five historic days in a row, should not be assigned on the first tentative day of the planning window because then she&#8217;s work too many days in a row.</p>
</li>
<li>
<p>Do not load all historic entities in memory: even though immovable entities don&#8217;t affect solving performance, they can cause out of memory problems when the data grows to years. Only load those that might still affect the current constraints with a good safety margin, for example load the past year.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Tentative</strong>: The first few time periods that are being planned freely for the last time. After this planning, their planning entities become <a href="#immovablePlanningEntities">immovable</a> or <a href="#nonvolatileReplanning">semi-immovable</a>.</p>
<div class="ulist">
<ul>
<li>
<p>The result of the tentative planning is usually shared with the business. For example in nurse rostering, the nurses will use this schedule to plan their personal lives. Changing that schedule later becomes disruptive (but if exceptions force us to do so, <a href="#nonvolatileReplanning">we minimize disruption</a>).</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Draft</strong>: The latter time periods that are being planned freely, but not for the last time. They are likely to change again in the next planning effort.</p>
<div class="ulist">
<ul>
<li>
<p>The draft part is needed to assure that the tentatively planned entities will allow room of a good, feasible planning afterwards. It prevents you from painting yourself in a corner.</p>
</li>
<li>
<p>That draft part is usually not shared with the business yet, because it is too volatile. However, it is stored in the database and used a starting point for the next plan.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Future</strong> (out of scope): Planning entities that aren&#8217;t in the current planning window.</p>
<div class="ulist">
<ul>
<li>
<p>If <a href="#assigningTimeToPlanningEntities">time is a planning variable</a>, there is no future part. Instead, if the planning window is too small to plan all entities, you&#8217;re dealing with <a href="#overconstrainedPlanning">overconstrained planning</a>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./RepeatedPlanning/continuousPlanningEmployeeRostering.png" alt="continuousPlanningEmployeeRostering">
</div>
</div>
<div class="paragraph">
<p>In the employee rostering example above, we replan every four days.
Each time, we actually plan a window of 12 days, but we only share the tentative roster of the next four days with the employees.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The start of the planning window (so the first tentative time period) does <em>not</em> need to be now.
That too can be a week in advance.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./RepeatedPlanning/continuousPlanningPatientAdmissionSchedule.png" alt="continuousPlanningPatientAdmissionSchedule">
</div>
</div>
<div class="paragraph">
<p>In the hospital bed planning example above, notice the difference between the original planning of November 1th and the new planning of November 5th: some problem facts (F, H, I, J, K) changed meanwhile, which results in unrelated planning entities (G) changing too.</p>
</div>
<div class="sect3">
<h4 id="immovablePlanningEntities"><a class="anchor" href="#immovablePlanningEntities"></a><a class="link" href="#immovablePlanningEntities">15.4.1. Immovable Planning Entities</a></h4>
<div class="paragraph">
<p>To make some planning entities immovable, simply add an entity <code>SelectionFilter</code> that returns <code>true</code> if an entity is movable and <code>false</code> if it is immovable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public class MovableShiftAssignmentSelectionFilter implements SelectionFilter&lt;NurseRoster, ShiftAssignment&gt; {

    @Override
    public boolean accept(ScoreDirector&lt;NurseRoster&gt; scoreDirector, ShiftAssignment shiftAssignment) {
        NurseRoster nurseRoster = scoreDirector.getWorkingSolution();
        ShiftDate shiftDate = shiftAssignment.getShift().getShiftDate();
        return nurseRoster.getNurseRosterInfo().isInPlanningWindow(shiftDate);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And configure it like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningEntity(movableEntitySelectionFilter = MovableShiftAssignmentSelectionFilter.class)
public class ShiftAssignment {
    ...
}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Custom <code>MoveListFactory</code> and <code>MoveIteratorFactory</code> implementations must make sure that they don&#8217;t move immovable entities.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="nonvolatileReplanning"><a class="anchor" href="#nonvolatileReplanning"></a><a class="link" href="#nonvolatileReplanning">15.4.2. Nonvolatile Replanning to minimize disruption (Semi-movable Planning Entities)</a></h4>
<div class="paragraph">
<p>Replanning an existing plan can be very disruptive on the plan.
If the plan affects humans (such as employees, drivers, &#8230;&#8203;), very disruptive changes are often undesirable.
In such cases, nonvolatile replanning helps by restricting planning freedom: the gain of changing a plan must be higher than the disruption it causes.
This is usually implemented by taxing all planning entities that change.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./RepeatedPlanning/nonvolatileReplanning.png" alt="nonvolatileReplanning">
</div>
</div>
<div class="paragraph">
<p>For example, in the Machine Reassignment example, the entity has both the planning variable <code>machine</code> and its original value <code>originalMachine</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningEntity(...)
public class ProcessAssignment {

    private MrProcess process;
    private Machine originalMachine;
    private Machine machine;

    public Machine getOriginalMachine() {...}

    @PlanningVariable(...)
    public Machine getMachine() {...}

    public boolean isMoved() {
        return originalMachine != null &amp;&amp; originalMachine != machine;
    }

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>During planning, the planning variable <code>machine</code> changes.
By comparing it with the originalMachine, a change in plan can be penalized:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>rule "processMoved"
    when
        ProcessAssignment(moved == true)
    then
        scoreHolder.addSoftConstraintMatch(kcontext, -1000);
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>The soft penalty of <code>-1000</code> means that a better solution is only accepted if it improves the soft score for at least <code>1000</code> points per variable changed (or if it improves the hard score).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="realTimePlanning"><a class="anchor" href="#realTimePlanning"></a><a class="link" href="#realTimePlanning">15.5. Real-time Planning</a></h3>
<div class="paragraph">
<p>To do real-time planning, first combine <a href="#backupPlanning">backup planning</a> and <a href="#continuousPlanning">continuous planning</a> with short planning windows to lower the burden of real-time planning.
As time passes, the problem itself changes:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./RepeatedPlanning/realTimePlanningVehicleRouting.png" alt="realTimePlanningVehicleRouting">
</div>
</div>
<div class="paragraph">
<p>In the example above, three customers are added at different times (<code>07:56</code>, <code>08:02</code> and <code>08:45</code>), after the original customer set finished solving at <code>07:55</code> and in some cases after the vehicles already left.
Planner can handle such scenario&#8217;s with <code>ProblemFactChange</code> (in combination with <a href="#immovablePlanningEntities">immovable planning entities</a>).</p>
</div>
<div class="sect3">
<h4 id="problemFactChange"><a class="anchor" href="#problemFactChange"></a><a class="link" href="#problemFactChange">15.5.1. <code>ProblemFactChange</code></a></h4>
<div class="paragraph">
<p>While the <code>Solver</code> is solving, an outside event might want to change one of the problem facts, for example an airplane is delayed and needs the runway at a later time.
Do not change the problem fact instances used by the <code>Solver</code> while it is solving (from another thread or even in the same thread), as that will corrupt it.
Instead, add a <code>ProblemFactChange</code> to the <code>Solver</code> which it will execute in the solver thread as soon as possible.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public interface Solver&lt;Solution_&gt; {

    ...

    boolean addProblemFactChange(ProblemFactChange&lt;Solution_&gt; problemFactChange);

    boolean isEveryProblemFactChangeProcessed();

    ...

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">public interface ProblemFactChange&lt;Solution_&gt; {

    void doChange(ScoreDirector&lt;Solution_&gt; scoreDirector);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    public void deleteComputer(final CloudComputer computer) {
        solver.addProblemFactChange(scoreDirector -&gt; {
            CloudBalance cloudBalance = scoreDirector.getWorkingSolution();
            CloudComputer workingComputer = scoreDirector.lookUpWorkingObject(computer);
            // First remove the problem fact from all planning entities that use it
            for (CloudProcess process : cloudBalance.getProcessList()) {
                if (process.getComputer() == workingComputer) {
                    scoreDirector.beforeVariableChanged(process, "computer");
                    process.setComputer(null);
                    scoreDirector.afterVariableChanged(process, "computer");
                }
            }
            // A SolutionCloner does not clone problem fact lists (such as computerList)
            // Shallow clone the computerList so only workingSolution is affected, not bestSolution or guiSolution
            ArrayList&lt;CloudComputer&gt; computerList = new ArrayList&lt;&gt;(cloudBalance.getComputerList());
            cloudBalance.setComputerList(computerList);
            // Remove the problem fact itself
            scoreDirector.beforeProblemFactRemoved(workingComputer);
            computerList.remove(workingComputer);
            scoreDirector.afterProblemFactRemoved(workingComputer);
            scoreDirector.triggerVariableListeners();
        });
    }</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Any change on the problem facts or planning entities in a <code>ProblemFactChange</code> must be told to the <code>ScoreDirector</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./RepeatedPlanning/realTimePlanningConcurrencySequenceDiagram.png" alt="realTimePlanningConcurrencySequenceDiagram">
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To write a <code>ProblemFactChange</code> correctly, it&#8217;s important to understand the behaviour of <a href="#cloningASolution">a planning clone</a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Any change in a <code>ProblemFactChange</code> must be done on the <code>Solution</code> instance of <code>scoreDirector.getWorkingSolution()</code>.
The <code>workingSolution</code> is <a href="#cloningASolution">a planning clone</a> of the <code>BestSolutionChangedEvent</code>'s <code>bestSolution</code>.
So the <code>workingSolution</code> in the <code>Solver</code> is never the same instance as the <code>Solution</code> in the rest of your application: it is a planning clone.
Use the method <code>ScoreDirector.lookUpWorkingObject()</code> to translate an retrieve the working solution&#8217;s instance of an object.</p>
</li>
<li>
<p>A planning clone also clones the planning entities and planning entity collections.
So any change on the planning entities must happen on the instances hold by <code>scoreDirector.getWorkingSolution()</code>.</p>
</li>
<li>
<p>A planning clone does not clone the problem facts, nor the problem fact collections.
<em>Therefore the <code><em>workingSolution</em></code> and the <code><em>bestSolution</em></code> share the same problem fact instances and the same problem fact list instances.</em></p>
<div class="paragraph">
<p>Any problem fact or problem fact list changed by a <code>ProblemFactChange</code> must be problem cloned first (which can imply rerouting references in other problem facts and planning entities). Otherwise, if the <code>workingSolution</code> and <code>bestSolution</code> are used in different threads (for example a solver thread and a GUI event thread), a race condition can occur.</p>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Many types of changes can leave a planning entity uninitialized, resulting in a partially initialized solution.
That&#8217;s fine, as long as the first solver phase can handle it.
All construction heuristics solver phases can handle that, so it&#8217;s recommended to configure such a solver phase as the first phase.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In essence, the <code>Solver</code> stops, runs the <code>ProblemFactChange</code> and <strong>restarts</strong>.
This is a <em>warm start</em> because its initial solution is the adjusted best solution of the previous run.
Each solver phase runs again.
This implies the construction heuristic runs again, but because little or no planning variables are uninitialized (unless you have a <a href="#nullablePlanningVariable">nullable planning variable</a>), it finishes much quicker than in a cold start.</p>
</div>
<div class="paragraph">
<p>Each configured <code>Termination</code> resets (both in solver and phase configuration), but a previous call to <code>terminateEarly()</code> is not undone.
Normally however, you won&#8217;t configure any <code>Termination</code> (except in daemon mode), just call <code>Solver.terminateEarly()</code> when the results are needed.
Alternatively, do configure a <code>Termination</code> and use the daemon mode in combination with <code><a href="#SolverEventListener">BestSolutionChangedEvent</a></code> as described below.</p>
</div>
</div>
<div class="sect3">
<h4 id="daemon"><a class="anchor" href="#daemon"></a><a class="link" href="#daemon">15.5.2. Daemon: <code>solve()</code> Does Not Return</a></h4>
<div class="paragraph">
<p>In real-time planning, it&#8217;s often useful to have a solver thread wait when it runs out of work, and immediately resume solving a problem once new problem fact changes are added.
Putting the <code>Solver</code> in daemon mode has these effects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the <code>Solver</code>'s <code>Termination</code> terminates, it does not return from <code>solve()</code> but blocks its thread instead (which frees up CPU power).</p>
<div class="ulist">
<ul>
<li>
<p>Except for <code>terminateEarly()</code>, which does make it return from <code>solve()</code>, freeing up system resources and allowing an application to shutdown gracefully.</p>
</li>
<li>
<p>If a <code>Solver</code> starts with an empty planning entity collection, it waits in the blocked state immediately.</p>
</li>
</ul>
</div>
</li>
<li>
<p>If a <code>ProblemFactChange</code> is added, it goes into the running state, applies the <code>ProblemFactChange</code> and runs the <code>Solver</code> again.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To configure the daemon mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;solver&gt;
  &lt;daemon&gt;true&lt;/daemon&gt;
  ...
&lt;/solver&gt;</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Don&#8217;t forget to call <code>Solver.terminateEarly()</code> when your application needs to shutdown to avoid killing the solver thread unnaturally.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Subscribe to the <code><a href="#SolverEventListener">BestSolutionChangedEvent</a></code> to process new best solutions found by the solver thread.
A <code>BestSolutionChangedEvent</code> doesn&#8217;t guarantee that every <code>ProblemFactChange</code> has been processed already, nor that the solution is initialized and feasible.
To ignore <code>BestSolutionChangedEvent</code>s with such invalid solutions, do this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">    public void bestSolutionChanged(BestSolutionChangedEvent&lt;CloudBalance&gt; event) {
        if (event.isEveryProblemFactChangeProcessed()
                // Ignore infeasible (including uninitialized) solutions
                &amp;&amp; event.getNewBestSolution().getScore().isFeasible()) {
            ...
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use <code>Score.isSolutionInitialized()</code> instead of <code>Score.isFeasible()</code> to only ignore uninitialized solutions, but do accept infeasible solutions too.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="integration"><a class="anchor" href="#integration"></a><a class="link" href="#integration">16. Integration</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="integrationOverview"><a class="anchor" href="#integrationOverview"></a><a class="link" href="#integrationOverview">16.1. Overview</a></h3>
<div class="paragraph">
<p>Planner&#8217;s input and output data (the planning problem and the best solution) are plain old JavaBeans (POJO&#8217;s), so integration with other Java technologies is straightforward.
For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To read a planning problem from the database (and store the best solution in it), annotate the domain POJO&#8217;s with JPA annotations.</p>
</li>
<li>
<p>To read a planning problem from an XML file (and store the best solution in it), annotate the domain POJO&#8217;s with XStream or JAXB annotations.</p>
</li>
<li>
<p>To expose the Solver as a REST Service that reads the planning problem and responds with the best solution, annotate the domain POJO&#8217;s with XStream, JAXB or Jackson annotations and hook the <code>Solver</code> in Camel or RESTEasy.</p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./Integration/integrationOverview.png" alt="integrationOverview">
</div>
</div>
</div>
<div class="sect2">
<h3 id="integrationWithPersistentStorage"><a class="anchor" href="#integrationWithPersistentStorage"></a><a class="link" href="#integrationWithPersistentStorage">16.2. Persistent Storage</a></h3>
<div class="sect3">
<h4 id="integrationWithJpaAndHibernate"><a class="anchor" href="#integrationWithJpaAndHibernate"></a><a class="link" href="#integrationWithJpaAndHibernate">16.2.1. Database: JPA and Hibernate</a></h4>
<div class="paragraph">
<p>Enrich the domain POJO&#8217;s (solution, entities and problem facts) with JPA annotations
to store them in a database by calling <code>EntityManager.persist()</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not confuse JPA&#8217;s <code>@Entity</code> annotation with Planner&#8217;s <code>@PlanningEntity</code> annotation.
They can appear both on the same class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningEntity // OptaPlanner annotation
@Entity // JPA annotation
public class Talk {...}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Add a dependency to the <code>optaplanner-persistence-jpa</code> jar to take advantage of these extra integration features:</p>
</div>
<div class="sect4">
<h5 id="jpaAndHibernatePersistingAScore"><a class="anchor" href="#jpaAndHibernatePersistingAScore"></a><a class="link" href="#jpaAndHibernatePersistingAScore">16.2.1.1. JPA and Hibernate: Persisting a <code>Score</code></a></h5>
<div class="paragraph">
<p>When a <code>Score</code> is persisted into a relational database, JPA and Hibernate will default to Java serializing it to a <code>BLOB</code> column.
This has several disadvantages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Java serialization format of <code>Score</code> classes is currently not backwards compatible. Upgrading to a newer Planner version can break reading an existing database.</p>
</li>
<li>
<p>The score is not easily readable for a query executed in the database console. This is annoying during development.</p>
</li>
<li>
<p>The score cannot be used in a SQL or JPA-QL query to efficiently filter the results: for example to query all infeasible schedules.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To avoid these issues, configure it to instead use INTEGER (or other) columns, by using the appropriate <code>*ScoreHibernateType</code> for your <code>Score</code> type, for example for a <code>HardSoftScore</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningSolution
@Entity
@TypeDef(defaultForType = HardSoftScore.class, typeClass = HardSoftScoreHibernateType.class)
public class CloudBalance {

    @PlanningScore
    @Columns(columns = {@Column(name = "initScore"), @Column(name = "hardScore"), @Column(name = "softScore")})
    protected HardSoftScore score;

    ...
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Configure the same number of <code>@Column</code> annotations as the number of score levels in the score plus one (for the <code>initScore</code>), otherwise Hibernate will fail fast because a property mapping has the wrong number of columns.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this case, the DDL will look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql" data-lang="sql">CREATE TABLE CloudBalance(
    ...
    initScore INTEGER,
    hardScore INTEGER,
    softScore INTEGER
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using a <code>BigDecimal</code> based <code>Score</code>, specify the precision and scale of the columns to avoid silent rounding:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningSolution
@Entity
@TypeDef(defaultForType = HardSoftBigDecimalScore.class, typeClass = HardSoftBigDecimalScoreHibernateType.class)
public class CloudBalance{

    @PlanningScore
    @Columns(columns = {
            @Column(name = "initScore")
            @Column(name = "hardScore", precision = 10, scale = 5),
            @Column(name = "softScore", precision = 10, scale = 5)})
    protected HardSoftBigDecimalScore score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, the DDL will look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql" data-lang="sql">CREATE TABLE CloudBalance(
    ...
    initScore INTEGER,
    hardScore DECIMAL(10, 5),
    softScore DECIMAL(10, 5)
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using any type of bendable <code>Score</code>, specify the hard and soft level sizes as parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningSolution
@Entity
@TypeDef(defaultForType = BendableScore.class, typeClass = BendableScoreHibernateType.class, parameters = {
        @Parameter(name = "hardLevelsSize", value = "3"),
        @Parameter(name = "softLevelsSize", value = "2")})
public class Schedule {

    @PlanningScore
    @Columns(columns = {
            @Column(name = "initScore")
            @Column(name = "hard0Score"),
            @Column(name = "hard1Score"),
            @Column(name = "hard2Score"),
            @Column(name = "soft0Score"),
            @Column(name = "soft1Score")})
    protected BendableScore score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>All this support is Hibernate specific because currently JPA 2.1&#8217;s converters do not support converting to multiple columns.</p>
</div>
</div>
<div class="sect4">
<h5 id="jpaAndHibernatePlanningCloning"><a class="anchor" href="#jpaAndHibernatePlanningCloning"></a><a class="link" href="#jpaAndHibernatePlanningCloning">16.2.1.2. JPA and Hibernate: Planning Cloning</a></h5>
<div class="paragraph">
<p>In JPA and Hibernate, there is usually a <code>@ManyToOne</code> relationship from most problem fact classes to the planning solution class.
Therefore, the problem fact classes reference the planning solution class, which implies that when the solution is <a href="#cloningASolution">planning cloned</a>, they need to be cloned too.
Use an <code>@DeepPlanningClone</code> on each such problem fact class to enforce that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningSolution // OptaPlanner annotation
@Entity // JPA annotation
public class Conference {

    @OneToMany(mappedBy="conference")
    private List&lt;Room&gt; roomList;

    ...
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@DeepPlanningClone // OptaPlanner annotation: Force the default planning cloner to planning clone this class too
@Entity // JPA annotation
public class Room {

    @ManyToOne
    private Conference conference; // Because of this reference, this problem fact needs to be planning cloned too

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Neglecting to do this can lead to persisting duplicate solutions, JPA exceptions or other side effects.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="integrationWithXStream"><a class="anchor" href="#integrationWithXStream"></a><a class="link" href="#integrationWithXStream">16.2.2. XML or JSON: XStream</a></h4>
<div class="paragraph">
<p>Enrich the domain POJO&#8217;s (solution, entities and problem facts) with XStream annotations to serialize them to/from XML or JSON.</p>
</div>
<div class="paragraph">
<p>Add a dependency to the <code>optaplanner-persistence-xstream</code> jar to take advantage of these extra integration features:</p>
</div>
<div class="sect4">
<h5 id="xStreamMarshallingAScore"><a class="anchor" href="#xStreamMarshallingAScore"></a><a class="link" href="#xStreamMarshallingAScore">16.2.2.1. XStream: Marshalling a <code>Score</code></a></h5>
<div class="paragraph">
<p>When a <code>Score</code> is marshalled to XML or JSON by the default XStream configuration, it&#8217;s verbose and ugly.
To fix that, configure the appropriate <code>ScoreXStreamConverter</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningSolution
@XStreamAlias("CloudBalance")
public class CloudBalance {

    @PlanningScore
    @XStreamConverter(HardSoftScoreXStreamConverter.class)
    private HardSoftScore score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, this will generate pretty XML:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;CloudBalance&gt;
   ...
   &lt;score&gt;0hard/-200soft&lt;/score&gt;
&lt;/CloudBalance&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The same applies for a bendable score:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningSolution
@XStreamAlias("Schedule")
public class Schedule {

    @PlanningScore
    @XStreamConverter(BendableScoreXStreamConverter.class)
    private BendableScore score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, this will generate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;Schedule&gt;
   ...
   &lt;score&gt;[0/0]hard/[-100/-20/-3]soft&lt;/score&gt;
&lt;/Schedule&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>hardLevelsSize</code> and <code>softLevelsSize</code> implied, when reading a bendable score from an XML element, must always be in sync with those in the solver.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="integrationWithJaxb"><a class="anchor" href="#integrationWithJaxb"></a><a class="link" href="#integrationWithJaxb">16.2.3. XML or JSON: JAXB</a></h4>
<div class="paragraph">
<p>Enrich the domain POJO&#8217;s (solution, entities and problem facts) with JAXB annotations to serialize them to/from XML or JSON.</p>
</div>
<div class="paragraph">
<p>Add a dependency to the <code>optaplanner-persistence-jaxb</code> jar to take advantage of these extra integration features:</p>
</div>
<div class="sect4">
<h5 id="jaxbMarshallingAScore"><a class="anchor" href="#jaxbMarshallingAScore"></a><a class="link" href="#jaxbMarshallingAScore">16.2.3.1. JAXB: Marshalling a <code>Score</code></a></h5>
<div class="paragraph">
<p>When a <code>Score</code> is marshalled to XML or JSON by the default JAXB configuration, it&#8217;s corrupted.
To fix that, configure the appropriate <code>ScoreJaxbXmlAdapter</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningSolution
@XmlRootElement @XmlAccessorType(XmlAccessType.FIELD)
public class CloudBalance {

    @PlanningScore
    @XmlJavaTypeAdapter(HardSoftScoreJaxbXmlAdapter.class)
    private HardSoftScore score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, this will generate pretty XML:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;cloudBalance&gt;
   ...
   &lt;score&gt;0hard/-200soft&lt;/score&gt;
&lt;/cloudBalance&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The same applies for a bendable score:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningSolution
@XmlRootElement @XmlAccessorType(XmlAccessType.FIELD)
public class Schedule {

    @PlanningScore
    @XmlJavaTypeAdapter(BendableScoreJaxbXmlAdapter.class)
    private BendableScore score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, with a <code>hardLevelsSize</code> of <code>2</code> and a <code>softLevelsSize</code> of <code>3</code>, that will generate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;schedule&gt;
   ...
   &lt;score&gt;[0/0]hard/[-100/-20/-3]soft&lt;/score&gt;
&lt;/schedule&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>hardLevelsSize</code> and <code>softLevelsSize</code> implied, when reading a bendable score from an XML element, must always be in sync with those in the solver.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="integrationWithJackson"><a class="anchor" href="#integrationWithJackson"></a><a class="link" href="#integrationWithJackson">16.2.4. JSON: Jackson</a></h4>
<div class="paragraph">
<p>Enrich the domain POJO&#8217;s (solution, entities and problem facts) with Jackson annotations to serialize them to/from JSON.</p>
</div>
<div class="paragraph">
<p>Add a dependency to the <code>optaplanner-persistence-jackson</code> jar to take advantage of these extra integration features:</p>
</div>
<div class="sect4">
<h5 id="jacksonMarshallingAScore"><a class="anchor" href="#jacksonMarshallingAScore"></a><a class="link" href="#jacksonMarshallingAScore">16.2.4.1. JAXB: Marshalling a <code>Score</code></a></h5>
<div class="paragraph">
<p>When a <code>Score</code> is marshalled to JSON by the default Jackson configuration, it fails.
To fix that, configure a <code>ScoreJacksonJsonSerializer</code> and the appropriate <code>ScoreJacksonJsonDeserializer</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningSolution
public class CloudBalance {

    @PlanningScore
    @JsonSerialize(using = ScoreJacksonJsonSerializer.class)
    @JsonDeserialize(using = HardSoftScoreJacksonJsonDeserializer.class)
    private HardSoftScore score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, this will generate pretty JSON:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json" data-lang="json">{
   ...
   "score":"0hard/-200soft"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The same applies for a bendable score:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">@PlanningSolution
public class Schedule {

    @PlanningScore
    @JsonSerialize(using = ScoreJacksonJsonSerializer.class)
    @JsonDeserialize(using = BendableScoreJacksonXmlAdapter.class)
    private BendableScore score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, with a <code>hardLevelsSize</code> of <code>2</code> and a <code>softLevelsSize</code> of <code>3</code>, that will generate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json" data-lang="json">{
   ...
   "score":"[0/0]hard/[-100/-20/-3]soft"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>hardLevelsSize</code> and <code>softLevelsSize</code> implied, when reading a bendable score from a JSON element, must always be in sync with those in the solver.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="integrationWithSoaAndEsb"><a class="anchor" href="#integrationWithSoaAndEsb"></a><a class="link" href="#integrationWithSoaAndEsb">16.3. SOA and ESB</a></h3>
<div class="sect3">
<h4 id="integrationWithCamel"><a class="anchor" href="#integrationWithCamel"></a><a class="link" href="#integrationWithCamel">16.3.1. Camel and Karaf</a></h4>
<div class="paragraph">
<p><a href="http://camel.apache.org/">Camel</a> is an enterprise integration framework which includes support for Planner (starting from Camel 2.13). It can expose a use case as a REST service, a SOAP service, a JMS service, &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p><a href="http://camel.apache.org/optaplanner.html">Read the documentation for the camel-optaplanner component.</a>
That component works in Karaf too.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="integrationWithOtherEnvironments"><a class="anchor" href="#integrationWithOtherEnvironments"></a><a class="link" href="#integrationWithOtherEnvironments">16.4. Other Environments</a></h3>
<div class="sect3">
<h4 id="integrationWithJBossModules"><a class="anchor" href="#integrationWithJBossModules"></a><a class="link" href="#integrationWithJBossModules">16.4.1. JBoss Modules, WildFly and JBoss EAP</a></h4>
<div class="paragraph">
<p>To deploy an Planner web application on WildFly, simply include the optaplanner dependency jars in the <code>war</code> file&#8217;s <code>WEB-INF/lib</code> directory (just like any other dependency) as shown in the <code>optaplanner-webexamples-*.war</code>.
However, in this approach the war file can easily grow to several MB in size, which is fine for a one-time deployment, but too heavyweight for frequent redeployments (especially over a slow network connection).</p>
</div>
<div class="paragraph">
<p>The remedy is to use deliver the optaplanner jars in a JBoss module to WildFly and create a skinny war.
Let&#8217;s create an module called <em>org.optaplanner</em>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Navigate to the directory <code>${WILDFLY_HOME}/modules/system/layers/base/</code>. This directory contains the JBoss modules of WildFly. Create directory structure <code>org/optaplanner/main</code> for our new module.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Copy <code>optaplanner-core-${version}.jar</code> and all its direct and transitive dependency jars into that new directory. Use "mvn dependency:tree" on each optaplanner artifact to discover all dependencies.</p>
</li>
<li>
<p>Create the file <code>module.xml</code> in that new directory. Give it this content:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;module xmlns="urn:jboss:module:1.3" name="org.optaplanner"&gt;
  &lt;resources&gt;
    ...
    &lt;resource-root path="kie-api-${version}.jar"/&gt;
    ...
    &lt;resource-root path="optaplanner-core-${version}.jar"/&gt;
    ...
    &lt;resource-root path="."/&gt;
  &lt;/resources&gt;
  &lt;dependencies&gt;
    &lt;module name="javaee.api"/&gt;
  &lt;/dependencies&gt;
&lt;/module&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Navigate to the deployed <code>war</code> file.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Remove <code>optaplanner-core-${version}.jar</code> and all its direct and transitive dependency jars from the <code>WEB-INF/lib</code> directory in the <code>war</code> file.</p>
</li>
<li>
<p>Create the file <code>jboss-deployment-structure.xml</code> in the <code>WEB-INF/lib</code> directory. Give it this content:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;jboss-deployment-structure&gt;
   &lt;deployment&gt;
      &lt;dependencies&gt;
         &lt;module name="org.optaplanner" export="true"/&gt;
      &lt;/dependencies&gt;
   &lt;/deployment&gt;
&lt;/jboss-deployment-structure&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Because of JBoss Modules' <code>ClassLoader</code> magic, you&#8217;ll likely need to provide the <code>ClassLoader</code> of your classes <a href="#solverConfigurationByXML">during the SolverFactory creation</a>,
so it can find the classpath resources (such as the solver config, score DRL&#8217;s and domain classes) in your jars.</p>
</div>
</div>
<div class="sect3">
<h4 id="integrationWithOSGi"><a class="anchor" href="#integrationWithOSGi"></a><a class="link" href="#integrationWithOSGi">16.4.2. OSGi</a></h4>
<div class="paragraph">
<p>The <code>optaplanner-core</code> jar includes OSGi metadata in its <code>MANIFEST.MF</code> file to function properly in an OSGi environment too.
Furthermore, the maven artifact <code>kie-karaf-features</code> contains a <code>features.xml</code> file that supports the OSGi-feature <code>optaplanner-engine</code>.</p>
</div>
<div class="paragraph">
<p>Because of the OSGi&#8217;s <code>ClassLoader</code> magic, you&#8217;ll likely need to provide the <code>ClassLoader</code> of your classes <a href="#solverConfigurationByXML">during the SolverFactory creation</a>,
so it can find the classpath resources (such as the solver config, score DRL&#8217;s and domain classes) in your jars.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Planner does <em>not</em> require OSGi.
It works perfectly fine in a normal Java environment too.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="integrationWithAndroid"><a class="anchor" href="#integrationWithAndroid"></a><a class="link" href="#integrationWithAndroid">16.4.3. Android</a></h4>
<div class="paragraph">
<p>Android is not a complete JVM (because some JDK libraries are missing), but Planner works on Android with <a href="#easyJavaScoreCalculation">easy Java</a> or <a href="#incrementalJavaScoreCalculation">incremental Java</a> score calculation.
The Drools rule engine does not work on Android yet, so Drools score calculation doesn&#8217;t work on Android and its dependencies need to be excluded.</p>
</div>
<div class="paragraph">
<p><strong>Workaround to use Planner on Android:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add a dependency to the <code>build.gradle</code> file in your Android project to exclude <code>org.drools</code> and <code>xmlpull</code> dependencies:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle" data-lang="gradle">dependencies {
    ...
    compile('org.optaplanner:optaplanner-core:...') {
        exclude group: 'xmlpull'
        exclude group: 'org.drools'
    }
    ...
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="integrationWithHumanPlanners"><a class="anchor" href="#integrationWithHumanPlanners"></a><a class="link" href="#integrationWithHumanPlanners">16.5. Integration with Human Planners (Politics)</a></h3>
<div class="paragraph">
<p>A good Planner implementation beats any good human planner for non-trivial datasets.
Many human planners fail to accept this, often because they feel threatened by an automated system.</p>
</div>
<div class="paragraph">
<p>But despite that, both can benefit if the human planner becomes the supervisor of Planner:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>The human planner defines and validates the score function.</strong></p>
<div class="ulist">
<ul>
<li>
<p>Some examples expose a <code>\*Parametrization</code> object, which defines the weight for each score constraint. The human planner can then tweak those weights at runtime.</p>
</li>
<li>
<p>When the business changes, the score function often needs to change too. The human planner can notify the developers to add, change or remove score constraints.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>The human planner is always in control of Planner.</strong></p>
<div class="ulist">
<ul>
<li>
<p>As shown in the course scheduling example, the human planner can lock one or more planning variables to a specific planning value and make those immovable. Because they are <a href="#immovablePlanningEntities">immovable</a>, Planner does not change them: it optimizes the planning around the enforcements made by the human. If the human planner locks all planning variables, he/she sidelines Planner completely.</p>
</li>
<li>
<p>In a prototype implementation, the human planner might use this occasionally. But as the implementation matures, it must become obsolete. But do keep the feature alive: as a reassurance for the humans. Or in case that one day the business changes dramatically before the score constraints can be adjusted.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Therefore, it&#8217;s often a good idea to involve the human planner in your project.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./Integration/parameterizeTheScoreWeights.png" alt="parameterizeTheScoreWeights">
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./Integration/keepTheUserInControl.png" alt="keepTheUserInControl">
</div>
</div>
</div>
<div class="sect2">
<h3 id="sizingHardwareAndSoftware"><a class="anchor" href="#sizingHardwareAndSoftware"></a><a class="link" href="#sizingHardwareAndSoftware">16.6. Sizing Hardware and Software</a></h3>
<div class="paragraph">
<p>Before sizing a Planner service, first understand the typical behaviour of a <code>Solver.solve()</code> call:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./Integration/sizingHardware.png" alt="sizingHardware">
</div>
</div>
<div class="paragraph">
<p>Understand these guidelines to decide the hardware for a Planner service:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>RAM memory</strong>: Provision plenty, but no need to provide more.</p>
<div class="ulist">
<ul>
<li>
<p>The problem dataset, loaded before Planner is called, often consumes the most memory. It depends on the problem scale.</p>
<div class="ulist">
<ul>
<li>
<p>For example, in the Machine Reassignment example some datasets use over 1GB in memory. But in most examples, they use just a few MB.</p>
</li>
<li>
<p>If this is a problem, review the domain class structure: remove classes or fields that Planner doesn&#8217;t need during solving.</p>
</li>
<li>
<p>Planner usually has up to three solution instances: the internal working solution, the best solution and the old best solution (when it&#8217;s being replaced). However, these are all a <a href="#cloningASolution">planning clone</a> of each other, so many problem fact instances are shared between those solution instances.</p>
</li>
</ul>
</div>
</li>
<li>
<p>During solving, the memory is very volatile, because solving creates many short-lived objects. The Garbage Collector deletes these in bulk and therefore needs some heap space as a buffer.</p>
</li>
<li>
<p>The maximum size of the JVM heap space can be in three states:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Insufficient</strong>: An <code>OutOfMemoryException</code> is thrown (often because the Garbage Collector is using more than 98% of the CPU time).</p>
</li>
<li>
<p><strong>Narrow</strong>: The heap buffer for those short-lived instances is too small, therefore the Garbage Collector needs to run more than it would like to, which causes a performance loss.</p>
<div class="ulist">
<ul>
<li>
<p>Profiling shows that in the heap chart, the used heap space frequently touches the max heap space during solving. It also shows that the Garbage Collector has a significant CPU usage impact.</p>
</li>
<li>
<p>Adding more heap space increases the <a href="#scoreCalculationSpeed">score calculation speed</a>.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Plenty</strong>: There is enough heap space. The Garbage Collector is active, but its CPU usage is low.</p>
<div class="ulist">
<ul>
<li>
<p>Adding more heap space does <em>not</em> increase performance.</p>
</li>
<li>
<p>Usually, this is around 300 to 500MB above the dataset size, <em>regardless of the problem scale</em> (except with <a href="#nearbySelection">nearby selection</a> and caching move selector, neither are used by default).</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>CPU power</strong>: More is better.</p>
<div class="ulist">
<ul>
<li>
<p>Improving CPU speed directly increases the <a href="#scoreCalculationSpeed">score calculation speed</a>.</p>
<div class="ulist">
<ul>
<li>
<p>If the CPU power is twice as fast, it takes half the time to find the same result. However, this does not guarantee that it finds a better result in the same time, nor that it finds a similar result for a problem twice as a big in the same time.</p>
</li>
<li>
<p>Increasing CPU power usually does not resolve scaling issues, because planning problems scale exponentially. Power tweaking the solver configuration has far better results for scaling issues than throwing hardware at it.</p>
</li>
</ul>
</div>
</li>
<li>
<p>During the <code>solve()</code> method, the CPU power will max out until it returns (except in <a href="#daemon">daemon mode</a> or if your <a href="#SolverEventListener">SolverEventListener</a> writes the best solution to disk or the network).</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Number of CPU cores</strong>: one CPU core per active Solver, plus at least one one for the operating system.</p>
<div class="ulist">
<ul>
<li>
<p>So in a multitenant application, which has one Solver per tenant, this means one CPU core per tenant, unless the number of solver threads is limited, as that limits the number of tenants being solved in parallel.</p>
</li>
<li>
<p>With Partitioned Search, presume one CPU core per partition (per active tenant), unless the number of partition threads is limited.</p>
<div class="ulist">
<ul>
<li>
<p>To reduce the number of used cores, it can be better to reduce the partition threads (so solve some partitions sequentially) than to reduce the number of partitions.</p>
</li>
</ul>
</div>
</li>
<li>
<p>In use cases with many tenants (such as scheduling Software as a Service) or many partitions, it might not be affordable to provision that many CPU&#8217;s.</p>
<div class="ulist">
<ul>
<li>
<p>Reduce the number of active Solvers at a time. For example: give each tenant only one minute of machine time and use a <code>ExecutorService</code> with a fixed thread pool to queue requests.</p>
</li>
<li>
<p>Distribute the Solver runs across the day (or night). This is especially an opportunity in SaaS that&#8217;s used across the globe, due to timezones: UK and India can use the same CPU core when scheduling at night.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The SolverManager will take care of the orchestration, especially in those underfunded environments in which solvers (and partitions) are forced to share CPU cores or wait in line.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>I/O (network, disk, &#8230;&#8203;)</strong>: Not used during solving.</p>
<div class="ulist">
<ul>
<li>
<p>Planner is not a web server: a solver thread does not block (unlike a servlet thread), each one fully drains a CPU.</p>
<div class="ulist">
<ul>
<li>
<p>A web server can handle 24 active servlets threads with eight cores without performance loss, because most servlets threads are blocking on I/O.</p>
</li>
<li>
<p>However, 24 active solver threads with eight cores will cause each solver&#8217;s <a href="#scoreCalculationSpeed">score calculation speed</a> to be three times slower, causing a big performance loss.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Note that calling any I/O during solving, for example a remote service in your score calculation, causes a huge performance loss because it&#8217;s called thousands of times per second, so it should complete in microseconds. So no good implementation does that.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Keep these guidelines in mind when selecting and configuring the software.
See <a href="https://www.optaplanner.org/blog/archive.html">our blog archive</a> for the details of our experiments, which use our diverse set of examples.
Your mileage may vary.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Operating System</p>
<div class="ulist">
<ul>
<li>
<p>No experimentally proven advice yet (but prefer Linux anyway).</p>
</li>
</ul>
</div>
</li>
<li>
<p>JDK</p>
<div class="ulist">
<ul>
<li>
<p>Version: Java 7 can be between 10% and 25% faster than Java 6. But Java 8 however is usually not significantly faster than Java 7.</p>
</li>
<li>
<p>Garbage Collector: ParallelGC (the default in Java 8) can be potentially between 5% and 35% faster than G1GC (the default in Java 9). Unlike web servers, Planner needs a GC focused on throughput, not latency. Use <code>-XX:+UseParallelGC</code> to turn on ParallelGC.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Logging can have a severe impact on performance.</p>
<div class="ulist">
<ul>
<li>
<p>Debug logging <code>org.drools</code> can reduce performance by a factor of 7.</p>
</li>
<li>
<p>Debug logging <code>org.optaplanner</code> can be between 0% and 15% slower than info logging. Trace logging can be between 5% and 70% slower than info logging.</p>
</li>
<li>
<p>Synchronous logging to a file has an additional significant impact for debug and trace logging (but not for info logging).</p>
</li>
</ul>
</div>
</li>
<li>
<p>Avoid a cloud environment in which you share your CPU core(s) with other virtual machines or containers. Performance (and therefore solution quality) can be unreliable when the available CPU power varies greatly.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Keep in mind that the perfect hardware/software environment will probably <em>not</em> solve scaling issues (even Moore&#8217;s law is too slow).
There is no need to follow these guidelines to the letter.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="designPatterns"><a class="anchor" href="#designPatterns"></a><a class="link" href="#designPatterns">17. Design Patterns</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="designPatternsIntroduction"><a class="anchor" href="#designPatternsIntroduction"></a><a class="link" href="#designPatternsIntroduction">17.1. Design Patterns Introduction</a></h3>
<div class="paragraph">
<p>These design patterns list and solve common design challenges.</p>
</div>
<div class="sect3">
<h4 id="domainModelingGuide"><a class="anchor" href="#domainModelingGuide"></a><a class="link" href="#domainModelingGuide">17.1.1. Domain Modeling Guide</a></h4>
<div class="paragraph">
<p>A good model can greatly improve the success of your planning implementation.
These guidelines help to design a good model:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Draw a class diagram</strong> of your domain model. <em>Normalize</em> it get rid of duplicate data.</p>
<div class="ulist">
<ul>
<li>
<p>Write down some sample instances for each class.</p>
<div class="ulist">
<ul>
<li>
<p>For example in employee rostering, the samples for the <code>Employee</code> class are <em>Ann</em>, <em>Bert</em> and <em>Carl</em>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Determine which relationships (or fields) change during planning</strong>. Color them orange.
Often there is only one such relationship (or field).
One side of these relationships will become a planning variable later on.</p>
<div class="ulist">
<ul>
<li>
<p>For example in employee rostering, the <code>Shift</code> to <code>Employee</code> relationship changes during planning,
so it is orange.
Other relationships, such as from <code>Employee</code> to <code>Skill</code>, are immutable during planning
because Planner can&#8217;t decide to give an employee an extra skill.</p>
</li>
</ul>
</div>
</li>
<li>
<p>If there are multiple relationships (or fields): <strong>check for <a href="#shadowVariable">shadow variables</a></strong>.
A shadow variables does change during planning,
but its value can be calculated based on one or more genuine planning variables, without dispute.
Color those shadow relationships (or fields) purple.</p>
<div class="ulist">
<ul>
<li>
<p>Only one side of a bi-directional relationship can be a genuine planning variable,
the other side will become an <a href="#bidirectionalVariable">inverse relation shadow variable</a> later on.
Keep those relationships in orange.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Check for <a href="#chainedPlanningVariable">chained planning variables</a></strong>.
In a chained variable design, the focus lies on deciding the order of a set planning entity instances,
instead of assigning them to a date/time (although there can be an assigned date/time as a shadow variable).
A typical use case is <a href="#vehicleRouting">vehicle routing</a>.</p>
</li>
<li>
<p>If there is an orange <em>many to many</em> relationship, <strong>replace that <em>many to many</em> relationship</strong>
with a <em>one to many</em> and a <em>many to one</em> relationship to a new intermediate class.</p>
<div class="ulist">
<ul>
<li>
<p>Planner currently doesn&#8217;t support a <code>@PlanningVariable</code> on a collection.
Although a future version will support it for flexibility reasons,
it probably has an inherit performance and complexity cost, so it might be better to avoid it anyway.</p>
</li>
<li>
<p>For example in employee rostering the <code>ShiftAssignment</code> class is
the <em>many to many</em> relationship between the <code>Shift</code> and <code>Employee</code>.
It&#8217;s effectively every spot that needs to be filled with an employee.</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./DesignPatterns/employeeShiftRosteringModelingGuideA.png" alt="employeeShiftRosteringModelingGuideA">
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>In a <em>many to one</em> relationship, <strong>usually the <em>many</em> side is the planning entity class</strong>.
Annotate it with a <code>@PlanningEntity</code> annotation.</p>
<div class="ulist">
<ul>
<li>
<p>For example in employee rostering, the <code>ShiftAssignment</code> class has an <code>@PlanningEntity</code> annotation.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The planning entity class should have <strong>at least one problem property</strong>.
So a planning entity class cannot consist out of only planning variables
(or even an id and only planning variables).
Remove a surplus <code>@PlanningVariable</code> so it becomes a problem property.
This heavily decreases <a href="#searchSpaceSize">the search space size</a> and heavily increases solving efficiency.</p>
<div class="ulist">
<ul>
<li>
<p>For example in employee rostering, the <code>ShiftAssignment</code> class should not annotate
both the shift and employee relationship with <code>@PlanningVariable</code>.</p>
</li>
<li>
<p>When all planning variables are <code>null</code> (which occurs when the planning solution is still uninitialized),
a planning entity instance should still be describable to the business people.</p>
<div class="ulist">
<ul>
<li>
<p>So a surrogate ID does not suffice as the required minimum of one problem property.</p>
</li>
</ul>
</div>
</li>
<li>
<p>This way, there is no need to add a hard constraint to assure that two planning entities are different:
they are already different due to their problem properties.</p>
</li>
<li>
<p>In some cases, multiple planning entity instances have the same set of problem properties.
In such cases, it can be useful to create an extra problem property to distinguish them.</p>
<div class="ulist">
<ul>
<li>
<p>For example in employee rostering, the <code>ShiftAssignment</code> class has besides the problem property <code>Shift</code>
also the problem property <code>indexInShift</code> (which is an <code>int</code>).</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Choose the model in which <strong>the number of planning entities is fixed during planning</strong>.</p>
<div class="ulist">
<ul>
<li>
<p>For example in employee rostering, it&#8217;s impossible to know in advance how many shifts each employee will have
before Planner solves it (and it can even differ per best solution found).
On the other hand, the number of employees per shift is known in advance,
so it&#8217;s better to make the <code>Shift</code> relationship a problem property
and the <code>Employee</code> relationship a planning variable.</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./DesignPatterns/employeeShiftRosteringModelingGuideB.png" alt="employeeShiftRosteringModelingGuideB">
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>For inspiration, take a look at how the examples modeled their domain:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./DesignPatterns/entityVariableAndValueExamples.png" alt="entityVariableAndValueExamples">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Vehicle routing is special, because it uses a <a href="#chainedPlanningVariable">chained planning variable</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="assigningTimeToPlanningEntities"><a class="anchor" href="#assigningTimeToPlanningEntities"></a><a class="link" href="#assigningTimeToPlanningEntities">17.2. Assigning Time to Planning Entities</a></h3>
<div class="paragraph">
<p>Dealing with time and dates in planning problems may be problematic because it is dependent on the needs of your use case.</p>
</div>
<div class="paragraph">
<p>There are several representations of timestamps, dates, durations and periods in Java.
Choose the right representation type for your use case:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.util.Date</code> (deprecated): a slow, error-prone way to represent timestamps. Do not use.</p>
</li>
<li>
<p><code>java.time.LocalDateTime</code>, <code>LocalDate</code>, <code>DayOfWeek</code>, <code>Duration</code>, <code>Period</code>, &#8230;&#8203;: an accurate way to represent and calculate with timestamps, dates, &#8230;&#8203;</p>
<div class="ulist">
<ul>
<li>
<p>Supports timezones and DST (Daylight Saving Time).</p>
</li>
<li>
<p>Requires Java 8 or higher.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>int</code> or <code>long</code>: Caches a timestamp as a simplified number of coarse-grained time units (such as minutes) from the start of the global planning time window or the epoch.</p>
<div class="ulist">
<ul>
<li>
<p>For example: a <code>LocalDateTime</code> of <code>1-JAN 08:00:00</code> becomes an <code>int</code> of <code>400</code> minutes. Similarly <code>1-JAN 09:00:00</code> becomes <code>460</code> minutes.</p>
</li>
<li>
<p>It often represents an extra field in a class, alongside the <code>LocalDateTime</code> field from which it was calculated. The <code>LocalDateTime</code> is used for user visualization, but the <code>int</code> is used in the score constraints.</p>
</li>
<li>
<p>It is faster in calculations, which is especially useful in the TimeGrain pattern.</p>
</li>
<li>
<p>Do not use if timezones or DST affect the score constraints.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are also several designs for assigning a planning entity to a starting time (or date):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The starting time is fixed beforehand. It is not a planning variable (in such solver).</p>
<div class="ulist">
<ul>
<li>
<p>For example, in the <a href="#bedAllocation">hospital bed planning</a> example, the arrival day of each patient is fixed beforehand.</p>
</li>
<li>
<p>This is common in <a href="#multiStagePlanning">multi stage planning</a>, when the starting time has been decided already in an earlier planning stage.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The starting time is not fixed, it is a planning variable (genuine or shadow).</p>
<div class="ulist">
<ul>
<li>
<p>If all planning entities have the same duration, use the <a href="#timeslotPattern">Timeslot pattern</a>.</p>
<div class="ulist">
<ul>
<li>
<p>For example in course scheduling, all lectures take one hour. Therefore, each timeslot is one hour.</p>
</li>
</ul>
</div>
</li>
<li>
<p>If the duration differs and time is rounded to a specifc time granularity (for example 5 minutes) use the <a href="#timeGrainPattern">TimeGrain pattern</a>.</p>
<div class="ulist">
<ul>
<li>
<p>For example in meeting scheduling, all meetings start at 15 minute intervals. All meetings take 15, 30, 45, 60, 90 or 120 minutes.</p>
</li>
</ul>
</div>
</li>
<li>
<p>If the duration differs and one task starts immediately after the previous task (assigned to the same executor) finishes, use the <a href="#chainedThroughTimePattern">Chained Through Time pattern</a>.</p>
<div class="ulist">
<ul>
<li>
<p>For example in time windowed vehicle routing, each vehicle departs immediately to the next customer when the delivery for the previous customer finishes.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Choose the right pattern depending on the use case:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./DesignPatterns/assigningTimeToPlanningEntities.png" alt="assigningTimeToPlanningEntities">
</div>
</div>
<div class="sect3">
<h4 id="timeslotPattern"><a class="anchor" href="#timeslotPattern"></a><a class="link" href="#timeslotPattern">17.2.1. Timeslot Pattern: Assign to a Fixed-Length Timeslot</a></h4>
<div class="paragraph">
<p>If all planning entities have <strong>the same duration</strong> (or can be inflated to the same duration), the Timeslot pattern is useful.
The planning entities are assigned to a timeslot rather than time.
For example in <a href="#curriculumCourse">course timetabling</a>, all lectures take one hour.</p>
</div>
<div class="paragraph">
<p>The timeslots can start at any time.
For example, the timeslots start at 8:00, 9:00, 10:15 (after a 15-minute break), 11:15, &#8230;&#8203; They can even overlap, but that is unusual.</p>
</div>
<div class="paragraph">
<p>It is also usable if all planning entities can be inflated to the same duration.
For example in <a href="#examination">exam timetabling</a>, some exams take 90 minutes and others 120 minutes, but all timeslots are 120 minutes.
When an exam of 90 minutes is assigned to a timeslot, for the remaining 30 minutes, its seats are occupied too and cannot be used by another exam.</p>
</div>
<div class="paragraph">
<p>Usually there is a second planning variable, for example the room.
In course timetabling, two lectures are in conflict if they share the same room at the same timeslot.
However, in exam timetabling, that is allowed, if there is enough seating capacity in the room (although mixed exam durations in the same room do inflict a soft score penalty).</p>
</div>
</div>
<div class="sect3">
<h4 id="timeGrainPattern"><a class="anchor" href="#timeGrainPattern"></a><a class="link" href="#timeGrainPattern">17.2.2. TimeGrain Pattern: Assign to a Starting TimeGrain</a></h4>
<div class="paragraph">
<p>Assigning humans to start a meeting at four seconds after 9 o&#8217;clock is pointless because most human activities have a time granularity of five minutes or 15 minutes.
Therefore it is not necessary to allow a planning entity to be assigned subsecond, second or even one minute accuracy.
The five minute or 15 minutes accuracy suffices.
The TimeGrain pattern models such <strong>time accuracy</strong> by partitioning time as time grains.
For example in <a href="#meetingScheduling">meeting scheduling</a>, all meetings start/end in hour, half hour, or 15-minute intervals before or after each hour, therefore the optimal settings for time grains is 15 minutes.</p>
</div>
<div class="paragraph">
<p>Each planning entity is assigned to a start time grain.
The end time grain is calculated by adding the duration in grains to the starting time grain.
Overlap of two entities is determined by comparing their start and end time grains.</p>
</div>
<div class="paragraph">
<p>This pattern also works well with a coarser time granularity (such as days, half days, hours, &#8230;&#8203;).
With a finer time granularity (such as seconds, milliseconds, &#8230;&#8203;) and a long time window, the value range (and therefore <a href="#searchSpaceSize">the search space</a>) can become too high, which reduces efficiency and scalability.
However, such solution is not impossible, as shown in <a href="#cheapTimeScheduling">cheap time scheduling</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="chainedThroughTimePattern"><a class="anchor" href="#chainedThroughTimePattern"></a><a class="link" href="#chainedThroughTimePattern">17.2.3. Chained Through Time Pattern: Assign in a Chain that Determines Starting Time</a></h4>
<div class="paragraph">
<p>If a person or a machine continuously works on <strong>one task at a time in sequence</strong>,
which means starting a task when the previous is finished (or with a deterministic delay), the Chained Through Time pattern is useful.
For example, in the vehicle routing with time windows example, a vehicle drives from customer to customer (thus it handles one customer at a time).</p>
</div>
<div class="paragraph">
<p>In this pattern, the planning entities are <a href="#chainedPlanningVariable">chained</a>.
The anchor determines the starting time of its first planning entity.
The second entity&#8217;s starting time is calculated based on the starting time and duration of the first entity.
For example, in task assignment, Beth (the anchor) starts working at 8:00, thus her first task starts at 8:00.
It lasts 52 mins, therefore her second task starts at 8:52.
The starting time of an entity is usually <a href="#shadowVariable">a shadow variable</a>.</p>
</div>
<div class="paragraph">
<p>An anchor has only one chain.
Although it is possible to split up the anchor into two separate anchors, for example split up Beth into Beth&#8217;s left hand and Beth&#8217;s right hand (because she can do two tasks at the same time), this model makes pooling resources difficult.
Consequently, using this model in the exam scheduling example to allow two or more exams to use the same room at the same time is problematic.</p>
</div>
<div class="paragraph">
<p>Between planning entities, there are three ways to create gaps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>No gaps: This is common when the anchor is a machine. For example, a build server always starts the next job when the previous finishes, without a break.</p>
</li>
<li>
<p>Only deterministic gaps: This is common for humans. For example, any task that crosses the 10:00 barrier gets an extra 15 minutes duration so the human can take a break.</p>
<div class="ulist">
<ul>
<li>
<p>A deterministic gap can be subjected to complex business logic. For example in vehicle routing, a cross-continent truck driver needs to rest 15 minutes after two hours of driving (which may also occur during loading or unloading time at a customer location) and also needs to rest 10 hours after 14 hours of work.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Planning variable gaps: This is uncommon, because an extra planning variable (which impacts the <a href="#searchSpaceSize">search space</a>) reduces efficiency and scalability.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="multiStragePlanning"><a class="anchor" href="#multiStragePlanning"></a><a class="link" href="#multiStragePlanning">17.3. Multi-stage planning</a></h3>
<div class="paragraph">
<p>For practical or organizational reasons (such as Conway&#8217;s law), complex planning problems are often broken down in multiple stages.
A typical example is train scheduling, where one department decides where and when a train will arrive or depart, and another departments assigns the operators to the actual train cars/locomotives.</p>
</div>
<div class="paragraph">
<p>Each stage has its own solver configuration (and therefore its own <code>SolverFactory</code>). Do not confuse it with <a href="#solverPhase">multi-phase solving</a> which uses a one-solver configuration.</p>
</div>
<div class="paragraph">
<p>Similarly to <a href="#partitionedSearch">Partitioned Search</a>, multi-stage planning leads to suboptimal results.
Nevertheless, it may be beneficial in order to simplify the maintenance, ownership, and help to start a project.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="development"><a class="anchor" href="#development"></a><a class="link" href="#development">18. Development</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="methodologyOverview"><a class="anchor" href="#methodologyOverview"></a><a class="link" href="#methodologyOverview">18.1. Methodology Overview</a></h3>
<div class="paragraph">
<p>The diagram below explains the overall structure of the OptaPlanner source code:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./Development/methodologyOverview.png" alt="methodologyOverview">
</div>
</div>
<div class="paragraph">
<p>In the diagram above, it&#8217;s important to understand the clear separation between the configuration and runtime classes.</p>
</div>
<div class="paragraph">
<p>The development philosophy includes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Reuse</strong>: The examples are reused as integration tests, stress tests and demo&#8217;s. The documentation images are reused as slides.</p>
</li>
<li>
<p><strong>Consistent terminology</strong>: Each example has a class <code>App</code> (executable class), <code>Dao</code> (Data Access Object) and <code>Panel</code> (swing UI).</p>
</li>
<li>
<p><strong>Consistent structure</strong>: Each example has the same packages: <code>domain</code>, <code>persistence</code>, <code>app</code>, <code>solver</code> and <code>swingui</code>.</p>
</li>
<li>
<p><strong>Real world usefulness</strong>: Every feature is used in an example. Most examples are real world use cases with real world constraints, often with real world data.</p>
</li>
<li>
<p><strong>Automated testing</strong>: There are unit tests, integration tests, performance regressions tests and stress tests. The test coverage is high.</p>
</li>
<li>
<p><strong>Fail fast with an understandable error message</strong>: Invalid states are checked as early as possible.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="developmentGuidelines"><a class="anchor" href="#developmentGuidelines"></a><a class="link" href="#developmentGuidelines">18.2. Development guidelines</a></h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Fail fast. There are several levels of fail fast, from better to worse:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><strong>Fail Fast at compile time</strong>. For example: Don&#8217;t accept an <code>Object</code> as parameter if it needs to be a <code>String</code> or an <code>Integer</code>.</p>
</li>
<li>
<p><strong>Fail Fast at startup time</strong>. For example: if the configuration parameter needs to be a positive <code>int</code> and it&#8217;s negative, fail fast</p>
</li>
<li>
<p><strong>Fail Fast at runtime</strong>. For example: if the request needs to contain a double between <code>0.0</code> and <code>1.0</code> and it&#8217;s bigger than <code>1.0</code>, fail fast.</p>
</li>
<li>
<p><strong>Fail Fast at runtime in assertion mode</strong> if the detection performance cost is high. For example: If, after every low level iteration, the variable A needs to be equal to the square root of B, check it if and only if an assert flag is set to true (usually controlled by the <a href="#environmentMode">EnvironmentMode</a>).</p>
</li>
</ol>
</div>
</li>
<li>
<p><code>Exception</code> messages</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>The <code>Exception</code> message must include the name and state of each relevant variable. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">if (fooSize &lt; 0) {
    throw new IllegalArgumentException("The fooSize (" + fooSize + ") of bar (" + this + ") must be positive.");
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that the output clearly explains what&#8217;s wrong:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">Exception in thread "main" java.lang.IllegalArgumentException: The fooSize (-5) of bar (myBar) must be positive.
    at ...</code></pre>
</div>
</div>
</li>
<li>
<p>Whenever possible, the <code>Exception</code> message must include context.</p>
</li>
<li>
<p>Whenever the fix is not obvious, the <code>Exception</code> message should include advice. Advice normally starts with the word <em>maybe</em> on a new line:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java" data-lang="java">Exception in thread "main" java.lang.IllegalStateException: The valueRangeDescriptor (fooRange) is nullable, but not countable (false).
Maybe the member (getFooRange) should return CountableValueRange.
    at ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The word <em>maybe</em> is to indicate that the advice is not guaranteed to be right in all cases.</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Generics. The <code>Solution</code> class is often passed as a generic type parameter to subsystems. The <code>PlanningEntity</code> class(es) are rarely passed as a generic type parameter.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 7.0.0.Final<br>
Last updated 2017-05-26 08:42:53 CEST
</div>
</div>
<script type="text/javascript">
dataLayer = [{'channel' : 'OptaPlanner', 'additional_tracking_code' : 'UA-39485370-1'}];
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NJWS5L');</script>
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-NJWS5L" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>